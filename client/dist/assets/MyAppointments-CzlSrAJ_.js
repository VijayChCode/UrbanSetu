import{g as ts,r as n,u as ss,v as p,j as e,P as it,a4 as ot,a5 as as,G as Ce,U as ns,a7 as ls,a6 as _t,f as rs,a8 as is,a9 as os,y as h,h as ds,L as cs,z as T,H as nt,aa as lt,ab as ms,ah as St,C as us,ac as xs,a1 as hs,E as Re,ad as gs,ae as kt}from"./index-CBBj6AuS.js";const D="https://urbansetu.onrender.com";function ps(){const{currentUser:s}=ts(a=>a.user),[g,R]=n.useState([]),[dt,G]=n.useState(!0),[he,le]=n.useState(null),[z,ct]=n.useState(""),[W,Te]=n.useState("all"),[Se,re]=n.useState("all"),[ge,ie]=n.useState(""),[V,N]=n.useState(!1),[b,ke]=n.useState(null),[J,A]=n.useState(""),[F,L]=n.useState(""),[Q,fe]=n.useState(!1),[_,oe]=n.useState(null),[v,X]=n.useState([]),[S,H]=n.useState(!1),P=ss(),[ze,$]=n.useState(null);n.useEffect(()=>{const a=async()=>{if(!s){le("Please sign in to view your appointments"),G(!1);return}try{G(!0),le(null);const c=await fetch(`${D}/api/bookings/my`,{credentials:"include"});if(c.ok){const x=await c.json();R(x)}else throw new Error("Failed to fetch appointments")}catch{le("Failed to load appointments. Please try again.")}finally{G(!1)}},o=async()=>{if(s&&(s.role==="admin"||s.role==="rootadmin"))try{const c=await fetch(`${D}/api/bookings/archived`,{credentials:"include"});if(!c.ok)throw new Error("Not allowed");const x=await c.json();X(Array.isArray(x)?x:[])}catch{X([]),h.error("Failed to fetch archived appointments")}else X([])};a(),o()},[s]),n.useEffect(()=>{const a=o=>{R(c=>c.filter(x=>x._id!==o.detail))};return window.addEventListener("removeAppointmentRow",a),()=>{window.removeEventListener("removeAppointmentRow",a)}},[s]),n.useEffect(()=>{s&&R(a=>a.map(o=>{const c={...o};return o.buyerId&&(o.buyerId._id===s._id||o.buyerId===s._id)&&(c.buyerId={...c.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),o.sellerId&&(o.sellerId._id===s._id||o.sellerId===s._id)&&(c.sellerId={...c.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),c}))},[s]),n.useEffect(()=>{function a(o){R(c=>c.map(x=>x._id===o.appointmentId?{...x,...o.updatedAppointment}:x))}return p.on("appointmentUpdate",a),()=>{p.off("appointmentUpdate",a)}},[]),n.useEffect(()=>{function a(c){const x=c.appointment;x.buyerId&&s&&(x.buyerId._id===s._id||x.buyerId===s._id)?x.role="buyer":x.sellerId&&s&&(x.sellerId._id===s._id||x.sellerId===s._id)&&(x.role="seller"),R(w=>[x,...w])}p.on("appointmentCreated",a);const o=c=>{R(x=>x.map(w=>{const j={...w};return w.buyerId&&(w.buyerId._id===c.userId||w.buyerId===c.userId)&&(j.buyerId={...j.buyerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),w.sellerId&&(w.sellerId._id===c.userId||w.sellerId===c.userId)&&(j.sellerId={...j.sellerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),j}))};return p.on("profileUpdated",o),()=>{p.off("appointmentCreated",a),p.off("profileUpdated",o)}},[s]),n.useEffect(()=>{if(!s)return;const a=setInterval(()=>{p.emit("userAppointmentsActive",{userId:s._id})},1e3);return()=>clearInterval(a)},[s]);const q=async(a,o)=>{ie(a+o);try{const c=await fetch(`${D}/api/bookings/${a}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:o})}),x=await c.json();if(c.status===401){h.error("Session expired or unauthorized. Please sign in again."),P("/sign-in");return}if(c.ok){R(j=>j.map(E=>E._id===a?{...E,status:o}:E));const w=o==="accepted"?"accepted":"rejected";h.success(`Appointment ${w} successfully! ${o==="accepted"?"Contact information is now visible to both parties.":""}`,{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),P("/user/my-appointments")}else h.error(x.message||"Failed to update appointment status.")}catch{h.error("An error occurred. Please try again.")}ie("")},de=async a=>{setAppointmentToHandle(a),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},Ee=async a=>{setAppointmentToHandle(a),setShowArchiveModal(!0)},Be=async a=>{setAppointmentToHandle(a),setShowUnarchiveModal(!0)},Ae=g.filter(a=>{var E,B,ee,U,C,te,me,K,Oe,be;if(s._id===((B=(E=a.buyerId)==null?void 0:E._id)==null?void 0:B.toString())&&a.visibleToBuyer===!1||s._id===((U=(ee=a.sellerId)==null?void 0:ee._id)==null?void 0:U.toString())&&a.visibleToSeller===!1)return!1;const o=new Date(a.date)<new Date||new Date(a.date).toDateString()===new Date().toDateString()&&a.time&&a.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(W==="outdated")return o;const c=W==="all"?!0:a.status===W,x=Se==="all"?!0:a.role===Se,w=((C=a.propertyName)==null?void 0:C.toLowerCase().includes(z.toLowerCase()))||((te=a.message)==null?void 0:te.toLowerCase().includes(z.toLowerCase()))||((K=(me=a.buyerId)==null?void 0:me.username)==null?void 0:K.toLowerCase().includes(z.toLowerCase()))||((be=(Oe=a.sellerId)==null?void 0:Oe.username)==null?void 0:be.toLowerCase().includes(z.toLowerCase()));let j=!0;return J&&(j=j&&new Date(a.date)>=new Date(J)),F&&(j=j&&new Date(a.date)<=new Date(F)),c&&x&&w&&j}),_e=Array.isArray(v)?v.filter(a=>{var w,j,E,B,ee,U;const o=new Date(a.date)<new Date||new Date(a.date).toDateString()===new Date().toDateString()&&a.time&&a.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(W==="outdated")return o;W==="all"||a.status;const c=((w=a.propertyName)==null?void 0:w.toLowerCase().includes(z.toLowerCase()))||((j=a.message)==null?void 0:j.toLowerCase().includes(z.toLowerCase()))||((B=(E=a.buyerId)==null?void 0:E.username)==null?void 0:B.toLowerCase().includes(z.toLowerCase()))||((U=(ee=a.sellerId)==null?void 0:ee.username)==null?void 0:U.toLowerCase().includes(z.toLowerCase()));let x=!0;return J&&(x=x&&new Date(a.date)>=new Date(J)),F&&(x=x&&new Date(a.date)<=new Date(F)),c&&x}):[];function Me(a){oe({...a,date:a.date?new Date(a.date).toISOString().split("T")[0]:"",time:a.time||"",message:a.message||"",buyerReinitiationCount:a.buyerReinitiationCount||0,sellerReinitiationCount:a.sellerReinitiationCount||0}),fe(!0)}async function Le(a){var w,j;if(a.preventDefault(),!_)return;const o=s&&(((w=_.buyerId)==null?void 0:w._id)===s._id||_.buyerId===s._id);if(s&&(((j=_.sellerId)==null?void 0:j._id)===s._id||(_.sellerId,s._id)),(o?_.buyerReinitiationCount||0:_.sellerReinitiationCount||0)>=2){h.error("You have reached the maximum number of reinitiations for your role.");return}if(!_.buyerId||!_.sellerId){h.error("Cannot reinitiate: one of the parties no longer exists.");return}const x={..._,status:"pending"};try{const E=await fetch(`${D}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(x)}),B=await E.json();E.ok?(h.success("Appointment reinitiated successfully!",{autoClose:5e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),fe(!1),oe(null),P("/user/my-appointments"),R(ee=>ee.map(U=>U._id===B.appointment._id?{...U,...B.appointment}:U))):h.error(B.message||"Failed to reinitiate appointment.")}catch{h.error("An error occurred. Please try again.")}}const Fe=(a,o)=>{R(c=>c.map(x=>x._id===a?{...x,status:o}:x))},Z=async()=>{G(!0),le(null);try{const a=await fetch(`${D}/api/bookings/my`,{credentials:"include"});if(a.ok){const o=await a.json();R(o)}else throw new Error("Failed to fetch appointments");if(s&&(s.role==="admin"||s.role==="rootadmin")){const o=await fetch(`${D}/api/bookings/archived`,{credentials:"include"});if(o.ok){const c=await o.json();X(Array.isArray(c)?c:[])}}else X([])}catch{le("Failed to refresh appointments. Please try again.")}finally{G(!1)}},Ie=a=>{if(console.log("Copy button clicked, message:",a),!a){h.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(a).then(()=>{h.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{ce(a)}):ce(a)},ce=a=>{try{const o=document.createElement("textarea");o.value=a,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();const c=document.execCommand("copy");document.body.removeChild(o),c?(console.log("Copy successful via fallback method"),h.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),h.error("Failed to copy message"))}catch(o){console.error("Fallback copy error:",o),h.error("Copy not supported")}};return dt?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):he?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:he})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:S?"Archived Appointments":"My Appointments"}),!S&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."})]}),e.jsx("button",{onClick:Z,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),s&&(s.role==="admin"||s.role==="rootadmin")&&e.jsx("button",{onClick:()=>H(!S),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${S?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:S?e.jsxs(e.Fragment,{children:[e.jsx(it,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(ot,{})," Archived Appointments (",v.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:W,onChange:a=>Te(a.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:J,onChange:a=>A(a.target.value),max:F||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:F,onChange:a=>L(a.target.value),min:J||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:Se,onChange:a=>re(a.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(as,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:z,onChange:a=>ct(a.target.value)})]})]}),S&&s&&(s.role==="admin"||s.role==="rootadmin")?_e.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:_e.map(a=>e.jsx(At,{appt:a,currentUser:s,handleStatusUpdate:q,handleAdminDelete:de,actionLoading:ge,onShowOtherParty:o=>{ke(o),N(!0)},onOpenReinitiate:()=>Me(a),handleArchiveAppointment:Ee,handleUnarchiveAppointment:Be,isArchived:!0,onCancelRefresh:Fe,copyMessageToClipboard:Ie},a._id))})]})}):Ae.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Ae.map(a=>e.jsx(At,{appt:a,currentUser:s,handleStatusUpdate:q,handleAdminDelete:de,actionLoading:ge,onShowOtherParty:o=>{ke(o),N(!0)},onOpenReinitiate:()=>Me(a),handleArchiveAppointment:Ee,handleUnarchiveAppointment:Be,isArchived:!1,onCancelRefresh:Fe,copyMessageToClipboard:Ie},a._id))})]})}),V&&b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>N(!1),title:"Close","aria-label":"Close",children:e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ns,{user:{username:b.username,avatar:b.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(ls,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[b.username||"User",b.role==="admin"&&e.jsx(_t,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:b.role||"User"})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(rs,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(is,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(os,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.createdAt?new Date(b.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]})})]})}),Q&&_&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:Le,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:_.date,onChange:a=>oe(o=>({...o,date:a.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:_.time,onChange:a=>oe(o=>({...o,time:a.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:_.message,onChange:a=>oe(o=>({...o,message:a.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>fe(!1),children:"Cancel"})]})]})})]})})}function rt(s){const g=new Date,R=new Date;return R.setDate(g.getDate()-1),s.toDateString()===g.toDateString()?"Today":s.toDateString()===R.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function At({appt:s,currentUser:g,handleStatusUpdate:R,handleAdminDelete:dt,actionLoading:G,onShowOtherParty:he,onOpenReinitiate:le,handleArchiveAppointment:z,handleUnarchiveAppointment:ct,isArchived:W,onCancelRefresh:Te,copyMessageToClipboard:Se}){var vt,wt;const[re,ge]=n.useState(null),[ie,V]=n.useState(""),[N,b]=n.useState(s.comments||[]),[ke,J]=n.useState(!1),[A,F]=n.useState(null),[L,Q]=n.useState(""),[fe,_]=n.useState(null),oe=ds(),[v,X]=n.useState(!1),S=n.useRef(null),H=n.useRef(null),[P,ze]=n.useState(!0),[$,q]=n.useState(0),[de,Ee]=n.useState(""),[Be,Ae]=n.useState(!1),[_e,Me]=n.useState(!1),[Le,Fe]=n.useState(!1),[Z,Ie]=n.useState(!1),[ce,a]=n.useState(!1),[o,c]=n.useState(!1),x=n.useRef(null),w=n.useRef(null),j=n.useRef(null),[E,B]=n.useState(!1),[ee,U]=n.useState(null),[C,te]=n.useState(null),[me,K]=n.useState(!0),[Oe,be]=n.useState(!1),[It,He]=n.useState(!1),[$e,Pe]=n.useState(""),[mt,Ue]=n.useState(""),[Ve,Je]=n.useState(null),[ut,xt]=n.useState(!1),[Dt,Rt]=n.useState(!1),[Tt,Et]=n.useState(!1),[Bt,Mt]=n.useState(!1),[Ft,qe]=n.useState(!1),[Ot,Ke]=n.useState(!1),[$t,Ye]=n.useState(!1),[fs,Ge]=n.useState(null),[pe,se]=n.useState(""),[zt,ht]=n.useState(""),ue=n.useRef({}),[We,Y]=n.useState(null);n.useEffect(()=>{if(ce){const t=setTimeout(()=>{a(!1)},1e4);return()=>clearTimeout(t)}},[ce]);function Qe(t){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${t}`))||[]}catch{return[]}}function Lt(t,l){const r=Qe(t);if(!r.includes(l)){const u=[...r,l];localStorage.setItem(`removedDeletedMsgs_${t}`,JSON.stringify(u))}}const Xe=(g.role==="admin"||g.role==="rootadmin")&&g.adminApprovalStatus==="approved",Ht=oe.pathname.includes("/admin"),M=s.role==="seller",ye=s.role==="buyer",ae=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),O=!ae||s.status==="pending"||s.status==="rejected"||s.status==="cancelledByAdmin",gt=(Xe||s.status==="accepted")&&ae,i=M?s.buyerId:s.sellerId,Pt=t=>{te(t),K(!0),B(!0)},Ut=t=>{te(t),K(!1),B(!0)},Vt=async()=>{var t;if(C){try{if(me){const l=!((t=C.readBy)!=null&&t.includes(g._id))&&C.senderEmail!==g.email,r=await fetch(`${D}/api/bookings/${s._id}/comment/${C._id}`,{method:"DELETE",credentials:"include"}),u=await r.json();r.ok?(b(d=>u.comments.map(m=>{const f=d.find(y=>y._id===m._id);return f&&f.status==="read"&&m.status!=="read"?{...m,status:"read"}:m})),l&&q(d=>Math.max(0,d-1)),h.success("Message deleted for everyone!")):h.error(u.message||"Failed to delete message.")}else b(l=>l.filter(r=>r._id!==C._id)),Lt(s._id,C._id),h.success("Message deleted for you!")}catch{h.error("An error occurred. Please try again.")}B(!1),te(null),K(!0)}},Jt=()=>{localStorage.setItem(jt,Date.now()),b([]),h.success("Chat Cleared"),be(!1)},Ze=async()=>{if(!ie.trim())return;const t=ie.trim(),l=re,r=`temp-${Date.now()}`,u={_id:r,sender:g._id,senderEmail:g.email,senderName:g.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[g._id],...l?{replyTo:l._id}:{}};b(d=>[...d,u]),V(""),ge(null),J(!0),S.current&&S.current.scrollIntoView({behavior:"smooth"});try{const d=await fetch(`${D}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...l?{replyTo:l._id}:{}})}),m=await d.json();if(d.ok){const f=m.comments[m.comments.length-1];b(y=>y.map(k=>k._id===r?{...f}:k))}else b(f=>f.filter(y=>y._id!==r)),h.error(m.message||"Failed to send message.")}catch{b(m=>m.filter(f=>f._id!==r)),h.error("An error occurred. Please try again.")}finally{J(!1)}},et=async t=>{if(!L.trim())return;_(t),b(r=>r.map(u=>u._id===t?{...u,message:L,edited:!0,editedAt:new Date}:u)),F(null),Q(""),V("");try{const r=await fetch(`${D}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:L})}),u=await r.json();r.ok?(b(d=>d.map(m=>{const f=u.comments.find(y=>y._id===m._id);return f?f._id===t?f:m.status==="read"&&f.status!=="read"?{...f,status:"read"}:f:m})),h.success("Message edited successfully!")):(b(d=>d.map(m=>m._id===t?{...m,message:m.originalMessage||m.message,edited:m.wasEdited||!1}:m)),F(t),Q(L),V(L),h.error(u.message||"Failed to edit message."))}catch{b(u=>u.map(d=>d._id===t?{...d,message:d.originalMessage||d.message,edited:d.wasEdited||!1}:d)),F(t),Q(L),V(L),h.error("An error occurred. Please try again.")}finally{_(null)}},qt=t=>{F(t._id),Q(t.message),V(t.message),b(l=>l.map(r=>r._id===t._id?{...r,originalMessage:r.message,wasEdited:r.edited}:r)),setTimeout(()=>{j.current&&(j.current.focus(),j.current.select())},100)},Kt=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},ft=async()=>{se(""),qe(!0)},Yt=async()=>{if(M&&!pe.trim()){h.error("Reason is required for seller cancellation.");return}try{const t=await fetch(`${D}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:pe})}),l=await t.json();if(t.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(h.success("Appointment cancelled successfully."),typeof Te=="function"&&Te(s._id,M?"cancelledBySeller":"cancelledByBuyer")):h.error(l.message||"Failed to cancel appointment."),qe(!1),se("")}catch{h.error("An error occurred. Please try again.")}},Gt=async()=>{se(""),Ke(!0)},Wt=async()=>{if(!pe.trim()){h.error("Reason is required for admin cancellation.");return}try{const t=await fetch(`${D}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:pe})}),l=await t.json();if(t.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(h.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):h.error(l.message||"Failed to cancel appointment."),Ke(!1),se("")}catch{h.error("An error occurred. Please try again.")}},tt=async()=>{Ye(!0)},Qt=async()=>{try{const t=ye?"buyer":M?"seller":null;if(!t)return;if((await fetch(`${D}/api/bookings/${s._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:t})})).ok){if(typeof window<"u"){const r=new CustomEvent("removeAppointmentRow",{detail:s._id});window.dispatchEvent(r),h.success("Appointment removed from your table successfully")}}else h.error("Failed to remove appointment from table.");Ye(!1)}catch{h.error("An error occurred. Please try again.")}};n.useEffect(()=>{v&&S.current&&S.current.scrollIntoView({behavior:"smooth"})},[v]);const st=n.useRef(!1),je=n.useCallback(async()=>{if(!H.current||st.current)return;const{scrollTop:t,scrollHeight:l,clientHeight:r}=H.current;if(!(l-t-r<10))return;const d=N.filter(m=>{var f;return!((f=m.readBy)!=null&&f.includes(g._id))&&m.senderEmail!==g.email});if(d.length>0){st.current=!0;try{(await fetch(`${D}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(b(f=>f.map(y=>d.some(k=>k._id===y._id)?{...y,readBy:[...y.readBy||[],g._id],status:"read"}:y)),d.forEach(f=>{p.emit("messageRead",{appointmentId:s._id,messageId:f._id,userId:g._id,readBy:g._id})}),console.log(`Marked ${d.length} messages as read for user ${g._id}`))}catch(m){console.error("Error marking messages as read:",m)}finally{st.current=!1}}},[N,g._id,s._id,p]),bt=n.useRef(N.length),Xt=n.useRef(N);n.useEffect(()=>{const t=N.slice(bt.current),l=t.length;if(bt.current=N.length,Xt.current=N,l>0&&v){const r=t.some(d=>d.senderEmail===g.email),u=t.filter(d=>d.senderEmail!==g.email);r||P?setTimeout(()=>{S.current&&(S.current.scrollIntoView({behavior:"smooth"}),P&&u.length>0&&setTimeout(()=>{je()},300))},100):u.length>0&&q(d=>d+u.length)}},[N.length,P,v,g.email,je]);const pt=n.useCallback(()=>{if(H.current){const{scrollTop:t,scrollHeight:l,clientHeight:r}=H.current,u=l-t-r<10;if(ze(u),u){const d=N.filter(m=>{var f;return!((f=m.readBy)!=null&&f.includes(g._id))&&m.senderEmail!==g.email}).length;d>0&&(console.log(`User manually scrolled to bottom, marking ${d} messages as read`),je()),$>0&&q(0)}}},[$,je,N,g._id]),at=n.useCallback(()=>{if(!H.current||N.length===0)return;const t=`chatClearTime_${s._id}`,l=Number(localStorage.getItem(t))||0,r=Qe(s._id),u=N.filter(k=>new Date(k.timestamp).getTime()>l&&!r.includes(k._id));if(u.length===0)return;const m=H.current.getBoundingClientRect(),f=m.top+60;let y="";for(let k=0;k<u.length;k++){const ne=ue.current[u[k]._id];if(ne){const we=ne.getBoundingClientRect();if(we.top>=f&&we.bottom<=m.bottom){const Ne=new Date(u[k].timestamp);y=rt(Ne);break}}}if(!y)for(let k=0;k<u.length;k++){const ne=ue.current[u[k]._id];if(ne&&ne.getBoundingClientRect().bottom>f){const Ne=new Date(u[k].timestamp);y=rt(Ne);break}}y&&y!==de&&Ee(y)},[N,de,s._id]);n.useEffect(()=>{const t=H.current;if(t&&v){const l=()=>{pt(),at(),Ae(!0),w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{Ae(!1)},1e3)};if(t.addEventListener("scroll",l),t){const{scrollTop:r,scrollHeight:u,clientHeight:d}=t,m=u-r-d<10;ze(m)}return setTimeout(at,100),()=>{t.removeEventListener("scroll",l),w.current&&clearTimeout(w.current)}}},[v,pt,at]),n.useEffect(()=>{v&&S.current&&S.current.scrollIntoView({behavior:"smooth"})},[v]);const Zt=n.useCallback(()=>{S.current&&(S.current.scrollIntoView({behavior:"smooth"}),q(0),setTimeout(()=>{je()},500))},[je]);n.useEffect(()=>{function t(l){var r,u;if(l.appointmentId===s._id&&!v){if(l.comment.deleted)return;const d=l.comment.senderEmail===((r=s.buyerId)==null?void 0:r.email),m=l.comment.senderEmail===((u=s.sellerId)==null?void 0:u.email),y=!d&&!m?"UrbanSetu":l.comment.senderEmail||"User";h.info(`New message from ${y}`)}}return p.on("commentUpdate",t),()=>{p.off("commentUpdate",t)}},[s._id,v]),n.useEffect(()=>{function t(l){l.appointmentId===s._id&&(b(r=>{const u=r.findIndex(d=>d._id===l.comment._id);if(u!==-1){const d=[...r],m=r[u],f=l.comment;let y=f.status;return m.status==="read"&&f.status!=="read"&&(y="read"),d[u]={...f,status:y},d}else return!r.some(m=>m._id.toString().startsWith("temp-"))||l.comment.senderEmail!==g.email?[...r,l.comment]:r}),l.comment.deleted&&l.comment.senderEmail!==g.email&&ve>0&&q(r=>Math.max(0,r-1)),v&&l.comment.senderEmail!==g.email&&(setTimeout(()=>{fetch(`${D}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"})},100),setTimeout(()=>{S.current&&P&&S.current.scrollIntoView({behavior:"smooth"})},50)))}return p.on("commentUpdate",t),()=>{p.off("commentUpdate",t)}},[s._id,b,v,g.email,P]),n.useEffect(()=>{v&&(fetch(`${D}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"}),N.length===0&&(c(!0),fetch(`${D}/api/bookings/${s._id}`).then(t=>t.json()).then(t=>{t&&Array.isArray(t.comments)&&b(t.comments)}).catch(t=>console.error("Failed to fetch comments:",t)).finally(()=>c(!1))))},[v,s._id,N.length]),n.useEffect(()=>{function t(r){r.appointmentId===s._id&&b(u=>u.map(d=>d._id===r.commentId?{...d,status:d.status==="read"?"read":"delivered"}:d))}function l(r){r.appointmentId===s._id&&b(u=>u.map(d=>{var m;return(m=d.readBy)!=null&&m.includes(r.userId)?d:{...d,status:"read",readBy:[...d.readBy||[],r.userId]}}))}return p.on("commentDelivered",t),p.on("commentRead",l),()=>{p.off("commentDelivered",t),p.off("commentRead",l)}},[s._id,b]);const yt=Qe(s._id),ve=N.filter(t=>{var l;return!((l=t.readBy)!=null&&l.includes(g._id))&&t.senderEmail!==g.email&&!yt.includes(t._id)}).length;n.useEffect(()=>(v?document.body.style.overflow="hidden":(document.body.style.overflow="",q(0)),()=>{document.body.style.overflow=""}),[v]);const jt=`chatClearTime_${s._id}`,es=Number(localStorage.getItem(jt))||0,De=N.filter(t=>new Date(t.timestamp).getTime()>es&&!yt.includes(t._id));n.useEffect(()=>{if(!v||!(i!=null&&i._id))return;p.emit("checkUserOnline",{userId:i._id});function t(l){l.userId===i._id&&Me(!!l.online)}return p.on("userOnlineStatus",t),p.on("userOnlineUpdate",t),()=>{p.off("userOnlineStatus",t),p.off("userOnlineUpdate",t)}},[v,i==null?void 0:i._id]),n.useEffect(()=>{if(!(i!=null&&i._id))return;p.emit("checkUserOnline",{userId:i._id});function t(l){l.userId===i._id&&Fe(!!l.online)}return p.on("userOnlineStatus",t),p.on("userOnlineUpdate",t),()=>{p.off("userOnlineStatus",t),p.off("userOnlineUpdate",t)}},[i==null?void 0:i._id]),n.useEffect(()=>{function t(l){l.fromUserId===(i==null?void 0:i._id)&&l.appointmentId===s._id&&(Ie(!0),x.current&&clearTimeout(x.current),x.current=setTimeout(()=>Ie(!1),1e3))}return p.on("typing",t),()=>{p.off("typing",t),x.current&&clearTimeout(x.current)}},[i==null?void 0:i._id,s._id]),n.useEffect(()=>{if(!v)return;const t=l=>{var r;l.ctrlKey&&l.key==="f"&&(l.preventDefault(),(r=j.current)==null||r.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[v]);const I=We?N.find(t=>t._id===We):null;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${ae?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!ae&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(cs,{to:Ht?`/admin/listing/${s.listingId._id}`:`/user/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${M?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:M?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[gt?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>he(i),title:"Click to view details",children:(i==null?void 0:i.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(i==null?void 0:i.username)||"Unknown"}),gt?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:i==null?void 0:i.email}),e.jsx("div",{className:"text-sm text-gray-600",children:i!=null&&i.mobileNumber&&(i==null?void 0:i.mobileNumber)!==""?i.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:Xe?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Kt(s.status)}`,children:s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:ae?e.jsxs(e.Fragment,{children:[M&&s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>R(s._id,"accepted"),disabled:G===s._id+"accepted",title:"Accept Appointment",children:e.jsx(nt,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>R(s._id,"rejected"),disabled:G===s._id+"rejected",title:"Reject Appointment",children:e.jsx(Ce,{})})]}),M&&s.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:ft,title:"Cancel Appointment (Seller)",children:e.jsx(T,{})}),M&&(s.status==="cancelledBySeller"||s.status==="cancelledByBuyer"||s.status==="cancelledByAdmin"||s.status==="rejected"||s.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:tt,title:"Remove from table",style:{opacity:.5},children:e.jsx(T,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),ye&&(s.status==="pending"||s.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:ft,title:"Cancel Appointment (Buyer)",children:e.jsx(T,{})}),ye&&(s.status==="cancelledByBuyer"||s.status==="cancelledBySeller"||s.status==="cancelledByAdmin"||s.status==="deletedByAdmin"||s.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:tt,title:"Remove from table",style:{opacity:.5},children:e.jsx(T,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),Xe&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Gt,title:"Cancel Appointment (Admin)",children:e.jsx(_t,{})}),(s.status==="cancelledByBuyer"&&ye||s.status==="cancelledBySeller"&&M)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>le(s),disabled:s.status==="cancelledByBuyer"&&ye&&(s.buyerReinitiationCount||0)>=2||s.status==="cancelledBySeller"&&M&&(s.sellerReinitiationCount||0)>=2||!s.buyerId||!s.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:ye&&s.status==="cancelledByBuyer"?`${2-(s.buyerReinitiationCount||0)} left`:M&&s.status==="cancelledBySeller"?`${2-(s.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:tt,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(T,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-3 shadow-lg mx-auto relative transform transition-all duration-200 group ${O?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50":"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white hover:shadow-xl hover:scale-105"}`,title:O?ae?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments":"Open Chat",onClick:O?void 0:()=>X(!0),disabled:O,children:[e.jsx(lt,{size:22,className:O?"":"group-hover:animate-pulse"}),!O&&e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"}),Z&&!O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!Z&&ve>0&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:ve}),!Z&&ve>0&&!O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:ve}),!Z&&ve===0&&Le&&!O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200",children:[O?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 min-h-96",children:[e.jsx(lt,{className:"text-6xl text-gray-400 mb-6"}),e.jsx("div",{className:"text-xl font-semibold text-gray-500 text-center",children:ae?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments"}),e.jsx("div",{className:"text-gray-400 text-center mt-2",children:ae?s.status==="pending"?"Chat will be enabled once the appointment is accepted":s.status==="rejected"?"This appointment has been rejected":"This appointment has been cancelled by admin":"This appointment has already passed"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 sm:gap-3 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-600 rounded-t-3xl relative",children:We&&I?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!I.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{var t;ge(I),(t=j.current)==null||t.focus(),Y(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!I.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Se(I.message),Y(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(ms,{size:18})}),I.senderEmail!==g.email&&!I.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Je(I),He(!0),Y(null)},title:"Report message","aria-label":"Report message",children:e.jsx(St,{size:18})}),I.senderEmail===g.email&&!I.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{qt(I),Y(null)},className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",title:"Edit comment","aria-label":"Edit comment",disabled:A!==null,children:e.jsx(us,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Pt(I),Y(null)},title:"Delete","aria-label":"Delete",children:e.jsx(T,{size:18})})]}),I.senderEmail!==g.email&&!I.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ut(I),Y(null)},title:"Delete locally","aria-label":"Delete locally",children:e.jsx(T,{size:18})}),I.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{te(I),K(!1),B(!0),Y(null)},title:"Delete from chat locally","aria-label":"Delete from chat locally",children:e.jsx(T,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>Y(null),title:"Close options","aria-label":"Close options",children:e.jsx(Ce,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1 sm:p-1.5 shadow-lg flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-200",onClick:()=>he(i),title:"Click to view user details",children:i!=null&&i.avatar?e.jsx("img",{src:i.avatar,alt:i.username||"User",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm",children:((i==null?void 0:i.username)||"U").charAt(0).toUpperCase()})}),e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 min-w-0 flex-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-white truncate cursor-pointer hover:underline",onClick:()=>he(i),title:"Click to view user details",children:(i==null?void 0:i.username)||"Unknown User"}),e.jsx("div",{className:"flex items-center gap-1 sm:hidden",children:Z?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):_e?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Offline"})}),e.jsx("div",{className:"hidden sm:flex items-center gap-1",children:Z?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):_e?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Offline"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 ml-auto flex-shrink-0",children:[De.length>0&&e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>be(!0),title:"Clear chat locally",children:"Clear Chat"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>a(!ce),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(xs,{className:"text-sm"})}),ce&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>X(!1),title:"Close","aria-label":"Close",children:e.jsx(Ce,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{ref:H,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[de&&De.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${Be?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:de})})}),o?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"Loading messages..."})]}):De.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(lt,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):De.map((t,l)=>{var y,k,ne,we,Ne,Nt,Ct;const r=t.senderEmail===g.email,u=A===t._id,d=new Date(t.timestamp),m=l>0?new Date(De[l-1].timestamp):null,f=m?d.toDateString()!==m.toDateString():!0;return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(hs.Fragment,{children:[f&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:rt(d)})}),e.jsx("div",{className:`flex w-full ${r?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*l}s`},children:e.jsxs("div",{ref:xe=>ue.current[t._id]=xe,"data-message-id":t._id,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[85%] sm:max-w-[70%] md:max-w-[60%] break-words overflow-hidden relative transform hover:scale-[1.02] transition-transform duration-200 min-h-[60px] min-w-[140px] ${r?"pr-24":"pr-20"} ${r?"bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-blue-200":"bg-white text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-gray-300"}`,style:{animationDelay:`${.03*l}s`},children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg w-full max-w-full break-words cursor-pointer transform hover:scale-[1.02] transition-transform duration-200",onClick:()=>{ue.current[t.replyTo]&&(ue.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),ue.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{ue.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),((k=(y=N.find(xe=>xe._id===t.replyTo))==null?void 0:y.message)==null?void 0:k.substring(0,30))||"Original message",((we=(ne=N.find(xe=>xe._id===t.replyTo))==null?void 0:ne.message)==null?void 0:we.length)>30?"...":""]})}),!r&&t.senderEmail!==((Ne=s.buyerId)==null?void 0:Ne.email)&&t.senderEmail!==((Nt=s.sellerId)==null?void 0:Nt.email)&&e.jsx("div",{className:"font-semibold mb-1 text-xs text-purple-600",children:"UrbanSetu"}),e.jsx("div",{className:"flex items-center gap-1 mb-6",children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(Re,{className:"inline-block text-lg"})," ",t.senderEmail===g.email?"You deleted this message":"This message was deleted."]}):e.jsx("div",{className:r?"text-base font-medium":"text-sm",children:u?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap",children:(t.message||"").replace(/\n+$/,"")}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:`absolute bottom-2 right-2 flex items-center gap-1 text-[10px] ${r?"text-blue-200":"text-gray-500"}`,children:[e.jsx("span",{children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{className:`${r?"hover:bg-white hover:bg-opacity-20":"hover:bg-gray-100"} ml-1 p-1 rounded-full transition-colors`,onClick:xe=>{xe.stopPropagation(),Y(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(gs,{size:r?14:12})}),t.senderEmail===g.email&&!t.deleted&&e.jsx("span",{className:"flex items-center gap-1 ml-1",children:(Ct=t.readBy)!=null&&Ct.includes(i==null?void 0:i._id)?e.jsx(kt,{className:"text-green-400 text-xs",title:"Read"}):t.status==="delivered"?e.jsx(kt,{className:"text-blue-200 text-xs",title:"Delivered"}):t.status==="sending"?e.jsx(nt,{className:"text-blue-200 text-xs animate-pulse",title:"Sending..."}):e.jsx(nt,{className:"text-blue-200 text-xs",title:"Sent"})})]})]})})]},t._id||l)}),e.jsx("div",{ref:S})]}),re&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(vt=re.message)==null?void 0:vt.substring(0,40),((wt=re.message)==null?void 0:wt.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>ge(null),title:"Cancel reply",children:e.jsx(Ce,{className:"w-3 h-3"})})]})}),A&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:L}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{F(null),Q(""),V("")},title:"Cancel edit",children:e.jsx(Ce,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-200 bg-white resize-y whitespace-pre-wrap",placeholder:A?"Edit your message...":"Type a message...",value:ie,onChange:t=>{V(t.target.value),A&&Q(t.target.value),A||p.emit("typing",{toUserId:i._id,fromUserId:g._id,appointmentId:s._id})},onKeyDown:t=>{const l=window.innerWidth>=768&&!("ontouchstart"in window||navigator.maxTouchPoints>0);t.key==="Enter"&&(l&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),A?et(A):Ze())},ref:j}),e.jsx("button",{onClick:A?()=>et(A):Ze,disabled:(A?fe===A:ke)||!ie.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:transform-none flex items-center gap-2 min-w-24",children:A?fe===A?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":ke?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(10px) scale(0.98); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                  }
                `})]}),!P&&!O&&!A&&!re&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:Zt,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:$>0?`${$} new message${$>1?"s":""}`:"Scroll to bottom","aria-label":$>0?`${$} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),$>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:$>99?"99+":$})]})})]})}),E&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Delete Message"]}),C!=null&&C.deleted?e.jsx("p",{className:"text-gray-600 mb-6",children:"Delete this message for me?"}):(C==null?void 0:C.senderEmail)===g.email?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:me,onChange:t=>K(t.target.checked),className:"form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Also delete for"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(i==null?void 0:i.username)||"other user"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-7",children:me?"The message will be permanently deleted for everyone":"The message will only be deleted for you"})]})]}):e.jsxs("p",{className:"text-gray-600 mb-6",children:["Delete message from"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(i==null?void 0:i.username)||"other user"}),"?"]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{B(!1),te(null),K(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Vt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),C!=null&&C.deleted?"Delete for me":(C==null?void 0:C.senderEmail)===g.email&&me?"Delete for everyone":"Delete for me"]})]})]})}),Oe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Clear Chat"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear chat? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>be(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Jt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Clear Chat"]})]})]})}),Dt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Delete Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for deletion (required):"}),e.jsx("textarea",{value:zt,onChange:t=>ht(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for deleting this appointment..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Rt(!1),Ge(null),ht("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmAdminDelete,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Delete Appointment"]})]})]})}),Tt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ot,{className:"text-blue-500"}),"Archive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Et(!1),Ge(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmArchive,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(ot,{size:12}),"Archive"]})]})]})}),Bt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(it,{className:"text-green-500"}),"Unarchive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Mt(!1),Ge(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmUnarchive,className:"px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(it,{size:12}),"Unarchive"]})]})]})}),Ft&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Re,{className:"text-orange-500"}),"Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for cancellation ",M?"(required)":"(optional)",":"]}),e.jsx("textarea",{value:pe,onChange:t=>se(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",rows:"3",placeholder:M?"Please provide a reason for cancelling...":"Optional reason for cancelling..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{qe(!1),se("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Yt,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2",children:[e.jsx(Re,{size:12}),"Cancel Appointment"]})]})]})}),Ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Re,{className:"text-red-500"}),"Admin Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment as admin?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for admin cancellation (required):"}),e.jsx("textarea",{value:pe,onChange:t=>se(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for admin cancellation..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ke(!1),se("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Wt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Re,{size:12}),"Cancel as Admin"]})]})]})}),$t&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Remove Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to permanently remove this appointment from your table? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>Ye(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Qt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Remove Permanently"]})]})]})}),It&&Ve&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(St,{className:"text-red-500"})," Report message"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsxs("select",{value:$e,onChange:t=>Pe(t.target.value),className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900",children:[e.jsx("option",{value:"",children:"-- Select a reason --"}),e.jsx("option",{value:"Spam or scam",children:"Spam or scam"}),e.jsx("option",{value:"Harassment or hate speech",children:"Harassment or hate speech"}),e.jsx("option",{value:"Inappropriate content",children:"Inappropriate content"}),e.jsx("option",{value:"Sensitive or personal data",children:"Sensitive or personal data"}),e.jsx("option",{value:"Fraud or illegal activity",children:"Fraud or illegal activity"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional details (optional)"}),e.jsx("textarea",{value:mt,onChange:t=>Ue(t.target.value),rows:4,placeholder:"Add any context to help admins review...",className:"w-full p-2 border border-gray-300 rounded resize-y focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900"})]}),e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Message excerpt:"}),e.jsx("div",{className:"line-clamp-4 whitespace-pre-wrap",children:(Ve.message||"").slice(0,300)})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{He(!1),Je(null),Pe(""),Ue("")},className:"px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(!$e){h.error("Please select a reason");return}xt(!0);try{const t=await fetch(`${D}/api/notifications/report-chat`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appointmentId:s._id,commentId:Ve._id,reason:$e,details:mt})}),l=await t.json();t.ok?(h.success("Reported to admins"),He(!1),Je(null),Pe(""),Ue("")):h.error(l.message||"Failed to submit report")}catch{h.error("Network error while reporting")}finally{xt(!1)}},disabled:ut||!$e,className:"px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50",children:ut?"Reportingâ€¦":"Report"})]})]})})]})}export{ps as default};
