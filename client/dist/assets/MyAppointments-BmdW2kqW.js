import{g as ls,r as a,u as is,v as y,j as e,P as ct,a4 as mt,a5 as os,G as ve,U as ds,a7 as cs,a6 as Tt,f as ms,a8 as us,a9 as xs,y as x,h as hs,L as gs,z as T,H as it,aa as ot,ab as fs,ah as It,C as bs,ac as ps,a1 as ys,E as Ae,ad as js,ae as Dt}from"./index-T5xbu-4v.js";const E="https://urbansetu.onrender.com";function Ns(){const{currentUser:s}=ls(n=>n.user),[h,R]=a.useState([]),[ut,W]=a.useState(!0),[me,ae]=a.useState(null),[H,xt]=a.useState(""),[Q,_e]=a.useState("all"),[we,re]=a.useState("all"),[ue,le]=a.useState(""),[K,N]=a.useState(!1),[j,Ne]=a.useState(null),[Y,_]=a.useState(""),[L,U]=a.useState(""),[X,xe]=a.useState(!1),[I,ie]=a.useState(null),[v,Z]=a.useState([]),[A,q]=a.useState(!1),V=is(),[Le,P]=a.useState(null);a.useEffect(()=>{const n=async()=>{if(!s){ae("Please sign in to view your appointments"),W(!1);return}try{W(!0),ae(null);const c=await fetch(`${E}/api/bookings/my`,{credentials:"include"});if(c.ok){const g=await c.json();R(g)}else throw new Error("Failed to fetch appointments")}catch{ae("Failed to load appointments. Please try again.")}finally{W(!1)}},i=async()=>{if(s&&(s.role==="admin"||s.role==="rootadmin"))try{const c=await fetch(`${E}/api/bookings/archived`,{credentials:"include"});if(!c.ok)throw new Error("Not allowed");const g=await c.json();Z(Array.isArray(g)?g:[])}catch{Z([]),x.error("Failed to fetch archived appointments")}else Z([])};n(),i()},[s]),a.useEffect(()=>{const n=i=>{R(c=>c.filter(g=>g._id!==i.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[s]),a.useEffect(()=>{s&&R(n=>n.map(i=>{const c={...i};return i.buyerId&&(i.buyerId._id===s._id||i.buyerId===s._id)&&(c.buyerId={...c.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),i.sellerId&&(i.sellerId._id===s._id||i.sellerId===s._id)&&(c.sellerId={...c.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),c}))},[s]),a.useEffect(()=>{function n(i){R(c=>c.map(g=>g._id===i.appointmentId?{...g,...i.updatedAppointment}:g))}return y.on("appointmentUpdate",n),()=>{y.off("appointmentUpdate",n)}},[]),a.useEffect(()=>{function n(c){const g=c.appointment;g.buyerId&&s&&(g.buyerId._id===s._id||g.buyerId===s._id)?g.role="buyer":g.sellerId&&s&&(g.sellerId._id===s._id||g.sellerId===s._id)&&(g.role="seller"),R(C=>[g,...C])}y.on("appointmentCreated",n);const i=c=>{R(g=>g.map(C=>{const S={...C};return C.buyerId&&(C.buyerId._id===c.userId||C.buyerId===c.userId)&&(S.buyerId={...S.buyerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),C.sellerId&&(C.sellerId._id===c.userId||C.sellerId===c.userId)&&(S.sellerId={...S.sellerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),S}))};return y.on("profileUpdated",i),()=>{y.off("appointmentCreated",n),y.off("profileUpdated",i)}},[s]),a.useEffect(()=>{if(!s)return;const n=setInterval(()=>{y.emit("userAppointmentsActive",{userId:s._id})},1e3);return()=>clearInterval(n)},[s]);const G=async(n,i)=>{le(n+i);try{const c=await fetch(`${E}/api/bookings/${n}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:i})}),g=await c.json();if(c.status===401){x.error("Session expired or unauthorized. Please sign in again."),V("/sign-in");return}if(c.ok){R(S=>S.map(M=>M._id===n?{...M,status:i}:M));const C=i==="accepted"?"accepted":"rejected";x.success(`Appointment ${C} successfully! ${i==="accepted"?"Contact information is now visible to both parties.":""}`,{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),V("/user/my-appointments")}else x.error(g.message||"Failed to update appointment status.")}catch{x.error("An error occurred. Please try again.")}le("")},oe=async n=>{setAppointmentToHandle(n),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},Ie=async n=>{setAppointmentToHandle(n),setShowArchiveModal(!0)},De=async n=>{setAppointmentToHandle(n),setShowUnarchiveModal(!0)},Ce=h.filter(n=>{var M,B,O,b,Me,ee,He,Ue,k,te;if(s._id===((B=(M=n.buyerId)==null?void 0:M._id)==null?void 0:B.toString())&&n.visibleToBuyer===!1||s._id===((b=(O=n.sellerId)==null?void 0:O._id)==null?void 0:b.toString())&&n.visibleToSeller===!1)return!1;const i=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(Q==="outdated")return i;const c=Q==="all"?!0:n.status===Q,g=we==="all"?!0:n.role===we,C=((Me=n.propertyName)==null?void 0:Me.toLowerCase().includes(H.toLowerCase()))||((ee=n.message)==null?void 0:ee.toLowerCase().includes(H.toLowerCase()))||((Ue=(He=n.buyerId)==null?void 0:He.username)==null?void 0:Ue.toLowerCase().includes(H.toLowerCase()))||((te=(k=n.sellerId)==null?void 0:k.username)==null?void 0:te.toLowerCase().includes(H.toLowerCase()));let S=!0;return Y&&(S=S&&new Date(n.date)>=new Date(Y)),L&&(S=S&&new Date(n.date)<=new Date(L)),c&&g&&C&&S}),Se=Array.isArray(v)?v.filter(n=>{var C,S,M,B,O,b;const i=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(Q==="outdated")return i;Q==="all"||n.status;const c=((C=n.propertyName)==null?void 0:C.toLowerCase().includes(H.toLowerCase()))||((S=n.message)==null?void 0:S.toLowerCase().includes(H.toLowerCase()))||((B=(M=n.buyerId)==null?void 0:M.username)==null?void 0:B.toLowerCase().includes(H.toLowerCase()))||((b=(O=n.sellerId)==null?void 0:O.username)==null?void 0:b.toLowerCase().includes(H.toLowerCase()));let g=!0;return Y&&(g=g&&new Date(n.date)>=new Date(Y)),L&&(g=g&&new Date(n.date)<=new Date(L)),c&&g}):[];function Re(n){ie({...n,date:n.date?new Date(n.date).toISOString().split("T")[0]:"",time:n.time||"",message:n.message||"",buyerReinitiationCount:n.buyerReinitiationCount||0,sellerReinitiationCount:n.sellerReinitiationCount||0}),xe(!0)}async function ze(n){var C,S;if(n.preventDefault(),!I)return;const i=s&&(((C=I.buyerId)==null?void 0:C._id)===s._id||I.buyerId===s._id);if(s&&(((S=I.sellerId)==null?void 0:S._id)===s._id||(I.sellerId,s._id)),(i?I.buyerReinitiationCount||0:I.sellerReinitiationCount||0)>=2){x.error("You have reached the maximum number of reinitiations for your role.");return}if(!I.buyerId||!I.sellerId){x.error("Cannot reinitiate: one of the parties no longer exists.");return}const g={...I,status:"pending"};try{const M=await fetch(`${E}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(g)}),B=await M.json();M.ok?(x.success("Appointment reinitiated successfully!",{autoClose:5e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),xe(!1),ie(null),V("/user/my-appointments"),R(O=>O.map(b=>b._id===B.appointment._id?{...b,...B.appointment}:b))):x.error(B.message||"Failed to reinitiate appointment.")}catch{x.error("An error occurred. Please try again.")}}const Te=(n,i)=>{R(c=>c.map(g=>g._id===n?{...g,status:i}:g))},Ee=async()=>{W(!0),ae(null);try{const n=await fetch(`${E}/api/bookings/my`,{credentials:"include"});if(n.ok){const i=await n.json();R(i)}else throw new Error("Failed to fetch appointments");if(s&&(s.role==="admin"||s.role==="rootadmin")){const i=await fetch(`${E}/api/bookings/archived`,{credentials:"include"});if(i.ok){const c=await i.json();Z(Array.isArray(c)?c:[])}}else Z([])}catch{ae("Failed to refresh appointments. Please try again.")}finally{W(!1)}},Be=n=>{if(console.log("Copy button clicked, message:",n),!n){x.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(n).then(()=>{x.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{Pe(n)}):Pe(n)},Pe=n=>{try{const i=document.createElement("textarea");i.value=n,i.style.position="fixed",i.style.left="-999999px",i.style.top="-999999px",document.body.appendChild(i),i.focus(),i.select();const c=document.execCommand("copy");document.body.removeChild(i),c?(console.log("Copy successful via fallback method"),x.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),x.error("Failed to copy message"))}catch(i){console.error("Fallback copy error:",i),x.error("Copy not supported")}};return ut?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):me?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:me})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:A?"Archived Appointments":"My Appointments"}),!A&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Monitor all appointments across the platform. Use the status filter to view appointments and interactive chatbox to connect with otherparty."})]}),e.jsx("button",{onClick:Ee,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),s&&(s.role==="admin"||s.role==="rootadmin")&&e.jsx("button",{onClick:()=>q(!A),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${A?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:A?e.jsxs(e.Fragment,{children:[e.jsx(ct,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(mt,{})," Archived Appointments (",v.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:Q,onChange:n=>_e(n.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:Y,onChange:n=>_(n.target.value),max:L||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:L,onChange:n=>U(n.target.value),min:Y||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:we,onChange:n=>re(n.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(os,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:H,onChange:n=>xt(n.target.value)})]})]}),A&&s&&(s.role==="admin"||s.role==="rootadmin")?Se.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Se.map(n=>e.jsx(Rt,{appt:n,currentUser:s,handleStatusUpdate:G,handleAdminDelete:oe,actionLoading:ue,onShowOtherParty:i=>{Ne(i),N(!0)},onOpenReinitiate:()=>Re(n),handleArchiveAppointment:Ie,handleUnarchiveAppointment:De,isArchived:!0,onCancelRefresh:Te,copyMessageToClipboard:Be},n._id))})]})}):Ce.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Ce.map(n=>e.jsx(Rt,{appt:n,currentUser:s,handleStatusUpdate:G,handleAdminDelete:oe,actionLoading:ue,onShowOtherParty:i=>{Ne(i),N(!0)},onOpenReinitiate:()=>Re(n),handleArchiveAppointment:Ie,handleUnarchiveAppointment:De,isArchived:!1,onCancelRefresh:Te,copyMessageToClipboard:Be},n._id))})]})}),K&&j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>N(!1),title:"Close","aria-label":"Close",children:e.jsx(ve,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ds,{user:{username:j.username,avatar:j.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(cs,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[j.username||"User",j.role==="admin"&&e.jsx(Tt,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:j.role||"User"})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(ms,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:j.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(us,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:j.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(xs,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:j.createdAt?new Date(j.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]})})]})}),X&&I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:ze,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:I.date,onChange:n=>ie(i=>({...i,date:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:I.time,onChange:n=>ie(i=>({...i,time:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:I.message,onChange:n=>ie(i=>({...i,message:n.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>xe(!1),children:"Cancel"})]})]})})]})})}function dt(s){const h=new Date,R=new Date;return R.setDate(h.getDate()-1),s.toDateString()===h.toDateString()?"Today":s.toDateString()===R.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function Rt({appt:s,currentUser:h,handleStatusUpdate:R,handleAdminDelete:ut,actionLoading:W,onShowOtherParty:me,onOpenReinitiate:ae,handleArchiveAppointment:H,handleUnarchiveAppointment:xt,isArchived:Q,onCancelRefresh:_e,copyMessageToClipboard:we}){var St,kt;const[re,ue]=a.useState(null),[le,K]=a.useState(""),[N,j]=a.useState(s.comments||[]),[Ne,Y]=a.useState(!1),[_,L]=a.useState(null),[U,X]=a.useState(""),[xe,I]=a.useState(null),ie=hs(),[v,Z]=a.useState(!1),A=a.useRef(null),q=a.useRef(null),[V,Le]=a.useState(!0),[P,G]=a.useState(0),[oe,Ie]=a.useState(""),[De,Ce]=a.useState(!1),[Se,Re]=a.useState(!1),[ze,Te]=a.useState(!1),[Ee,Be]=a.useState(null),[Pe,n]=a.useState(null),[i,c]=a.useState(!1),[g,C]=a.useState(!1),[S,M]=a.useState(!1),B=a.useRef(null),O=a.useRef(null),b=a.useRef(null),[Me,ee]=a.useState(!1),[He,Ue]=a.useState(null),[k,te]=a.useState(null),[Fe,he]=a.useState(!0),[Et,qe]=a.useState(!1),[Bt,Ve]=a.useState(!1),[Oe,Je]=a.useState(""),[ht,Ke]=a.useState(""),[Ye,Ge]=a.useState(null),[gt,ft]=a.useState(!1),[Mt,Ft]=a.useState(!1),[Ot,$t]=a.useState(!1),[Lt,zt]=a.useState(!1),[Pt,We]=a.useState(!1),[Ht,Qe]=a.useState(!1),[Ut,Xe]=a.useState(!1),[vs,Ze]=a.useState(null),[ge,se]=a.useState(""),[qt,bt]=a.useState(""),de=a.useRef({}),[$e,J]=a.useState(null);a.useEffect(()=>{if(g){const t=setTimeout(()=>{C(!1)},1e4);return()=>clearTimeout(t)}},[g]);function et(t){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${t}`))||[]}catch{return[]}}function Vt(t,r){const l=et(t);if(!l.includes(r)){const m=[...l,r];localStorage.setItem(`removedDeletedMsgs_${t}`,JSON.stringify(m))}}const tt=(h.role==="admin"||h.role==="rootadmin")&&h.adminApprovalStatus==="approved",Jt=ie.pathname.includes("/admin"),F=s.role==="seller",fe=s.role==="buyer",ne=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),z=!ne||s.status==="pending"||s.status==="rejected"||s.status==="cancelledByAdmin",pt=(tt||s.status==="accepted")&&ne,o=F?s.buyerId:s.sellerId,Kt=t=>{te(t),he(!0),ee(!0)},Yt=t=>{te(t),he(!1),ee(!0)},Gt=async()=>{var t;if(k){try{if(Fe){const r=!((t=k.readBy)!=null&&t.includes(h._id))&&k.senderEmail!==h.email,l=await fetch(`${E}/api/bookings/${s._id}/comment/${k._id}`,{method:"DELETE",credentials:"include"}),m=await l.json();l.ok?(j(d=>m.comments.map(u=>{const f=d.find(p=>p._id===u._id);return f&&f.status==="read"&&u.status!=="read"?{...u,status:"read"}:u})),r&&G(d=>Math.max(0,d-1)),x.success("Message deleted for everyone!")):x.error(m.message||"Failed to delete message.")}else j(r=>r.filter(l=>l._id!==k._id)),Vt(s._id,k._id),x.success("Message deleted for you!")}catch{x.error("An error occurred. Please try again.")}ee(!1),te(null),he(!0)}},Wt=()=>{localStorage.setItem(Nt,Date.now()),j([]),x.success("Chat Cleared"),qe(!1)},st=async()=>{if(!le.trim())return;const t=le.trim(),r=re,l=`temp-${Date.now()}`,m={_id:l,sender:h._id,senderEmail:h.email,senderName:h.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[h._id],...r?{replyTo:r._id}:{}};j(u=>[...u,m]),K(""),ue(null),Y(!0);const d=()=>{b.current&&(b.current.focus(),b.current.setSelectionRange(0,0),document.activeElement!==b.current&&(b.current.click(),b.current.focus()))};d(),requestAnimationFrame(d),setTimeout(d,10),A.current&&A.current.scrollIntoView({behavior:"smooth"});try{const u=await fetch(`${E}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...r?{replyTo:r._id}:{}})}),f=await u.json();if(u.ok){const p=f.comments[f.comments.length-1];j(w=>w.map($=>$._id===l?{...p}:$))}else{j(w=>w.filter($=>$._id!==l)),x.error(f.message||"Failed to send message.");const p=()=>{b.current&&(b.current.focus(),b.current.setSelectionRange(0,0),document.activeElement!==b.current&&(b.current.click(),b.current.focus()))};p(),requestAnimationFrame(p)}}catch{j(p=>p.filter(w=>w._id!==l)),x.error("An error occurred. Please try again.");const f=()=>{b.current&&(b.current.focus(),b.current.setSelectionRange(0,0),document.activeElement!==b.current&&(b.current.click(),b.current.focus()))};f(),requestAnimationFrame(f)}finally{Y(!1)}},nt=async t=>{if(!U.trim())return;I(t),j(l=>l.map(m=>m._id===t?{...m,message:U,edited:!0,editedAt:new Date}:m));try{const l=await fetch(`${E}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:U})}),m=await l.json();l.ok?(j(d=>d.map(u=>{const f=m.comments.find(p=>p._id===u._id);return f?f._id===t?f:u.status==="read"&&f.status!=="read"?{...f,status:"read"}:f:u})),L(null),X(""),K(""),x.success("Message edited successfully!")):(j(d=>d.map(u=>u._id===t?{...u,message:u.originalMessage||u.message,edited:u.wasEdited||!1}:u)),L(t),X(U),K(U),x.error(m.message||"Failed to edit message."))}catch{j(m=>m.map(d=>d._id===t?{...d,message:d.originalMessage||d.message,edited:d.wasEdited||!1}:d)),L(t),X(U),K(U),x.error("An error occurred. Please try again.")}finally{I(null)}},Qt=t=>{L(t._id),X(t.message),K(t.message),j(r=>r.map(l=>l._id===t._id?{...l,originalMessage:l.message,wasEdited:l.edited}:l)),setTimeout(()=>{b.current&&(b.current.focus(),b.current.select())},100)},Xt=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},yt=async()=>{se(""),We(!0)},Zt=async()=>{if(F&&!ge.trim()){x.error("Reason is required for seller cancellation.");return}try{const t=await fetch(`${E}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:ge})}),r=await t.json();if(t.status===401){x.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(x.success("Appointment cancelled successfully."),typeof _e=="function"&&_e(s._id,F?"cancelledBySeller":"cancelledByBuyer")):x.error(r.message||"Failed to cancel appointment."),We(!1),se("")}catch{x.error("An error occurred. Please try again.")}},es=async()=>{se(""),Qe(!0)},ts=async()=>{if(!ge.trim()){x.error("Reason is required for admin cancellation.");return}try{const t=await fetch(`${E}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:ge})}),r=await t.json();if(t.status===401){x.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(x.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):x.error(r.message||"Failed to cancel appointment."),Qe(!1),se("")}catch{x.error("An error occurred. Please try again.")}},at=async()=>{Xe(!0)},ss=async()=>{try{const t=fe?"buyer":F?"seller":null;if(!t)return;if((await fetch(`${E}/api/bookings/${s._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:t})})).ok){if(typeof window<"u"){const l=new CustomEvent("removeAppointmentRow",{detail:s._id});window.dispatchEvent(l),x.success("Appointment removed from your table successfully")}}else x.error("Failed to remove appointment from table.");Xe(!1)}catch{x.error("An error occurred. Please try again.")}};a.useEffect(()=>{v&&A.current&&A.current.scrollIntoView({behavior:"smooth"})},[v]);const rt=a.useRef(!1),be=a.useCallback(async()=>{if(!q.current||rt.current)return;const{scrollTop:t,scrollHeight:r,clientHeight:l}=q.current;if(!(r-t-l<10))return;const d=N.filter(u=>{var f;return!((f=u.readBy)!=null&&f.includes(h._id))&&u.senderEmail!==h.email});if(d.length>0){rt.current=!0;try{(await fetch(`${E}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(j(f=>f.map(p=>d.some(w=>w._id===p._id)?{...p,readBy:[...p.readBy||[],h._id],status:"read"}:p)),d.forEach(f=>{y.emit("messageRead",{appointmentId:s._id,messageId:f._id,userId:h._id,readBy:h._id})}),console.log(`Marked ${d.length} messages as read for user ${h._id}`))}catch(u){console.error("Error marking messages as read:",u)}finally{rt.current=!1}}},[N,h._id,s._id,y]),jt=a.useRef(N.length),ns=a.useRef(N);a.useEffect(()=>{const t=N.slice(jt.current),r=t.length;if(jt.current=N.length,ns.current=N,r>0&&v){const l=t.some(d=>d.senderEmail===h.email),m=t.filter(d=>d.senderEmail!==h.email);l||V?setTimeout(()=>{A.current&&(A.current.scrollIntoView({behavior:"smooth"}),V&&m.length>0&&setTimeout(()=>{be()},300))},100):m.length>0&&G(d=>d+m.length)}},[N.length,V,v,h.email,be]);const vt=a.useCallback(()=>{if(q.current){const{scrollTop:t,scrollHeight:r,clientHeight:l}=q.current,m=r-t-l<10;if(Le(m),m){const d=N.filter(u=>{var f;return!((f=u.readBy)!=null&&f.includes(h._id))&&u.senderEmail!==h.email}).length;d>0&&(console.log(`User manually scrolled to bottom, marking ${d} messages as read`),be()),P>0&&G(0)}}},[P,be,N,h._id]),lt=a.useCallback(()=>{if(!q.current||N.length===0)return;const t=`chatClearTime_${s._id}`,r=Number(localStorage.getItem(t))||0,l=et(s._id),m=N.filter(w=>new Date(w.timestamp).getTime()>r&&!l.includes(w._id));if(m.length===0)return;const u=q.current.getBoundingClientRect(),f=u.top+60;let p="";for(let w=0;w<m.length;w++){const $=de.current[m[w]._id];if($){const ye=$.getBoundingClientRect();if(ye.top>=f&&ye.bottom<=u.bottom){const je=new Date(m[w].timestamp);p=dt(je);break}}}if(!p)for(let w=0;w<m.length;w++){const $=de.current[m[w]._id];if($&&$.getBoundingClientRect().bottom>f){const je=new Date(m[w].timestamp);p=dt(je);break}}p&&p!==oe&&Ie(p)},[N,oe,s._id]);a.useEffect(()=>{const t=q.current;if(t&&v){const r=()=>{vt(),lt(),Ce(!0),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{Ce(!1)},1e3)};if(t.addEventListener("scroll",r),t){const{scrollTop:l,scrollHeight:m,clientHeight:d}=t,u=m-l-d<10;Le(u)}return setTimeout(lt,100),()=>{t.removeEventListener("scroll",r),O.current&&clearTimeout(O.current)}}},[v,vt,lt]),a.useEffect(()=>{v&&A.current&&A.current.scrollIntoView({behavior:"smooth"})},[v]);const as=a.useCallback(()=>{A.current&&(A.current.scrollIntoView({behavior:"smooth"}),G(0),setTimeout(()=>{be()},500))},[be]);a.useEffect(()=>{function t(r){var l,m;if(r.appointmentId===s._id&&!v){if(r.comment.deleted)return;const d=r.comment.senderEmail===((l=s.buyerId)==null?void 0:l.email),u=r.comment.senderEmail===((m=s.sellerId)==null?void 0:m.email),p=!d&&!u?"UrbanSetu":r.comment.senderEmail||"User";x.info(`New message from ${p}`)}}return y.on("commentUpdate",t),()=>{y.off("commentUpdate",t)}},[s._id,v]),a.useEffect(()=>{function t(r){r.appointmentId===s._id&&(j(l=>{const m=l.findIndex(d=>d._id===r.comment._id);if(m!==-1){const d=[...l],u=l[m],f=r.comment;let p=f.status;return u.status==="read"&&f.status!=="read"&&(p="read"),d[m]={...f,status:p},d}else return!l.some(u=>u._id.toString().startsWith("temp-"))||r.comment.senderEmail!==h.email?[...l,r.comment]:l}),r.comment.deleted&&r.comment.senderEmail!==h.email&&pe>0&&G(l=>Math.max(0,l-1)),v&&r.comment.senderEmail!==h.email&&(setTimeout(async()=>{try{const l=await fetch(`${E}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"});l.ok||console.warn("Failed to mark comments as read:",l.status)}catch(l){console.warn("Error marking comments as read:",l)}},100),setTimeout(()=>{A.current&&V&&A.current.scrollIntoView({behavior:"smooth"})},50)))}return y.on("commentUpdate",t),()=>{y.off("commentUpdate",t)}},[s._id,j,v,h.email,V]),a.useEffect(()=>{v&&fetch(`${E}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"}).catch(t=>{console.warn("Error marking comments as read on modal open:",t)})},[v,s._id]),a.useEffect(()=>{function t(l){l.appointmentId===s._id&&j(m=>m.map(d=>d._id===l.commentId?{...d,status:d.status==="read"?"read":"delivered"}:d))}function r(l){l.appointmentId===s._id&&j(m=>m.map(d=>{var u;return(u=d.readBy)!=null&&u.includes(l.userId)?d:{...d,status:"read",readBy:[...d.readBy||[],l.userId]}}))}return y.on("commentDelivered",t),y.on("commentRead",r),()=>{y.off("commentDelivered",t),y.off("commentRead",r)}},[s._id,j]);const wt=et(s._id),pe=N.filter(t=>{var r;return!((r=t.readBy)!=null&&r.includes(h._id))&&t.senderEmail!==h.email&&!wt.includes(t._id)}).length;a.useEffect(()=>(v?document.body.style.overflow="hidden":(document.body.style.overflow="",G(0)),()=>{document.body.style.overflow=""}),[v]);const Nt=`chatClearTime_${s._id}`,rs=Number(localStorage.getItem(Nt))||0,ke=N.filter(t=>new Date(t.timestamp).getTime()>rs&&!wt.includes(t._id));a.useEffect(()=>{if(!v||!(o!=null&&o._id))return;y.emit("checkUserOnline",{userId:o._id});function t(r){r.userId===o._id&&(Re(!!r.online),Be(r.lastSeen||null))}return y.on("userOnlineStatus",t),y.on("userOnlineUpdate",t),()=>{y.off("userOnlineStatus",t),y.off("userOnlineUpdate",t)}},[v,o==null?void 0:o._id]),a.useEffect(()=>{if(!(o!=null&&o._id))return;y.emit("checkUserOnline",{userId:o._id});function t(r){r.userId===o._id&&(Te(!!r.online),n(r.lastSeen||null))}return y.on("userOnlineStatus",t),y.on("userOnlineUpdate",t),()=>{y.off("userOnlineStatus",t),y.off("userOnlineUpdate",t)}},[o==null?void 0:o._id]),a.useEffect(()=>{function t(r){r.fromUserId===(o==null?void 0:o._id)&&r.appointmentId===s._id&&(c(!0),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>c(!1),1e3))}return y.on("typing",t),()=>{y.off("typing",t),B.current&&clearTimeout(B.current)}},[o==null?void 0:o._id,s._id]),a.useEffect(()=>{if(!v)return;const t=r=>{var l;r.ctrlKey&&r.key==="f"&&(r.preventDefault(),(l=b.current)==null||l.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[v]);function Ct(t){if(!t)return null;const r=new Date(t),l=new Date,m=Math.floor((l-r)/(1e3*60)),d=Math.floor(m/60),u=Math.floor(d/24);return m<1?"last seen just now":m<60?`last seen ${m} minute${m>1?"s":""} ago`:d<24?`last seen ${d} hour${d>1?"s":""} ago`:u<7?`last seen ${u} day${u>1?"s":""} ago`:`last seen ${r.toLocaleDateString("en-US",{month:"short",day:"numeric",year:r.getFullYear()!==l.getFullYear()?"numeric":void 0})}`}const D=$e?N.find(t=>t._id===$e):null;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${ne?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!ne&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(gs,{to:Jt?`/admin/listing/${s.listingId._id}`:`/user/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${F?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:F?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[pt?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>me(o),title:"Click to view details",children:(o==null?void 0:o.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(o==null?void 0:o.username)||"Unknown"}),pt?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:o==null?void 0:o.email}),e.jsx("div",{className:"text-sm text-gray-600",children:o!=null&&o.mobileNumber&&(o==null?void 0:o.mobileNumber)!==""?o.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:tt?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Xt(s.status)}`,children:s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:ne?e.jsxs(e.Fragment,{children:[F&&s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>R(s._id,"accepted"),disabled:W===s._id+"accepted",title:"Accept Appointment",children:e.jsx(it,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>R(s._id,"rejected"),disabled:W===s._id+"rejected",title:"Reject Appointment",children:e.jsx(ve,{})})]}),F&&s.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:yt,title:"Cancel Appointment (Seller)",children:e.jsx(T,{})}),F&&(s.status==="cancelledBySeller"||s.status==="cancelledByBuyer"||s.status==="cancelledByAdmin"||s.status==="rejected"||s.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:at,title:"Remove from table",style:{opacity:.5},children:e.jsx(T,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),fe&&(s.status==="pending"||s.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:yt,title:"Cancel Appointment (Buyer)",children:e.jsx(T,{})}),fe&&(s.status==="cancelledByBuyer"||s.status==="cancelledBySeller"||s.status==="cancelledByAdmin"||s.status==="deletedByAdmin"||s.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:at,title:"Remove from table",style:{opacity:.5},children:e.jsx(T,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),tt&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:es,title:"Cancel Appointment (Admin)",children:e.jsx(Tt,{})}),(s.status==="cancelledByBuyer"&&fe||s.status==="cancelledBySeller"&&F)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>ae(s),disabled:s.status==="cancelledByBuyer"&&fe&&(s.buyerReinitiationCount||0)>=2||s.status==="cancelledBySeller"&&F&&(s.sellerReinitiationCount||0)>=2||!s.buyerId||!s.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:fe&&s.status==="cancelledByBuyer"?`${2-(s.buyerReinitiationCount||0)} left`:F&&s.status==="cancelledBySeller"?`${2-(s.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:at,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(T,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-3 shadow-lg mx-auto relative transform transition-all duration-200 group ${z?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50":"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white hover:shadow-xl hover:scale-105"}`,title:z?ne?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments":"Open Chat",onClick:z?void 0:()=>Z(!0),disabled:z,children:[e.jsx(ot,{size:22,className:z?"":"group-hover:animate-pulse"}),!z&&e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"}),i&&!z&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!i&&pe>0&&z&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:pe}),!i&&pe>0&&!z&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:pe}),!i&&pe===0&&ze&&!z&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200",children:[z?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 min-h-96",children:[e.jsx(ot,{className:"text-6xl text-gray-400 mb-6"}),e.jsx("div",{className:"text-xl font-semibold text-gray-500 text-center",children:ne?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments"}),e.jsx("div",{className:"text-gray-400 text-center mt-2",children:ne?s.status==="pending"?"Chat will be enabled once the appointment is accepted":s.status==="rejected"?"This appointment has been rejected":"This appointment has been cancelled by admin":"This appointment has already passed"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 sm:gap-3 px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-600 rounded-t-3xl relative",children:$e&&D?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!D.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{var t;ue(D),(t=b.current)==null||t.focus(),J(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!D.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{we(D.message),J(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(fs,{size:18})}),D.senderEmail!==h.email&&!D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ge(D),Ve(!0),J(null)},title:"Report message","aria-label":"Report message",children:e.jsx(It,{size:18})}),D.senderEmail===h.email&&!D.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{Qt(D),J(null)},className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",title:"Edit comment","aria-label":"Edit comment",disabled:_!==null,children:e.jsx(bs,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Kt(D),J(null)},title:"Delete","aria-label":"Delete",children:e.jsx(T,{size:18})})]}),D.senderEmail!==h.email&&!D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Yt(D),J(null)},title:"Delete locally","aria-label":"Delete locally",children:e.jsx(T,{size:18})}),D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{te(D),he(!1),ee(!0),J(null)},title:"Delete from chat locally","aria-label":"Delete from chat locally",children:e.jsx(T,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>J(null),title:"Close options","aria-label":"Close options",children:e.jsx(ve,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1 sm:p-1.5 shadow-lg flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-200",onClick:()=>me(o),title:"Click to view user details",children:o!=null&&o.avatar?e.jsx("img",{src:o.avatar,alt:o.username||"User",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm",children:((o==null?void 0:o.username)||"U").charAt(0).toUpperCase()})}),e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 min-w-0 flex-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[e.jsx("h3",{className:"text-base sm:text-lg font-bold text-white truncate cursor-pointer hover:underline",onClick:()=>me(o),title:"Click to view user details",children:(o==null?void 0:o.username)||"Unknown User"}),e.jsx("div",{className:"flex items-center gap-1 sm:hidden",children:i?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):Se?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:Ct(Ee)||"Offline"})}),e.jsx("div",{className:"hidden sm:flex items-center gap-1",children:i?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):Se?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:Ct(Ee)||"Offline"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 ml-auto flex-shrink-0",children:[ke.length>0&&e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>qe(!0),title:"Clear chat locally",children:"Clear Chat"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>C(!g),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(ps,{className:"text-sm"})}),g&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>Z(!1),title:"Close","aria-label":"Close",children:e.jsx(ve,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{ref:q,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[oe&&ke.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${De?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:oe})})}),S?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"Loading messages..."})]}):ke.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(ot,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):ke.map((t,r)=>{var p,w,$,ye,je,At,_t;const l=t.senderEmail===h.email,m=_===t._id,d=new Date(t.timestamp),u=r>0?new Date(ke[r-1].timestamp):null,f=u?d.toDateString()!==u.toDateString():!0;return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(ys.Fragment,{children:[f&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:dt(d)})}),e.jsx("div",{className:`flex w-full ${l?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*r}s`},children:e.jsxs("div",{ref:ce=>de.current[t._id]=ce,"data-message-id":t._id,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] break-all overflow-hidden relative transition-all duration-200 min-h-[60px] ${l?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300":"bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300"}`,style:{animationDelay:`${.03*r}s`},children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{de.current[t.replyTo]&&(de.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),de.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{de.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),((w=(p=N.find(ce=>ce._id===t.replyTo))==null?void 0:p.message)==null?void 0:w.substring(0,30))||"Original message",((ye=($=N.find(ce=>ce._id===t.replyTo))==null?void 0:$.message)==null?void 0:ye.length)>30?"...":""]})}),!l&&t.senderEmail!==((je=s.buyerId)==null?void 0:je.email)&&t.senderEmail!==((At=s.sellerId)==null?void 0:At.email)&&e.jsx("div",{className:"font-semibold mb-1 text-xs text-purple-600",children:"UrbanSetu"}),e.jsx("div",{className:`text-left ${l?"text-base font-medium":"text-sm"}`,children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(Ae,{className:"inline-block text-lg"})," ",t.senderEmail===h.email?"You deleted this message":"This message was deleted."]}):e.jsx("div",{children:m?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap",children:(t.message||"").replace(/\n+$/,"")}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[e.jsx("span",{className:`${l?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),!t.deleted&&e.jsx("button",{className:`${t.senderEmail===h.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:ce=>{ce.stopPropagation(),J(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(js,{size:12})}),t.senderEmail===h.email&&!t.deleted&&e.jsx("span",{className:"flex items-center gap-1 ml-1",children:(_t=t.readBy)!=null&&_t.includes(o==null?void 0:o._id)?e.jsx(Dt,{className:"text-green-400 text-xs",title:"Read"}):t.status==="delivered"?e.jsx(Dt,{className:"text-blue-200 text-xs",title:"Delivered"}):t.status==="sending"?e.jsx(it,{className:"text-blue-200 text-xs animate-pulse",title:"Sending..."}):e.jsx(it,{className:"text-blue-200 text-xs",title:"Sent"})})]})]})})]},t._id||r)}),e.jsx("div",{ref:A})]}),re&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(St=re.message)==null?void 0:St.substring(0,40),((kt=re.message)==null?void 0:kt.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>ue(null),title:"Cancel reply",children:e.jsx(ve,{className:"w-3 h-3"})})]})}),_&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:U}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{L(null),X(""),K("")},title:"Cancel edit",children:e.jsx(ve,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-200 bg-white resize-y whitespace-pre-wrap",placeholder:_?"Edit your message...":"Type a message...",value:le,onChange:t=>{K(t.target.value),_&&X(t.target.value),_||y.emit("typing",{toUserId:o._id,fromUserId:h._id,appointmentId:s._id})},onClick:()=>{$e&&(J(null),x.info("You can hit reply icon in header to reply"))},onKeyDown:t=>{const r=window.innerWidth>=768&&!("ontouchstart"in window||navigator.maxTouchPoints>0);t.key==="Enter"&&(r&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),_?nt(_):st())},ref:b}),e.jsx("button",{onClick:t=>{t.preventDefault(),_?nt(_):st()},disabled:(_?xe===_:Ne)||!le.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:transform-none flex items-center gap-2 min-w-24",children:_?xe===_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":Ne?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(10px) scale(0.98); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                  }
                `})]}),!V&&!z&&!_&&!re&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:as,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:P>0?`${P} new message${P>1?"s":""}`:"Scroll to bottom","aria-label":P>0?`${P} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),P>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:P>99?"99+":P})]})})]})}),Me&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Delete Message"]}),k!=null&&k.deleted?e.jsx("p",{className:"text-gray-600 mb-6",children:"Delete this message for me?"}):(k==null?void 0:k.senderEmail)===h.email?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Fe,onChange:t=>he(t.target.checked),className:"form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Also delete for"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(o==null?void 0:o.username)||"other user"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-7",children:Fe?"The message will be permanently deleted for everyone":"The message will only be deleted for you"})]})]}):e.jsxs("p",{className:"text-gray-600 mb-6",children:["Delete message from"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(o==null?void 0:o.username)||"other user"}),"?"]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ee(!1),te(null),he(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Gt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),k!=null&&k.deleted?"Delete for me":(k==null?void 0:k.senderEmail)===h.email&&Fe?"Delete for everyone":"Delete for me"]})]})]})}),Et&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Clear Chat"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear chat? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>qe(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Wt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Clear Chat"]})]})]})}),Mt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Delete Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for deletion (required):"}),e.jsx("textarea",{value:qt,onChange:t=>bt(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for deleting this appointment..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ft(!1),Ze(null),bt("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmAdminDelete,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Delete Appointment"]})]})]})}),Ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(mt,{className:"text-blue-500"}),"Archive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{$t(!1),Ze(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmArchive,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(mt,{size:12}),"Archive"]})]})]})}),Lt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ct,{className:"text-green-500"}),"Unarchive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{zt(!1),Ze(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmUnarchive,className:"px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ct,{size:12}),"Unarchive"]})]})]})}),Pt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Ae,{className:"text-orange-500"}),"Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for cancellation ",F?"(required)":"(optional)",":"]}),e.jsx("textarea",{value:ge,onChange:t=>se(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",rows:"3",placeholder:F?"Please provide a reason for cancelling...":"Optional reason for cancelling..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{We(!1),se("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Zt,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2",children:[e.jsx(Ae,{size:12}),"Cancel Appointment"]})]})]})}),Ht&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(Ae,{className:"text-red-500"}),"Admin Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment as admin?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for admin cancellation (required):"}),e.jsx("textarea",{value:ge,onChange:t=>se(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for admin cancellation..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Qe(!1),se("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:ts,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Ae,{size:12}),"Cancel as Admin"]})]})]})}),Ut&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(T,{className:"text-red-500"}),"Remove Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to permanently remove this appointment from your table? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>Xe(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:ss,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(T,{size:12}),"Remove Permanently"]})]})]})}),Bt&&Ye&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(It,{className:"text-red-500"})," Report message"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsxs("select",{value:Oe,onChange:t=>Je(t.target.value),className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900",children:[e.jsx("option",{value:"",children:"-- Select a reason --"}),e.jsx("option",{value:"Spam or scam",children:"Spam or scam"}),e.jsx("option",{value:"Harassment or hate speech",children:"Harassment or hate speech"}),e.jsx("option",{value:"Inappropriate content",children:"Inappropriate content"}),e.jsx("option",{value:"Sensitive or personal data",children:"Sensitive or personal data"}),e.jsx("option",{value:"Fraud or illegal activity",children:"Fraud or illegal activity"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional details (optional)"}),e.jsx("textarea",{value:ht,onChange:t=>Ke(t.target.value),rows:4,placeholder:"Add any context to help admins review...",className:"w-full p-2 border border-gray-300 rounded resize-y focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900"})]}),e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Message excerpt:"}),e.jsx("div",{className:"line-clamp-4 whitespace-pre-wrap",children:(Ye.message||"").slice(0,300)})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{Ve(!1),Ge(null),Je(""),Ke("")},className:"px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(!Oe){x.error("Please select a reason");return}ft(!0);try{const t=await fetch(`${E}/api/notifications/report-chat`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appointmentId:s._id,commentId:Ye._id,reason:Oe,details:ht})}),r=await t.json();t.ok?(x.info("Thank you for reporting."),Ve(!1),Ge(null),Je(""),Ke("")):x.error(r.message||"Failed to submit report")}catch{x.error("Network error while reporting")}finally{ft(!1)}},disabled:gt||!Oe,className:"px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50",children:gt?"Reportingâ€¦":"Report"})]})]})})]})}export{Ns as default};
