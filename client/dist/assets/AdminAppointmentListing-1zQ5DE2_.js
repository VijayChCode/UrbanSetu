import{g as H,h as K,u as M,r as n,j as e,y as l}from"./index-CTi7rXfY.js";const g="https://urbansetu.onrender.com";function X(){const{currentUser:i}=H(t=>t.user),I=K(),x=M(),c=new URLSearchParams(I.search),a=c.get("listingId"),L=c.get("propertyName"),A=c.get("propertyDescription"),p=c.get("listingType"),[s,B]=n.useState({date:"",time:"",message:"",purpose:"",propertyName:L||"",propertyDescription:A||""}),[P,T]=n.useState(!1),[h,f]=n.useState(!1),[y,w]=n.useState(null),[U,v]=n.useState(!0),[j,_]=n.useState([]),[q,N]=n.useState([]),[R,b]=n.useState(!1),[d,S]=n.useState(""),[k,C]=n.useState(""),u=t=>{B(r=>({...r,[t.target.name]:t.target.value}))},$=async t=>{if(t.preventDefault(),!i){l.error("Please sign in as admin to book an appointment."),x("/admin/profile");return}if(!s.date||!s.time||!s.message||!s.purpose||!s.propertyName||!s.propertyDescription){l.error("Please fill out all fields before booking the appointment.");return}if(!a){l.error("Listing information is missing. Please try again.");return}f(!0);try{const r=k||i._id,m=await fetch(`${g}/api/bookings/user/${r}`,{credentials:"include"});let D=!1;if(m.ok){const Y=await m.json(),G=["pending","accepted"];D=!!Y.find(o=>!o.listingId||o.listingId._id!==a&&o.listingId!==a||new Date(o.date)<new Date||new Date(o.date).toDateString()===new Date().toDateString()&&o.time&&o.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})?!1:!!(o.buyerId&&(o.buyerId._id===r||o.buyerId===r)&&(G.includes(o.status)||o.status==="cancelledByBuyer"&&(o.buyerReinitiationCount||0)<2)))}if(D){l.error("This user already has an active appointment for this property or can still reinitiate. Booking Failed."),f(!1);return}let F={...s,listingId:a,buyerEmail:d||i.email,buyerId:k||i._id};const E=await fetch(`${g}/api/bookings/admin`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(F)}),J=await E.json();E.ok?(T(!0),l.success(`Property booked successfully on behalf of ${d||i.email}. Both seller and buyer are notified.`),setTimeout(()=>{x("/admin/appointments")},2e3)):l.error(J.message||"Failed to book appointment.")}catch(r){console.error("Error booking appointment:",r),l.error("An error occurred. Please try again.")}finally{f(!1)}};n.useEffect(()=>{(async()=>{if(a){v(!0);try{const m=await(await fetch(`${g}/api/listing/get/${a}`)).json();w(m)}catch{w(null)}finally{v(!1)}}})()},[a]),n.useEffect(()=>{O()},[]);const O=async()=>{try{const t=await fetch(`${g}/api/user/all-users-autocomplete`,{credentials:"include"});if(t.ok){const r=await t.json();_(r)}}catch{}};n.useEffect(()=>{if(d.trim()){const t=j.filter(r=>r.email.toLowerCase().includes(d.toLowerCase()));N(t),b(t.length>0)}else N([]),b(!1)},[d,j]);const z=t=>{S(t.email),C(t._id),b(!1)};return i?U?e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-blue-600 text-xl font-semibold py-10",children:"Loading property information..."})})}):y&&i&&i._id===y.userRef?e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-red-600 text-xl font-semibold py-10",children:"You cannot book an appointment for your own property."})})}):e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsxs("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 mb-6 text-center drop-shadow",children:"Book Appointment (Admin)"}),P?e.jsxs("div",{className:"text-center text-green-600 text-xl font-semibold py-10",children:["Appointment booked successfully!",e.jsx("br",{}),"The property owner will review your request.",e.jsx("br",{}),"Redirecting to admin appointments..."]}):e.jsxs("form",{onSubmit:$,className:"space-y-6",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"font-bold text-base",children:"User Assignment"}),e.jsx("div",{className:"text-sm font-semibold",children:"Assign to (User Email - optional)"}),e.jsx("div",{className:"text-xs text-gray-600",children:"Enter user email to assign booking (leave empty for admin booking)"}),e.jsx("div",{className:"text-xs text-blue-500 mt-1",children:"ðŸ’¡ Tip: Start typing to see email suggestions. If left empty, the booking will be owned by the admin."})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block font-semibold mb-1",children:"User Email (optional)"}),e.jsx("input",{type:"email",name:"buyerEmail",value:d,onChange:t=>{S(t.target.value),C("")},className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",autoComplete:"off",placeholder:"Type to search users by email..."}),R&&e.jsx("div",{className:"absolute z-10 bg-white border rounded w-full max-h-40 overflow-y-auto shadow",children:q.map(t=>e.jsxs("div",{className:"px-3 py-2 hover:bg-blue-100 cursor-pointer",onClick:()=>z(t),children:[t.email," (",t.username,")"]},t._id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("input",{type:"date",name:"date",value:s.date,onChange:u,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0}),e.jsx("input",{type:"time",name:"time",value:s.time,onChange:u,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("select",{name:"purpose",value:s.purpose,onChange:u,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select Purpose"}),p==="rent"&&e.jsx("option",{value:"rent",children:"Rent"}),(p==="sale"||p==="buy")&&e.jsx("option",{value:"buy",children:"Buy"})]})}),e.jsx("input",{type:"text",name:"propertyName",value:s.propertyName,onChange:u,placeholder:"Property Name",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("textarea",{name:"propertyDescription",value:s.propertyDescription,onChange:u,placeholder:"Property Description",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"2",required:!0}),e.jsx("textarea",{name:"message",value:s.message,onChange:u,placeholder:"Tell us about your requirements...",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"4",required:!0}),e.jsx("div",{className:"flex justify-center mt-6",children:e.jsx("button",{type:"submit",disabled:h,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 px-8 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed",children:h?"Booking...":"Book Appointment"})})]})]})}):e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-red-600 text-xl font-semibold py-10",children:"Please sign in as admin to book an appointment."})})})}export{X as default};
