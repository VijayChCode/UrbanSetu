import{g as $s,r as l,u as Os,x as v,j as e,P as kt,a4 as At,a5 as Ls,H as Re,U as zs,ak as Zt,a6 as ls,f as Ps,a8 as Hs,a9 as Us,y as g,h as qs,L as Ys,A as B,t as Ze,aa as Nt,ab as Js,ac as es,al as ts,D as Ct,ad as ss,ae as Ks,af as Vs,a1 as Gs,G as ze,ag as as,ah as Ws}from"./index-DXO7rKz0.js";const E="https://urbansetu.onrender.com";function Zs(){const{currentUser:s}=$s(n=>n.user),[c,$]=l.useState([]),[_t,ae]=l.useState(!0),[ve,me]=l.useState(null),[Q,It]=l.useState(""),[ne,Pe]=l.useState("all"),[Ee,ue]=l.useState("all"),[we,xe]=l.useState(""),[G,w]=l.useState(!1),[b,et]=l.useState(null),[he,T]=l.useState(""),[q,X]=l.useState(""),[Z,je]=l.useState(!1),[M,fe]=l.useState(null),[j,le]=l.useState([]),[O,ee]=l.useState(!1),P=Os(),[tt,C]=l.useState(null);l.useEffect(()=>{const n=async()=>{if(!s){me("Please sign in to view your appointments"),ae(!1);return}try{ae(!0),me(null);const x=await fetch(`${E}/api/bookings/my`,{credentials:"include"});if(x.ok){const h=await x.json();$(h)}else throw new Error("Failed to fetch appointments")}catch{me("Failed to load appointments. Please try again.")}finally{ae(!1)}},o=async()=>{if(s&&(s.role==="admin"||s.role==="rootadmin"))try{const x=await fetch(`${E}/api/bookings/archived`,{credentials:"include"});if(!x.ok)throw new Error("Not allowed");const h=await x.json();le(Array.isArray(h)?h:[])}catch{le([]),g.error("Failed to fetch archived appointments")}else le([])};n(),o()},[s]),l.useEffect(()=>{const n=o=>{$(x=>x.filter(h=>h._id!==o.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[s]),l.useEffect(()=>(G?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[G]),l.useEffect(()=>(Z?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[Z]),l.useEffect(()=>{s&&$(n=>n.map(o=>{const x={...o};return o.buyerId&&(o.buyerId._id===s._id||o.buyerId===s._id)&&(x.buyerId={...x.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),o.sellerId&&(o.sellerId._id===s._id||o.sellerId===s._id)&&(x.sellerId={...x.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),x}))},[s]),l.useEffect(()=>{function n(o){$(x=>x.map(h=>h._id===o.appointmentId?{...h,...o.updatedAppointment}:h))}return v.on("appointmentUpdate",n),()=>{v.off("appointmentUpdate",n)}},[]),l.useEffect(()=>{function n(x){const h=x.appointment;h.buyerId&&s&&(h.buyerId._id===s._id||h.buyerId===s._id)?h.role="buyer":h.sellerId&&s&&(h.sellerId._id===s._id||h.sellerId===s._id)&&(h.role="seller"),$(N=>[h,...N])}v.on("appointmentCreated",n);const o=x=>{$(h=>h.map(N=>{const k={...N};return N.buyerId&&(N.buyerId._id===x.userId||N.buyerId===x.userId)&&(k.buyerId={...k.buyerId,username:x.username,email:x.email,mobileNumber:x.mobileNumber,avatar:x.avatar}),N.sellerId&&(N.sellerId._id===x.userId||N.sellerId===x.userId)&&(k.sellerId={...k.sellerId,username:x.username,email:x.email,mobileNumber:x.mobileNumber,avatar:x.avatar}),k}))};return v.on("profileUpdated",o),()=>{v.off("appointmentCreated",n),v.off("profileUpdated",o)}},[s]),l.useEffect(()=>{if(!s)return;const n=setInterval(()=>{v.emit("userAppointmentsActive",{userId:s._id})},1e3);return()=>clearInterval(n)},[s]);const F=async(n,o)=>{xe(n+o);try{const x=await fetch(`${E}/api/bookings/${n}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:o})}),h=await x.json();if(x.status===401){g.error("Session expired or unauthorized. Please sign in again."),P("/sign-in");return}if(x.ok){$(k=>k.map(L=>L._id===n?{...L,status:o}:L));const N=o==="accepted"?"accepted":"rejected";g.success(`Appointment ${N} successfully! ${o==="accepted"?"Contact information is now visible to both parties.":""}`,{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),P("/user/my-appointments")}else g.error(h.message||"Failed to update appointment status.")}catch{g.error("An error occurred. Please try again.")}xe("")},ge=async n=>{setAppointmentToHandle(n),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},He=async n=>{setAppointmentToHandle(n),setShowArchiveModal(!0)},Ue=async n=>{setAppointmentToHandle(n),setShowUnarchiveModal(!0)},Me=c.filter(n=>{var L,z,H,f,Ve,re,st,at,_,ie;if(s._id===((z=(L=n.buyerId)==null?void 0:L._id)==null?void 0:z.toString())&&n.visibleToBuyer===!1||s._id===((f=(H=n.sellerId)==null?void 0:H._id)==null?void 0:f.toString())&&n.visibleToSeller===!1)return!1;const o=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(ne==="outdated")return o;const x=ne==="all"?!0:n.status===ne,h=Ee==="all"?!0:n.role===Ee,N=((Ve=n.propertyName)==null?void 0:Ve.toLowerCase().includes(Q.toLowerCase()))||((re=n.message)==null?void 0:re.toLowerCase().includes(Q.toLowerCase()))||((at=(st=n.buyerId)==null?void 0:st.username)==null?void 0:at.toLowerCase().includes(Q.toLowerCase()))||((ie=(_=n.sellerId)==null?void 0:_.username)==null?void 0:ie.toLowerCase().includes(Q.toLowerCase()));let k=!0;return he&&(k=k&&new Date(n.date)>=new Date(he)),q&&(k=k&&new Date(n.date)<=new Date(q)),x&&h&&N&&k}),Fe=Array.isArray(j)?j.filter(n=>{var N,k,L,z,H,f;const o=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(ne==="outdated")return o;ne==="all"||n.status;const x=((N=n.propertyName)==null?void 0:N.toLowerCase().includes(Q.toLowerCase()))||((k=n.message)==null?void 0:k.toLowerCase().includes(Q.toLowerCase()))||((z=(L=n.buyerId)==null?void 0:L.username)==null?void 0:z.toLowerCase().includes(Q.toLowerCase()))||((f=(H=n.sellerId)==null?void 0:H.username)==null?void 0:f.toLowerCase().includes(Q.toLowerCase()));let h=!0;return he&&(h=h&&new Date(n.date)>=new Date(he)),q&&(h=h&&new Date(n.date)<=new Date(q)),x&&h}):[];function qe(n){fe({...n,date:n.date?new Date(n.date).toISOString().split("T")[0]:"",time:n.time||"",message:n.message||"",buyerReinitiationCount:n.buyerReinitiationCount||0,sellerReinitiationCount:n.sellerReinitiationCount||0}),je(!0)}async function Ne(n){var N,k;if(n.preventDefault(),!M)return;const o=s&&(((N=M.buyerId)==null?void 0:N._id)===s._id||M.buyerId===s._id);if(s&&(((k=M.sellerId)==null?void 0:k._id)===s._id||(M.sellerId,s._id)),(o?M.buyerReinitiationCount||0:M.sellerReinitiationCount||0)>=2){g.error("You have reached the maximum number of reinitiations for your role.");return}if(!M.buyerId||!M.sellerId){g.error("Cannot reinitiate: one of the parties no longer exists.");return}const h={...M,status:"pending"};try{const L=await fetch(`${E}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(h)}),z=await L.json();L.ok?(g.success("Appointment reinitiated successfully!",{autoClose:5e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),je(!1),fe(null),P("/user/my-appointments"),$(H=>H.map(f=>f._id===z.appointment._id?{...f,...z.appointment}:f))):g.error(z.message||"Failed to reinitiate appointment.")}catch{g.error("An error occurred. Please try again.")}}const Ye=(n,o)=>{$(x=>x.map(h=>h._id===n?{...h,status:o}:h))},Je=async()=>{ae(!0),me(null);try{const n=await fetch(`${E}/api/bookings/my`,{credentials:"include"});if(n.ok){const o=await n.json();$(o)}else throw new Error("Failed to fetch appointments");if(s&&(s.role==="admin"||s.role==="rootadmin")){const o=await fetch(`${E}/api/bookings/archived`,{credentials:"include"});if(o.ok){const x=await o.json();le(Array.isArray(x)?x:[])}}else le([])}catch{me("Failed to refresh appointments. Please try again.")}finally{ae(!1)}},Ke=n=>{if(!n){g.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(n).then(()=>{g.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{Ce(n)}):Ce(n)},Ce=n=>{try{const o=document.createElement("textarea");o.value=n,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();const x=document.execCommand("copy");document.body.removeChild(o),x?g.success("Copied",{autoClose:2e3,position:"bottom-center"}):(console.error("Fallback copy failed"),g.error("Failed to copy message"))}catch(o){console.error("Fallback copy error:",o),g.error("Copy not supported")}};return _t?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):ve?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:ve})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:O?"Archived Appointments":"My Appointments"}),!O&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Monitor all appointments across the platform. Use the status filter to view appointments and interactive chatbox to connect with otherparty."})]}),e.jsx("button",{onClick:Je,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),s&&(s.role==="admin"||s.role==="rootadmin")&&e.jsx("button",{onClick:()=>ee(!O),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${O?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:O?e.jsxs(e.Fragment,{children:[e.jsx(kt,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(At,{})," Archived Appointments (",j.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:ne,onChange:n=>Pe(n.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:he,onChange:n=>T(n.target.value),max:q||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:q,onChange:n=>X(n.target.value),min:he||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:Ee,onChange:n=>ue(n.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ls,{className:"text-gray-500 hover:text-blue-500 transition-colors duration-200"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:Q,onChange:n=>It(n.target.value)})]})]}),O&&s&&(s.role==="admin"||s.role==="rootadmin")?Fe.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Fe.map(n=>e.jsx(ns,{appt:n,currentUser:s,handleStatusUpdate:F,handleAdminDelete:ge,actionLoading:we,onShowOtherParty:o=>{et(o),w(!0)},onOpenReinitiate:()=>qe(n),handleArchiveAppointment:He,handleUnarchiveAppointment:Ue,isArchived:!0,onCancelRefresh:Ye,copyMessageToClipboard:Ke},n._id))})]})}):Me.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Me.map(n=>e.jsx(ns,{appt:n,currentUser:s,handleStatusUpdate:F,handleAdminDelete:ge,actionLoading:we,onShowOtherParty:o=>{et(o),w(!0)},onOpenReinitiate:()=>qe(n),handleArchiveAppointment:He,handleUnarchiveAppointment:Ue,isArchived:!1,onCancelRefresh:Ye,copyMessageToClipboard:Ke},n._id))})]})}),G&&b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",style:{overflow:"hidden"},children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>w(!1),title:"Close","aria-label":"Close",children:e.jsx(Re,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(zs,{user:{username:b.username,avatar:b.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 border-2 border-white rounded-full flex items-center justify-center",children:b.isTyping?e.jsx("div",{className:"w-full h-full bg-yellow-500 rounded-full flex items-center justify-center",children:e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"})}):b.isOnline?e.jsx("div",{className:"w-full h-full bg-green-500 rounded-full flex items-center justify-center",children:e.jsx(Zt,{className:"w-2 h-2 text-white"})}):e.jsx("div",{className:"w-full h-full bg-gray-400 rounded-full flex items-center justify-center",children:e.jsx(Zt,{className:"w-2 h-2 text-white"})})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[b.username||"User",b.role==="admin"&&e.jsx(ls,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:b.role||"User"}),b.isTyping?e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-yellow-600 font-medium text-xs bg-yellow-100 px-3 py-1 rounded-full",children:"Typing..."})}):b.isOnline?e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-green-600 font-medium text-xs bg-green-100 px-3 py-1 rounded-full",children:"Online"})}):e.jsx("div",{className:"mt-2",children:e.jsx("span",{className:"text-gray-600 font-medium text-xs bg-gray-100 px-3 py-1 rounded-full",children:(()=>{if(!b.lastSeen)return"Offline";const n=new Date(b.lastSeen),x=Math.floor((new Date-n)/(1e3*60)),h=Math.floor(x/60),N=Math.floor(h/24);return x<1?"Last seen just now":x<60?`Last seen ${x} minute${x>1?"s":""} ago`:h<24?`Last seen ${h} hour${h>1?"s":""} ago`:N<7?`Last seen ${N} day${N>1?"s":""} ago`:`Last seen ${n.toLocaleDateString("en-US",{month:"short",day:"numeric"})}`})()})})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(Ps,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Hs,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Us,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:b.createdAt?new Date(b.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]})})]})}),Z&&M&&e.jsx("div",{className:"modal-backdrop",children:e.jsx("div",{className:"modal-content",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:Ne,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:M.date,onChange:n=>fe(o=>({...o,date:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:M.time,onChange:n=>fe(o=>({...o,time:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:M.message,onChange:n=>fe(o=>({...o,message:n.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>je(!1),children:"Cancel"})]})]})})})]})})}function St(s){const c=new Date,$=new Date;return $.setDate(c.getDate()-1),s.toDateString()===c.toDateString()?"Today":s.toDateString()===$.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function ns({appt:s,currentUser:c,handleStatusUpdate:$,handleAdminDelete:_t,actionLoading:ae,onShowOtherParty:ve,onOpenReinitiate:me,handleArchiveAppointment:Q,handleUnarchiveAppointment:It,isArchived:ne,onCancelRefresh:Pe,copyMessageToClipboard:Ee}){var Jt,Kt;const[ue,we]=l.useState(null),[xe,G]=l.useState(""),[w,b]=l.useState(s.comments||[]),[et,he]=l.useState(!1),[T,q]=l.useState(null),[X,Z]=l.useState(""),[je,M]=l.useState(null),fe=qs(),[j,le]=l.useState(!1),O=l.useRef(null),ee=l.useRef(null),[P,tt]=l.useState(!0),[C,F]=l.useState(0),[ge,He]=l.useState(""),[Ue,Me]=l.useState(!1),[Fe,qe]=l.useState(!1),[Ne,Ye]=l.useState(!1),[Je,Ke]=l.useState(null),[Ce,n]=l.useState(null),[o,x]=l.useState(!1),[h,N]=l.useState(!1),[k,L]=l.useState(!1),z=l.useRef(null),H=l.useRef(null),f=l.useRef(null),[Ve,re]=l.useState(!1),[st,at]=l.useState(null),[_,ie]=l.useState(null),[Ge,Se]=l.useState(!0),[rs,nt]=l.useState(!1),[is,lt]=l.useState(!1),[We,rt]=l.useState(""),[Dt,it]=l.useState(""),[ot,dt]=l.useState(null),[Tt,Rt]=l.useState(!1),[os,ds]=l.useState(!1),[cs,ms]=l.useState(!1),[us,xs]=l.useState(!1),[ct,mt]=l.useState(!1),[hs,ut]=l.useState(!1),[xt,ht]=l.useState(!1);l.useEffect(()=>(ct||xt?document.body.classList.add("modal-open"):document.body.classList.remove("modal-open"),()=>{document.body.classList.remove("modal-open")}),[ct,xt]);const[Qs,ft]=l.useState(null),[ke,oe]=l.useState(""),[fs,Et]=l.useState(""),te=l.useRef({}),[Qe,W]=l.useState(null),[be,Mt]=l.useState(!1),[U,gs]=l.useState(window.innerWidth<=768);l.useEffect(()=>{const t=()=>{gs(window.innerWidth<=768)};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const[bs,Ft]=l.useState(!1),[Y,Bt]=l.useState(null),[gt,$t]=l.useState(!1),[ps,Ot]=l.useState(!1),[Be,Ae]=l.useState(!1);l.useEffect(()=>{if(h){const t=setTimeout(()=>N(!1),1e4);return()=>clearTimeout(t)}},[h]),l.useEffect(()=>{const t=r=>{Be&&!r.target.closest(".chat-options-menu")&&Ae(!1)},a=()=>{Be&&Ae(!1)};return document.addEventListener("mousedown",t),document.addEventListener("scroll",a,!0),()=>{document.removeEventListener("mousedown",t),document.removeEventListener("scroll",a,!0)}},[Be]),l.useEffect(()=>{if(gt){const t=setTimeout(()=>{$t(!1),Ot(!0);const a=setTimeout(()=>Ot(!1),1e3);return()=>clearTimeout(a)},800);return()=>clearTimeout(t)}},[gt]);function Xe(t){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${t}`))||[]}catch{return[]}}function Lt(t,a){const r=Xe(t);if(!r.includes(a)){const d=[...r,a];localStorage.setItem(`removedDeletedMsgs_${t}`,JSON.stringify(d))}}const ys=async()=>{try{L(!0);const t=await fetch(`${E}/api/bookings/${s._id}`,{credentials:"include"});if(t.ok){const a=await t.json();a.comments&&a.comments.length!==w.length&&(b(a.comments),F(0))}}catch(t){console.error("Error fetching latest comments:",t),g.error("Failed to refresh messages")}finally{L(!1)}},bt=(c.role==="admin"||c.role==="rootadmin")&&c.adminApprovalStatus==="approved",vs=fe.pathname.includes("/admin"),J=s.role==="seller",_e=s.role==="buyer",de=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),K=!de||s.status==="pending"||s.status==="rejected"||s.status==="cancelledByAdmin",zt=(bt||s.status==="accepted")&&de&&s.status!=="cancelledByBuyer"&&s.status!=="cancelledBySeller"&&s.status!=="cancelledByAdmin"&&s.status!=="rejected"&&s.status!=="deletedByAdmin",m=J?s.buyerId:s.sellerId,ws=t=>{ie(t),Se(!0),re(!0)},js=t=>{ie(t),Se(!1),re(!0)},Ns=async()=>{var t;if(_){try{if(Ge){const a=!((t=_.readBy)!=null&&t.includes(c._id))&&_.senderEmail!==c.email,r=await fetch(`${E}/api/bookings/${s._id}/comment/${_._id}`,{method:"DELETE",credentials:"include"}),d=await r.json();r.ok?(b(i=>d.comments.map(u=>{const p=i.find(y=>y._id===u._id);return p&&p.status==="read"&&u.status!=="read"?{...u,status:"read"}:u})),a&&F(i=>Math.max(0,i-1)),g.success("Message deleted for everyone!")):g.error(d.message||"Failed to delete message.")}else{try{await fetch(`${E}/api/bookings/${s._id}/comment/${_._id}/remove-for-me`,{method:"PATCH",credentials:"include"})}catch{}b(a=>a.filter(r=>r._id!==_._id)),Lt(s._id,_._id),g.success("Message deleted for you!")}}catch{g.error("An error occurred. Please try again.")}re(!1),ie(null),Se(!0)}},Cs=async()=>{try{const t=Date.now();localStorage.setItem(qt,t),b([]),await fetch(`${E}/api/bookings/${s._id}/chat/clear-local`,{method:"PATCH",credentials:"include"}),g.success("Chat Cleared")}catch(t){console.error("Failed to persist chat clear:",t),g.error("Cleared locally, but failed to sync with server.")}finally{nt(!1)}},Ss=t=>{Bt(t),Ft(!0)},pt=async()=>{if(!xe.trim())return;$t(!0);const t=xe.trim(),a=ue,r=`temp-${Date.now()}`,d={_id:r,sender:c._id,senderEmail:c.email,senderName:c.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[c._id],...a?{replyTo:a._id}:{}};b(u=>[...u,d]),G(""),we(null);const i=()=>{f.current&&(f.current.focus(),f.current.setSelectionRange(0,0),document.activeElement!==f.current&&(f.current.click(),f.current.focus()))};i(),requestAnimationFrame(i),setTimeout(i,10),O.current&&O.current.scrollIntoView({behavior:"smooth"}),(async()=>{try{const u=await fetch(`${E}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...a?{replyTo:a._id}:{}})}),p=await u.json();if(u.ok){const y=p.comments[p.comments.length-1];b(S=>S.map(R=>R._id===r?{...y}:R))}else{b(S=>S.filter(R=>R._id!==r)),g.error(p.message||"Failed to send message.");const y=()=>{f.current&&(f.current.focus(),f.current.setSelectionRange(0,0),document.activeElement!==f.current&&(f.current.click(),f.current.focus()))};y(),requestAnimationFrame(y)}}catch{b(y=>y.filter(S=>S._id!==r)),g.error("An error occurred. Please try again.");const p=()=>{f.current&&(f.current.focus(),f.current.setSelectionRange(0,0),document.activeElement!==f.current&&(f.current.click(),f.current.focus()))};p(),requestAnimationFrame(p)}})()},yt=async t=>{if(!X.trim())return;M(t),b(r=>r.map(d=>d._id===t?{...d,message:X,edited:!0,editedAt:new Date}:d));try{const r=await fetch(`${E}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:X})}),d=await r.json();if(r.ok){b(u=>u.map(p=>{const y=d.comments.find(S=>S._id===p._id);return y?y._id===t?y:p.status==="read"&&y.status!=="read"?{...y,status:"read"}:y:p})),q(null),Z(""),G("");const i=()=>{f.current&&(f.current.focus(),f.current.setSelectionRange(0,0),document.activeElement!==f.current&&(f.current.click(),f.current.focus()))};i(),requestAnimationFrame(i),setTimeout(i,10),g.success("Message edited successfully!")}else b(i=>i.map(u=>u._id===t?{...u,message:u.originalMessage||u.message,edited:u.wasEdited||!1}:u)),q(t),Z(X),G(X),g.error(d.message||"Failed to edit message.")}catch{b(d=>d.map(i=>i._id===t?{...i,message:i.originalMessage||i.message,edited:i.wasEdited||!1}:i)),q(t),Z(X),G(X),g.error("An error occurred. Please try again.")}finally{M(null)}},ks=t=>{q(t._id),Z(t.message),G(t.message),b(a=>a.map(r=>r._id===t._id?{...r,originalMessage:r.message,wasEdited:r.edited}:r)),setTimeout(()=>{if(f.current){f.current.focus();const a=f.current.value.length;f.current.setSelectionRange(a,a)}},100)},As=t=>{we(t);const a=()=>{if(f.current){f.current.focus();const r=f.current.value.length;f.current.setSelectionRange(r,r),document.activeElement!==f.current&&(f.current.click(),f.current.focus())}};setTimeout(a,50),setTimeout(a,100),setTimeout(a,200)},_s=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},Pt=async()=>{oe(""),mt(!0)},Is=async()=>{if(!ke.trim()){g.error("Reason is required for cancellation.");return}try{const t=await fetch(`${E}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:ke})}),a=await t.json();if(t.status===401){g.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(g.success("Appointment cancelled successfully."),typeof Pe=="function"&&Pe(s._id,J?"cancelledBySeller":"cancelledByBuyer")):g.error(a.message||"Failed to cancel appointment."),mt(!1),oe("")}catch{g.error("An error occurred. Please try again.")}},Ds=async()=>{oe(""),ut(!0)},Ts=async()=>{if(!ke.trim()){g.error("Reason is required for admin cancellation.");return}try{const t=await fetch(`${E}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:ke})}),a=await t.json();if(t.status===401){g.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(g.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):g.error(a.message||"Failed to cancel appointment."),ut(!1),oe("")}catch{g.error("An error occurred. Please try again.")}},vt=async()=>{ht(!0)},Rs=async()=>{try{const t=_e?"buyer":J?"seller":null;if(!t)return;if((await fetch(`${E}/api/bookings/${s._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:t})})).ok){if(typeof window<"u"){const r=new CustomEvent("removeAppointmentRow",{detail:s._id});window.dispatchEvent(r),g.success("Appointment removed from your table successfully")}}else g.error("Failed to remove appointment from table.");ht(!1)}catch{g.error("An error occurred. Please try again.")}};l.useEffect(()=>{if(j){const t=w.find(a=>{var r,d,i;return!((r=a.readBy)!=null&&r.includes(c._id))&&a.senderEmail!==c.email&&!a.deleted&&new Date(a.timestamp).getTime()>$e&&!((i=(d=a.removedFor)==null?void 0:d.includes)!=null&&i.call(d,c._id))&&!pe.includes(a._id)});t&&te.current[t._id]?setTimeout(()=>{const a=te.current[t._id];a&&a.scrollIntoView({behavior:"smooth",block:"start"})},100):O.current&&setTimeout(()=>{O.current.scrollIntoView({behavior:"smooth"})},100)}},[j,w,c._id,$e,pe]);const wt=l.useRef(!1),Ie=l.useCallback(async()=>{if(!ee.current||wt.current)return;const{scrollTop:t,scrollHeight:a,clientHeight:r}=ee.current;if(!(a-t-r<10))return;const i=w.filter(u=>{var p;return!((p=u.readBy)!=null&&p.includes(c._id))&&u.senderEmail!==c.email});if(i.length>0){wt.current=!0;try{(await fetch(`${E}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(b(p=>p.map(y=>i.some(S=>S._id===y._id)?{...y,readBy:[...y.readBy||[],c._id],status:"read"}:y)),i.forEach(p=>{v.emit("messageRead",{appointmentId:s._id,messageId:p._id,userId:c._id,readBy:c._id})}),console.log(`Marked ${i.length} messages as read for user ${c._id}`),F(p=>Math.max(0,p-i.length)))}catch(u){console.error("Error marking messages as read:",u)}finally{wt.current=!1}}},[w,c._id,s._id,v]),Ht=l.useRef(w.length),Es=l.useRef(w);l.useEffect(()=>{const t=w.slice(Ht.current),a=t.length;if(Ht.current=w.length,Es.current=w,a>0&&j){const r=t.some(i=>i.senderEmail===c.email),d=t.filter(i=>i.senderEmail!==c.email);r||P?setTimeout(()=>{O.current&&(O.current.scrollIntoView({behavior:"smooth"}),P&&d.length>0&&setTimeout(()=>{Ie()},300))},100):d.length>0&&F(i=>i+d.length)}},[w.length,P,j,c.email,Ie]);const Ut=l.useCallback(()=>{if(ee.current){const{scrollTop:t,scrollHeight:a,clientHeight:r}=ee.current,d=a-t-r<10;if(tt(d),d){const i=w.filter(u=>{var p;return!((p=u.readBy)!=null&&p.includes(c._id))&&u.senderEmail!==c.email}).length;i>0&&(console.log(`User manually scrolled to bottom, marking ${i} messages as read`),Ie()),C>0&&F(0)}}},[C,Ie,w,c._id]),jt=l.useCallback(()=>{if(!ee.current||w.length===0)return;const t=`chatClearTime_${s._id}`,a=Number(localStorage.getItem(t))||0,r=(()=>{const A=s.role==="buyer"?s.buyerChatClearedAt:s.sellerChatClearedAt;return A?new Date(A).getTime():0})(),d=Math.max(a,r),i=Xe(s._id),u=w.filter(A=>new Date(A.timestamp).getTime()>d&&!i.includes(A._id));if(u.length===0)return;const y=ee.current.getBoundingClientRect(),S=y.top+60;let R="";for(let A=0;A<u.length;A++){const ce=te.current[u[A]._id];if(ce){const De=ce.getBoundingClientRect();if(De.top>=S&&De.bottom<=y.bottom){const Te=new Date(u[A].timestamp);R=St(Te);break}}}if(!R)for(let A=0;A<u.length;A++){const ce=te.current[u[A]._id];if(ce&&ce.getBoundingClientRect().bottom>S){const Te=new Date(u[A].timestamp);R=St(Te);break}}R&&R!==ge&&He(R)},[w,ge,s._id]);l.useEffect(()=>{const t=ee.current;if(t&&j){const a=()=>{if(Ut(),jt(),Me(!0),t&&U){const{scrollTop:r}=t;r<50&&(Mt(!0),setTimeout(()=>Mt(!1),3e3))}H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{Me(!1)},1e3)};if(t.addEventListener("scroll",a),t){const{scrollTop:r,scrollHeight:d,clientHeight:i}=t,u=d-r-i<10;tt(u)}return setTimeout(jt,100),()=>{t.removeEventListener("scroll",a),H.current&&clearTimeout(H.current)}}},[j,Ut,jt]);const Ms=l.useCallback(()=>{O.current&&(O.current.scrollIntoView({behavior:"smooth"}),F(0),setTimeout(()=>{Ie()},500))},[Ie]);l.useEffect(()=>{function t(a){var r,d;if(a.appointmentId===s._id&&!j){if(a.comment.deleted)return;const i=a.comment.senderEmail===((r=s.buyerId)==null?void 0:r.email),u=a.comment.senderEmail===((d=s.sellerId)==null?void 0:d.email),y=!i&&!u?"UrbanSetu":a.comment.senderEmail||"User";g.info(`New message from ${y}`)}}return v.on("commentUpdate",t),()=>{v.off("commentUpdate",t)}},[s._id,j]),l.useEffect(()=>{function t(d){d.appointmentId===s._id&&b(i=>{var p;const u=i.findIndex(y=>y._id===d.comment._id);if(u!==-1){const y=[...i],S=i[u],R=d.comment;let A=R.status;return S.status==="read"&&R.status!=="read"&&(A="read"),y[u]={...R,status:A},y}else return!i.some(S=>S._id.toString().startsWith("temp-"))||d.comment.senderEmail!==c.email?(d.comment.senderEmail!==c.email&&!j&&!((p=d.comment.readBy)!=null&&p.includes(c._id))&&F(S=>S+1),[...i,d.comment]):i})}function a({appointmentId:d,clearedAt:i}){if(d===s._id){try{const u=`chatClearTime_${s._id}`,p=Number(localStorage.getItem(u))||0,y=i?new Date(i).getTime():0,S=Math.max(p,y);localStorage.setItem(u,String(S))}catch{}b([]),F(0)}}function r({appointmentId:d,commentId:i}){d===s._id&&(b(u=>u.filter(p=>p._id!==i)),Lt(s._id,i))}return v.on("commentUpdate",t),v.on("chatClearedForUser",a),v.on("commentRemovedForUser",r),()=>{v.off("commentUpdate",t),v.off("chatClearedForUser",a),v.off("commentRemovedForUser",r)}},[s._id,c.email,c._id,j]),l.useEffect(()=>{j&&fetch(`${E}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"}).catch(t=>{console.warn("Error marking comments as read on modal open:",t)})},[j,s._id]),l.useEffect(()=>{function t(r){r.appointmentId===s._id&&b(d=>d.map(i=>i._id===r.commentId?{...i,status:i.status==="read"?"read":"delivered",deliveredAt:new Date}:i))}function a(r){r.appointmentId===s._id&&b(d=>d.map(i=>{var u;return(u=i.readBy)!=null&&u.includes(r.userId)?i:{...i,status:"read",readBy:[...i.readBy||[],r.userId],readAt:new Date}}))}return v.on("commentDelivered",t),v.on("commentRead",a),()=>{v.off("commentDelivered",t),v.off("commentRead",a)}},[s._id,b]);const qt=`chatClearTime_${s._id}`,Fs=Number(localStorage.getItem(qt))||0,Bs=(()=>{const t=s.role==="buyer"?s.buyerChatClearedAt:s.sellerChatClearedAt;return t?new Date(t).getTime():0})(),$e=Math.max(Fs,Bs),pe=Xe(s._id),V=w.filter(t=>{var a,r,d;return!((a=t.readBy)!=null&&a.includes(c._id))&&t.senderEmail!==c.email&&!t.deleted&&new Date(t.timestamp).getTime()>$e&&!((d=(r=t.removedFor)==null?void 0:r.includes)!=null&&d.call(r,c._id))&&!pe.includes(t._id)}).length;l.useEffect(()=>{j&&C===0&&V>0&&F(V)},[j,V,C]),l.useEffect(()=>{!j&&V>0&&F(V)},[V,j]),l.useEffect(()=>{w.length>0&&V>0&&C===0&&F(V)},[w,V,C]),l.useEffect(()=>{(async()=>{if(w.length>0&&C===0){const a=w.filter(r=>{var d,i,u;return!((d=r.readBy)!=null&&d.includes(c._id))&&r.senderEmail!==c.email&&!r.deleted&&new Date(r.timestamp).getTime()>$e&&!((u=(i=r.removedFor)==null?void 0:i.includes)!=null&&u.call(i,c._id))&&!Xe(s._id).includes(r._id)}).length;a>0&&F(a)}})()},[w,c._id,s._id,C]),l.useEffect(()=>(j?document.body.style.overflow="hidden":(document.body.style.overflow="",V>0?F(V):F(0)),()=>{document.body.style.overflow=""}),[j,V]);const ye=w.filter(t=>{var a,r;return new Date(t.timestamp).getTime()>$e&&!pe.includes(t._id)&&!((r=(a=t.removedFor)==null?void 0:a.includes)!=null&&r.call(a,c._id))});l.useEffect(()=>{if(!j||!(m!=null&&m._id))return;v.emit("checkUserOnline",{userId:m._id});function t(a){a.userId===m._id&&(qe(!!a.online),Ke(a.lastSeen||null))}return v.on("userOnlineStatus",t),v.on("userOnlineUpdate",t),()=>{v.off("userOnlineStatus",t),v.off("userOnlineUpdate",t)}},[j,m==null?void 0:m._id]),l.useEffect(()=>{if(!(m!=null&&m._id))return;v.emit("checkUserOnline",{userId:m._id});function t(a){a.userId===m._id&&(Ye(!!a.online),n(a.lastSeen||null))}return v.on("userOnlineStatus",t),v.on("userOnlineUpdate",t),()=>{v.off("userOnlineStatus",t),v.off("userOnlineUpdate",t)}},[m==null?void 0:m._id]),l.useEffect(()=>{function t(a){a.fromUserId===(m==null?void 0:m._id)&&a.appointmentId===s._id&&(x(!0),z.current&&clearTimeout(z.current),z.current=setTimeout(()=>x(!1),1e3))}return v.on("typing",t),()=>{v.off("typing",t),z.current&&clearTimeout(z.current)}},[m==null?void 0:m._id,s._id]),l.useEffect(()=>{if(!j)return;const t=a=>{var r;a.ctrlKey&&a.key==="f"&&(a.preventDefault(),(r=f.current)==null||r.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[j]);function Yt(t){if(!t)return null;const a=new Date(t),r=new Date,d=Math.floor((r-a)/(1e3*60)),i=Math.floor(d/60),u=Math.floor(i/24);return d<1?"last seen just now":d<60?`last seen ${d} minute${d>1?"s":""} ago`:i<24?`last seen ${i} hour${i>1?"s":""} ago`:u<7?`last seen ${u} day${u>1?"s":""} ago`:`last seen ${a.toLocaleDateString("en-US",{month:"short",day:"numeric",year:a.getFullYear()!==r.getFullYear()?"numeric":void 0})}`}const D=Qe?w.find(t=>t._id===Qe):null;return e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${de?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!de&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(Ys,{to:vs?`/admin/listing/${s.listingId._id}`:`/user/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${J?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:J?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[zt?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>ve({...m,isOnline:Ne,isTyping:o,lastSeen:Ce}),title:"Click to view details",children:(m==null?void 0:m.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(m==null?void 0:m.username)||"Unknown"}),zt?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:m==null?void 0:m.email}),e.jsx("div",{className:"text-sm text-gray-600",children:m!=null&&m.mobileNumber&&(m==null?void 0:m.mobileNumber)!==""?m.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:bt?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${_s(s.status)}`,children:s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:de?e.jsxs(e.Fragment,{children:[J&&s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>$(s._id,"accepted"),disabled:ae===s._id+"accepted",title:"Accept Appointment",children:e.jsx(Ze,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>$(s._id,"rejected"),disabled:ae===s._id+"rejected",title:"Reject Appointment",children:e.jsx(Re,{})})]}),J&&s.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Pt,title:"Cancel Appointment (Seller)",children:e.jsx(B,{})}),J&&(s.status==="cancelledBySeller"||s.status==="cancelledByBuyer"||s.status==="cancelledByAdmin"||s.status==="rejected"||s.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:vt,title:"Remove from table",style:{opacity:.5},children:e.jsx(B,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),_e&&(s.status==="pending"||s.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Pt,title:"Cancel Appointment (Buyer)",children:e.jsx(B,{})}),_e&&(s.status==="cancelledByBuyer"||s.status==="cancelledBySeller"||s.status==="cancelledByAdmin"||s.status==="deletedByAdmin"||s.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:vt,title:"Remove from table",style:{opacity:.5},children:e.jsx(B,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),bt&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Ds,title:"Cancel Appointment (Admin)",children:e.jsx(ls,{})}),(s.status==="cancelledByBuyer"&&_e||s.status==="cancelledBySeller"&&J)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>me(s),disabled:s.status==="cancelledByBuyer"&&_e&&(s.buyerReinitiationCount||0)>=2||s.status==="cancelledBySeller"&&J&&(s.sellerReinitiationCount||0)>=2||!s.buyerId||!s.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:_e&&s.status==="cancelledByBuyer"?`${2-(s.buyerReinitiationCount||0)} left`:J&&s.status==="cancelledBySeller"?`${2-(s.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:vt,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(B,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-3 shadow-lg mx-auto relative transform transition-all duration-200 group ${K?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50":"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white hover:shadow-xl hover:scale-105"}`,title:K?de?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments":"Open Chat",onClick:K?void 0:()=>le(!0),disabled:K,children:[e.jsx(Nt,{size:22,className:K?"":"group-hover:animate-pulse"}),!K&&e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"}),o&&!K&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!o&&C>0&&K&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:C}),!o&&C>0&&!K&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:C}),!o&&C===0&&Ne&&!K&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200 transform transition-all duration-500 hover:shadow-3xl",children:[K?e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 min-h-96",children:[e.jsx(Nt,{className:"text-6xl text-gray-400 mb-6"}),e.jsx("div",{className:"text-xl font-semibold text-gray-500 text-center",children:de?s.status==="pending"?"Chat not available for pending appointments":s.status==="rejected"?"Chat not available for rejected appointments":"Chat not available for appointments cancelled by admin":"Chat not available for outdated appointments"}),e.jsx("div",{className:"text-gray-400 text-center mt-2",children:de?s.status==="pending"?"Chat will be enabled once the appointment is accepted":s.status==="rejected"?"This appointment has been rejected":"This appointment has been cancelled by admin":"This appointment has already passed"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex items-center gap-2 sm:gap-3 px-4 sm:px-6 py-3 sm:py-4 border-b-2 border-blue-700 bg-gradient-to-r from-blue-700 via-purple-700 to-blue-900 rounded-t-3xl relative shadow-2xl",children:Qe&&D?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!D.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{As(D),W(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!D.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ee(D.message),W(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(Js,{size:18})}),D.senderEmail===c.email&&!D.deleted&&e.jsx("button",{className:"text-white hover:text-blue-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Ss(D),W(null)},title:"Message info","aria-label":"Message info",children:e.jsx(es,{size:18})}),D.senderEmail!==c.email&&!D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{dt(D),lt(!0),W(null)},title:"Report message","aria-label":"Report message",children:e.jsx(ts,{size:18})}),D.senderEmail===c.email&&!D.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{ks(D),W(null)},className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",title:"Edit comment","aria-label":"Edit comment",disabled:T!==null,children:e.jsx(Ct,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{ws(D),W(null)},title:"Delete","aria-label":"Delete",children:e.jsx(B,{size:18})})]}),D.senderEmail!==c.email&&!D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{js(D),W(null)},title:"Delete locally","aria-label":"Delete locally",children:e.jsx(B,{size:18})}),D.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{ie(D),Se(!1),re(!0),W(null)},title:"Delete from chat locally","aria-label":"Delete from chat locally",children:e.jsx(B,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>W(null),title:"Close options","aria-label":"Close options",children:e.jsx(Re,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1 sm:p-1.5 shadow-lg flex-shrink-0 cursor-pointer hover:scale-105 transition-transform duration-200",onClick:()=>ve({...m,isOnline:Ne,isTyping:o,lastSeen:Ce}),title:"Click to view user details",children:m!=null&&m.avatar?e.jsx("img",{src:m.avatar,alt:m.username||"User",className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-semibold text-sm",children:((m==null?void 0:m.username)||"U").charAt(0).toUpperCase()})}),e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 min-w-0 flex-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[e.jsx("h3",{className:"text-sm sm:text-lg font-bold text-white truncate cursor-pointer hover:underline",onClick:()=>ve({...m,isOnline:Ne,isTyping:o,lastSeen:Ce}),title:"Click to view user details",children:(m==null?void 0:m.username)||"Unknown User"}),e.jsx("div",{className:"flex items-center gap-1 sm:hidden",children:o?e.jsx("span",{className:"text-yellow-100 font-semibold text-[10px] bg-yellow-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap",children:"Typing..."}):Fe?e.jsx("span",{className:"text-green-100 font-semibold text-[10px] bg-green-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-[10px] bg-gray-500 bg-opacity-80 px-1.5 py-0.5 rounded-full whitespace-nowrap",children:Yt(Je)||"Offline"})}),e.jsx("div",{className:"hidden sm:flex items-center gap-1",children:o?e.jsx("span",{className:"text-yellow-100 font-semibold text-xs bg-yellow-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Typing..."}):Fe?e.jsx("span",{className:"text-green-100 font-semibold text-xs bg-green-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:"Online"}):e.jsx("span",{className:"text-gray-100 font-semibold text-xs bg-gray-500 bg-opacity-80 px-2 py-1 rounded-full whitespace-nowrap",children:Yt(Je)||"Offline"})})]})}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 ml-auto flex-shrink-0",children:[C>0&&e.jsxs("div",{className:"bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse",children:[C," new message",C>1?"s":""]}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors shadow",onClick:()=>Ae(!Be),title:"Chat options","aria-label":"Chat options",children:e.jsx(ss,{className:"text-sm"})}),Be&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-white rounded-lg shadow-lg border border-gray-200 z-20 min-w-[160px] chat-options-menu",children:[e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{ys(),Ae(!1)},disabled:k,children:[e.jsx(Ks,{className:`text-sm ${k?"animate-spin":""}`}),"Refresh Messages"]}),ye.length>0&&e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",onClick:()=>{nt(!0),Ae(!1)},children:[e.jsx(B,{className:"text-sm"}),"Clear Chat"]}),e.jsxs("button",{className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",onClick:()=>{N(!h),Ae(!1)},children:[e.jsx(Vs,{className:"text-sm"}),"Keyboard Shortcuts"]})]})]}),h&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>le(!1),title:"Close","aria-label":"Close",children:e.jsx(Re,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{ref:ee,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative bg-gradient-to-b from-transparent to-blue-50/30",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[e.jsx("div",{className:`px-4 py-3 bg-gradient-to-r from-blue-50 to-purple-50 border-l-4 border-blue-400 rounded-r-lg mb-4 transform transition-all duration-500 hover:scale-105 hover:shadow-lg hover:from-blue-100 hover:to-purple-100 hover:border-blue-500 hover:border-l-6 backdrop-blur-sm ${U&&be?"animate-attentionGlow shadow-lg border-blue-500 bg-gradient-to-r from-blue-100 to-purple-100 scale-105":U&&P?"animate-slideInFromTop shadow-lg border-blue-500 bg-gradient-to-r from-blue-100 to-purple-100 animate-attentionGlow":"animate-gentlePulse"}`,style:{animationDelay:"0s",transform:U&&be?"scale(1.05)":U&&P?"scale(1.02)":"scale(1)",boxShadow:U&&be?"0 15px 35px rgba(59, 130, 246, 0.25)":U&&P?"0 10px 25px rgba(59, 130, 246, 0.15)":"none"},children:e.jsxs("p",{className:"text-sm text-blue-700 font-medium text-center flex items-center justify-center gap-2",children:[e.jsx("span",{className:`${U&&be?"animate-bounce text-blue-600":U&&P?"animate-bounce":"animate-gentlePulse"}`,children:"ðŸ”’"}),"Your privacy is our top priority â€” all your chats and data are fully encrypted for your safety",U&&be&&e.jsx("span",{className:"ml-2 animate-pulse text-blue-600",children:"âœ¨"}),U&&P&&!be&&e.jsx("span",{className:"ml-2 animate-pulse text-blue-600",children:"âœ¨"})]})}),ge&&ye.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${Ue?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:ge})})}),k?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"Loading messages..."})]}):ye.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(Nt,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):ye.map((t,a)=>{var R,A,ce,De,Te,Vt,Gt,Wt,Qt,Xt;const r=t.senderEmail===c.email,d=T===t._id,i=new Date(t.timestamp),u=a>0?new Date(ye[a-1].timestamp):null,p=u?i.toDateString()!==u.toDateString():!0;i.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"});const y=!r&&!((R=t.readBy)!=null&&R.includes(c._id))&&!t.deleted&&!((ce=(A=t.removedFor)==null?void 0:A.includes)!=null&&ce.call(A,c._id))&&!pe.includes(t._id)&&!ye.slice(0,a).some(I=>{var Oe,se,Le;return!((Oe=I.readBy)!=null&&Oe.includes(c._id))&&I.senderEmail!==c.email&&!I.deleted&&!((Le=(se=I.removedFor)==null?void 0:se.includes)!=null&&Le.call(se,c._id))&&!pe.includes(I._id)}),S=ye.filter(I=>{var Oe,se,Le;return!((Oe=I.readBy)!=null&&Oe.includes(c._id))&&I.senderEmail!==c.email&&!I.deleted&&!((Le=(se=I.removedFor)==null?void 0:se.includes)!=null&&Le.call(se,c._id))&&!pe.includes(I._id)}).length;return e.jsxs(Gs.Fragment,{children:[p&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:St(i)})}),y&&S>0&&e.jsx("div",{className:"w-full flex justify-center my-3",children:e.jsxs("div",{className:"bg-red-500 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white animate-pulse",children:[S," unread message",S>1?"s":""]})}),e.jsx("div",{className:`flex w-full ${r?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*a}s`},children:e.jsxs("div",{ref:I=>te.current[t._id]=I,"data-message-id":t._id,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] lg:max-w-[60%] xl:max-w-[50%] break-words overflow-hidden relative transition-all duration-300 min-h-[60px] ${r?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300 hover:shadow-2xl":"bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300 hover:shadow-xl"}`,style:{animationDelay:`${.03*a}s`},children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{te.current[t.replyTo]&&(te.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),te.current[t.replyTo].classList.add("reply-highlight"),setTimeout(()=>{var I;(I=te.current[t.replyTo])==null||I.classList.remove("reply-highlight")},1600))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),((Te=(De=w.find(I=>I._id===t.replyTo))==null?void 0:De.message)==null?void 0:Te.substring(0,30))||"Original message",((Gt=(Vt=w.find(I=>I._id===t.replyTo))==null?void 0:Vt.message)==null?void 0:Gt.length)>30?"...":""]})}),!r&&t.senderEmail!==((Wt=s.buyerId)==null?void 0:Wt.email)&&t.senderEmail!==((Qt=s.sellerId)==null?void 0:Qt.email)&&e.jsx("div",{className:"font-semibold mb-1 text-xs text-purple-600",children:"UrbanSetu"}),e.jsx("div",{className:`text-left ${r?"text-base font-medium":"text-sm"}`,children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(ze,{className:"inline-block text-lg"})," ",t.senderEmail===c.email?"You deleted this message":"This message was deleted."]}):e.jsx("div",{children:d?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap break-words",children:(t.message||"").replace(/\n+$/,"")}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[e.jsx("span",{className:`${r?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),e.jsx("button",{className:`${t.senderEmail===c.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:I=>{I.stopPropagation(),W(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(ss,{size:12})}),t.senderEmail===c.email&&!t.deleted&&e.jsx("span",{className:"flex items-center gap-1 ml-1",children:(Xt=t.readBy)!=null&&Xt.includes(m==null?void 0:m._id)?e.jsx(as,{className:"text-green-400 text-xs",title:"Read"}):t.status==="delivered"?e.jsx(as,{className:"text-blue-200 text-xs",title:"Delivered"}):t.status==="sending"?e.jsx(Ze,{className:"text-blue-200 text-xs animate-pulse",title:"Sending..."}):e.jsx(Ze,{className:"text-blue-200 text-xs",title:"Sent"})})]})]})})]},t._id||a)}),e.jsx("div",{ref:O})]}),ue&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(Jt=ue.message)==null?void 0:Jt.substring(0,40),((Kt=ue.message)==null?void 0:Kt.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>we(null),title:"Cancel reply",children:e.jsx(Re,{className:"w-3 h-3"})})]})}),T&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:X}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{q(null),Z(""),G("")},title:"Cancel edit",children:e.jsx(Re,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-300 bg-white resize-y whitespace-pre-wrap break-all hover:border-blue-300 hover:shadow-xl focus:shadow-2xl transform hover:scale-[1.01]",placeholder:T?"Edit your message...":"Type a message...",value:xe,onChange:t=>{G(t.target.value),T&&Z(t.target.value),T||v.emit("typing",{toUserId:m._id,fromUserId:c._id,appointmentId:s._id})},onClick:()=>{Qe&&(W(null),g.info("You can hit reply icon in header to reply"))},onKeyDown:t=>{const a=window.matchMedia("(min-width: 768px)").matches;if(t.key==="Enter"){if(t.isComposing||t.keyCode===229)return;(a&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),T?yt(T):pt())}},ref:f}),e.jsx("button",{onClick:t=>{t.preventDefault(),T?yt(T):pt()},disabled:T?je===T:!xe.trim(),className:"bg-gradient-to-r from-blue-600 to-purple-700 text-white w-12 h-12 rounded-full shadow-lg hover:from-blue-700 hover:to-purple-800 hover:shadow-xl transform hover:scale-110 transition-all duration-300 disabled:opacity-50 disabled:transform-none flex items-center justify-center hover:shadow-2xl active:scale-95 group",children:T?je===T?e.jsx(Ct,{className:"text-lg text-white animate-editSaving"}):e.jsx(Ct,{className:"text-lg text-white group-hover:scale-110 transition-transform duration-200"}):e.jsx("div",{className:"relative",children:ps?e.jsx(Ze,{className:"text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon animate-sent"}):e.jsx(Ws,{className:`text-lg text-white group-hover:scale-110 transition-all duration-300 send-icon ${gt?"animate-fly":""}`})})})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(20px) scale(0.95); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes gentlePulse {
                    0%, 100% { opacity: 1; transform: scale(1); }
                    50% { opacity: 0.9; transform: scale(1.01); }
                  }
                  .animate-gentlePulse {
                    animation: gentlePulse 3s ease-in-out infinite;
                  }
                  @keyframes attentionGlow {
                    0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
                    50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
                  }
                  .animate-attentionGlow {
                    animation: attentionGlow 2s ease-in-out infinite;
                  }
                  @keyframes slideInFromTop {
                    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-slideInFromTop {
                    animation: slideInFromTop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
                  }
                  @keyframes sendIconFly {
                    0% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                    20% { 
                      transform: translate(0, 0) scale(1.2); 
                      opacity: 1;
                    }
                    40% { 
                      transform: translate(15px, -20px) scale(1.3); 
                      opacity: 0.8;
                    }
                    60% { 
                      transform: translate(25px, -35px) scale(1.4); 
                      opacity: 0.6;
                    }
                    80% { 
                      transform: translate(15px, -20px) scale(1.2); 
                      opacity: 0.8;
                    }
                    100% { 
                      transform: translate(0, 0) scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-fly {
                    animation: sendIconFly 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes sentSuccess {
                    0% { 
                      transform: scale(0.8); 
                      opacity: 0;
                    }
                    50% { 
                      transform: scale(1.2); 
                      opacity: 1;
                    }
                    100% { 
                      transform: scale(1); 
                      opacity: 1;
                    }
                  }
                  .send-icon.animate-sent {
                    animation: sentSuccess 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                  }
                  @keyframes editSaving {
                    0% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                    20% { 
                      transform: scale(1.15) rotate(-8deg) translate(-1px, -1px); 
                      opacity: 0.9;
                    }
                    40% { 
                      transform: scale(1.25) rotate(0deg) translate(0, -2px); 
                      opacity: 1;
                    }
                    60% { 
                      transform: scale(1.15) rotate(8deg) translate(1px, -1px); 
                      opacity: 0.9;
                    }
                    80% { 
                      transform: scale(1.1) rotate(-4deg) translate(-1px, 0); 
                      opacity: 0.95;
                    }
                    100% { 
                      transform: scale(1) rotate(0deg) translate(0, 0); 
                      opacity: 1;
                    }
                  }
                  .animate-editSaving {
                    animation: editSaving 1.2s ease-in-out infinite;
                  }
                `})]}),!P&&!K&&!T&&!ue&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:Ms,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:C>0?`${C} new message${C>1?"s":""}`:"Scroll to bottom","aria-label":C>0?`${C} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),C>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:C>99?"99+":C})]})})]})}),Ve&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(B,{className:"text-red-500"}),"Delete Message"]}),_!=null&&_.deleted?e.jsx("p",{className:"text-gray-600 mb-6",children:"Delete this message for me?"}):(_==null?void 0:_.senderEmail)===c.email?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:Ge,onChange:t=>Se(t.target.checked),className:"form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Also delete for"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(m==null?void 0:m.username)||"other user"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-7",children:Ge?"The message will be permanently deleted for everyone":"The message will only be deleted for you"})]})]}):e.jsxs("p",{className:"text-gray-600 mb-6",children:["Delete message from"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(m==null?void 0:m.username)||"other user"}),"?"]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{re(!1),ie(null),Se(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Ns,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(B,{size:12}),_!=null&&_.deleted?"Delete for me":(_==null?void 0:_.senderEmail)===c.email&&Ge?"Delete for everyone":"Delete for me"]})]})]})}),rs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(B,{className:"text-red-500"}),"Clear Chat"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear chat? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>nt(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Cs,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(B,{size:12}),"Clear Chat"]})]})]})}),os&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(B,{className:"text-red-500"}),"Delete Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for deletion (required):"}),e.jsx("textarea",{value:fs,onChange:t=>Et(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for deleting this appointment..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ds(!1),ft(null),Et("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmAdminDelete,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(B,{size:12}),"Delete Appointment"]})]})]})}),cs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(At,{className:"text-blue-500"}),"Archive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ms(!1),ft(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmArchive,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(At,{size:12}),"Archive"]})]})]})}),us&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(kt,{className:"text-green-500"}),"Unarchive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{xs(!1),ft(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmUnarchive,className:"px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(kt,{size:12}),"Unarchive"]})]})]})}),ct&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ze,{className:"text-orange-500"}),"Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:ke,onChange:t=>oe(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",rows:"3",placeholder:J?"Please provide a reason for cancelling...":"Optional reason for cancelling..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{mt(!1),oe("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Is,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2",children:[e.jsx(ze,{size:12}),"Cancel Appointment"]})]})]})}),hs&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ze,{className:"text-red-500"}),"Admin Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment as admin?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for admin cancellation (required):"}),e.jsx("textarea",{value:ke,onChange:t=>oe(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for admin cancellation..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ut(!1),oe("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Ts,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(ze,{size:12}),"Cancel as Admin"]})]})]})}),xt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(B,{className:"text-red-500"}),"Remove Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to permanently remove this appointment from your table? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>ht(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Rs,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(B,{size:12}),"Remove Permanently"]})]})]})}),is&&ot&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(ts,{className:"text-red-500"})," Report message"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason"}),e.jsxs("select",{value:We,onChange:t=>rt(t.target.value),className:"w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900",children:[e.jsx("option",{value:"",children:"-- Select a reason --"}),e.jsx("option",{value:"Spam or scam",children:"Spam or scam"}),e.jsx("option",{value:"Harassment or hate speech",children:"Harassment or hate speech"}),e.jsx("option",{value:"Inappropriate content",children:"Inappropriate content"}),e.jsx("option",{value:"Sensitive or personal data",children:"Sensitive or personal data"}),e.jsx("option",{value:"Fraud or illegal activity",children:"Fraud or illegal activity"}),e.jsx("option",{value:"Other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional details (optional)"}),e.jsx("textarea",{value:Dt,onChange:t=>it(t.target.value),rows:4,placeholder:"Add any context to help admins review...",className:"w-full p-2 border border-gray-300 rounded resize-y focus:outline-none focus:ring-2 focus:ring-red-500 text-gray-900"})]}),e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Message excerpt:"}),e.jsx("div",{className:"line-clamp-4 whitespace-pre-wrap",children:(ot.message||"").slice(0,300)})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>{lt(!1),dt(null),rt(""),it("")},className:"px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(!We){g.error("Please select a reason");return}Rt(!0);try{const t=await fetch(`${E}/api/notifications/report-chat`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({appointmentId:s._id,commentId:ot._id,reason:We,details:Dt})}),a=await t.json();t.ok?(g.info("Thank you for reporting."),lt(!1),dt(null),rt(""),it("")):g.error(a.message||"Failed to submit report")}catch{g.error("Network error while reporting")}finally{Rt(!1)}},disabled:Tt||!We,className:"px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-50",children:Tt?"Reportingâ€¦":"Report"})]})]})}),bs&&Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(es,{className:"text-blue-500"})," Message Info"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 rounded p-3 text-sm text-gray-700",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Message:"}),e.jsxs("div",{className:"whitespace-pre-wrap break-words",children:[(Y.message||"").slice(0,200),(Y.message||"").length>200?"...":""]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Sent:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Y.timestamp).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),Y.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Delivered:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Y.deliveredAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),Y.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Read:"}),e.jsx("span",{className:"text-sm text-gray-800",children:new Date(Y.readAt).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0})})]}),!Y.deliveredAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-gray-500",children:"Not delivered yet"})]}),Y.deliveredAt&&!Y.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-blue-600",children:"Delivered"})]}),Y.readAt&&e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsx("span",{className:"text-sm text-green-600",children:"Read"})]})]})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:()=>{Ft(!1),Bt(null)},className:"px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700",children:"Close"})})]})})]})}export{Zs as default};
