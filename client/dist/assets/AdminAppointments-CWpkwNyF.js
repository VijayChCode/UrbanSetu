import{g as gt,r as m,v as J,j as e,L as tt,a3 as ft,P as ne,a4 as ve,a5 as bt,G as yt,U as pt,a6 as he,a7 as jt,f as vt,a8 as wt,a9 as Nt,y as b,a1 as p,aa as je,ab as Ct,E as xe,C as St,z as Be,ac as Xe,H as Ze}from"./index-NqD0ZT7S.js";const _="https://urbansetu.onrender.com";function At(){const{currentUser:s}=gt(r=>r.user),[h,D]=m.useState([]),[le,O]=m.useState([]),[we,G]=m.useState(!0),[B,Ne]=m.useState("all"),[T,Ce]=m.useState(""),[S,Se]=m.useState(null),[ke,K]=m.useState(!1),[Ae,Y]=m.useState(!1),[L,Ie]=m.useState(!1),[P,_e]=m.useState(""),[H,De]=m.useState(""),[k,x]=m.useState(null),[N,z]=m.useState(""),[M,q]=m.useState(!1),[ie,C]=m.useState(!1),[V,E]=m.useState(!1),[U,W]=m.useState(!1);m.useEffect(()=>{const r=async()=>{try{const w=await(await fetch(`${_}/api/bookings`,{credentials:"include"})).json();D(w),G(!1)}catch(a){console.error("Failed to fetch appointments",a),G(!1)}},i=async()=>{try{const w=await(await fetch(`${_}/api/bookings/archived`,{credentials:"include"})).json();O(w)}catch(a){console.error("Failed to fetch archived appointments",a)}};r(),i();const d=setInterval(()=>{r(),i()},5e3),c=a=>{D(w=>w.map(g=>{const y={...g};return g.buyerId&&(g.buyerId._id===a.userId||g.buyerId===a.userId)&&(y.buyerId={...y.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),g.sellerId&&(g.sellerId._id===a.userId||g.sellerId===a.userId)&&(y.sellerId={...y.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),y})),O(w=>w.map(g=>{const y={...g};return g.buyerId&&(g.buyerId._id===a.userId||g.buyerId===a.userId)&&(y.buyerId={...y.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),g.sellerId&&(g.sellerId._id===a.userId||g.sellerId===a.userId)&&(y.sellerId={...y.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),y}))};return J.on("profileUpdated",c),()=>{clearInterval(d),J.off("profileUpdated",c)}},[]),m.useEffect(()=>{s&&(D(r=>r.map(i=>{const d={...i};return i.buyerId&&(i.buyerId._id===s._id||i.buyerId===s._id)&&(d.buyerId={...d.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),i.sellerId&&(i.sellerId._id===s._id||i.sellerId===s._id)&&(d.sellerId={...d.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),d})),O(r=>r.map(i=>{const d={...i};return i.buyerId&&(i.buyerId._id===s._id||i.buyerId===s._id)&&(d.buyerId={...d.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),i.sellerId&&(i.sellerId._id===s._id||i.sellerId===s._id)&&(d.sellerId={...d.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),d})))},[s]);const oe=async r=>{x(r),z(""),q(!0)},Q=async()=>{if(!N.trim()){b.error("Please provide a reason for cancelling this appointment.");return}try{console.log("Attempting to cancel appointment:",k),console.log("Current user:",s),console.log("User role:",s.role),console.log("Admin approval status:",s.adminApprovalStatus);const r=h.find(c=>c._id===k);r&&(console.log("Current appointment status:",r.status),console.log("Appointment date:",r.date),console.log("Appointment time:",r.time));const i=await fetch(`${_}/api/bookings/${k}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:N})});console.log("Response status:",i.status);const d=await i.json();console.log("Response data:",d),i.ok?(D(c=>c.map(a=>a._id===k?{...a,status:"cancelledByAdmin",cancelReason:N}:a)),b.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):b.error(d.message||"Failed to cancel appointment."),q(!1),x(null),z("")}catch(r){console.error("Error in confirmAdminCancel:",r),b.error("An error occurred. Please try again.")}},te=async r=>{x(r),C(!0)},v=async()=>{try{console.log("Attempting to reinitiate appointment:",k);const r=await fetch(`${_}/api/bookings/${k}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",r.status);const i=await r.json();console.log("Response data:",i),r.ok?(D(d=>d.map(c=>c._id===k?{...c,status:"pending",cancelReason:""}:c)),b.success("Appointment reinitiated successfully. Both buyer and seller have been notified.")):b.error(i.message||"Failed to reinitiate appointment."),C(!1),x(null)}catch(r){console.error("Error in confirmReinitiate:",r),b.error("An error occurred. Please try again.")}},se=async r=>{x(r),E(!0)},ge=async()=>{try{const r=await fetch(`${_}/api/bookings/${k}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),i=await r.json();if(r.ok){const d=h.find(c=>c._id===k);d&&(D(c=>c.filter(a=>a._id!==k)),O(c=>[{...d,archivedByAdmin:!0,archivedAt:new Date},...c])),b.success("Appointment archived successfully.")}else b.error(i.message||"Failed to archive appointment.");E(!1),x(null)}catch(r){console.error("Error in confirmArchive:",r),b.error("An error occurred. Please try again.")}},re=async r=>{x(r),W(!0)},de=async()=>{try{const r=await fetch(`${_}/api/bookings/${k}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),i=await r.json();if(r.ok){const d=le.find(c=>c._id===k);d&&(O(c=>c.filter(a=>a._id!==k)),D(c=>[{...d,archivedByAdmin:!1,archivedAt:void 0},...c])),b.success("Appointment unarchived successfully.")}else b.error(i.message||"Failed to unarchive appointment.");W(!1),x(null)}catch(r){console.error("Error in confirmUnarchive:",r),b.error("An error occurred. Please try again.")}},ce=async r=>{if(!r){b.error("User ID not available");return}Y(!0),K(!0);try{const i=await fetch(`${_}/api/user/id/${r}`),d=await i.json();i.ok?Se(d):(b.error("Failed to fetch user details."),K(!1))}catch{b.error("An error occurred while fetching user details."),K(!1)}Y(!1)},fe=h.filter(r=>{var w,g,y,X,A,F,$,Z,ee;const i=new Date(r.date)<new Date||new Date(r.date).toDateString()===new Date().toDateString()&&r.time&&r.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),d=B==="all"?!0:B==="outdated"?i:r.status===B,c=((g=(w=r.buyerId)==null?void 0:w.email)==null?void 0:g.toLowerCase().includes(T.toLowerCase()))||((X=(y=r.sellerId)==null?void 0:y.email)==null?void 0:X.toLowerCase().includes(T.toLowerCase()))||((A=r.propertyName)==null?void 0:A.toLowerCase().includes(T.toLowerCase()))||(($=(F=r.buyerId)==null?void 0:F.username)==null?void 0:$.toLowerCase().includes(T.toLowerCase()))||((ee=(Z=r.sellerId)==null?void 0:Z.username)==null?void 0:ee.toLowerCase().includes(T.toLowerCase()));let a=!0;return P&&(a=a&&new Date(r.date)>=new Date(P)),H&&(a=a&&new Date(r.date)<=new Date(H)),d&&c&&a}),ae=le.filter(r=>{var w,g,y,X,A,F,$,Z,ee;const i=new Date(r.date)<new Date||new Date(r.date).toDateString()===new Date().toDateString()&&r.time&&r.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),d=B==="all"?!0:B==="outdated"?i:r.status===B,c=((g=(w=r.buyerId)==null?void 0:w.email)==null?void 0:g.toLowerCase().includes(T.toLowerCase()))||((X=(y=r.sellerId)==null?void 0:y.email)==null?void 0:X.toLowerCase().includes(T.toLowerCase()))||((A=r.propertyName)==null?void 0:A.toLowerCase().includes(T.toLowerCase()))||(($=(F=r.buyerId)==null?void 0:F.username)==null?void 0:$.toLowerCase().includes(T.toLowerCase()))||((ee=(Z=r.sellerId)==null?void 0:Z.username)==null?void 0:ee.toLowerCase().includes(T.toLowerCase()));let a=!0;return P&&(a=a&&new Date(r.date)>=new Date(P)),H&&(a=a&&new Date(r.date)<=new Date(H)),d&&c&&a}),be=async()=>{G(!0);try{const r=await fetch(`${_}/api/bookings`,{credentials:"include"});if(r.ok){const d=await r.json();D(d)}const i=await fetch(`${_}/api/bookings/archived`,{credentials:"include"});if(i.ok){const d=await i.json();O(Array.isArray(d)?d:[])}}catch{}finally{G(!1)}};return we?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(h)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(ft,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:L?"Archived Appointments":"All Appointments (Admin View)"}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:be,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>Ie(!L),className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${L?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:L?e.jsxs(e.Fragment,{children:[e.jsx(ne,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{})," ",e.jsxs("span",{children:["Archived Appointments (",le.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:L?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments. 💡 Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:B,onChange:r=>Ne(r.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:P,onChange:r=>_e(r.target.value),max:H||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:H,onChange:r=>De(r.target.value),min:P||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bt,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:T,onChange:r=>Ce(r.target.value)})]})]}),L?ae.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:ae.map(r=>e.jsx(et,{appt:r,currentUser:s,handleAdminCancel:oe,handleReinitiateAppointment:te,handleArchiveAppointment:se,handleUnarchiveAppointment:re,onUserClick:ce,isArchived:!0,showCancelModal:M,setShowCancelModal:q,showReinitiateModal:ie,setShowReinitiateModal:C,showArchiveModal:V,setShowArchiveModal:E,showUnarchiveModal:U,setShowUnarchiveModal:W,appointmentToHandle:k,setAppointmentToHandle:x,cancelReason:N,setCancelReason:z,confirmAdminCancel:Q,confirmReinitiate:v,confirmArchive:ge,confirmUnarchive:de},r._id))})]})}):fe.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:fe.map(r=>e.jsx(et,{appt:r,currentUser:s,handleAdminCancel:oe,handleReinitiateAppointment:te,handleArchiveAppointment:se,handleUnarchiveAppointment:re,onUserClick:ce,isArchived:!1,showCancelModal:M,setShowCancelModal:q,showReinitiateModal:ie,setShowReinitiateModal:C,showArchiveModal:V,setShowArchiveModal:E,showUnarchiveModal:U,setShowUnarchiveModal:W,appointmentToHandle:k,setAppointmentToHandle:x,cancelReason:N,setCancelReason:z,confirmAdminCancel:Q,confirmReinitiate:v,confirmArchive:ge,confirmUnarchive:de},r._id))})]})})]}),ke&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>K(!1),title:"Close","aria-label":"Close",children:e.jsx(yt,{className:"w-4 h-4"})}),Ae?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-4 text-gray-600",children:"Loading user details..."})]}):S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(pt,{user:{username:S.username,avatar:S.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:S.role==="admin"||S.role==="rootadmin"?e.jsx(he,{className:"w-3 h-3 text-white"}):e.jsx(jt,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[S.username,(S.role==="admin"||S.role==="rootadmin")&&e.jsx(he,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:S.role||"User"}),S.adminApprovalStatus&&e.jsx("p",{className:`text-xs font-medium px-2 py-1 rounded-full ${S.adminApprovalStatus==="approved"?"bg-green-100 text-green-700":S.adminApprovalStatus==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:S.adminApprovalStatus})]})]})]})}),e.jsxs("div",{className:"px-6 py-6 space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(vt,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:S.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(wt,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:S.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Nt,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:new Date(S.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]})]}),e.jsx("button",{onClick:()=>K(!1),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold",children:"Close"})]})]}):e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-gray-600",children:"User not found"})})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(tt,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function Me(s){const h=new Date,D=new Date;return D.setDate(h.getDate()-1),s.toDateString()===h.toDateString()?"Today":s.toDateString()===D.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function et({appt:s,currentUser:h,handleAdminCancel:D,handleReinitiateAppointment:le,handleArchiveAppointment:O,handleUnarchiveAppointment:we,onUserClick:G,isArchived:B,showCancelModal:Ne,setShowCancelModal:T,showReinitiateModal:Ce,setShowReinitiateModal:S,showArchiveModal:Se,setShowArchiveModal:ke,showUnarchiveModal:K,setShowUnarchiveModal:Ae,appointmentToHandle:Y,setAppointmentToHandle:L,cancelReason:Ie,setCancelReason:P,confirmAdminCancel:_e,confirmReinitiate:H,confirmArchive:De,confirmUnarchive:k}){var Oe,He,Ve,Je,Ge,Ke;const[x,N]=m.useState(s.comments||[]),[z,M]=m.useState(""),[q,ie]=m.useState(!1),[C,V]=m.useState(null),[E,U]=m.useState(""),[W,oe]=m.useState(null),[Q,te]=m.useState(null),[v,se]=m.useState(!1),[ge,re]=m.useState(!1),[de,ce]=m.useState(""),[fe,ae]=m.useState(!1),[be,r]=m.useState(null),[i,d]=m.useState(!1),c=p.useRef(null),a=p.useRef(null),w=p.useRef(null),g=p.useRef({}),[y,X]=m.useState(!0),[A,F]=m.useState(0),[$,Z]=m.useState(""),[ee,Re]=m.useState(!1),[ye,Le]=m.useState(!1),[st,Fe]=m.useState(()=>mt(s._id)),me=p.useRef(null);p.useEffect(()=>{if(ye){const t=setTimeout(()=>{Le(!1)},1e4);return()=>clearTimeout(t)}},[ye]),p.useEffect(()=>{v&&c.current&&c.current.scrollIntoView({behavior:"smooth"})},[v]);const $e=p.useRef(x.length),rt=p.useRef(x);p.useEffect(()=>{const t=x.slice($e.current),n=t.length;if($e.current=x.length,rt.current=x,n>0&&v){const l=t.some(o=>o.senderEmail===h.email),u=t.filter(o=>o.senderEmail!==h.email);l||y?setTimeout(()=>{c.current&&c.current.scrollIntoView({behavior:"smooth"})},100):u.length>0&&F(o=>o+u.length)}},[x.length,y,v,h.email]),p.useEffect(()=>{F(0)},[v]);const Te=p.useCallback(()=>{if(!a.current||x.length===0)return;const n=a.current.getBoundingClientRect(),l=n.top+60;let u="";for(let o=0;o<x.length;o++){const f=g.current[x[o]._id];if(f){const j=f.getBoundingClientRect();if(j.top>=l&&j.bottom<=n.bottom){const I=new Date(x[o].timestamp);u=Me(I);break}}}if(!u)for(let o=0;o<x.length;o++){const f=g.current[x[o]._id];if(f&&f.getBoundingClientRect().bottom>l){const I=new Date(x[o].timestamp);u=Me(I);break}}u&&u!==$&&Z(u)},[x,$]),pe=p.useCallback(async()=>{const t=x.filter(n=>{var l;return!((l=n.readBy)!=null&&l.includes(h._id))&&n.senderEmail!==h.email});if(t.length>0)try{(await fetch(`${_}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(N(l=>l.map(u=>t.some(o=>o._id===u._id)?{...u,readBy:[...u.readBy||[],h._id],status:"read"}:u)),t.forEach(l=>{J.emit("messageRead",{appointmentId:s._id,messageId:l._id,userId:h._id})}))}catch(n){console.error("Error marking messages as read:",n)}},[x,h._id,s._id,J]),Ee=p.useCallback(()=>{if(a.current){const{scrollTop:t,scrollHeight:n,clientHeight:l}=a.current,u=n-t-l<5;X(u),u&&A>0&&(F(0),pe())}},[A,pe]);p.useEffect(()=>{const t=a.current;if(t&&v){const n=()=>{Ee(),Te(),Re(!0),me.current&&clearTimeout(me.current),me.current=setTimeout(()=>{Re(!1)},1e3)};return t.addEventListener("scroll",n),Ee(),setTimeout(Te,100),()=>{t.removeEventListener("scroll",n),me.current&&clearTimeout(me.current)}}},[v,Ee,Te]);const at=p.useCallback(()=>{c.current&&(c.current.scrollIntoView({behavior:"smooth"}),F(0),setTimeout(()=>{pe()},500))},[pe]);p.useEffect(()=>(v?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[v]),p.useEffect(()=>{function t(n){n.appointmentId===s._id&&!v&&b.custom(l=>e.jsxs("div",{className:"bg-blue-600 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2 animate-bounce-in",children:[e.jsx(je,{})," New message from ",n.comment.senderEmail||"User",e.jsx("button",{onClick:()=>{se(!0),b.dismiss(l.id)},className:"ml-4 bg-white text-blue-700 px-2 py-1 rounded",children:"Open Chat"})]}))}return J.on("commentUpdate",t),()=>{J.off("commentUpdate",t)}},[s._id,v]),p.useEffect(()=>{function t(n){n.appointmentId===s._id&&(N(l=>{const u=l.findIndex(o=>o._id===n.comment._id);if(u!==-1){const o=[...l],f=l[u],j=n.comment;let I=j.status;return f.status==="read"&&j.status!=="read"&&(I="read"),o[u]={...j,status:I},o}else return!l.some(f=>f._id.toString().startsWith("temp-"))||n.comment.senderEmail!==h.email?[...l,n.comment]:l}),v&&n.comment.senderEmail!==h.email&&(setTimeout(()=>{fetch(`${_}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"})},100),setTimeout(()=>{c.current&&y&&c.current.scrollIntoView({behavior:"smooth"})},50)))}return J.on("commentUpdate",t),()=>{J.off("commentUpdate",t)}},[s._id,N,v,h.email,y]),p.useEffect(()=>{if(!v)return;const t=n=>{var l;n.ctrlKey&&n.key==="f"&&(n.preventDefault(),(l=w.current)==null||l.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[v]);const Pe=async()=>{if(!z.trim())return;const t=z.trim(),n=Q,l=`temp-${Date.now()}`,u={_id:l,sender:h._id,senderEmail:h.email,senderName:h.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[h._id],...n?{replyTo:n._id}:{}};N(o=>[...o,u]),M(""),te(null),ie(!0),setTimeout(()=>{c.current&&c.current.scrollIntoView({behavior:"smooth"})},50);try{const o=await fetch(`${_}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...n?{replyTo:n._id}:{}})}),f=await o.json();if(o.ok){const j=f.comments[f.comments.length-1];N(I=>I.map(ue=>ue._id===l?{...j,status:"sent"}:ue))}else N(j=>j.filter(I=>I._id!==l)),M(t),b.error(f.message||"Failed to send message.")}catch{N(f=>f.filter(j=>j._id!==l)),M(t),b.error("An error occurred. Please try again.")}finally{ie(!1)}},ze=async t=>{if(!E.trim())return;oe(t),N(l=>l.map(u=>u._id===t?{...u,message:E,edited:!0,editedAt:new Date}:u)),V(null),U(""),M("");try{const l=await fetch(`${_}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:E})}),u=await l.json();l.ok?(N(o=>o.map(f=>{const j=u.comments.find(I=>I._id===f._id);return j?j._id===t?j:f.status==="read"&&j.status!=="read"?{...j,status:"read"}:j:f})),b.success("Message edited successfully!")):(N(o=>o.map(f=>f._id===t?{...f,message:f.originalMessage||f.message,edited:f.wasEdited||!1}:f)),V(t),U(E),M(E),b.error(u.message||"Failed to edit message."))}catch{N(u=>u.map(o=>o._id===t?{...o,message:o.originalMessage||o.message,edited:o.wasEdited||!1}:o)),V(t),U(E),M(E),b.error("An error occurred. Please try again.")}finally{oe(null)}},nt=t=>{V(t._id),U(t.message),M(t.message),N(n=>n.map(l=>l._id===t._id?{...l,originalMessage:l.message,wasEdited:l.edited}:l)),setTimeout(()=>{w.current&&(w.current.focus(),w.current.select())},100)},Ue=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),lt=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},it=()=>{re(!0),ce("")},ot=async t=>{t.preventDefault(),d(!0);try{const n=await fetch(`${_}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:de})}),l=await n.json();n.ok&&l.success?(re(!1),se(!0)):b.error("Incorrect password. Please try again.")}catch{b.error("Failed to verify password. Please try again.")}d(!1)},dt=t=>{r(t),ae(!0)},ct=async()=>{if(be){try{const t=await fetch(`${_}/api/bookings/${s._id}/comment/${be._id}`,{method:"DELETE",credentials:"include"}),n=await t.json();t.ok?(N(n.comments),b.success("Message deleted successfully!")):b.error(n.message||"Failed to delete message.")}catch{b.error("An error occurred. Please try again.")}ae(!1),r(null)}};function mt(t){try{return JSON.parse(localStorage.getItem(`hiddenDeletedMsgs_${t}`))||[]}catch{return[]}}const ut=p.useCallback(t=>{Fe(n=>{if(!n.includes(t)){const l=[...n,t];return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${s._id}`,JSON.stringify(l))},0),l}return n})},[s._id]),xt=p.useCallback(t=>{Fe(n=>{const l=n.filter(u=>u!==t);return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${s._id}`,JSON.stringify(l))},0),l})},[s._id]);return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${B?"bg-gray-50":""} ${Ue?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!Ue&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),B&&s.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(s.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(tt,{to:`/admin/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return G((t=s.buyerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((Oe=s.buyerId)==null?void 0:Oe.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((He=s.buyerId)==null?void 0:He.email)||s.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((Ve=s.buyerId)==null?void 0:Ve.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return G((t=s.sellerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((Je=s.sellerId)==null?void 0:Je.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(Ge=s.sellerId)==null?void 0:Ge.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((Ke=s.sellerId)==null?void 0:Ke.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${lt(s.status)}`,children:s.status==="deletedByAdmin"?"Deleted by Admin":s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)}),s.status==="deletedByAdmin"&&s.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',s.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:B?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>we(s._id),title:"Unarchive Appointment",children:[e.jsx(ne,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[s.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>le(s._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(he,{})," Reinitiate"]}):s.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>D(s._id),title:"Cancel Appointment (Admin)",children:[e.jsx(he,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>O(s._id),title:"Archive Appointment",children:[e.jsx(ve,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsx("button",{className:"flex items-center justify-center bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full p-2 shadow-md mx-auto relative",title:"Open Chat",onClick:it,children:e.jsx(je,{size:20})}),ge&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl",onClick:()=>re(!1),title:"Close",children:"×"}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(he,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:ot,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:de,onChange:t=>ce(t.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:i,children:i?"Verifying...":"Unlock Chat"})]})]})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 rounded-2xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-200 to-purple-200 rounded-t-2xl relative",children:[e.jsx(je,{className:"text-blue-600 text-xl"}),e.jsx("h3",{className:"text-lg font-bold text-blue-800",children:"Chat"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>Le(!ye),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(Ct,{className:"text-sm"})}),ye&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>se(!1),title:"Close","aria-label":"Close",children:"×"})]})]}),e.jsxs("div",{ref:a,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[$&&x.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${ee?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:$})})}),x.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(je,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start a conversation to communicate with the parties"})]}):x.map((t,n)=>{var I,ue;const l=t.senderEmail===h.email,u=C===t._id,o=new Date(t.timestamp),f=n>0?new Date(x[n-1].timestamp):null,j=f?o.toDateString()!==f.toDateString():!0;return e.jsxs(p.Fragment,{children:[j&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Me(o)})}),e.jsx("div",{className:`flex w-full ${l?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*n}s`},children:e.jsxs("div",{ref:R=>g.current[t._id]=R,className:`rounded-2xl px-4 py-2 text-sm shadow-lg max-w-[80%] break-words relative ${l?"bg-gradient-to-r from-blue-400 to-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-blue-300 pl-2 mb-1 text-xs text-gray-500 bg-blue-50 rounded w-full max-w-full break-words cursor-pointer",onClick:()=>{g.current[t.replyTo]&&(g.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),g.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{g.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsx("span",{className:"text-xs text-gray-600 truncate",children:((I=x.find(R=>R._id===t.replyTo))==null?void 0:I.message)||"Original message"})}),e.jsxs("div",{className:"font-semibold mb-1 flex items-center gap-2 justify-start text-left",children:[e.jsx("span",{className:"truncate max-w-[60%] min-w-[80px] inline-block align-middle overflow-hidden text-ellipsis text-left",children:l?"You":(()=>{var Ye,qe,We,Qe;const R=t.senderEmail===((Ye=s.buyerId)==null?void 0:Ye.email),ht=t.senderEmail===((qe=s.sellerId)==null?void 0:qe.email);return R?((We=s.buyerId)==null?void 0:We.username)||t.senderName||t.senderEmail:ht?((Qe=s.sellerId)==null?void 0:Qe.username)||t.senderName||t.senderEmail:t.senderName||t.senderEmail})()}),e.jsx("span",{className:"text-gray-300 ml-2 text-[10px]",children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsx("div",{className:"text-left",children:t.deleted?(()=>{const R=st.includes(t._id);return h&&(h.role==="admin"||h.role==="rootadmin")?R?e.jsx("div",{className:"border border-gray-300 bg-gray-100 rounded p-2 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 text-xs",children:[e.jsx(xe,{className:"inline-block"}),e.jsx("span",{children:"Deleted message hidden from view"})]}),e.jsx("button",{className:"text-xs text-blue-500 hover:text-blue-700 underline",onClick:()=>xt(t._id),title:"Show this deleted message content",children:"Show"})]})}):e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(xe,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400",children:t.originalMessage?e.jsx("span",{children:t.originalMessage}):t.message?e.jsx("span",{children:t.message}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})}),!1,e.jsx("button",{className:"mt-2 text-xs text-red-500 hover:text-red-700 underline",onClick:()=>ut(t._id),title:"Hide this deleted message from your admin view",children:"Hide from admin view"})]}):e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(xe,{className:"inline-block text-lg"})," This message has been deleted."]})})():e.jsx("div",{children:u?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"✏️ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[t.message,t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-2 justify-end mt-1",children:[!t.deleted&&e.jsx("button",{className:`${t.senderEmail===h.email?"text-yellow-500 hover:text-yellow-700":"text-blue-600 hover:text-blue-800"}`,onClick:()=>{var R;te(t),(R=w.current)==null||R.focus()},title:"Reply",children:e.jsx("svg",{width:"18",height:"18",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),t.senderEmail===h.email&&!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>nt(t),className:"text-green-800 hover:text-green-950",title:"Edit comment",disabled:C!==null,children:e.jsx(St,{size:12})}),e.jsx("button",{className:"text-red-700 hover:text-red-900",onClick:()=>dt(t),title:"Delete comment",children:e.jsx(Be,{size:12})}),e.jsx("span",{className:"ml-1",children:(ue=t.readBy)!=null&&ue.some(R=>R!==h._id)?e.jsx(Xe,{className:"text-white inline",title:"Read"}):t.status==="delivered"?e.jsx(Xe,{className:"text-white/70 inline",title:"Delivered"}):t.status==="sending"?e.jsx(Ze,{className:"text-white/50 inline animate-pulse",title:"Sending..."}):e.jsx(Ze,{className:"text-white/70 inline",title:"Sent"})})]})]})]})})]},t._id||n)}),e.jsx("div",{ref:c})]}),Q&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsx("span",{className:"text-xs text-gray-600 truncate",children:Q.message}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700",onClick:()=>te(null),title:"Cancel reply",children:"×"})]})}),C&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"✏️ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:E}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700",onClick:()=>{V(null),U(""),M("")},title:"Cancel edit",children:"×"})]})}),e.jsxs("div",{className:"flex gap-2 mt-2 px-4 pb-4",children:[e.jsx("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-full text-sm focus:ring-2 focus:ring-blue-200 shadow",placeholder:C?"Edit your message...":"Type a message...",value:z,onChange:t=>{M(t.target.value),C&&U(t.target.value)},onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),C?ze(C):Pe())},ref:w}),e.jsx("button",{onClick:C?()=>ze(C):Pe,disabled:(C?W===C:q)||!z.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-full text-sm font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50 flex items-center gap-2 min-w-20",children:C?W===C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":q?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(10px) scale(0.98); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                }
              `}),!y&&!C&&!Q&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:at,className:"bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-all duration-200 hover:scale-110 relative",title:A>0?`${A} new message${A>1?"s":""}`:"Scroll to bottom","aria-label":A>0?`${A} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),A>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:A>99?"99+":A})]})})]})}),fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Be,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Delete Message"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to delete this message for everyone?"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ae(!1),r(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:ct,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Be,{size:14}),"Delete"]})]})]})})}),Ne&&Y===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(xe,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Cancel Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:Ie,onChange:t=>P(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for cancelling this appointment..."})]})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{T(!1),L(null),P("")},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:_e,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(xe,{size:14}),"Cancel Appointment"]})]})]})})}),Ce&&Y===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ne,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Reinitiate Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{S(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:H,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ne,{size:14}),"Reinitiate"]})]})]})})}),Se&&Y===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ve,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Archive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ke(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:De,className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(ve,{size:14}),"Archive"]})]})]})})}),K&&Y===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ne,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Unarchive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ae(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:k,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ne,{size:14}),"Unarchive"]})]})]})})})]})]})}export{At as default};
