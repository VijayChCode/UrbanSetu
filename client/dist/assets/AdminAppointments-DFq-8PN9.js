import{b as K,r as o,j as e,w as Y,x as q,y as Q,L as W,z as G,A as X,l as Z}from"./index-crh2KQ3K.js";function te(){const{currentUser:s}=K(t=>t.user),[p,j]=o.useState([]),[w,N]=o.useState([]),[R,A]=o.useState(!0),[m,$]=o.useState("all"),[c,y]=o.useState(""),[h,z]=o.useState(null),[U,f]=o.useState(!1),[C,v]=o.useState(!1),[u,H]=o.useState(!1),[b,M]=o.useState(""),[g,O]=o.useState("");o.useEffect(()=>{(async()=>{try{const r=await(await fetch("/api/bookings")).json();j(r),A(!1)}catch(n){console.error("Failed to fetch appointments",n),A(!1)}})()},[]),o.useEffect(()=>{(async()=>{try{const r=await(await fetch("/api/bookings/archived",{credentials:"include"})).json();N(r)}catch(n){console.error("Failed to fetch archived appointments",n)}})()},[]);const S=async t=>{const n=prompt("Please provide a reason for cancelling this appointment:");if(n&&window.confirm("Are you sure you want to cancel this appointment?"))try{console.log("Attempting to cancel appointment:",t),console.log("Current user:",s),console.log("User role:",s.role),console.log("Admin approval status:",s.adminApprovalStatus);const r=p.find(d=>d._id===t);r&&(console.log("Current appointment status:",r.status),console.log("Appointment date:",r.date),console.log("Appointment time:",r.time));const i=await fetch(`/api/bookings/${t}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:n})});console.log("Response status:",i.status);const l=await i.json();console.log("Response data:",l),i.ok?(j(d=>d.map(x=>x._id===t?{...x,status:"cancelledByAdmin",cancelReason:n}:x)),alert("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):alert(l.message||"Failed to cancel appointment.")}catch(r){console.error("Error in handleAdminCancel:",r),alert("An error occurred. Please try again.")}},k=async t=>{if(window.confirm("Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."))try{console.log("Attempting to reinitiate appointment:",t);const n=await fetch(`/api/bookings/${t}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",n.status);const r=await n.json();console.log("Response data:",r),n.ok?(j(i=>i.map(l=>l._id===t?{...l,status:"pending",cancelReason:""}:l)),alert("Appointment reinitiated successfully. Both buyer and seller have been notified.")):alert(r.message||"Failed to reinitiate appointment.")}catch(n){console.error("Error in handleReinitiateAppointment:",n),alert("An error occurred. Please try again.")}},B=async t=>{if(window.confirm("Are you sure you want to archive this appointment? It will be moved to the archived section."))try{const n=await fetch(`/api/bookings/${t}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),r=await n.json();if(n.ok){const i=p.find(l=>l._id===t);i&&(j(l=>l.filter(d=>d._id!==t)),N(l=>[{...i,archivedByAdmin:!0,archivedAt:new Date},...l])),alert("Appointment archived successfully.")}else alert(r.message||"Failed to archive appointment.")}catch(n){console.error("Error in handleArchiveAppointment:",n),alert("An error occurred. Please try again.")}},L=async t=>{if(window.confirm("Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."))try{const n=await fetch(`/api/bookings/${t}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),r=await n.json();if(n.ok){const i=w.find(l=>l._id===t);i&&(N(l=>l.filter(d=>d._id!==t)),j(l=>[{...i,archivedByAdmin:!1,archivedAt:void 0},...l])),alert("Appointment unarchived successfully.")}else alert(r.message||"Failed to unarchive appointment.")}catch(n){console.error("Error in handleUnarchiveAppointment:",n),alert("An error occurred. Please try again.")}},D=async t=>{if(!t){alert("User ID not available");return}v(!0),f(!0);try{const n=await fetch(`/api/user/id/${t}`),r=await n.json();n.ok?z(r):(alert("Failed to fetch user details."),f(!1))}catch{alert("An error occurred while fetching user details."),f(!1)}v(!1)},_=p.filter(t=>{var l,d,x,F,I,T,P,E,J;const n=m==="all"?!0:t.status===m,r=((d=(l=t.buyerId)==null?void 0:l.email)==null?void 0:d.toLowerCase().includes(c.toLowerCase()))||((F=(x=t.sellerId)==null?void 0:x.email)==null?void 0:F.toLowerCase().includes(c.toLowerCase()))||((I=t.propertyName)==null?void 0:I.toLowerCase().includes(c.toLowerCase()))||((P=(T=t.buyerId)==null?void 0:T.username)==null?void 0:P.toLowerCase().includes(c.toLowerCase()))||((J=(E=t.sellerId)==null?void 0:E.username)==null?void 0:J.toLowerCase().includes(c.toLowerCase()));let i=!0;return b&&(i=i&&new Date(t.date)>=new Date(b)),g&&(i=i&&new Date(t.date)<=new Date(g)),n&&r&&i}),a=w.filter(t=>{var i,l,d,x,F,I,T,P,E;const n=((l=(i=t.buyerId)==null?void 0:i.email)==null?void 0:l.toLowerCase().includes(c.toLowerCase()))||((x=(d=t.sellerId)==null?void 0:d.email)==null?void 0:x.toLowerCase().includes(c.toLowerCase()))||((F=t.propertyName)==null?void 0:F.toLowerCase().includes(c.toLowerCase()))||((T=(I=t.buyerId)==null?void 0:I.username)==null?void 0:T.toLowerCase().includes(c.toLowerCase()))||((E=(P=t.sellerId)==null?void 0:P.username)==null?void 0:E.toLowerCase().includes(c.toLowerCase()));let r=!0;return b&&(r=r&&new Date(t.date)>=new Date(b)),g&&(r=r&&new Date(t.date)<=new Date(g)),n&&r});return R?e.jsx("p",{className:"text-center mt-8 text-lg font-semibold text-blue-600 animate-pulse",children:"Loading appointments..."}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:u?"Archived Appointments":"All Appointments (Admin View)"}),e.jsx("button",{onClick:()=>H(!u),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-colors ${u?"bg-blue-500 text-white hover:bg-blue-600":"bg-gray-500 text-white hover:bg-gray-600"}`,children:u?e.jsxs(e.Fragment,{children:[e.jsx(Y,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{})," Archived Appointments (",w.length,")"]})})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:u?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:m,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:b,onChange:t=>M(t.target.value),max:g||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:g,onChange:t=>O(t.target.value),min:b||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:c,onChange:t=>y(t.target.value)})]})]}),u?a.filter(t=>m==="all"?!0:t.status===m).length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Comments"})]})}),e.jsx("tbody",{children:a.filter(t=>m==="all"?!0:t.status===m).map(t=>e.jsx(V,{appt:t,currentUser:s,handleAdminCancel:S,handleReinitiateAppointment:k,handleArchiveAppointment:B,handleUnarchiveAppointment:L,onUserClick:D,isArchived:!0},t._id))})]})}):_.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Comments"})]})}),e.jsx("tbody",{children:_.map(t=>e.jsx(V,{appt:t,currentUser:s,handleAdminCancel:S,handleReinitiateAppointment:k,handleArchiveAppointment:B,handleUnarchiveAppointment:L,onUserClick:D,isArchived:!1},t._id))})]})})]}),U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"User Details"}),C?e.jsx("p",{children:"Loading..."}):h?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Username:"})," ",h.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",h.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",h.mobileNumber||"Not provided"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Role:"})," ",h.role]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Admin Status:"})," ",h.adminApprovalStatus]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Created:"})," ",new Date(h.createdAt).toLocaleDateString()]})]}):e.jsx("p",{children:"User not found"}),e.jsx("button",{onClick:()=>f(!1),className:"mt-4 bg-blue-500 text-white px-4 py-2 rounded",children:"Close"})]})})]})}function V({appt:s,currentUser:p,handleAdminCancel:j,handleReinitiateAppointment:w,handleArchiveAppointment:N,handleUnarchiveAppointment:R,onUserClick:A,isArchived:m}){var S,k,B,L,D,_;const[$,c]=o.useState(s.comments||[]),[y,h]=o.useState(""),[z,U]=o.useState(!1),[f,C]=o.useState(null),[v,u]=o.useState("");console.log("Admin Appointment data:",s),console.log("Admin listingId:",s.listingId);const H=async()=>{if(y.trim()){U(!0);try{const a=await fetch(`/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:y})}),t=await a.json();a.ok?(c(t.comments),h("")):alert(t.message||"Failed to send comment.")}catch{alert("An error occurred. Please try again.")}U(!1)}},b=async a=>{if(v.trim())try{const t=await fetch(`/api/bookings/${s._id}/comment/${a}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:v})}),n=await t.json();t.ok?(c(n.comments),C(null),u("")):alert(n.message||"Failed to edit comment.")}catch{alert("An error occurred. Please try again.")}},M=a=>{C(a._id),u(a.message)},g=a=>a.senderEmail===(p==null?void 0:p.email),O=a=>{switch(a){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}};return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${m?"bg-gray-50":""}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),m&&s.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(s.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(W,{to:`/admin/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var a;return A((a=s.buyerId)==null?void 0:a._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((S=s.buyerId)==null?void 0:S.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((k=s.buyerId)==null?void 0:k.email)||s.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((B=s.buyerId)==null?void 0:B.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var a;return A((a=s.sellerId)==null?void 0:a._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((L=s.sellerId)==null?void 0:L.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(D=s.sellerId)==null?void 0:D.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((_=s.sellerId)==null?void 0:_.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${O(s.status)}`,children:s.status==="deletedByAdmin"?"Deleted by Admin":s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)}),s.status==="deletedByAdmin"&&s.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',s.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:m?e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl",onClick:()=>R(s._id),title:"Unarchive Appointment",children:e.jsx(Y,{})}):e.jsxs(e.Fragment,{children:[s.status==="cancelledByAdmin"?e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl",onClick:()=>w(s._id),title:"Reinitiate Appointment (Admin)",children:e.jsx(G,{})}):s.status!=="deletedByAdmin"?e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:()=>j(s._id),title:"Cancel Appointment (Admin)",children:e.jsx(G,{})}):null,e.jsx("button",{className:"text-orange-500 hover:text-orange-700 text-xl",onClick:()=>N(s._id),title:"Archive Appointment",children:e.jsx(q,{})})]})})}),e.jsxs("td",{className:"border p-2 min-w-[300px] max-w-[400px]",children:[s.status==="deletedByAdmin"?e.jsxs("div",{className:"text-center text-gray-500 text-sm",children:[e.jsx("div",{className:"mb-2",children:"This appointment has been deleted and commented by admin."}),s.adminComment&&e.jsxs("div",{className:"text-xs bg-gray-100 p-2 rounded",children:[e.jsx("strong",{children:"Admin Comment:"}),' "',s.adminComment,'"']})]}):s.status==="cancelledByAdmin"?e.jsxs("div",{className:"text-center text-red-500 text-sm",children:[e.jsx("div",{className:"mb-2",children:"This appointment has been cancelled by admin."}),s.cancelReason&&e.jsxs("div",{className:"text-xs bg-red-100 p-2 rounded border border-red-200",children:[e.jsx("strong",{children:"Cancellation Reason:"}),' "',s.cancelReason,'"']})]}):e.jsx("div",{className:"max-h-32 overflow-y-auto space-y-2",children:$.map((a,t)=>e.jsx("div",{className:"text-xs border-b pb-1",children:f===a._id?e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"text",className:"w-full px-2 py-1 border rounded text-xs",value:v,onChange:n=>u(n.target.value)}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b(a._id),className:"bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600",children:"Save"}),e.jsx("button",{onClick:()=>C(null),className:"bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600",children:"Cancel"})]})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("span",{className:"font-semibold text-blue-700",children:[a.senderEmail,":"]}),e.jsx("span",{className:"break-words",children:a.message}),e.jsx("div",{className:"text-gray-400 text-xs mt-1",children:new Date(a.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-2 flex-shrink-0",children:[g(a)&&e.jsx("button",{onClick:()=>M(a),className:"text-blue-600 hover:text-blue-800",title:"Edit comment",children:e.jsx(X,{size:12})}),e.jsx("button",{className:"text-red-500 hover:text-red-700",onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{const n=await fetch(`/api/bookings/${s._id}/comment/${a._id}`,{method:"DELETE",credentials:"include"}),r=await n.json();n.ok?c(r.comments):alert(r.message||"Failed to delete comment.")}catch{alert("An error occurred. Please try again.")}},title:"Delete comment",children:e.jsx(Z,{size:12})})]})]})},a._id||t))}),s.status!=="deletedByAdmin"&&s.status!=="cancelledByAdmin"&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("input",{type:"text",className:"flex-1 px-2 py-1 border rounded text-xs",placeholder:"Add a comment...",value:y,onChange:a=>h(a.target.value)}),e.jsx("button",{onClick:H,disabled:z||!y.trim(),className:"bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition disabled:opacity-50",children:"Send"})]})]})]})}export{te as default};
