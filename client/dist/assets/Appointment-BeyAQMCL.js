import{g as q,h as T,u as _,r as i,j as e,C as R,y as a}from"./index-CTi7rXfY.js";const v="https://urbansetu.onrender.com";function O(){const{currentUser:n}=q(o=>o.user),j=T(),g=_(),d=new URLSearchParams(j.search),l=d.get("listingId"),N=d.get("propertyName"),k=d.get("propertyDescription"),p=d.get("listingType"),[r,S]=i.useState({date:"",time:"",message:"",purpose:"",propertyName:N||"",propertyDescription:k||""}),[D,A]=i.useState(!1),[y,x]=i.useState(!1),[f,C]=i.useState(!1),[u,m]=i.useState(!1),[w,h]=i.useState(!0),c=o=>{S(s=>({...s,[o.target.name]:o.target.value}))};i.useEffect(()=>{async function o(){if(!n||!l){m(!1),h(!1);return}h(!0);try{const s=await fetch(`${v}/api/bookings/my`,{credentials:"include"});if(s.ok){const b=await s.json(),P=["pending","accepted"],B=b.find(t=>!t.listingId||t.listingId._id!==l&&t.listingId!==l||new Date(t.date)<new Date||new Date(t.date).toDateString()===new Date().toDateString()&&t.time&&t.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})?!1:!!(P.includes(t.status)||t.status==="cancelledByBuyer"&&t.buyerId&&(t.buyerId._id===n._id||t.buyerId===n._id)&&(t.buyerReinitiationCount||0)<2||t.status==="cancelledBySeller"&&t.sellerId&&(t.sellerId._id===n._id||t.sellerId===n._id)&&(t.sellerReinitiationCount||0)<2));m(!!B)}else m(!1)}catch{m(!1)}finally{h(!1)}}o()},[n,l]);const I=async o=>{if(o.preventDefault(),u){a.info("You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again.");return}if(!f){a.warning("You must agree to share your contact information with the seller to book an appointment.");return}if(!n){a.info("Please sign in to book an appointment."),g("/sign-in");return}if(!r.date||!r.time||!r.message||!r.purpose||!r.propertyName||!r.propertyDescription){a.warning("Please fill out all fields before booking the appointment.");return}if(!l){a.warning("Listing information is missing. Please try again.");return}x(!0);try{const s=await fetch(`${v}/api/bookings`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...r,listingId:l})}),b=await s.json();s.ok?(A(!0),setTimeout(()=>{n&&(n.role==="admin"||n.role==="rootadmin")?g("/admin/appointments"):g("/user/my-appointments")},2e3)):a.error(b.message||"Failed to book appointment.")}catch(s){console.error("Error booking appointment:",s),a.error("An error occurred. Please try again.")}finally{x(!1)}};return n?e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:[e.jsxs("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 mb-6 text-center drop-shadow",children:"Book Appointment"}),D?e.jsxs("div",{className:"text-center text-green-600 text-xl font-semibold py-10",children:["Appointment booked successfully!",e.jsx("br",{}),"The property owner will review your request.",e.jsx("br",{}),"Redirecting to your appointments..."]}):e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("input",{type:"date",name:"date",value:r.date,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0}),e.jsx("input",{type:"time",name:"time",value:r.time,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("select",{name:"purpose",value:r.purpose,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select Purpose"}),p==="rent"&&e.jsx("option",{value:"rent",children:"Rent"}),(p==="sale"||p==="buy")&&e.jsx("option",{value:"buy",children:"Buy"})]})}),e.jsx("input",{type:"text",name:"propertyName",value:r.propertyName,onChange:c,placeholder:"Property Name",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("textarea",{name:"propertyDescription",value:r.propertyDescription,onChange:c,placeholder:"Property Description",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"2",required:!0}),e.jsx("textarea",{name:"message",value:r.message,onChange:c,placeholder:"Tell us about your requirements...",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"4",required:!0}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{type:"checkbox",id:"agreement",checked:f,onChange:o=>C(o.target.checked),required:!0}),e.jsxs("label",{htmlFor:"agreement",className:"text-sm text-gray-700 select-none",children:["I understand that ",e.jsx("span",{className:"font-semibold text-blue-700",children:"my contact information and details will be shared with the seller"})," for this appointment."]})]}),e.jsx("div",{className:"flex justify-center mt-6",children:e.jsx("button",{type:"submit",className:"w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",disabled:y||!f||u||w,children:w?"Checking...":y?"Booking...":u?"Already Booked":"Book Appointment"})}),u&&e.jsx("div",{className:"text-red-600 text-sm mt-2 text-center font-semibold",children:"You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again."})]})]}),e.jsx(R,{})]}):e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-red-600 text-xl font-semibold py-10",children:"Please sign in to book an appointment."})})})}export{O as default};
