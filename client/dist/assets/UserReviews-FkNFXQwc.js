import{g as Y,r as n,w as g,j as e,aC as Z,y as d,z as ee,A as N,b as se,H as z,t as M}from"./index-Q0CPHuoJ.js";import{R as te}from"./ReviewForm-bV13e6u_.js";import{C as re}from"./ContactSupportWrapper-Cz_FObh8.js";const R="https://urbansetu.onrender.com";function ie(){const{currentUser:o}=Y(s=>s.user),[p,x]=n.useState([]),[h,f]=n.useState(!0),[S,U]=n.useState(""),[u,y]=n.useState(null),[C,B]=n.useState(""),[b,q]=n.useState(""),[H,j]=n.useState(!1),[i,v]=n.useState(null);n.useEffect(()=>{w()},[]),n.useEffect(()=>{const s=t=>{!o||t.userId!==o._id||x(l=>t.status==="removed"?l.map(r=>r._id===t._id?{...r,...t}:r):t._deleted?l.filter(r=>r._id!==t._id):l.map(r=>r._id===t._id?{...r,...t}:r))};g.on("reviewUpdated",s);const a=t=>{console.log("[UserReviews] Received profileUpdated socket event:",t),console.log("[UserReviews] Current reviews:",p.length),x(l=>{const r=l.map(m=>m.userId===t.userId?(console.log("[UserReviews] Updating review:",m._id,"for user:",t.userId),{...m,userName:t.username,userAvatar:t.avatar}):m);return console.log("[UserReviews] Updated reviews:",r.length),r})};return g.on("profileUpdated",a),console.log("[UserReviews] Socket listeners set up for profileUpdated"),()=>{g.off("reviewUpdated",s),g.off("profileUpdated",a),console.log("[UserReviews] Socket listeners cleaned up")}},[o]),n.useEffect(()=>{const s=setInterval(async()=>{if(o)try{const a=await fetch(`${R}/api/user/id/${o._id}`);if(a.ok){const t=await a.json();(t.username!==o.username||t.avatar!==o.avatar)&&(console.log("[UserReviews] Profile updated via polling:",t),x(l=>l.map(r=>r.userId===t._id?{...r,userName:t.username,userAvatar:t.avatar}:r)))}}catch(a){console.error("[UserReviews] Error polling for profile updates:",a)}},3e4);return()=>clearInterval(s)},[o]);const w=async()=>{try{f(!0),console.log("Fetching user reviews...");const s=await fetch(`${R}/api/review/user`,{credentials:"include"}),a=await s.json();console.log("Reviews data:",a),s.ok?x(a):U(a.message||"Failed to fetch reviews")}catch(s){console.error("Error fetching reviews:",s),U("Network error. Please try again.")}finally{f(!1)}},W=s=>{v(s),j(!0)},G=async()=>{if(i)try{const s=await fetch(`${R}/api/review/delete/${i._id}`,{method:"DELETE",credentials:"include"}),a=await s.json();s.ok?(x(p.filter(t=>t._id!==i._id)),d.success("Review deleted successfully")):d.error(a.message||"Failed to delete review")}catch{d.error("Network error. Please try again.")}finally{j(!1),v(null)}},J=s=>{y(s)},K=()=>{y(null),w(),d.success("Review updated successfully")},O=async()=>{try{f(!0),await w(),d.success("Reviews refreshed successfully")}catch{d.error("Failed to refresh reviews")}},I=s=>[...Array(5)].map((a,t)=>e.jsx(se,{className:`text-lg ${t<s?"text-yellow-400":"text-gray-300"}`},t)),k=s=>new Date(s).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),Q=s=>{if(!s)return e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:"Unknown"});const t={pending:{color:"bg-yellow-100 text-yellow-800",icon:M},approved:{color:"bg-green-100 text-green-800",icon:M},rejected:{color:"bg-red-100 text-red-800",icon:z},removed:{color:"bg-gray-100 text-gray-800",icon:z}}[s];if(!t)return e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:s.charAt(0).toUpperCase()+s.slice(1)});const l=t.icon;return e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${t.color}`,children:[e.jsx(l,{className:"mr-1"}),s.charAt(0).toUpperCase()+s.slice(1)]})},_=p.filter(s=>{var E,F,A,L,$,D,P,T;if(b&&s.status!==b)return!1;const a=((F=(E=s.listingId)==null?void 0:E.name)==null?void 0:F.toLowerCase())||"",t=((L=(A=s.listingId)==null?void 0:A.city)==null?void 0:L.toLowerCase())||"",l=((D=($=s.listingId)==null?void 0:$.state)==null?void 0:D.toLowerCase())||"",r=String(s.rating),m=((P=s.comment)==null?void 0:P.toLowerCase())||"",V=((T=s.adminNote)==null?void 0:T.toLowerCase())||"",X=k(s.createdAt).toLowerCase(),c=C.toLowerCase();return a.includes(c)||t.includes(c)||l.includes(c)||r===c||m.includes(c)||V.includes(c)||X.includes(c)||c===""});return h?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your reviews..."})]})}):e.jsxs("div",{className:"max-w-full sm:max-w-2xl md:max-w-4xl mx-auto px-2 sm:px-4 py-4 sm:py-8",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-3 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 sm:mb-6",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800",children:"My Reviews"}),e.jsxs("button",{onClick:O,disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50 disabled:cursor-not-allowed shadow",title:"Refresh reviews",children:[e.jsx(Z,{className:`${h?"animate-spin":""}`}),"Refresh"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4 mb-6",children:[e.jsx("input",{type:"text",placeholder:"Search by property name, city, state, review comment, admin note, or review date...",className:"border border-gray-300 rounded-lg px-3 py-2 w-full sm:w-1/2",value:C,onChange:s=>{B(s.target.value)}}),e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 w-full sm:w-1/4",value:b,onChange:s=>{q(s.target.value),s.target.value?d.info(`Filtered by status: ${s.target.value}`):d.info("Showing all reviews")},children:[e.jsx("option",{value:"",children:"All Statuses"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"removed",children:"Removed"})]})]}),S&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-red-800",children:S})}),_.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"⭐"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"No Reviews Found"}),e.jsx("p",{className:"text-gray-600",children:"Try adjusting your search or filters."})]}):e.jsx("div",{className:"space-y-4 sm:space-y-6",children:_.map(s=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-3 sm:p-6 hover:shadow-md transition-shadow overflow-x-auto",children:e.jsxs("div",{className:"flex flex-col gap-2 sm:gap-4 lg:flex-row lg:items-start lg:justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[Q(s.status),e.jsx("span",{className:"text-sm text-gray-500",children:k(s.createdAt)})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[I(s.rating),e.jsxs("span",{className:"text-sm text-gray-600",children:[s.rating," star",s.rating>1?"s":""]})]}),e.jsx("p",{className:"text-gray-700 mb-3",children:s.comment}),s.listingId&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsx("h4",{className:"font-semibold text-gray-800",children:e.jsx("a",{href:`/user/listing/${typeof s.listingId=="object"?s.listingId._id:s.listingId}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",children:s.listingId.name})}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.listingId.city,", ",s.listingId.state]})]}),s.adminNote&&e.jsx("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Admin Note:"})," ",s.adminNote]})})]}),e.jsxs("div",{className:"flex flex-col gap-2 lg:flex-shrink-0 w-full sm:w-auto",children:[e.jsxs("button",{onClick:()=>J(s),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 transition shadow",children:[e.jsx(ee,{}),"Edit"]}),e.jsxs("button",{onClick:()=>W(s),className:"flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg hover:from-red-600 hover:to-pink-600 transition shadow",children:[e.jsx(N,{}),"Delete"]})]})]})},s._id))})]}),u&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-xs sm:max-w-md w-full",children:e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsx("h2",{className:"text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-4",children:"Edit Review"}),e.jsx(te,{listingId:typeof u.listingId=="object"?u.listingId._id:u.listingId,existingReview:u,onReviewSubmitted:K}),e.jsx("button",{onClick:()=>y(null),className:"mt-4 w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600",children:"Cancel"})]})})}),H&&i&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-md w-full mx-4 shadow-xl",children:e.jsxs("div",{className:"p-4 sm:p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(N,{className:"text-red-500"}),"Delete Review"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this review? This action cannot be undone."}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[I(i.rating),e.jsxs("span",{className:"text-sm text-gray-600",children:[i.rating," star",i.rating>1?"s":""]})]}),e.jsx("p",{className:"text-sm text-gray-700 line-clamp-3",children:i.comment}),i.listingId&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Property: ",i.listingId.name]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{j(!1),v(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:G,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(N,{size:12}),"Delete Review"]})]})]})})}),e.jsx(re,{})]})}export{ie as default};
