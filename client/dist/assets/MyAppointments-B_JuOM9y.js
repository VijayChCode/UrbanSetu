import{g as Bt,r as a,u as Et,v as f,j as e,$ as Ot,a0 as He,a1 as qe,a2 as Mt,H as lt,U as $t,a4 as Ft,a3 as it,f as Lt,a5 as zt,a6 as Pt,y as h,h as Ut,L as Ht,z as D,I as nt,a7 as Te,a8 as qt,Z as Jt,G as pe,D as Vt,ab as at}from"./index-Cm4M9phB.js";const R="https://urbansetu.onrender.com";function Gt(){const{currentUser:s}=Bt(n=>n.user),[g,_]=a.useState([]),[Je,V]=a.useState(!0),[je,X]=a.useState(null),[H,Ve]=a.useState(""),[K,ve]=a.useState("all"),[z,ue]=a.useState("all"),[Y,q]=a.useState(""),[S,w]=a.useState(!1),[$,xe]=a.useState(null),[N,ee]=a.useState(""),[T,G]=a.useState(""),[we,ae]=a.useState(!1),[I,y]=a.useState(null),[re,F]=a.useState([]),[B,le]=a.useState(!1),ie=Et(),[P,he]=a.useState(null);a.useEffect(()=>{const n=async()=>{if(!s){X("Please sign in to view your appointments"),V(!1);return}try{V(!0),X(null);const c=await fetch(`${R}/api/bookings/my`,{credentials:"include"});if(c.ok){const x=await c.json();_(x)}else throw new Error("Failed to fetch appointments")}catch{X("Failed to load appointments. Please try again.")}finally{V(!1)}},m=async()=>{try{const c=await fetch(`${R}/api/bookings/archived`,{credentials:"include"});if(!c.ok)throw new Error("Not allowed");const x=await c.json();F(Array.isArray(x)?x:[])}catch{F([]),s&&(s.role==="admin"||s.role==="rootadmin")&&h.error("Failed to fetch archived appointments")}};n(),m()},[s]),a.useEffect(()=>{const n=m=>{_(c=>c.filter(x=>x._id!==m.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[s]),a.useEffect(()=>{s&&_(n=>n.map(m=>{const c={...m};return m.buyerId&&(m.buyerId._id===s._id||m.buyerId===s._id)&&(c.buyerId={...c.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),m.sellerId&&(m.sellerId._id===s._id||m.sellerId===s._id)&&(c.sellerId={...c.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),c}))},[s]),a.useEffect(()=>{function n(m){_(c=>c.map(x=>x._id===m.appointmentId?{...x,...m.updatedAppointment}:x))}return f.on("appointmentUpdate",n),()=>{f.off("appointmentUpdate",n)}},[]),a.useEffect(()=>{function n(c){const x=c.appointment;x.buyerId&&s&&(x.buyerId._id===s._id||x.buyerId===s._id)?x.role="buyer":x.sellerId&&s&&(x.sellerId._id===s._id||x.sellerId===s._id)&&(x.role="seller"),_(j=>[x,...j])}f.on("appointmentCreated",n);const m=c=>{_(x=>x.map(j=>{const v={...j};return j.buyerId&&(j.buyerId._id===c.userId||j.buyerId===c.userId)&&(v.buyerId={...v.buyerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),j.sellerId&&(j.sellerId._id===c.userId||j.sellerId===c.userId)&&(v.sellerId={...v.sellerId,username:c.username,email:c.email,mobileNumber:c.mobileNumber,avatar:c.avatar}),v}))};return f.on("profileUpdated",m),()=>{f.off("appointmentCreated",n),f.off("profileUpdated",m)}},[s]),a.useEffect(()=>{if(!s)return;const n=setInterval(()=>{f.emit("userAppointmentsActive",{userId:s._id})},5e3);return()=>clearInterval(n)},[s]);const te=async(n,m)=>{q(n+m);try{const c=await fetch(`${R}/api/bookings/${n}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:m})}),x=await c.json();if(c.status===401){h.error("Session expired or unauthorized. Please sign in again."),ie("/sign-in");return}if(c.ok){_(v=>v.map(A=>A._id===n?{...A,status:m}:A));const j=m==="accepted"?"accepted":"rejected";h.success(`Appointment ${j} successfully! ${m==="accepted"?"Contact information is now visible to both parties.":""}`),ie("/user/my-appointments")}else h.error(x.message||"Failed to update appointment status.")}catch{h.error("An error occurred. Please try again.")}q("")},Ne=async n=>{setAppointmentToHandle(n),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},Ce=async n=>{setAppointmentToHandle(n),setShowArchiveModal(!0)},ge=async n=>{setAppointmentToHandle(n),setShowUnarchiveModal(!0)},Se=g.filter(n=>{var A,U,L,p,Q,se,J,Ie,oe,De;if(s._id===((U=(A=n.buyerId)==null?void 0:A._id)==null?void 0:U.toString())&&n.visibleToBuyer===!1||s._id===((p=(L=n.sellerId)==null?void 0:L._id)==null?void 0:p.toString())&&n.visibleToSeller===!1)return!1;const m=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(K==="outdated")return m;const c=K==="all"?!0:n.status===K,x=z==="all"?!0:n.role===z,j=((Q=n.propertyName)==null?void 0:Q.toLowerCase().includes(H.toLowerCase()))||((se=n.message)==null?void 0:se.toLowerCase().includes(H.toLowerCase()))||((Ie=(J=n.buyerId)==null?void 0:J.username)==null?void 0:Ie.toLowerCase().includes(H.toLowerCase()))||((De=(oe=n.sellerId)==null?void 0:oe.username)==null?void 0:De.toLowerCase().includes(H.toLowerCase()));let v=!0;return N&&(v=v&&new Date(n.date)>=new Date(N)),T&&(v=v&&new Date(n.date)<=new Date(T)),c&&x&&j&&v}),Ae=Array.isArray(re)?re.filter(n=>{var j,v,A,U,L,p;const m=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(K==="outdated")return m;K==="all"||n.status;const c=((j=n.propertyName)==null?void 0:j.toLowerCase().includes(H.toLowerCase()))||((v=n.message)==null?void 0:v.toLowerCase().includes(H.toLowerCase()))||((U=(A=n.buyerId)==null?void 0:A.username)==null?void 0:U.toLowerCase().includes(H.toLowerCase()))||((p=(L=n.sellerId)==null?void 0:L.username)==null?void 0:p.toLowerCase().includes(H.toLowerCase()));let x=!0;return N&&(x=x&&new Date(n.date)>=new Date(N)),T&&(x=x&&new Date(n.date)<=new Date(T)),c&&x}):[];function ke(n){y({...n,date:n.date?new Date(n.date).toISOString().split("T")[0]:"",time:n.time||"",message:n.message||"",buyerReinitiationCount:n.buyerReinitiationCount||0,sellerReinitiationCount:n.sellerReinitiationCount||0}),ae(!0)}async function Be(n){var j,v;if(n.preventDefault(),!I)return;const m=s&&(((j=I.buyerId)==null?void 0:j._id)===s._id||I.buyerId===s._id);if(s&&(((v=I.sellerId)==null?void 0:v._id)===s._id||(I.sellerId,s._id)),(m?I.buyerReinitiationCount||0:I.sellerReinitiationCount||0)>=2){h.error("You have reached the maximum number of reinitiations for your role.");return}if(!I.buyerId||!I.sellerId){h.error("Cannot reinitiate: one of the parties no longer exists.");return}const x={...I,status:"pending"};try{const A=await fetch(`${R}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(x)}),U=await A.json();A.ok?(h.success("Appointment reinitiated successfully!"),ae(!1),y(null),ie("/user/my-appointments"),_(L=>L.map(p=>p._id===U.appointment._id?{...p,...U.appointment}:p))):h.error(U.message||"Failed to reinitiate appointment.")}catch{h.error("An error occurred. Please try again.")}}const Z=(n,m)=>{_(c=>c.map(x=>x._id===n?{...x,status:m}:x))},_e=async()=>{V(!0),X(null);try{const n=await fetch(`${R}/api/bookings/my`,{credentials:"include"});if(n.ok){const c=await n.json();_(c)}else throw new Error("Failed to fetch appointments");const m=await fetch(`${R}/api/bookings/archived`,{credentials:"include"});if(m.ok){const c=await m.json();F(Array.isArray(c)?c:[])}}catch{X("Failed to refresh appointments. Please try again.")}finally{V(!1)}};return Je?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):je?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:je})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(Ot,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:B?"Archived Appointments":"My Appointments"}),!B&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"💡 Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."})]}),e.jsx("button",{onClick:_e,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),s&&(s.role==="admin"||s.role==="rootadmin")&&e.jsx("button",{onClick:()=>le(!B),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${B?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:B?e.jsxs(e.Fragment,{children:[e.jsx(He,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{})," Archived Appointments (",re.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:K,onChange:n=>ve(n.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:N,onChange:n=>ee(n.target.value),max:T||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:T,onChange:n=>G(n.target.value),min:N||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:z,onChange:n=>ue(n.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:H,onChange:n=>Ve(n.target.value)})]})]}),B&&s&&(s.role==="admin"||s.role==="rootadmin")?Ae.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Ae.map(n=>e.jsx(rt,{appt:n,currentUser:s,handleStatusUpdate:te,handleAdminDelete:Ne,actionLoading:Y,onShowOtherParty:m=>{xe(m),w(!0)},onOpenReinitiate:()=>ke(n),handleArchiveAppointment:Ce,handleUnarchiveAppointment:ge,isArchived:!0,onCancelRefresh:Z},n._id))})]})}):Se.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Se.map(n=>e.jsx(rt,{appt:n,currentUser:s,handleStatusUpdate:te,handleAdminDelete:Ne,actionLoading:Y,onShowOtherParty:m=>{xe(m),w(!0)},onOpenReinitiate:()=>ke(n),handleArchiveAppointment:Ce,handleUnarchiveAppointment:ge,isArchived:!1,onCancelRefresh:Z},n._id))})]})}),S&&$&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>w(!1),title:"Close","aria-label":"Close",children:e.jsx(lt,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx($t,{user:{username:$.username,avatar:$.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(Ft,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[$.username||"User",$.role==="admin"&&e.jsx(it,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:$.role||"User"})]})]})}),e.jsxs("div",{className:"px-6 py-6 space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(Lt,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:$.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(zt,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:$.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Pt,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:$.createdAt?new Date($.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]}),e.jsx("button",{onClick:()=>w(!1),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold",children:"Close"})]})]})}),we&&I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:Be,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:I.date,onChange:n=>y(m=>({...m,date:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:I.time,onChange:n=>y(m=>({...m,time:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:I.message,onChange:n=>y(m=>({...m,message:n.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>ae(!1),children:"Cancel"})]})]})})]})]})}function Ue(s){const g=new Date,_=new Date;return _.setDate(g.getDate()-1),s.toDateString()===g.toDateString()?"Today":s.toDateString()===_.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function rt({appt:s,currentUser:g,handleStatusUpdate:_,handleAdminDelete:Je,actionLoading:V,onShowOtherParty:je,onOpenReinitiate:X,handleArchiveAppointment:H,handleUnarchiveAppointment:Ve,isArchived:K,onCancelRefresh:ve}){const[z,ue]=a.useState(null),[Y,q]=a.useState(""),[S,w]=a.useState(s.comments||[]),[$,xe]=a.useState(!1),[N,ee]=a.useState(null),[T,G]=a.useState(""),[we,ae]=a.useState(null),I=Ut(),[y,re]=a.useState(!1),F=a.useRef(null),B=a.useRef(null),[le,ie]=a.useState(!0),[P,he]=a.useState(0),[te,Ne]=a.useState(""),[Ce,ge]=a.useState(!1),[Se,Ae]=a.useState(!1),[ke,Be]=a.useState(!1),[Z,_e]=a.useState(!1),[n,m]=a.useState(!1),[c,x]=a.useState(!1),j=a.useRef(null),v=a.useRef(null),A=a.useRef(null),[U,L]=a.useState(!1),[p,Q]=a.useState(null),[se,J]=a.useState(!0),[Ie,oe]=a.useState(!1),[De,ot]=a.useState(!1),[dt,ct]=a.useState(!1),[mt,ut]=a.useState(!1),[xt,Ee]=a.useState(!1),[ht,Oe]=a.useState(!1),[gt,Me]=a.useState(!1),[Kt,$e]=a.useState(null),[de,W]=a.useState(""),[ft,Ke]=a.useState(""),ne=a.useRef({});a.useEffect(()=>{if(n){const t=setTimeout(()=>{m(!1)},1e4);return()=>clearTimeout(t)}},[n]);function Fe(t){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${t}`))||[]}catch{return[]}}function bt(t,r){const l=Fe(t);if(!l.includes(r)){const d=[...l,r];localStorage.setItem(`removedDeletedMsgs_${t}`,JSON.stringify(d))}}const Le=(g.role==="admin"||g.role==="rootadmin")&&g.adminApprovalStatus==="approved",yt=I.pathname.includes("/admin"),E=s.role==="seller",ce=s.role==="buyer",O=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),Ye=(Le||s.status==="accepted")&&O,o=E?s.buyerId:s.sellerId,pt=t=>{Q(t),J(!0),L(!0)},jt=t=>{Q(t),J(!1),L(!0)},vt=async()=>{if(p){try{if(se){const t=await fetch(`${R}/api/bookings/${s._id}/comment/${p._id}`,{method:"DELETE",credentials:"include"}),r=await t.json();t.ok?(w(l=>r.comments.map(d=>{const i=l.find(u=>u._id===d._id);return i&&i.status==="read"&&d.status!=="read"?{...d,status:"read"}:d})),h.success("Message deleted for everyone!")):h.error(r.message||"Failed to delete message.")}else w(t=>t.filter(r=>r._id!==p._id)),bt(s._id,p._id),h.success("Message deleted for you!")}catch{h.error("An error occurred. Please try again.")}L(!1),Q(null),J(!0)}},wt=()=>{localStorage.setItem(et,Date.now()),w([]),h.success("Chat Cleared"),oe(!1)},Ge=async()=>{if(!Y.trim())return;xe(!0);const t=`temp-${Date.now()}`,r={_id:t,senderEmail:g.email,message:Y,status:"sending",timestamp:new Date().toISOString(),readBy:[g._id],...z?{replyTo:z._id}:{}};w(l=>[...l,r]),q(""),ue(null);try{const l=await fetch(`${R}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:Y,...z?{replyTo:z._id}:{}})}),d=await l.json();l.ok?(w(i=>[...i.filter(u=>u._id!==t),...d.comments.filter(u=>!i.some(b=>b._id===u._id))]),h.success("Message sent successfully!")):(w(i=>i.filter(u=>u._id!==t)),h.error(d.message||"Failed to send message."))}catch{w(d=>d.filter(i=>i._id!==t)),h.error("An error occurred. Please try again.")}xe(!1)},Ze=async t=>{if(!T.trim())return;ae(t),w(l=>l.map(d=>d._id===t?{...d,message:T,edited:!0,editedAt:new Date}:d)),ee(null),G(""),q("");try{const l=await fetch(`${R}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:T})}),d=await l.json();l.ok?(w(i=>i.map(u=>{const b=d.comments.find(C=>C._id===u._id);return b?b._id===t?b:u.status==="read"&&b.status!=="read"?{...b,status:"read"}:b:u})),h.success("Message edited successfully!")):(w(i=>i.map(u=>u._id===t?{...u,message:u.originalMessage||u.message,edited:u.wasEdited||!1}:u)),ee(t),G(T),q(T),h.error(d.message||"Failed to edit message."))}catch{w(d=>d.map(i=>i._id===t?{...i,message:i.originalMessage||i.message,edited:i.wasEdited||!1}:i)),ee(t),G(T),q(T),h.error("An error occurred. Please try again.")}finally{ae(null)}},Nt=t=>{ee(t._id),G(t.message),q(t.message),w(r=>r.map(l=>l._id===t._id?{...l,originalMessage:l.message,wasEdited:l.edited}:l)),setTimeout(()=>{A.current&&(A.current.focus(),A.current.select())},100)},Ct=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},Qe=async()=>{W(""),Ee(!0)},St=async()=>{if(E&&!de.trim()){h.error("Reason is required for seller cancellation.");return}try{const t=await fetch(`${R}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:de})}),r=await t.json();if(t.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(h.success("Appointment cancelled successfully."),typeof ve=="function"&&ve(s._id,E?"cancelledBySeller":"cancelledByBuyer")):h.error(r.message||"Failed to cancel appointment."),Ee(!1),W("")}catch{h.error("An error occurred. Please try again.")}},At=async()=>{W(""),Oe(!0)},kt=async()=>{if(!de.trim()){h.error("Reason is required for admin cancellation.");return}try{const t=await fetch(`${R}/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:de})}),r=await t.json();if(t.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}t.ok?(h.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):h.error(r.message||"Failed to cancel appointment."),Oe(!1),W("")}catch{h.error("An error occurred. Please try again.")}},ze=async()=>{Me(!0)},_t=async()=>{try{const t=ce?"buyer":E?"seller":null;if(!t)return;if((await fetch(`${R}/api/bookings/${s._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:t})})).ok){if(typeof window<"u"){const l=new CustomEvent("removeAppointmentRow",{detail:s._id});window.dispatchEvent(l),h.success("Appointment removed from your table successfully")}}else h.error("Failed to remove appointment from table.");Me(!1)}catch{h.error("An error occurred. Please try again.")}};a.useEffect(()=>{y&&F.current&&F.current.scrollIntoView({behavior:"smooth"})},[y]);const me=a.useCallback(async()=>{if(!B.current)return;const{scrollTop:t,scrollHeight:r,clientHeight:l}=B.current;if(!(r-t-l<10))return;const i=S.filter(u=>{var b;return!((b=u.readBy)!=null&&b.includes(g._id))&&u.senderEmail!==g.email});if(i.length>0)try{(await fetch(`${R}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(w(b=>b.map(C=>i.some(k=>k._id===C._id)?{...C,readBy:[...C.readBy||[],g._id],status:"read"}:C)),i.forEach(b=>{f.emit("messageRead",{appointmentId:s._id,messageId:b._id,userId:g._id,readBy:g._id})}),console.log(`Marked ${i.length} messages as read for user ${g._id}`))}catch(u){console.error("Error marking messages as read:",u)}},[S,g._id,s._id,f]),We=a.useRef(S.length),It=a.useRef(S);a.useEffect(()=>{const t=S.slice(We.current),r=t.length;if(We.current=S.length,It.current=S,r>0&&y){const l=t.some(i=>i.senderEmail===g.email),d=t.filter(i=>i.senderEmail!==g.email);l||le?setTimeout(()=>{F.current&&(F.current.scrollIntoView({behavior:"smooth"}),le&&d.length>0&&setTimeout(()=>{me()},300))},100):d.length>0&&he(i=>i+d.length)}},[S.length,le,y,g.email,me]);const Xe=a.useCallback(()=>{if(B.current){const{scrollTop:t,scrollHeight:r,clientHeight:l}=B.current,d=r-t-l<10;if(ie(d),d){const i=S.filter(u=>{var b;return!((b=u.readBy)!=null&&b.includes(g._id))&&u.senderEmail!==g.email}).length;i>0&&(console.log(`User manually scrolled to bottom, marking ${i} messages as read`),me()),P>0&&he(0)}}},[P,me,S,g._id]),Pe=a.useCallback(()=>{if(!B.current||S.length===0)return;const t=`chatClearTime_${s._id}`,r=Number(localStorage.getItem(t))||0,l=Fe(s._id),d=S.filter(k=>new Date(k.timestamp).getTime()>r&&!l.includes(k._id));if(d.length===0)return;const u=B.current.getBoundingClientRect(),b=u.top+60;let C="";for(let k=0;k<d.length;k++){const M=ne.current[d[k]._id];if(M){const ye=M.getBoundingClientRect();if(ye.top>=b&&ye.bottom<=u.bottom){const Re=new Date(d[k].timestamp);C=Ue(Re);break}}}if(!C)for(let k=0;k<d.length;k++){const M=ne.current[d[k]._id];if(M&&M.getBoundingClientRect().bottom>b){const Re=new Date(d[k].timestamp);C=Ue(Re);break}}C&&C!==te&&Ne(C)},[S,te,s._id]);a.useEffect(()=>{const t=B.current;if(t&&y){const r=()=>{Xe(),Pe(),ge(!0),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{ge(!1)},1e3)};if(t.addEventListener("scroll",r),t){const{scrollTop:l,scrollHeight:d,clientHeight:i}=t,u=d-l-i<10;ie(u)}return setTimeout(Pe,100),()=>{t.removeEventListener("scroll",r),v.current&&clearTimeout(v.current)}}},[y,Xe,Pe]),a.useEffect(()=>{y&&F.current&&F.current.scrollIntoView({behavior:"smooth"})},[y]);const Dt=a.useCallback(()=>{F.current&&(F.current.scrollIntoView({behavior:"smooth"}),he(0),setTimeout(()=>{me()},500))},[me]);a.useEffect(()=>{function t(r){var l,d;if(r.appointmentId===s._id&&!y){const i=r.comment.senderEmail===((l=s.buyerId)==null?void 0:l.email),u=r.comment.senderEmail===((d=s.sellerId)==null?void 0:d.email),C=!i&&!u?"Organization":r.comment.senderEmail||"User";h.info(`New message from ${C}`)}}return f.on("commentUpdate",t),()=>{f.off("commentUpdate",t)}},[s._id,y]),a.useEffect(()=>{function t(r){r.appointmentId===s._id&&(w(l=>{const d=l.findIndex(i=>i._id===r.comment._id);if(d!==-1){const i=[...l],u=l[d],b=r.comment;let C=b.status;return u.status==="read"&&b.status!=="read"&&(C="read"),i[d]={...b,status:C},i}else return[...l,r.comment]}),y&&r.comment.senderEmail!==g.email&&fetch(`${R}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"}))}return f.on("commentUpdate",t),()=>{f.off("commentUpdate",t)}},[s._id,w,y,g.email]),a.useEffect(()=>{y&&(fetch(`${R}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"}),S.length===0&&(x(!0),fetch(`${R}/api/bookings/${s._id}`).then(t=>t.json()).then(t=>{t&&Array.isArray(t.comments)&&w(t.comments)}).catch(t=>console.error("Failed to fetch comments:",t)).finally(()=>x(!1))))},[y,s._id,S.length]),a.useEffect(()=>{function t(l){l.appointmentId===s._id&&w(d=>d.map(i=>i._id===l.commentId?{...i,status:i.status==="read"?"read":"delivered"}:i))}function r(l){l.appointmentId===s._id&&w(d=>d.map(i=>{var u;return(u=i.readBy)!=null&&u.includes(l.userId)?i:{...i,status:"read",readBy:[...i.readBy||[],l.userId]}}))}return f.on("commentDelivered",t),f.on("commentRead",r),()=>{f.off("commentDelivered",t),f.off("commentRead",r)}},[s._id,w]);const fe=S.filter(t=>{var r;return!((r=t.readBy)!=null&&r.includes(g._id))&&t.senderEmail!==g.email}).length;a.useEffect(()=>(y?document.body.style.overflow="hidden":(document.body.style.overflow="",he(0)),()=>{document.body.style.overflow=""}),[y]);const et=`chatClearTime_${s._id}`,Rt=Number(localStorage.getItem(et))||0,Tt=Fe(s._id),be=S.filter(t=>new Date(t.timestamp).getTime()>Rt&&!Tt.includes(t._id));return a.useEffect(()=>{if(!y||!(o!=null&&o._id))return;f.emit("checkUserOnline",{userId:o._id});function t(r){r.userId===o._id&&Ae(!!r.online)}return f.on("userOnlineStatus",t),f.on("userOnlineUpdate",t),()=>{f.off("userOnlineStatus",t),f.off("userOnlineUpdate",t)}},[y,o==null?void 0:o._id]),a.useEffect(()=>{if(!(o!=null&&o._id))return;f.emit("checkUserOnline",{userId:o._id});function t(r){r.userId===o._id&&Be(!!r.online)}return f.on("userOnlineStatus",t),f.on("userOnlineUpdate",t),()=>{f.off("userOnlineStatus",t),f.off("userOnlineUpdate",t)}},[o==null?void 0:o._id]),a.useEffect(()=>{function t(r){r.fromUserId===(o==null?void 0:o._id)&&r.appointmentId===s._id&&(_e(!0),j.current&&clearTimeout(j.current),j.current=setTimeout(()=>_e(!1),2e3))}return f.on("typing",t),()=>{f.off("typing",t),j.current&&clearTimeout(j.current)}},[o==null?void 0:o._id,s._id]),a.useEffect(()=>{if(!y)return;const t=r=>{var l;r.ctrlKey&&r.key==="f"&&(r.preventDefault(),(l=A.current)==null||l.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[y]),e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${O?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!O&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(Ht,{to:yt?`/admin/listing/${s.listingId._id}`:`/user/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${E?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:E?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[Ye?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>je(o),title:"Click to view details",children:(o==null?void 0:o.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(o==null?void 0:o.username)||"Unknown"}),Ye?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:o==null?void 0:o.email}),e.jsx("div",{className:"text-sm text-gray-600",children:o!=null&&o.mobileNumber&&(o==null?void 0:o.mobileNumber)!==""?o.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:Le?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${Ct(s.status)}`,children:s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:O?e.jsxs(e.Fragment,{children:[E&&s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>_(s._id,"accepted"),disabled:V===s._id+"accepted",title:"Accept Appointment",children:e.jsx(nt,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>_(s._id,"rejected"),disabled:V===s._id+"rejected",title:"Reject Appointment",children:e.jsx(lt,{})})]}),E&&s.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Qe,title:"Cancel Appointment (Seller)",children:e.jsx(D,{})}),E&&(s.status==="cancelledBySeller"||s.status==="cancelledByBuyer"||s.status==="cancelledByAdmin"||s.status==="rejected"||s.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:ze,title:"Remove from table",style:{opacity:.5},children:e.jsx(D,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),ce&&(s.status==="pending"||s.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Qe,title:"Cancel Appointment (Buyer)",children:e.jsx(D,{})}),ce&&(s.status==="cancelledByBuyer"||s.status==="cancelledBySeller"||s.status==="cancelledByAdmin"||s.status==="deletedByAdmin"||s.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:ze,title:"Remove from table",style:{opacity:.5},children:e.jsx(D,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),Le&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:At,title:"Cancel Appointment (Admin)",children:e.jsx(it,{})}),(s.status==="cancelledByBuyer"&&ce||s.status==="cancelledBySeller"&&E)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>X(s),disabled:s.status==="cancelledByBuyer"&&ce&&(s.buyerReinitiationCount||0)>=2||s.status==="cancelledBySeller"&&E&&(s.sellerReinitiationCount||0)>=2||!s.buyerId||!s.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:ce&&s.status==="cancelledByBuyer"?`${2-(s.buyerReinitiationCount||0)} left`:E&&s.status==="cancelledBySeller"?`${2-(s.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:ze,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(D,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-2 shadow-md mx-auto relative ${O?"bg-blue-100 hover:bg-blue-200 text-blue-700":"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50"}`,title:O?"Open Chat":"Chat not available for outdated appointments",onClick:O?()=>re(!0):void 0,disabled:!O,children:[e.jsx(Te,{size:20}),Z&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!Z&&fe>0&&!O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:fe}),!Z&&fe>0&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:fe}),!Z&&fe===0&&ke&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 rounded-2xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col",children:[O?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-200 to-purple-200 rounded-t-2xl relative",children:[e.jsx(Te,{className:"text-blue-600 text-xl"}),e.jsx("h3",{className:"text-lg font-bold text-blue-800",children:"Chat"}),Z?e.jsx("span",{className:"ml-3 text-blue-600 font-semibold text-sm",children:"Typing..."}):Se?e.jsx("span",{className:"ml-3 text-green-600 font-semibold text-sm",children:"Online"}):e.jsx("span",{className:"ml-3 text-gray-600 font-semibold text-sm",children:"Offline"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[be.length>0&&e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>oe(!0),title:"Clear chat locally",children:"Clear Chat"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>m(!n),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(qt,{className:"text-sm"})}),n&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>re(!1),title:"Close","aria-label":"Close",children:"×"})]})]}),e.jsxs("div",{ref:B,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[te&&be.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${Ce?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:te})})}),c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"Loading messages..."})]}):be.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(Te,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):be.map((t,r)=>{var C,k;const l=t.senderEmail===g.email,d=N===t._id,i=new Date(t.timestamp),u=r>0?new Date(be[r-1].timestamp):null,b=u?i.toDateString()!==u.toDateString():!0;return i.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(Jt.Fragment,{children:[b&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Ue(i)})}),e.jsx("div",{className:`flex w-full ${l?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*r}s`},children:e.jsxs("div",{ref:M=>ne.current[t._id]=M,"data-message-id":t._id,className:`rounded-2xl px-4 py-2 text-sm shadow-lg max-w-[60%] break-words relative ${l?"bg-gradient-to-r from-blue-400 to-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,style:{animationDelay:`${.03*r}s`},children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-blue-300 pl-2 mb-1 text-xs text-gray-500 bg-blue-50 rounded w-full max-w-full break-words cursor-pointer",onClick:()=>{ne.current[t.replyTo]&&(ne.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),ne.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{ne.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsx("span",{className:"text-xs text-gray-600 truncate",children:((C=S.find(M=>M._id===t.replyTo))==null?void 0:C.message)||"Original message"})}),e.jsxs("div",{className:"font-semibold mb-1 flex items-center gap-2 flex-wrap break-all",children:[e.jsx("span",{className:"truncate max-w-[60%] min-w-[80px] inline-block align-middle overflow-hidden text-ellipsis",children:l?"You":(()=>{var tt,st;const M=t.senderEmail===((tt=s.buyerId)==null?void 0:tt.email),ye=t.senderEmail===((st=s.sellerId)==null?void 0:st.email);return!M&&!ye?"Organization":(o==null?void 0:o.username)||t.senderName||t.senderEmail})()}),e.jsx("span",{className:"text-gray-300 ml-2 text-[10px]",children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsx("div",{className:"flex items-center gap-1",children:t.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(pe,{className:"inline-block text-lg"})," ",t.senderEmail===g.email?"You deleted this message":"This message was deleted.",e.jsx("button",{className:"ml-2 text-red-700 hover:text-red-900",onClick:()=>{Q(t),J(!1),L(!0)},title:"Remove this deleted message from your chat view",children:e.jsx(D,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})})]}):e.jsx("div",{children:d?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"✏️ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[t.message,t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-2 justify-end mt-1",children:[!t.deleted&&e.jsx("button",{className:`${l?"text-yellow-500 hover:text-yellow-700":"text-blue-600 hover:text-blue-800"}`,onClick:()=>{var M;ue(t),(M=A.current)==null||M.focus()},title:"Reply",children:e.jsx("svg",{width:"18",height:"18",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),t.senderEmail===g.email&&!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Nt(t),className:"text-green-800 hover:text-green-950",title:"Edit comment",disabled:N!==null,children:e.jsx(Vt,{size:12})}),e.jsx("button",{className:"text-red-700 hover:text-red-900",onClick:()=>pt(t),children:e.jsx(D,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),e.jsx("span",{className:"ml-1",children:(k=t.readBy)!=null&&k.includes(o==null?void 0:o._id)?e.jsx(at,{className:"text-white inline"}):t.status==="delivered"?e.jsx(at,{className:"text-white/70 inline"}):e.jsx(nt,{className:"text-white/70 inline"})})]}),!l&&!d&&!t.deleted&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>jt(t),title:"Delete message locally",children:e.jsx(D,{size:14})})]})]})})]},t._id||r)}),e.jsx("div",{ref:F})]}),z&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsx("span",{className:"text-xs text-gray-600 truncate",children:z.message}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700",onClick:()=>ue(null),title:"Cancel reply",children:"×"})]})}),N&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"✏️ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:T}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700",onClick:()=>{ee(null),G(""),q("")},title:"Cancel edit",children:"×"})]})}),e.jsxs("div",{className:"flex gap-2 mt-2 px-4 pb-4",children:[e.jsx("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-full text-sm focus:ring-2 focus:ring-blue-200 shadow",placeholder:N?"Edit your message...":"Type a message...",value:Y,onChange:t=>{q(t.target.value),N&&G(t.target.value),N||f.emit("typing",{toUserId:o._id,fromUserId:g._id,appointmentId:s._id})},onKeyDown:t=>{t.key==="Enter"&&(N?Ze(N):Ge())},ref:A}),e.jsx("button",{onClick:N?()=>Ze(N):Ge,disabled:(N?we===N:$)||!Y.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-full text-sm font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50 flex items-center gap-2 min-w-20",children:N?we===N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":$?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(10px) scale(0.98); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                  }
                `})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 min-h-96",children:[e.jsx(Te,{className:"text-6xl text-gray-400 mb-6"}),e.jsx("div",{className:"text-xl font-semibold text-gray-500 text-center",children:"Chat not available for outdated appointments"}),e.jsx("div",{className:"text-gray-400 text-center mt-2",children:"This appointment has already passed"})]}),!le&&O&&!N&&!z&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:Dt,className:"bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-all duration-200 hover:scale-110 relative",title:P>0?`${P} new message${P>1?"s":""}`:"Scroll to bottom","aria-label":P>0?`${P} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),P>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:P>99?"99+":P})]})})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(D,{className:"text-red-500"}),"Delete Message"]}),p!=null&&p.deleted?e.jsx("p",{className:"text-gray-600 mb-6",children:"Delete this message for me?"}):(p==null?void 0:p.senderEmail)===g.email?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:se,onChange:t=>J(t.target.checked),className:"form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Also delete for"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(o==null?void 0:o.username)||"other user"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-7",children:se?"The message will be permanently deleted for everyone":"The message will only be deleted for you"})]})]}):e.jsxs("p",{className:"text-gray-600 mb-6",children:["Delete message from"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(o==null?void 0:o.username)||"other user"}),"?"]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{L(!1),Q(null),J(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:vt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(D,{size:12}),p!=null&&p.deleted?"Delete for me":(p==null?void 0:p.senderEmail)===g.email&&se?"Delete for everyone":"Delete for me"]})]})]})}),Ie&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(D,{className:"text-red-500"}),"Clear Chat"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to clear chat? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>oe(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:wt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(D,{size:12}),"Clear Chat"]})]})]})}),De&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(D,{className:"text-red-500"}),"Delete Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for deletion (required):"}),e.jsx("textarea",{value:ft,onChange:t=>Ke(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for deleting this appointment..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ot(!1),$e(null),Ke("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmAdminDelete,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(D,{size:12}),"Delete Appointment"]})]})]})}),dt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(qe,{className:"text-blue-500"}),"Archive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ct(!1),$e(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmArchive,className:"px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(qe,{size:12}),"Archive"]})]})]})}),mt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(He,{className:"text-green-500"}),"Unarchive Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ut(!1),$e(null)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:confirmUnarchive,className:"px-4 py-2 rounded bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(He,{size:12}),"Unarchive"]})]})]})}),xt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(pe,{className:"text-orange-500"}),"Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Reason for cancellation ",E?"(required)":"(optional)",":"]}),e.jsx("textarea",{value:de,onChange:t=>W(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500",rows:"3",placeholder:E?"Please provide a reason for cancelling...":"Optional reason for cancelling..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Ee(!1),W("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:St,className:"px-4 py-2 rounded bg-orange-600 text-white font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2",children:[e.jsx(pe,{size:12}),"Cancel Appointment"]})]})]})}),ht&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(pe,{className:"text-red-500"}),"Admin Cancel Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to cancel this appointment as admin?"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for admin cancellation (required):"}),e.jsx("textarea",{value:de,onChange:t=>W(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for admin cancellation..."})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Oe(!1),W("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:kt,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(pe,{size:12}),"Cancel as Admin"]})]})]})}),gt&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(D,{className:"text-red-500"}),"Remove Appointment"]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Are you sure you want to permanently remove this appointment from your table? This action cannot be undone."}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>Me(!1),className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:_t,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(D,{size:12}),"Remove Permanently"]})]})]})})]})}export{Gt as default};
