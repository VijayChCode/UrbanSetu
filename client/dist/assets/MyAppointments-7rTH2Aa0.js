import{g as Me,r as c,u as ze,t as g,j as e,Z as He,_ as Je,$ as qe,a0 as Ye,G as Ee,a2 as Ve,a1 as Oe,f as Ge,a3 as Ke,a4 as Xe,y as m,h as Ze,X as E,L as Qe,x as G,H as Te,a5 as Se,E as We,B as et,a8 as Be}from"./index-BrwaeCgm.js";const C="https://urbansetu.onrender.com";function nt(){const{currentUser:t}=Me(n=>n.user),[w,N]=c.useState([]),[Ae,U]=c.useState(!0),[he,K]=c.useState(null),[O,_e]=c.useState(""),[P,xe]=c.useState("all"),[D,ee]=c.useState("all"),[M,ne]=c.useState(""),[$,p]=c.useState(!1),[v,re]=c.useState(null),[z,X]=c.useState(""),[k,H]=c.useState(""),[ae,te]=c.useState(!1),[S,y]=c.useState(null),[Z,I]=c.useState([]),[B,ie]=c.useState(!1),Q=ze(),[R,le]=c.useState(null);c.useEffect(()=>{const n=async()=>{if(!t){K("Please sign in to view your appointments"),U(!1);return}try{U(!0),K(null);const a=await fetch(`${C}/api/bookings/my`,{credentials:"include"});if(a.ok){const i=await a.json();N(i)}else throw new Error("Failed to fetch appointments")}catch{K("Failed to load appointments. Please try again.")}finally{U(!1)}},r=async()=>{try{const a=await fetch(`${C}/api/bookings/archived`,{credentials:"include"});if(!a.ok)throw new Error("Not allowed");const i=await a.json();I(Array.isArray(i)?i:[])}catch{I([]),t&&(t.role==="admin"||t.role==="rootadmin")&&m.error("Failed to fetch archived appointments")}};n(),r()},[t]),c.useEffect(()=>{const n=r=>{N(a=>a.filter(i=>i._id!==r.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[t]),c.useEffect(()=>{t&&N(n=>n.map(r=>{const a={...r};return r.buyerId&&(r.buyerId._id===t._id||r.buyerId===t._id)&&(a.buyerId={...a.buyerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),r.sellerId&&(r.sellerId._id===t._id||r.sellerId===t._id)&&(a.sellerId={...a.sellerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),a}))},[t]),c.useEffect(()=>{function n(r){N(a=>a.map(i=>i._id===r.appointmentId?{...i,...r.updatedAppointment}:i))}return g.on("appointmentUpdate",n),()=>{g.off("appointmentUpdate",n)}},[]),c.useEffect(()=>{function n(a){const i=a.appointment;i.buyerId&&t&&(i.buyerId._id===t._id||i.buyerId===t._id)?i.role="buyer":i.sellerId&&t&&(i.sellerId._id===t._id||i.sellerId===t._id)&&(i.role="seller"),N(h=>[i,...h])}g.on("appointmentCreated",n);const r=a=>{N(i=>i.map(h=>{const u={...h};return h.buyerId&&(h.buyerId._id===a.userId||h.buyerId===a.userId)&&(u.buyerId={...u.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),h.sellerId&&(h.sellerId._id===a.userId||h.sellerId===a.userId)&&(u.sellerId={...u.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),u}))};return g.on("profileUpdated",r),()=>{g.off("appointmentCreated",n),g.off("profileUpdated",r)}},[t]),c.useEffect(()=>{if(!t)return;const n=setInterval(()=>{g.emit("userAppointmentsActive",{userId:t._id})},5e3);return()=>clearInterval(n)},[t]);const fe=async(n,r)=>{ne(n+r);try{const a=await fetch(`${C}/api/bookings/${n}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:r})}),i=await a.json();if(a.status===401){m.error("Session expired or unauthorized. Please sign in again."),Q("/sign-in");return}if(a.ok){N(u=>u.map(A=>A._id===n?{...A,status:r}:A));const h=r==="accepted"?"accepted":"rejected";m.success(`Appointment ${h} successfully! ${r==="accepted"?"Contact information is now visible to both parties.":""}`),Q("/user/my-appointments")}else m.error(i.message||"Failed to update appointment status.")}catch{m.error("An error occurred. Please try again.")}ne("")},ge=async n=>{const r=prompt("Please provide a reason for deleting this appointment:");if(r&&window.confirm("Are you sure you want to delete this appointment?"))try{const a=await fetch(`${C}/api/bookings/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:r})}),i=await a.json();if(a.status===401){m.error("Session expired or unauthorized. Please sign in again."),Q("/sign-in");return}a.ok?(N(h=>h.map(u=>u._id===n?{...u,status:"deletedByAdmin",adminComment:r}:u)),m.success("Appointment deleted successfully. Both buyer and seller have been notified."),Q("/user/my-appointments")):m.error(i.message||"Failed to delete appointment.")}catch{m.error("An error occurred. Please try again.")}},be=async n=>{if(window.confirm("Are you sure you want to archive this appointment? It will be moved to the archived section."))try{const r=await fetch(`${C}/api/bookings/${n}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),a=await r.json();if(r.ok){const i=w.find(h=>h._id===n);i&&(N(h=>h.filter(u=>u._id!==n)),I(h=>[{...i,archivedAt:new Date},...h])),m.success("Appointment archived successfully.")}else m.error(a.message||"Failed to archive appointment.")}catch{m.error("An error occurred. Please try again.")}},pe=async n=>{if(window.confirm("Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."))try{const r=await fetch(`${C}/api/bookings/${n}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),a=await r.json();if(r.ok){const i=Z.find(h=>h._id===n);i&&(I(h=>h.filter(u=>u._id!==n)),N(h=>[{...i,archivedAt:void 0},...h])),m.success("Appointment unarchived successfully.")}else m.error(a.message||"Failed to unarchive appointment.")}catch{m.error("An error occurred. Please try again.")}},J=w.filter(n=>{var A,l,F,T,ve,we,de,Ne,se,ce;if(t._id===((l=(A=n.buyerId)==null?void 0:A._id)==null?void 0:l.toString())&&n.visibleToBuyer===!1||t._id===((T=(F=n.sellerId)==null?void 0:F._id)==null?void 0:T.toString())&&n.visibleToSeller===!1)return!1;const r=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(P==="outdated")return r;const a=P==="all"?!0:n.status===P,i=D==="all"?!0:n.role===D,h=((ve=n.propertyName)==null?void 0:ve.toLowerCase().includes(O.toLowerCase()))||((we=n.message)==null?void 0:we.toLowerCase().includes(O.toLowerCase()))||((Ne=(de=n.buyerId)==null?void 0:de.username)==null?void 0:Ne.toLowerCase().includes(O.toLowerCase()))||((ce=(se=n.sellerId)==null?void 0:se.username)==null?void 0:ce.toLowerCase().includes(O.toLowerCase()));let u=!0;return z&&(u=u&&new Date(n.date)>=new Date(z)),k&&(u=u&&new Date(n.date)<=new Date(k)),a&&i&&h&&u}),oe=Array.isArray(Z)?Z.filter(n=>{var h,u,A,l,F,T;const r=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(P==="outdated")return r;P==="all"||n.status;const a=((h=n.propertyName)==null?void 0:h.toLowerCase().includes(O.toLowerCase()))||((u=n.message)==null?void 0:u.toLowerCase().includes(O.toLowerCase()))||((l=(A=n.buyerId)==null?void 0:A.username)==null?void 0:l.toLowerCase().includes(O.toLowerCase()))||((T=(F=n.sellerId)==null?void 0:F.username)==null?void 0:T.toLowerCase().includes(O.toLowerCase()));let i=!0;return z&&(i=i&&new Date(n.date)>=new Date(z)),k&&(i=i&&new Date(n.date)<=new Date(k)),a&&i}):[];function q(n){y({...n,date:n.date?new Date(n.date).toISOString().split("T")[0]:"",time:n.time||"",message:n.message||"",buyerReinitiationCount:n.buyerReinitiationCount||0,sellerReinitiationCount:n.sellerReinitiationCount||0}),te(!0)}async function ye(n){var h,u;if(n.preventDefault(),!S)return;const r=t&&(((h=S.buyerId)==null?void 0:h._id)===t._id||S.buyerId===t._id);if(t&&(((u=S.sellerId)==null?void 0:u._id)===t._id||(S.sellerId,t._id)),(r?S.buyerReinitiationCount||0:S.sellerReinitiationCount||0)>=2){m.error("You have reached the maximum number of reinitiations for your role.");return}if(!S.buyerId||!S.sellerId){m.error("Cannot reinitiate: one of the parties no longer exists.");return}const i={...S,status:"pending"};try{const A=await fetch(`${C}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(i)}),l=await A.json();A.ok?(m.success("Appointment reinitiated successfully!"),te(!1),y(null),Q("/user/my-appointments"),N(F=>F.map(T=>T._id===l.appointment._id?{...T,...l.appointment}:T))):m.error(l.message||"Failed to reinitiate appointment.")}catch{m.error("An error occurred. Please try again.")}}const Y=(n,r)=>{N(a=>a.map(i=>i._id===n?{...i,status:r}:i))},je=async()=>{U(!0),K(null);try{const n=await fetch(`${C}/api/bookings/my`,{credentials:"include"});if(n.ok){const a=await n.json();N(a)}else throw new Error("Failed to fetch appointments");const r=await fetch(`${C}/api/bookings/archived`,{credentials:"include"});if(r.ok){const a=await r.json();I(Array.isArray(a)?a:[])}}catch{K("Failed to refresh appointments. Please try again.")}finally{U(!1)}};return Ae?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):he?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:he})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(He,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:B?"Archived Appointments":"My Appointments"}),!B&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"💡 Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."})]}),e.jsx("button",{onClick:je,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),t&&(t.role==="admin"||t.role==="rootadmin")&&e.jsx("button",{onClick:()=>ie(!B),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${B?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:B?e.jsxs(e.Fragment,{children:[e.jsx(Je,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{})," Archived Appointments (",Z.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:P,onChange:n=>xe(n.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:z,onChange:n=>X(n.target.value),max:k||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:k,onChange:n=>H(n.target.value),min:z||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:D,onChange:n=>ee(n.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:O,onChange:n=>_e(n.target.value)})]})]}),B&&t&&(t.role==="admin"||t.role==="rootadmin")?oe.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:oe.map(n=>e.jsx(Re,{appt:n,currentUser:t,handleStatusUpdate:fe,handleAdminDelete:ge,actionLoading:M,onShowOtherParty:r=>{re(r),p(!0)},onOpenReinitiate:()=>q(n),handleArchiveAppointment:be,handleUnarchiveAppointment:pe,isArchived:!0,onCancelRefresh:Y},n._id))})]})}):J.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:J.map(n=>e.jsx(Re,{appt:n,currentUser:t,handleStatusUpdate:fe,handleAdminDelete:ge,actionLoading:M,onShowOtherParty:r=>{re(r),p(!0)},onOpenReinitiate:()=>q(n),handleArchiveAppointment:be,handleUnarchiveAppointment:pe,isArchived:!1,onCancelRefresh:Y},n._id))})]})}),$&&v&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>p(!1),title:"Close","aria-label":"Close",children:e.jsx(Ee,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[v.avatar&&v.avatar.trim()&&v.avatar!=="null"&&v.avatar!=="undefined"?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:v.avatar,alt:v.username,className:"w-16 h-16 rounded-full object-cover border-4 border-white shadow-lg",onError:n=>{n.target.style.display="none",n.target.nextElementSibling.style.display="flex"}}),e.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",style:{display:"none"},children:e.jsx("span",{className:"text-white font-bold text-lg",children:v.username?v.username.split(" ").map(n=>n.charAt(0).toUpperCase()).join("").slice(0,2):"U"})})]}):e.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-lg",children:v.username?v.username.split(" ").map(n=>n.charAt(0).toUpperCase()).join("").slice(0,2):"U"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(Ve,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[v.username||"User",v.role==="admin"&&e.jsx(Oe,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:v.role||"User"})]})]})}),e.jsxs("div",{className:"px-6 py-6 space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(Ge,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:v.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Ke,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:v.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Xe,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:v.createdAt?new Date(v.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]}),e.jsx("button",{onClick:()=>p(!1),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold",children:"Close"})]})]})}),ae&&S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:ye,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:S.date,onChange:n=>y(r=>({...r,date:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:S.time,onChange:n=>y(r=>({...r,time:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:S.message,onChange:n=>y(r=>({...r,message:n.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>te(!1),children:"Cancel"})]})]})})]})]})}function tt(t){const w=new Date,N=new Date;return N.setDate(w.getDate()-1),t.toDateString()===w.toDateString()?"Today":t.toDateString()===N.toDateString()?"Yesterday":t.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function Re({appt:t,currentUser:w,handleStatusUpdate:N,handleAdminDelete:Ae,actionLoading:U,onShowOtherParty:he,onOpenReinitiate:K,handleArchiveAppointment:O,handleUnarchiveAppointment:_e,isArchived:P,onCancelRefresh:xe}){const[D,ee]=c.useState(null),[M,ne]=c.useState(""),[$,p]=c.useState(t.comments||[]),[v,re]=c.useState(!1),[z,X]=c.useState(null),[k,H]=c.useState(""),[ae,te]=c.useState(null),S=Ze(),[y,Z]=c.useState(!1),I=c.useRef(null),B=c.useRef(null),[ie,Q]=c.useState(!0),[R,le]=c.useState(0),[fe,ge]=c.useState(!1),[be,pe]=c.useState(!1),[J,oe]=c.useState(!1),q=c.useRef(null),ye=c.useRef(null),Y=c.useRef({});function je(s){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${s}`))||[]}catch{return[]}}function n(s,o){const d=je(s);if(!d.includes(o)){const f=[...d,o];localStorage.setItem(`removedDeletedMsgs_${s}`,JSON.stringify(f))}}const r=(w.role==="admin"||w.role==="rootadmin")&&w.adminApprovalStatus==="approved",a=S.pathname.includes("/admin"),i=t.role==="seller",h=t.role==="buyer",u=new Date(t.date)>new Date||new Date(t.date).toDateString()===new Date().toDateString()&&(!t.time||t.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),A=(r||t.status==="accepted")&&u,l=i?t.buyerId:t.sellerId,F=async()=>{if(!M.trim())return;re(!0);const s=`temp-${Date.now()}`,o={_id:s,senderEmail:w.email,message:M,status:"sending",timestamp:new Date().toISOString(),readBy:[w._id],...D?{replyTo:D._id}:{}};p(d=>[...d,o]),ne(""),ee(null);try{const d=await fetch(`${C}/api/bookings/${t._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:M,...D?{replyTo:D._id}:{}})}),f=await d.json();d.ok?(p(x=>[...x.filter(b=>b._id!==s),...f.comments.filter(b=>!x.some(_=>_._id===b._id))]),m.success("Comment sent successfully!")):(p(x=>x.filter(b=>b._id!==s)),m.error(f.message||"Failed to send comment."))}catch{p(f=>f.filter(x=>x._id!==s)),m.error("An error occurred. Please try again.")}re(!1)},T=async s=>{if(!k.trim())return;te(s),p(d=>d.map(f=>f._id===s?{...f,message:k,edited:!0,editedAt:new Date}:f)),X(null),H("");try{const d=await fetch(`${C}/api/bookings/${t._id}/comment/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:k})}),f=await d.json();d.ok?(p(x=>x.map(b=>{const _=f.comments.find(L=>L._id===b._id);return _?_._id===s?_:b.status==="read"&&_.status!=="read"?{..._,status:"read"}:_:b})),m.success("Comment edited successfully!")):(p(x=>x.map(b=>b._id===s?{...b,message:b.originalMessage||b.message,edited:b.wasEdited||!1}:b)),X(s),H(k),m.error(f.message||"Failed to edit comment."))}catch{p(f=>f.map(x=>x._id===s?{...x,message:x.originalMessage||x.message,edited:x.wasEdited||!1}:x)),X(s),H(k),m.error("An error occurred. Please try again.")}finally{te(null)}},ve=s=>{X(s._id),H(s.message),p(o=>o.map(d=>d._id===s._id?{...d,originalMessage:d.message,wasEdited:d.edited}:d))},we=s=>{switch(s){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},de=async()=>{let s="";if(i){if(s=prompt("Please provide a reason for cancelling this appointment (required):"),!s)return m.error("Reason is required for seller cancellation.")}else s=prompt("Please provide a reason for cancelling this appointment (optional):")||"";if(window.confirm("Are you sure you want to cancel this appointment?"))try{const o=await fetch(`${C}/api/bookings/${t._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:s})}),d=await o.json();if(o.status===401){m.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}o.ok?(m.success("Appointment cancelled successfully."),typeof xe=="function"&&xe(t._id,i?"cancelledBySeller":"cancelledByBuyer")):m.error(d.message||"Failed to cancel appointment.")}catch{m.error("An error occurred. Please try again.")}},Ne=async()=>{const s=prompt("Please provide a reason for admin cancellation (required):");if(!s)return m.error("Reason is required for admin cancellation.");if(window.confirm("Are you sure you want to cancel this appointment as admin?"))try{const o=await fetch(`${C}/api/bookings/${t._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:s})}),d=await o.json();if(o.status===401){m.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}o.ok?(m.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):m.error(d.message||"Failed to cancel appointment.")}catch{m.error("An error occurred. Please try again.")}},se=async()=>{if(window.confirm("Are you sure you want to permanently remove this appointment from your table? This cannot be undone."))try{const s=h?"buyer":i?"seller":null;if(!s)return;if((await fetch(`${C}/api/bookings/${t._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:s})})).ok){if(typeof window<"u"){const d=new CustomEvent("removeAppointmentRow",{detail:t._id});window.dispatchEvent(d),m.success("Appointment removed from your table sucessfully")}}else m.error("Failed to remove appointment from table.")}catch{m.error("An error occurred. Please try again.")}};E.useEffect(()=>{y&&I.current&&I.current.scrollIntoView({behavior:"smooth"})},[y]);const ce=c.useRef($.length);E.useEffect(()=>{const s=$.length-ce.current;ce.current=$.length,s>0&&y&&(ie?setTimeout(()=>{I.current&&I.current.scrollIntoView({behavior:"smooth"})},100):le(o=>o+s))},[$.length,ie,y]);const Ce=E.useCallback(()=>{if(B.current){const{scrollTop:s,scrollHeight:o,clientHeight:d}=B.current,f=o-s-d<5;Q(f),f&&R>0&&le(0)}},[R]);E.useEffect(()=>{const s=B.current;if(s&&y)return s.addEventListener("scroll",Ce),Ce(),()=>{s.removeEventListener("scroll",Ce)}},[y,Ce]);const $e=E.useCallback(()=>{I.current&&(I.current.scrollIntoView({behavior:"smooth"}),le(0))},[]);E.useEffect(()=>{function s(o){var d,f;if(o.appointmentId===t._id&&!y){const x=o.comment.senderEmail===((d=t.buyerId)==null?void 0:d.email),b=o.comment.senderEmail===((f=t.sellerId)==null?void 0:f.email),L=!x&&!b?"Organization":o.comment.senderEmail||"User";m.info(`New message from ${L}`)}}return g.on("commentUpdate",s),()=>{g.off("commentUpdate",s)}},[t._id,y]),E.useEffect(()=>{function s(o){o.appointmentId===t._id&&(p(d=>{const f=d.findIndex(x=>x._id===o.comment._id);if(f!==-1){const x=[...d],b=d[f],_=o.comment;let L=_.status;return b.status==="read"&&_.status!=="read"&&(L="read"),x[f]={..._,status:L},x}else return[...d,o.comment]}),y&&o.comment.senderEmail!==w.email&&fetch(`${C}/api/bookings/${t._id}/comments/read`,{method:"PATCH",credentials:"include"}))}return g.on("commentUpdate",s),()=>{g.off("commentUpdate",s)}},[t._id,p,y,w.email]),E.useEffect(()=>{y&&(fetch(`${C}/api/bookings/${t._id}`).then(s=>s.json()).then(s=>{s&&Array.isArray(s.comments)&&p(o=>s.comments.map(d=>{const f=o.find(x=>x._id===d._id);return f&&f.status==="read"&&d.status!=="read"?{...d,status:"read"}:d}))}),fetch(`${C}/api/bookings/${t._id}/comments/read`,{method:"PATCH",credentials:"include"}))},[y,t._id]),E.useEffect(()=>{function s(d){d.appointmentId===t._id&&p(f=>f.map(x=>x._id===d.commentId?{...x,status:x.status==="read"?"read":"delivered"}:x))}function o(d){d.appointmentId===t._id&&p(f=>f.map(x=>{var b;return(b=x.readBy)!=null&&b.includes(d.userId)?x:{...x,status:"read",readBy:[...x.readBy||[],d.userId]}}))}return g.on("commentDelivered",s),g.on("commentRead",o),()=>{g.off("commentDelivered",s),g.off("commentRead",o)}},[t._id,p]);const me=$.filter(s=>{var o;return!((o=s.readBy)!=null&&o.includes(w._id))&&s.senderEmail!==w.email}).length;E.useEffect(()=>(y?document.body.style.overflow="hidden":(document.body.style.overflow="",le(0)),()=>{document.body.style.overflow=""}),[y]);const ke=`chatClearTime_${t._id}`,Fe=Number(localStorage.getItem(ke))||0,Le=je(t._id),Ue=$.filter(s=>new Date(s.timestamp).getTime()>Fe&&!Le.includes(s._id));return c.useEffect(()=>{if(!y||!(l!=null&&l._id))return;g.emit("checkUserOnline",{userId:l._id});function s(o){o.userId===l._id&&ge(!!o.online)}return g.on("userOnlineStatus",s),g.on("userOnlineUpdate",s),()=>{g.off("userOnlineStatus",s),g.off("userOnlineUpdate",s)}},[y,l==null?void 0:l._id]),c.useEffect(()=>{if(!(l!=null&&l._id))return;g.emit("checkUserOnline",{userId:l._id});function s(o){o.userId===l._id&&pe(!!o.online)}return g.on("userOnlineStatus",s),g.on("userOnlineUpdate",s),()=>{g.off("userOnlineStatus",s),g.off("userOnlineUpdate",s)}},[l==null?void 0:l._id]),c.useEffect(()=>{function s(o){o.fromUserId===(l==null?void 0:l._id)&&o.appointmentId===t._id&&(oe(!0),q.current&&clearTimeout(q.current),q.current=setTimeout(()=>oe(!1),2e3))}return g.on("typing",s),()=>{g.off("typing",s),q.current&&clearTimeout(q.current)}},[l==null?void 0:l._id,t._id]),e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${u?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(t.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:t.time}),!u&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:t.listingId?e.jsx(Qe,{to:a?`/admin/listing/${t.listingId._id}`:`/user/listing/${t.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:t.propertyName}):e.jsx("div",{className:"font-semibold",children:t.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${i?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:i?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[A?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>he(l),title:"Click to view details",children:(l==null?void 0:l.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(l==null?void 0:l.username)||"Unknown"}),A?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:l==null?void 0:l.email}),e.jsx("div",{className:"text-sm text-gray-600",children:l!=null&&l.mobileNumber&&(l==null?void 0:l.mobileNumber)!==""?l.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:r?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:t.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:t.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${we(t.status)}`,children:t.status==="cancelledByBuyer"?"Cancelled by Buyer":t.status==="cancelledBySeller"?"Cancelled by Seller":t.status==="cancelledByAdmin"?"Cancelled by Admin":t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:u?e.jsxs(e.Fragment,{children:[i&&t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>N(t._id,"accepted"),disabled:U===t._id+"accepted",title:"Accept Appointment",children:e.jsx(Te,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>N(t._id,"rejected"),disabled:U===t._id+"rejected",title:"Reject Appointment",children:e.jsx(Ee,{})})]}),i&&t.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:de,title:"Cancel Appointment (Seller)",children:e.jsx(G,{})}),i&&(t.status==="cancelledBySeller"||t.status==="cancelledByBuyer"||t.status==="cancelledByAdmin"||t.status==="rejected"||t.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:se,title:"Remove from table",style:{opacity:.5},children:e.jsx(G,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),h&&(t.status==="pending"||t.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:de,title:"Cancel Appointment (Buyer)",children:e.jsx(G,{})}),h&&(t.status==="cancelledByBuyer"||t.status==="cancelledBySeller"||t.status==="cancelledByAdmin"||t.status==="deletedByAdmin"||t.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:se,title:"Remove from table",style:{opacity:.5},children:e.jsx(G,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),r&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Ne,title:"Cancel Appointment (Admin)",children:e.jsx(Oe,{})}),(t.status==="cancelledByBuyer"&&h||t.status==="cancelledBySeller"&&i)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>K(t),disabled:t.status==="cancelledByBuyer"&&h&&(t.buyerReinitiationCount||0)>=2||t.status==="cancelledBySeller"&&i&&(t.sellerReinitiationCount||0)>=2||!t.buyerId||!t.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:h&&t.status==="cancelledByBuyer"?`${2-(t.buyerReinitiationCount||0)} left`:i&&t.status==="cancelledBySeller"?`${2-(t.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:se,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(G,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-2 shadow-md mx-auto relative ${u?"bg-blue-100 hover:bg-blue-200 text-blue-700":"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50"}`,title:u?"Open Chat":"Chat not available for outdated appointments",onClick:u?()=>Z(!0):void 0,disabled:!u,children:[e.jsx(Se,{size:20}),J&&u&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!J&&me>0&&!u&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:me}),!J&&me>0&&u&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:me}),!J&&me===0&&be&&u&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 rounded-2xl shadow-2xl max-w-md w-full p-0 relative animate-fadeIn flex flex-col",children:[u?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-200 to-purple-200 rounded-t-2xl relative",children:[e.jsx(Se,{className:"text-blue-600 text-xl"}),e.jsx("h3",{className:"text-lg font-bold text-blue-800",children:"Chat"}),J?e.jsx("span",{className:"ml-3 text-blue-600 font-semibold text-sm",children:"Typing..."}):fe?e.jsx("span",{className:"ml-3 text-green-600 font-semibold text-sm",children:"Online"}):e.jsx("span",{className:"ml-3 text-gray-600 font-semibold text-sm",children:"Offline"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>{localStorage.setItem(ke,Date.now()),p([])},title:"Clear chat locally",children:"Clear Chat"}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>Z(!1),title:"Close","aria-label":"Close",children:"×"})]})]}),e.jsxs("div",{ref:B,className:"flex-1 max-h-60 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",children:[D&&e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 mb-2 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsx("span",{className:"text-xs text-gray-600 truncate",children:D.message}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700",onClick:()=>ee(null),title:"Cancel reply",children:"×"})]}),Ue.map((s,o)=>{var L,Ie;const d=s.senderEmail===w.email,f=z===s._id,x=new Date(s.timestamp),b=o>0?new Date($[o-1].timestamp):null,_=b?x.toDateString()!==b.toDateString():!0;return x.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(E.Fragment,{children:[_&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-gray-200 text-gray-700 text-xs px-3 py-1 rounded-full shadow",children:tt(x)})}),e.jsx("div",{className:`flex w-full ${d?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*o}s`},children:e.jsxs("div",{ref:j=>Y.current[s._id]=j,className:`rounded-2xl px-4 py-2 text-sm shadow-lg max-w-[60%] break-words relative ${d?"bg-gradient-to-r from-blue-400 to-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,style:{animationDelay:`${.03*o}s`},children:[s.replyTo&&e.jsx("div",{className:"border-l-4 border-blue-300 pl-2 mb-1 text-xs text-gray-500 bg-blue-50 rounded w-full max-w-full break-words cursor-pointer",onClick:()=>{Y.current[s.replyTo]&&(Y.current[s.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),Y.current[s.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{Y.current[s.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsx("span",{className:"text-xs text-gray-600 truncate",children:((L=$.find(j=>j._id===s.replyTo))==null?void 0:L.message)||"Original message"})}),e.jsxs("div",{className:"font-semibold mb-1 flex items-center gap-2 flex-wrap break-all",children:[e.jsx("span",{className:"truncate max-w-[60%] min-w-[80px] inline-block align-middle overflow-hidden text-ellipsis",children:d?"You":(()=>{var W,ue;const j=s.senderEmail===((W=t.buyerId)==null?void 0:W.email),V=s.senderEmail===((ue=t.sellerId)==null?void 0:ue.email);return!j&&!V?"Organization":(l==null?void 0:l.username)||s.senderName||s.senderEmail})()}),e.jsx("span",{className:"text-gray-300 ml-2 text-[10px]",children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsx("div",{className:"flex items-center gap-1",children:s.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(We,{className:"inline-block text-lg"})," ",s.senderEmail===w.email?"You deleted this message":"This message was deleted.",e.jsx("button",{className:"ml-2 text-red-700 hover:text-red-900",onClick:()=>{p(j=>j.filter(V=>V._id!==s._id)),n(t._id,s._id)},title:"Remove this deleted message from your chat view",children:e.jsx(G,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})})]}):f?e.jsxs("div",{className:"w-full",children:[e.jsx("input",{type:"text",className:"border rounded px-2 py-1 text-xs w-full text-gray-900 bg-white focus:bg-white mb-2",value:k,onChange:j=>H(j.target.value),onKeyDown:j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),T(s._id))},autoFocus:!0}),e.jsxs("div",{className:"flex gap-1 justify-end",children:[e.jsx("button",{onClick:()=>T(s._id),disabled:ae===s._id,className:"bg-green-700 hover:bg-green-900 disabled:bg-green-500 disabled:cursor-not-allowed text-white font-bold px-2 py-1 rounded text-xs flex items-center gap-1",children:ae===s._id?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save"}),e.jsx("button",{onClick:()=>{X(null),H("")},disabled:ae===s._id,className:"bg-red-700 hover:bg-red-900 disabled:bg-red-500 disabled:cursor-not-allowed text-white font-bold px-2 py-1 rounded text-xs",children:"Cancel"})]})]}):e.jsxs("div",{children:[s.message,s.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})}),e.jsxs("div",{className:"flex items-center gap-2 justify-end mt-1",children:[!s.deleted&&e.jsx("button",{className:`${d?"text-yellow-500 hover:text-yellow-700":"text-blue-600 hover:text-blue-800"}`,onClick:()=>{var j;ee(s),(j=ye.current)==null||j.focus()},title:"Reply",children:e.jsx("svg",{width:"18",height:"18",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),s.senderEmail===w.email&&!f&&!s.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ve(s),className:"text-green-700 hover:text-green-900",title:"Edit comment",children:e.jsx(et,{size:12})}),e.jsx("button",{className:"text-red-700 hover:text-red-900",onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{const j=await fetch(`${C}/api/bookings/${t._id}/comment/${s._id}`,{method:"DELETE",credentials:"include"}),V=await j.json();j.ok?(p(De=>V.comments.map(W=>{const ue=De.find(Pe=>Pe._id===W._id);return ue&&ue.status==="read"&&W.status!=="read"?{...W,status:"read"}:W})),m.success("Comment deleted successfully!")):m.error(V.message||"Failed to delete comment.")}catch{m.error("An error occurred. Please try again.")}},children:e.jsx(G,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),e.jsx("span",{className:"ml-1",children:(Ie=s.readBy)!=null&&Ie.includes(l==null?void 0:l._id)?e.jsx(Be,{className:"text-white inline"}):s.status==="delivered"?e.jsx(Be,{className:"text-white/70 inline"}):e.jsx(Te,{className:"text-white/70 inline"})})]}),!d&&!f&&!s.deleted&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>{p(j=>j.filter(V=>V._id!==s._id)),n(t._id,s._id)},title:"Delete message locally",children:e.jsx(G,{size:14})})]})]})})]},s._id||o)}),e.jsx("div",{ref:I})]}),e.jsxs("div",{className:"flex gap-2 mt-2 px-4 pb-4",children:[D&&e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 mb-2 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsx("span",{className:"text-xs text-gray-600 truncate",children:D.message}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700",onClick:()=>ee(null),title:"Cancel reply",children:"×"})]}),e.jsx("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-full text-sm focus:ring-2 focus:ring-blue-200 shadow",placeholder:"Type a message...",value:M,onChange:s=>{ne(s.target.value),g.emit("typing",{toUserId:l._id,fromUserId:w._id,appointmentId:t._id})},onKeyDown:s=>{s.key==="Enter"&&F()},ref:ye}),e.jsx("button",{onClick:F,disabled:v||!M.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-full text-sm font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50 flex items-center gap-2",children:v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(10px) scale(0.98); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                  }
                `})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-60 p-8",children:[e.jsx(Se,{className:"text-4xl text-gray-400 mb-4"}),e.jsx("div",{className:"text-lg font-semibold text-gray-500 text-center",children:"Chat not available for outdated appointments"})]}),!ie&&u&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:$e,className:"bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-all duration-200 hover:scale-110 relative",title:R>0?`${R} new message${R>1?"s":""}`:"Scroll to bottom","aria-label":R>0?`${R} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),R>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:R>99?"99+":R})]})})]})})]})}export{nt as default};
