import{g as ue,r as o,u as me,v as y,j as e,P as he,a4 as xe,a5 as pe,G as be,U as fe,a7 as ge,a6 as ye,f as ve,a8 as je,a9 as we,y as d}from"./index-DLZ1a-qy.js";const N="https://urbansetu.onrender.com";function Se(){const{currentUser:r}=ue(t=>t.user),[Z,m]=o.useState([]),[ee,A]=o.useState(!0),[L,C]=o.useState(null),[x,te]=o.useState(""),[f,se]=o.useState("all"),[k,re]=o.useState("all"),[P,O]=o.useState(""),[ae,_]=o.useState(!1),[h,U]=o.useState(null),[v,ne]=o.useState(""),[j,oe]=o.useState(""),[le,R]=o.useState(!1),[c,S]=o.useState(null),[D,I]=o.useState([]),[w,ie]=o.useState(!1),F=me(),[Ne,Ae]=o.useState(null);o.useEffect(()=>{const t=async()=>{if(!r){C("Please sign in to view your appointments"),A(!1);return}try{A(!0),C(null);const a=await fetch(`${N}/api/bookings/my`,{credentials:"include"});if(a.ok){const n=await a.json();m(n)}else throw new Error("Failed to fetch appointments")}catch{C("Failed to load appointments. Please try again.")}finally{A(!1)}},s=async()=>{if(r&&(r.role==="admin"||r.role==="rootadmin"))try{const a=await fetch(`${N}/api/bookings/archived`,{credentials:"include"});if(!a.ok)throw new Error("Not allowed");const n=await a.json();I(Array.isArray(n)?n:[])}catch{I([]),d.error("Failed to fetch archived appointments")}else I([])};t(),s()},[r]),o.useEffect(()=>{const t=s=>{m(a=>a.filter(n=>n._id!==s.detail))};return window.addEventListener("removeAppointmentRow",t),()=>{window.removeEventListener("removeAppointmentRow",t)}},[r]),o.useEffect(()=>{r&&m(t=>t.map(s=>{const a={...s};return s.buyerId&&(s.buyerId._id===r._id||s.buyerId===r._id)&&(a.buyerId={...a.buyerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),s.sellerId&&(s.sellerId._id===r._id||s.sellerId===r._id)&&(a.sellerId={...a.sellerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),a}))},[r]),o.useEffect(()=>{function t(s){m(a=>a.map(n=>n._id===s.appointmentId?{...n,...s.updatedAppointment}:n))}return y.on("appointmentUpdate",t),()=>{y.off("appointmentUpdate",t)}},[]),o.useEffect(()=>{function t(a){const n=a.appointment;n.buyerId&&r&&(n.buyerId._id===r._id||n.buyerId===r._id)?n.role="buyer":n.sellerId&&r&&(n.sellerId._id===r._id||n.sellerId===r._id)&&(n.role="seller"),m(l=>[n,...l])}y.on("appointmentCreated",t);const s=a=>{m(n=>n.map(l=>{const i={...l};return l.buyerId&&(l.buyerId._id===a.userId||l.buyerId===a.userId)&&(i.buyerId={...i.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),l.sellerId&&(l.sellerId._id===a.userId||l.sellerId===a.userId)&&(i.sellerId={...i.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),i}))};return y.on("profileUpdated",s),()=>{y.off("appointmentCreated",t),y.off("profileUpdated",s)}},[r]),o.useEffect(()=>{if(!r)return;const t=setInterval(()=>{y.emit("userAppointmentsActive",{userId:r._id})},1e3);return()=>clearInterval(t)},[r]);const E=async(t,s)=>{O(t+s);try{const a=await fetch(`${N}/api/bookings/${t}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:s})}),n=await a.json();if(a.status===401){d.error("Session expired or unauthorized. Please sign in again."),F("/sign-in");return}if(a.ok){m(i=>i.map(u=>u._id===t?{...u,status:s}:u));const l=s==="accepted"?"accepted":"rejected";d.success(`Appointment ${l} successfully! ${s==="accepted"?"Contact information is now visible to both parties.":""}`,{autoClose:3e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),F("/user/my-appointments")}else d.error(n.message||"Failed to update appointment status.")}catch{d.error("An error occurred. Please try again.")}O("")},M=async t=>{setAppointmentToHandle(t),setDeleteReason(""),setShowDeleteAppointmentModal(!0)},T=async t=>{setAppointmentToHandle(t),setShowArchiveModal(!0)},B=async t=>{setAppointmentToHandle(t),setShowUnarchiveModal(!0)},$=Z.filter(t=>{var u,p,g,b,W,Y,K,Q,V,X;if(r._id===((p=(u=t.buyerId)==null?void 0:u._id)==null?void 0:p.toString())&&t.visibleToBuyer===!1||r._id===((b=(g=t.sellerId)==null?void 0:g._id)==null?void 0:b.toString())&&t.visibleToSeller===!1)return!1;const s=new Date(t.date)<new Date||new Date(t.date).toDateString()===new Date().toDateString()&&t.time&&t.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(f==="outdated")return s;const a=f==="all"?!0:t.status===f,n=k==="all"?!0:t.role===k,l=((W=t.propertyName)==null?void 0:W.toLowerCase().includes(x.toLowerCase()))||((Y=t.message)==null?void 0:Y.toLowerCase().includes(x.toLowerCase()))||((Q=(K=t.buyerId)==null?void 0:K.username)==null?void 0:Q.toLowerCase().includes(x.toLowerCase()))||((X=(V=t.sellerId)==null?void 0:V.username)==null?void 0:X.toLowerCase().includes(x.toLowerCase()));let i=!0;return v&&(i=i&&new Date(t.date)>=new Date(v)),j&&(i=i&&new Date(t.date)<=new Date(j)),a&&n&&l&&i}),z=Array.isArray(D)?D.filter(t=>{var l,i,u,p,g,b;const s=new Date(t.date)<new Date||new Date(t.date).toDateString()===new Date().toDateString()&&t.time&&t.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(f==="outdated")return s;f==="all"||t.status;const a=((l=t.propertyName)==null?void 0:l.toLowerCase().includes(x.toLowerCase()))||((i=t.message)==null?void 0:i.toLowerCase().includes(x.toLowerCase()))||((p=(u=t.buyerId)==null?void 0:u.username)==null?void 0:p.toLowerCase().includes(x.toLowerCase()))||((b=(g=t.sellerId)==null?void 0:g.username)==null?void 0:b.toLowerCase().includes(x.toLowerCase()));let n=!0;return v&&(n=n&&new Date(t.date)>=new Date(v)),j&&(n=n&&new Date(t.date)<=new Date(j)),a&&n}):[];function H(t){S({...t,date:t.date?new Date(t.date).toISOString().split("T")[0]:"",time:t.time||"",message:t.message||"",buyerReinitiationCount:t.buyerReinitiationCount||0,sellerReinitiationCount:t.sellerReinitiationCount||0}),R(!0)}async function de(t){var l,i;if(t.preventDefault(),!c)return;const s=r&&(((l=c.buyerId)==null?void 0:l._id)===r._id||c.buyerId===r._id);if(r&&(((i=c.sellerId)==null?void 0:i._id)===r._id||(c.sellerId,r._id)),(s?c.buyerReinitiationCount||0:c.sellerReinitiationCount||0)>=2){d.error("You have reached the maximum number of reinitiations for your role.");return}if(!c.buyerId||!c.sellerId){d.error("Cannot reinitiate: one of the parties no longer exists.");return}const n={...c,status:"pending"};try{const u=await fetch(`${N}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),p=await u.json();u.ok?(d.success("Appointment reinitiated successfully!",{autoClose:5e3,closeOnClick:!0,pauseOnHover:!1,draggable:!1}),R(!1),S(null),F("/user/my-appointments"),m(g=>g.map(b=>b._id===p.appointment._id?{...b,...p.appointment}:b))):d.error(p.message||"Failed to reinitiate appointment.")}catch{d.error("An error occurred. Please try again.")}}const q=(t,s)=>{m(a=>a.map(n=>n._id===t?{...n,status:s}:n))},ce=async()=>{A(!0),C(null);try{const t=await fetch(`${N}/api/bookings/my`,{credentials:"include"});if(t.ok){const s=await t.json();m(s)}else throw new Error("Failed to fetch appointments");if(r&&(r.role==="admin"||r.role==="rootadmin")){const s=await fetch(`${N}/api/bookings/archived`,{credentials:"include"});if(s.ok){const a=await s.json();I(Array.isArray(a)?a:[])}}else I([])}catch{C("Failed to refresh appointments. Please try again.")}finally{A(!1)}},J=t=>{if(console.log("Copy button clicked, message:",t),!t){d.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t).then(()=>{d.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{G(t)}):G(t)},G=t=>{try{const s=document.createElement("textarea");s.value=t,s.style.position="fixed",s.style.left="-999999px",s.style.top="-999999px",document.body.appendChild(s),s.focus(),s.select();const a=document.execCommand("copy");document.body.removeChild(s),a?(console.log("Copy successful via fallback method"),d.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),d.error("Failed to copy message"))}catch(s){console.error("Fallback copy error:",s),d.error("Copy not supported")}};return ee?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):L?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:L})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:w?"Archived Appointments":"My Appointments"}),!w&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Monitor all appointments across the platform. Use the status filter to view appointments and interactive chatbox to connect with otherparty."})]}),e.jsx("button",{onClick:ce,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),r&&(r.role==="admin"||r.role==="rootadmin")&&e.jsx("button",{onClick:()=>ie(!w),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${w?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:w?e.jsxs(e.Fragment,{children:[e.jsx(he,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{})," Archived Appointments (",D.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:f,onChange:t=>se(t.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:v,onChange:t=>ne(t.target.value),max:j||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:j,onChange:t=>oe(t.target.value),min:v||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:k,onChange:t=>re(t.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:x,onChange:t=>te(t.target.value)})]})]}),w&&r&&(r.role==="admin"||r.role==="rootadmin")?z.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:z.map(t=>e.jsx(AppointmentRow,{appt:t,currentUser:r,handleStatusUpdate:E,handleAdminDelete:M,actionLoading:P,onShowOtherParty:s=>{U(s),_(!0)},onOpenReinitiate:()=>H(t),handleArchiveAppointment:T,handleUnarchiveAppointment:B,isArchived:!0,onCancelRefresh:q,copyMessageToClipboard:J},t._id))})]})}):$.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:$.map(t=>e.jsx(AppointmentRow,{appt:t,currentUser:r,handleStatusUpdate:E,handleAdminDelete:M,actionLoading:P,onShowOtherParty:s=>{U(s),_(!0)},onOpenReinitiate:()=>H(t),handleArchiveAppointment:T,handleUnarchiveAppointment:B,isArchived:!1,onCancelRefresh:q,copyMessageToClipboard:J},t._id))})]})}),ae&&h&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>_(!1),title:"Close","aria-label":"Close",children:e.jsx(be,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(fe,{user:{username:h.username,avatar:h.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(ge,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[h.username||"User",h.role==="admin"&&e.jsx(ye,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:h.role||"User"})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(ve,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:h.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(je,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:h.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(we,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:h.createdAt?new Date(h.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]})})]})}),le&&c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:c.date,onChange:t=>S(s=>({...s,date:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:c.time,onChange:t=>S(s=>({...s,time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:c.message,onChange:t=>S(s=>({...s,message:t.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>R(!1),children:"Cancel"})]})]})})]})})}export{Se as default};
