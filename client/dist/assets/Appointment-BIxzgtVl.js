import{g as B,h as T,u as L,r as a,j as e,y as i}from"./index-DNwTbvcj.js";import{C as R}from"./ContactSupportWrapper-CspIlt0B.js";const v="https://urbansetu.onrender.com";function F(){const{currentUser:s}=B(n=>n.user),j=T(),m=L(),d=new URLSearchParams(j.search),l=d.get("listingId"),N=d.get("propertyName"),k=d.get("propertyDescription"),g=d.get("listingType"),[t,S]=a.useState({date:"",time:"",message:"",purpose:"",propertyName:N||"",propertyDescription:k||""}),[D,A]=a.useState(!1),[x,y]=a.useState(!1),[f,C]=a.useState(!1),[u,p]=a.useState(!1),[w,h]=a.useState(!0),c=n=>{S(o=>({...o,[n.target.name]:n.target.value}))};a.useEffect(()=>{async function n(){if(!s||!l){p(!1),h(!1);return}h(!0);try{const o=await fetch(`${v}/api/bookings/my`,{credentials:"include"});if(o.ok){const b=await o.json(),I=["pending","accepted"],q=b.find(r=>!r.buyerId||r.buyerId._id!==s._id&&r.buyerId!==s._id||!r.listingId||r.listingId._id!==l&&r.listingId!==l||new Date(r.date)<new Date||new Date(r.date).toDateString()===new Date().toDateString()&&r.time&&r.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})?!1:!!(I.includes(r.status)||r.status==="cancelledByBuyer"&&(r.buyerReinitiationCount||0)<2));p(!!q)}else p(!1)}catch{p(!1)}finally{h(!1)}}n()},[s,l]);const P=async n=>{if(n.preventDefault(),u){i.info("You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again.");return}if(!f){i.warning("You must agree to share your contact information with the seller to book an appointment.");return}if(!s){i.info("Please sign in to book an appointment."),m("/sign-in");return}if(!t.date||!t.time||!t.message||!t.purpose||!t.propertyName||!t.propertyDescription){i.warning("Please fill out all fields before booking the appointment.");return}if(!l){i.warning("Listing information is missing. Please try again.");return}y(!0);try{const o=await fetch(`${v}/api/bookings`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({...t,listingId:l})}),b=await o.json();o.ok?(A(!0),setTimeout(()=>{s&&(s.role==="admin"||s.role==="rootadmin")?m("/admin/appointments"):m("/user/my-appointments")},2e3)):i.error(b.message||"Failed to book appointment.")}catch(o){console.error("Error booking appointment:",o),i.error("An error occurred. Please try again.")}finally{y(!1)}};return s?e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:[e.jsxs("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 mb-6 text-center drop-shadow",children:"Book Appointment"}),D?e.jsxs("div",{className:"text-center text-green-600 text-xl font-semibold py-10",children:["Appointment booked successfully!",e.jsx("br",{}),"The property owner will review your request.",e.jsx("br",{}),"Redirecting to your appointments..."]}):e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("input",{type:"date",name:"date",value:t.date,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",min:new Date().toISOString().split("T")[0],required:!0}),e.jsx("input",{type:"time",name:"time",value:t.time,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("select",{name:"purpose",value:t.purpose,onChange:c,className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select Purpose"}),g==="rent"&&e.jsx("option",{value:"rent",children:"Rent"}),(g==="sale"||g==="buy")&&e.jsx("option",{value:"buy",children:"Buy"})]})}),e.jsx("input",{type:"text",name:"propertyName",value:t.propertyName,onChange:c,placeholder:"Property Name",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("textarea",{name:"propertyDescription",value:t.propertyDescription,onChange:c,placeholder:"Property Description",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"2",required:!0}),e.jsx("textarea",{name:"message",value:t.message,onChange:c,placeholder:"Tell us about your requirements...",className:"w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:"4",required:!0}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("input",{type:"checkbox",id:"agreement",checked:f,onChange:n=>C(n.target.checked),required:!0}),e.jsxs("label",{htmlFor:"agreement",className:"text-sm text-gray-700 select-none",children:["I understand that ",e.jsx("span",{className:"font-semibold text-blue-700",children:"my contact information and details will be shared with the seller"})," for this appointment."]})]}),e.jsx("div",{className:"flex justify-center mt-6",children:e.jsx("button",{type:"submit",className:"w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",disabled:x||!f||u||w,children:w?"Checking...":x?"Booking...":u?"Already Booked":"Book Appointment"})}),u&&e.jsx("div",{className:"text-red-600 text-sm mt-2 text-center font-semibold",children:"You already have an active appointment for this property. Please complete, cancel, or wait for the other party to respond before booking again."})]})]}),e.jsx(R,{})]}):e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 relative",children:e.jsx("div",{className:"text-center text-red-600 text-xl font-semibold py-10",children:"Please sign in to book an appointment."})})})}export{F as default};
