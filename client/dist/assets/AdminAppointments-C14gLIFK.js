import{g as Mt,r as m,v as Q,j as e,L as yt,a3 as Rt,P as me,a4 as Te,a5 as Bt,G as le,U as Ft,a6 as Ne,a7 as Lt,f as $t,a8 as Pt,a9 as zt,y as h,a1 as y,aa as Ge,ab as Ot,C as Ut,z as re,ac as Ht,E as ve,ad as Vt,ae as ft,H as bt}from"./index-CMpHVNtH.js";const A="https://urbansetu.onrender.com";function Kt(){const{currentUser:a}=Mt(s=>s.user),[u,D]=m.useState([]),[ue,H]=m.useState([]),[Me,X]=m.useState(!0),[M,Re]=m.useState("all"),[I,Be]=m.useState(""),[N,Fe]=m.useState(null),[Le,ne]=m.useState(!1),[$e,Ce]=m.useState(!1),[V,ie]=m.useState(!1),[L,Pe]=m.useState(""),[z,ze]=m.useState(""),[S,R]=m.useState(null),[Z,f]=m.useState(""),[v,O]=m.useState(!1),[B,ee]=m.useState(!1),[he,j]=m.useState(!1),[J,E]=m.useState(!1),[U,Se]=m.useState({}),xe=(s,l)=>{Se(i=>({...i,[s]:l}))};m.useEffect(()=>{const s=async()=>{try{const _=await(await fetch(`${A}/api/bookings`,{credentials:"include"})).json();D(_),X(!1)}catch(n){console.error("Failed to fetch appointments",n),X(!1)}},l=async()=>{try{const _=await(await fetch(`${A}/api/bookings/archived`,{credentials:"include"})).json();H(_)}catch(n){console.error("Failed to fetch archived appointments",n)}};s(),l();const i=setInterval(()=>{s(),l()},5e3),x=n=>{D(_=>_.map(g=>{const p={...g};return g.buyerId&&(g.buyerId._id===n.userId||g.buyerId===n.userId)&&(p.buyerId={...p.buyerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),g.sellerId&&(g.sellerId._id===n.userId||g.sellerId===n.userId)&&(p.sellerId={...p.sellerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),p})),H(_=>_.map(g=>{const p={...g};return g.buyerId&&(g.buyerId._id===n.userId||g.buyerId===n.userId)&&(p.buyerId={...p.buyerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),g.sellerId&&(g.sellerId._id===n.userId||g.sellerId===n.userId)&&(p.sellerId={...p.sellerId,username:n.username,email:n.email,mobileNumber:n.mobileNumber,avatar:n.avatar}),p}))};return Q.on("profileUpdated",x),()=>{clearInterval(i),Q.off("profileUpdated",x)}},[]),m.useEffect(()=>{a&&(D(s=>s.map(l=>{const i={...l};return l.buyerId&&(l.buyerId._id===a._id||l.buyerId===a._id)&&(i.buyerId={...i.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),l.sellerId&&(l.sellerId._id===a._id||l.sellerId===a._id)&&(i.sellerId={...i.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),i})),H(s=>s.map(l=>{const i={...l};return l.buyerId&&(l.buyerId._id===a._id||l.buyerId===a._id)&&(i.buyerId={...i.buyerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),l.sellerId&&(l.sellerId._id===a._id||l.sellerId===a._id)&&(i.sellerId={...i.sellerId,username:a.username,email:a.email,mobileNumber:a.mobileNumber,avatar:a.avatar}),i})))},[a]);const K=async s=>{R(s),f(""),O(!0)},oe=async()=>{if(!Z.trim()){h.error("Please provide a reason for cancelling this appointment.");return}try{console.log("Attempting to cancel appointment:",S),console.log("Current user:",a),console.log("User role:",a.role),console.log("Admin approval status:",a.adminApprovalStatus);const s=u.find(x=>x._id===S);s&&(console.log("Current appointment status:",s.status),console.log("Appointment date:",s.date),console.log("Appointment time:",s.time));const l=await fetch(`${A}/api/bookings/${S}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:Z})});console.log("Response status:",l.status);const i=await l.json();console.log("Response data:",i),l.ok?(D(x=>x.map(n=>n._id===S?{...n,status:"cancelledByAdmin",cancelReason:Z}:n)),h.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):h.error(i.message||"Failed to cancel appointment."),O(!1),R(null),f("")}catch(s){console.error("Error in confirmAdminCancel:",s),h.error("An error occurred. Please try again.")}},C=async s=>{R(s),ee(!0)},ge=async()=>{try{console.log("Attempting to reinitiate appointment:",S);const s=await fetch(`${A}/api/bookings/${S}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",s.status);const l=await s.json();console.log("Response data:",l),s.ok?(D(i=>i.map(x=>x._id===S?{...x,status:"pending",cancelReason:""}:x)),h.success("Appointment reinitiated successfully. Both buyer and seller have been notified.")):h.error(l.message||"Failed to reinitiate appointment."),ee(!1),R(null)}catch(s){console.error("Error in confirmReinitiate:",s),h.error("An error occurred. Please try again.")}},ke=async s=>{R(s),j(!0)},de=async()=>{try{const s=await fetch(`${A}/api/bookings/${S}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),l=await s.json();if(s.ok){const i=u.find(x=>x._id===S);i&&(D(x=>x.filter(n=>n._id!==S)),H(x=>[{...i,archivedByAdmin:!0,archivedAt:new Date},...x])),h.success("Appointment archived successfully.")}else h.error(l.message||"Failed to archive appointment.");j(!1),R(null)}catch(s){console.error("Error in confirmArchive:",s),h.error("An error occurred. Please try again.")}},fe=async s=>{R(s),E(!0)},be=async()=>{try{const s=await fetch(`${A}/api/bookings/${S}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),l=await s.json();if(s.ok){const i=ue.find(x=>x._id===S);i&&(H(x=>x.filter(n=>n._id!==S)),D(x=>[{...i,archivedByAdmin:!1,archivedAt:void 0},...x])),h.success("Appointment unarchived successfully.")}else h.error(l.message||"Failed to unarchive appointment.");E(!1),R(null)}catch(s){console.error("Error in confirmUnarchive:",s),h.error("An error occurred. Please try again.")}},Ae=async s=>{if(!s){h.error("User ID not available");return}Ce(!0),ne(!0);try{const l=await fetch(`${A}/api/user/id/${s}`),i=await l.json();l.ok?Fe(i):(h.error("Failed to fetch user details."),ne(!1))}catch{h.error("An error occurred while fetching user details."),ne(!1)}Ce(!1)},ce=u.filter(s=>{var _,g,p,$,se,ae,G,P,Y;const l=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i=M==="all"?!0:M==="outdated"?l:s.status===M,x=((g=(_=s.buyerId)==null?void 0:_.email)==null?void 0:g.toLowerCase().includes(I.toLowerCase()))||(($=(p=s.sellerId)==null?void 0:p.email)==null?void 0:$.toLowerCase().includes(I.toLowerCase()))||((se=s.propertyName)==null?void 0:se.toLowerCase().includes(I.toLowerCase()))||((G=(ae=s.buyerId)==null?void 0:ae.username)==null?void 0:G.toLowerCase().includes(I.toLowerCase()))||((Y=(P=s.sellerId)==null?void 0:P.username)==null?void 0:Y.toLowerCase().includes(I.toLowerCase()));let n=!0;return L&&(n=n&&new Date(s.date)>=new Date(L)),z&&(n=n&&new Date(s.date)<=new Date(z)),i&&x&&n}).map(s=>({...s,comments:U[s._id]||s.comments||[]})),te=ue.filter(s=>{var _,g,p,$,se,ae,G,P,Y;const l=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),i=M==="all"?!0:M==="outdated"?l:s.status===M,x=((g=(_=s.buyerId)==null?void 0:_.email)==null?void 0:g.toLowerCase().includes(I.toLowerCase()))||(($=(p=s.sellerId)==null?void 0:p.email)==null?void 0:$.toLowerCase().includes(I.toLowerCase()))||((se=s.propertyName)==null?void 0:se.toLowerCase().includes(I.toLowerCase()))||((G=(ae=s.buyerId)==null?void 0:ae.username)==null?void 0:G.toLowerCase().includes(I.toLowerCase()))||((Y=(P=s.sellerId)==null?void 0:P.username)==null?void 0:Y.toLowerCase().includes(I.toLowerCase()));let n=!0;return L&&(n=n&&new Date(s.date)>=new Date(L)),z&&(n=n&&new Date(s.date)<=new Date(z)),i&&x&&n}).map(s=>({...s,comments:U[s._id]||s.comments||[]})),pe=async()=>{X(!0);try{const s=await fetch(`${A}/api/bookings`,{credentials:"include"});if(s.ok){const i=await s.json();D(i)}const l=await fetch(`${A}/api/bookings/archived`,{credentials:"include"});if(l.ok){const i=await l.json();H(Array.isArray(i)?i:[])}}catch{}finally{X(!1)}},ye=s=>{if(console.log("Copy button clicked, message:",s),!s){h.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(s).then(()=>{h.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{we(s)}):we(s)},we=s=>{try{const l=document.createElement("textarea");l.value=s,l.style.position="fixed",l.style.left="-999999px",l.style.top="-999999px",document.body.appendChild(l),l.focus(),l.select();const i=document.execCommand("copy");document.body.removeChild(l),i?(console.log("Copy successful via fallback method"),h.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),h.error("Failed to copy message"))}catch(l){console.error("Fallback copy error:",l),h.error("Copy not supported")}};return Me?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(u)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(Rt,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:V?"Archived Appointments":"All Appointments (Admin View)"}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:pe,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>ie(!V),className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${V?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:V?e.jsxs(e.Fragment,{children:[e.jsx(me,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Te,{})," ",e.jsxs("span",{children:["Archived Appointments (",ue.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:V?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments.💡 High data traffic may cause this page to slow down or stop working. Please refresh to continue using it normally."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:M,onChange:s=>Re(s.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:L,onChange:s=>Pe(s.target.value),max:z||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:z,onChange:s=>ze(s.target.value),min:L||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bt,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:I,onChange:s=>Be(s.target.value)})]})]}),V?te.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:te.map(s=>e.jsx(pt,{appt:s,currentUser:a,handleAdminCancel:K,handleReinitiateAppointment:C,handleArchiveAppointment:ke,handleUnarchiveAppointment:fe,onUserClick:Ae,isArchived:!0,copyMessageToClipboard:ye,updateAppointmentComments:xe,showCancelModal:v,setShowCancelModal:O,showReinitiateModal:B,setShowReinitiateModal:ee,showArchiveModal:he,setShowArchiveModal:j,showUnarchiveModal:J,setShowUnarchiveModal:E,appointmentToHandle:S,setAppointmentToHandle:R,cancelReason:Z,setCancelReason:f,confirmAdminCancel:oe,confirmReinitiate:ge,confirmArchive:de,confirmUnarchive:be},s._id))})]})}):ce.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:ce.map(s=>e.jsx(pt,{appt:s,currentUser:a,handleAdminCancel:K,handleReinitiateAppointment:C,handleArchiveAppointment:ke,handleUnarchiveAppointment:fe,onUserClick:Ae,isArchived:!1,copyMessageToClipboard:ye,updateAppointmentComments:xe,showCancelModal:v,setShowCancelModal:O,showReinitiateModal:B,setShowReinitiateModal:ee,showArchiveModal:he,setShowArchiveModal:j,showUnarchiveModal:J,setShowUnarchiveModal:E,appointmentToHandle:S,setAppointmentToHandle:R,cancelReason:Z,setCancelReason:f,confirmAdminCancel:oe,confirmReinitiate:ge,confirmArchive:de,confirmUnarchive:be},s._id))})]})})]}),Le&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>ne(!1),title:"Close","aria-label":"Close",children:e.jsx(le,{className:"w-4 h-4"})}),$e?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-4 text-gray-600",children:"Loading user details..."})]}):N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ft,{user:{username:N.username,avatar:N.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:N.role==="admin"||N.role==="rootadmin"?e.jsx(Ne,{className:"w-3 h-3 text-white"}):e.jsx(Lt,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[N.username,(N.role==="admin"||N.role==="rootadmin")&&e.jsx(Ne,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:N.role||"User"}),N.adminApprovalStatus&&e.jsx("p",{className:`text-xs font-medium px-2 py-1 rounded-full ${N.adminApprovalStatus==="approved"?"bg-green-100 text-green-700":N.adminApprovalStatus==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:N.adminApprovalStatus})]})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx($t,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:N.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Pt,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:N.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(zt,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:new Date(N.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-gray-600",children:"User not found"})})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(yt,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function Ye(a){const u=new Date,D=new Date;return D.setDate(u.getDate()-1),a.toDateString()===u.toDateString()?"Today":a.toDateString()===D.toDateString()?"Yesterday":a.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function pt({appt:a,currentUser:u,handleAdminCancel:D,handleReinitiateAppointment:ue,handleArchiveAppointment:H,handleUnarchiveAppointment:Me,onUserClick:X,isArchived:M,copyMessageToClipboard:Re,updateAppointmentComments:I,showCancelModal:Be,setShowCancelModal:N,showReinitiateModal:Fe,setShowReinitiateModal:Le,showArchiveModal:ne,setShowArchiveModal:$e,showUnarchiveModal:Ce,setShowUnarchiveModal:V,appointmentToHandle:ie,setAppointmentToHandle:L,cancelReason:Pe,setCancelReason:z,confirmAdminCancel:ze,confirmReinitiate:S,confirmArchive:R,confirmUnarchive:Z}){var tt,st,at,rt,lt,nt,it,ot;const[f,v]=m.useState(a.comments||[]),[O,B]=m.useState(""),[ee,he]=m.useState(!1),[j,J]=m.useState(null),[E,U]=m.useState(""),[Se,xe]=m.useState(null),[K,oe]=m.useState(null),[C,ge]=m.useState(!1),[ke,de]=m.useState(!1),[fe,be]=m.useState(""),[Ae,ce]=m.useState(!1),[te,pe]=m.useState(null),[ye,we]=m.useState(!1),s=y.useRef(null),l=y.useRef(null),i=y.useRef(null),x=y.useRef({}),[n,_]=m.useState(!0),[g,p]=m.useState(0),[$,se]=m.useState(""),[ae,G]=m.useState(!1),[P,Y]=m.useState(!1),[wt,qe]=m.useState(()=>_t(a._id)),[Ie,q]=m.useState(null),je=y.useRef(null),[jt,_e]=m.useState(!1),[Oe,De]=m.useState(""),[We,Qe]=m.useState(!1),F=Ie?f.find(t=>t._id===Ie):null;y.useEffect(()=>{if(P){const t=setTimeout(()=>{Y(!1)},1e4);return()=>clearTimeout(t)}},[P]),y.useEffect(()=>{C&&s.current&&s.current.scrollIntoView({behavior:"smooth"})},[C]),y.useEffect(()=>{I&&I(a._id,f)},[f,a._id,I]),y.useEffect(()=>{a.comments&&a.comments.length>f.length&&v(a.comments)},[a.comments]);const Xe=y.useRef(f.length),vt=y.useRef(f);y.useEffect(()=>{const t=f.slice(Xe.current),o=t.length;if(Xe.current=f.length,vt.current=f,o>0&&C){const r=t.some(c=>c.senderEmail===u.email),d=t.filter(c=>c.senderEmail!==u.email);r||n?setTimeout(()=>{s.current&&s.current.scrollIntoView({behavior:"smooth"})},100):d.length>0&&p(c=>c+d.length)}},[f.length,n,C,u.email]),y.useEffect(()=>{p(0)},[C]);const Ue=y.useCallback(()=>{if(!l.current||f.length===0)return;const o=l.current.getBoundingClientRect(),r=o.top+60;let d="";for(let c=0;c<f.length;c++){const b=x.current[f[c]._id];if(b){const w=b.getBoundingClientRect();if(w.top>=r&&w.bottom<=o.bottom){const k=new Date(f[c].timestamp);d=Ye(k);break}}}if(!d)for(let c=0;c<f.length;c++){const b=x.current[f[c]._id];if(b&&b.getBoundingClientRect().bottom>r){const k=new Date(f[c].timestamp);d=Ye(k);break}}d&&d!==$&&se(d)},[f,$]),He=y.useRef(!1),Ee=y.useCallback(async()=>{if(He.current)return;const t=f.filter(o=>{var r;return!((r=o.readBy)!=null&&r.includes(u._id))&&o.senderEmail!==u.email});if(t.length>0){He.current=!0;try{(await fetch(`${A}/api/bookings/${a._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(v(r=>r.map(d=>t.some(c=>c._id===d._id)?{...d,readBy:[...d.readBy||[],u._id],status:"read"}:d)),t.forEach(r=>{Q.emit("messageRead",{appointmentId:a._id,messageId:r._id,userId:u._id})}))}catch(o){console.error("Error marking messages as read:",o)}finally{He.current=!1}}},[f,u._id,a._id,Q]),Ve=y.useCallback(()=>{if(l.current){const{scrollTop:t,scrollHeight:o,clientHeight:r}=l.current,d=o-t-r<5;_(d),d&&g>0&&(p(0),Ee())}},[g,Ee]);y.useEffect(()=>{const t=l.current;if(t&&C){const o=()=>{Ve(),Ue(),G(!0),je.current&&clearTimeout(je.current),je.current=setTimeout(()=>{G(!1)},1e3)};return t.addEventListener("scroll",o),Ve(),setTimeout(Ue,100),()=>{t.removeEventListener("scroll",o),je.current&&clearTimeout(je.current)}}},[C,Ve,Ue]);const Nt=y.useCallback(()=>{s.current&&(s.current.scrollIntoView({behavior:"smooth"}),p(0),setTimeout(()=>{Ee()},500))},[Ee]);y.useEffect(()=>(C?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[C]),y.useEffect(()=>{function t(r){r.appointmentId===a._id&&(v(d=>{const c=d.findIndex(b=>b._id===r.comment._id);if(c!==-1){const b=[...d],w=d[c],k=r.comment;let W=k.status;return w.status==="read"&&k.status!=="read"&&(W="read"),b[c]={...k,status:W},b}else return!d.some(w=>w._id.toString().startsWith("temp-"))||r.comment.senderEmail!==u.email?[...d,r.comment]:d}),r.comment.deleted&&r.comment.senderEmail!==u.email&&g>0&&p(d=>Math.max(0,d-1)),C&&r.comment.senderEmail!==u.email&&(setTimeout(()=>{fetch(`${A}/api/bookings/${a._id}/comments/read`,{method:"PATCH",credentials:"include"})},100),setTimeout(()=>{s.current&&n&&s.current.scrollIntoView({behavior:"smooth"})},50)))}Q.on("commentUpdate",t);const o=r=>{r.appointmentId===a._id&&(v([]),h.success("Chat deleted by admin"))};return Q.on("chatCleared",o),()=>{Q.off("commentUpdate",t),Q.off("chatCleared",o)}},[a._id,v,C,u.email,n]),y.useEffect(()=>{if(!C)return;const t=o=>{var r;o.ctrlKey&&o.key==="f"&&(o.preventDefault(),(r=i.current)==null||r.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[C]);const Je=async()=>{if(!O.trim())return;const t=O.trim(),o=K,r=`temp-${Date.now()}`,d={_id:r,sender:u._id,senderEmail:u.email,senderName:u.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[u._id],...o?{replyTo:o._id}:{}};v(c=>[...c,d]),B(""),oe(null),he(!0),setTimeout(()=>{i.current&&i.current.focus()},50),s.current&&s.current.scrollIntoView({behavior:"smooth"});try{const c=await fetch(`${A}/api/bookings/${a._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...o?{replyTo:o._id}:{}})}),b=await c.json();if(c.ok){const w=b.comments[b.comments.length-1];v(k=>k.map(W=>W._id===r?{...w}:W))}else v(w=>w.filter(k=>k._id!==r)),B(t),h.error(b.message||"Failed to send message."),setTimeout(()=>{i.current&&i.current.focus()},100)}catch{v(b=>b.filter(w=>w._id!==r)),B(t),h.error("An error occurred. Please try again."),setTimeout(()=>{i.current&&i.current.focus()},100)}finally{he(!1)}},Ke=async t=>{if(!E.trim())return;xe(t),v(r=>r.map(d=>d._id===t?{...d,message:E,edited:!0,editedAt:new Date}:d));try{const r=await fetch(`${A}/api/bookings/${a._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:E})}),d=await r.json();r.ok?(v(c=>c.map(b=>{const w=d.comments.find(k=>k._id===b._id);return w?w._id===t?w:b.status==="read"&&w.status!=="read"?{...w,status:"read"}:w:b})),J(null),U(""),B(""),h.success("Message edited successfully!")):(v(c=>c.map(b=>b._id===t?{...b,message:b.originalMessage||b.message,edited:b.wasEdited||!1}:b)),J(t),U(E),B(E),h.error(d.message||"Failed to edit message."))}catch{v(d=>d.map(c=>c._id===t?{...c,message:c.originalMessage||c.message,edited:c.wasEdited||!1}:c)),J(t),U(E),B(E),h.error("An error occurred. Please try again.")}finally{xe(null)}},Ct=t=>{J(t._id),U(t.message),B(t.message),v(o=>o.map(r=>r._id===t._id?{...r,originalMessage:r.message,wasEdited:r.edited}:r)),setTimeout(()=>{i.current&&(i.current.focus(),i.current.select())},100)},Ze=new Date(a.date)>new Date||new Date(a.date).toDateString()===new Date().toDateString()&&(!a.time||a.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),St=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},kt=()=>{de(!0),be("")},At=async t=>{t.preventDefault(),we(!0);try{const o=await fetch(`${A}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:fe})}),r=await o.json();o.ok&&r.success?(de(!1),ge(!0)):h.error("Incorrect password. Please try again.")}catch{h.error("Failed to verify password. Please try again.")}we(!1)},et=t=>{pe(t),ce(!0)},It=async()=>{var t;if(te){try{const o=!((t=te.readBy)!=null&&t.includes(u._id))&&te.senderEmail!==u.email,r=await fetch(`${A}/api/bookings/${a._id}/comment/${te._id}`,{method:"DELETE",credentials:"include"}),d=await r.json();r.ok?(v(d.comments),o&&p(c=>Math.max(0,c-1)),h.success("Message deleted successfully!")):h.error(d.message||"Failed to delete message.")}catch{h.error("An error occurred. Please try again.")}ce(!1),pe(null)}};function _t(t){try{return JSON.parse(localStorage.getItem(`hiddenDeletedMsgs_${t}`))||[]}catch{return[]}}const Dt=y.useCallback(t=>{qe(o=>{if(!o.includes(t)){const r=[...o,t];return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${a._id}`,JSON.stringify(r))},0),r}return o})},[a._id]),Et=y.useCallback(t=>{qe(o=>{const r=o.filter(d=>d!==t);return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${a._id}`,JSON.stringify(r))},0),r})},[a._id]);return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${M?"bg-gray-50":""} ${Ze?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(a.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:a.time}),!Ze&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),M&&a.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(a.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:a.listingId?e.jsx(yt,{to:`/admin/listing/${a.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:a.propertyName}):e.jsx("div",{className:"font-semibold",children:a.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return X((t=a.buyerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((tt=a.buyerId)==null?void 0:tt.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((st=a.buyerId)==null?void 0:st.email)||a.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((at=a.buyerId)==null?void 0:at.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return X((t=a.sellerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((rt=a.sellerId)==null?void 0:rt.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(lt=a.sellerId)==null?void 0:lt.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((nt=a.sellerId)==null?void 0:nt.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:a.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:a.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${St(a.status)}`,children:a.status==="deletedByAdmin"?"Deleted by Admin":a.status==="cancelledByBuyer"?"Cancelled by Buyer":a.status==="cancelledBySeller"?"Cancelled by Seller":a.status==="cancelledByAdmin"?"Cancelled by Admin":a.status.charAt(0).toUpperCase()+a.status.slice(1)}),a.status==="deletedByAdmin"&&a.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',a.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:M?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>Me(a._id),title:"Unarchive Appointment",children:[e.jsx(me,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[a.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>ue(a._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(Ne,{})," Reinitiate"]}):a.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>D(a._id),title:"Cancel Appointment (Admin)",children:[e.jsx(Ne,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>H(a._id),title:"Archive Appointment",children:[e.jsx(Te,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsxs("button",{className:"flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 mx-auto relative group",title:"Open Chat",onClick:kt,children:[e.jsx(Ge,{size:22,className:"group-hover:animate-pulse"}),e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"})]}),ke&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>de(!1),title:"Close",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(Ne,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:At,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:fe,onChange:t=>be(t.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:ye,children:ye?"Verifying...":"Unlock Chat"})]})]})}),C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200",children:[e.jsx("div",{className:"flex items-center gap-3 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-600 rounded-t-3xl relative",children:Ie&&F?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!F.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{var t;oe(F),(t=i.current)==null||t.focus(),q(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!F.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Re(F.message),q(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(Ot,{size:18})}),F.senderEmail===u.email&&!F.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{Ct(F),q(null)},className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",title:"Edit comment","aria-label":"Edit comment",disabled:j!==null,children:e.jsx(Ut,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{et(F),q(null)},title:"Delete","aria-label":"Delete",children:e.jsx(re,{size:18})})]}),F.senderEmail!==u.email&&!F.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{et(F),q(null)},title:"Delete","aria-label":"Delete",children:e.jsx(re,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>q(null),title:"Close options","aria-label":"Close options",children:e.jsx(le,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1.5 shadow-lg",children:e.jsx(Ge,{className:"text-blue-600 text-lg"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Live Chat"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[f.length>0&&e.jsx("button",{className:"text-red-100 hover:text-white bg-red-500/30 hover:bg-red-500/50 rounded-full p-2 transition-colors shadow flex items-center gap-2",onClick:()=>_e(!0),title:"Delete entire chat","aria-label":"Delete chat",children:e.jsx(re,{className:"text-sm"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>Y(!P),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(Ht,{className:"text-sm"})}),P&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>ge(!1),title:"Close","aria-label":"Close",children:e.jsx(le,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{ref:l,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[$&&f.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${ae?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:$})})}),f.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(Ge,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start a conversation to communicate with the parties"})]}):f.map((t,o)=>{var k,W,dt,ct,mt;const r=t.senderEmail===u.email,d=j===t._id,c=new Date(t.timestamp),b=o>0?new Date(f[o-1].timestamp):null,w=b?c.toDateString()!==b.toDateString():!0;return e.jsxs(y.Fragment,{children:[w&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Ye(c)})}),e.jsx("div",{className:`flex w-full ${r?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*o}s`},children:e.jsxs("div",{ref:T=>x.current[t._id]=T,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] break-all overflow-hidden relative transition-all duration-200 min-h-[60px] ${r?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300":"bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300"}`,children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{x.current[t.replyTo]&&(x.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),x.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{x.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"↩"}),((W=(k=f.find(T=>T._id===t.replyTo))==null?void 0:k.message)==null?void 0:W.substring(0,30))||"Original message",((ct=(dt=f.find(T=>T._id===t.replyTo))==null?void 0:dt.message)==null?void 0:ct.length)>30?"...":""]})}),e.jsx("div",{className:"font-semibold mb-2 flex items-center gap-2 justify-start text-left",children:e.jsx("span",{className:`truncate max-w-[120px] min-w-[60px] inline-block align-middle overflow-hidden text-ellipsis text-left ${r?"text-blue-100":"text-gray-700"}`,children:r?"You":(()=>{var ut,ht,xt,gt;const T=t.senderEmail===((ut=a.buyerId)==null?void 0:ut.email),Tt=t.senderEmail===((ht=a.sellerId)==null?void 0:ht.email);return T?((xt=a.buyerId)==null?void 0:xt.username)||t.senderName||t.senderEmail:Tt?((gt=a.sellerId)==null?void 0:gt.username)||t.senderName||t.senderEmail:t.senderName||t.senderEmail})()})}),e.jsx("div",{className:`text-left ${r?"text-base font-medium":"text-sm"}`,children:t.deleted?(()=>{const T=wt.includes(t._id);return u&&(u.role==="admin"||u.role==="rootadmin")?T?e.jsx("div",{className:"border border-gray-300 bg-gray-100 rounded p-2 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 text-xs",children:[e.jsx(ve,{className:"inline-block"}),e.jsx("span",{children:"Deleted message hidden from view"})]}),e.jsx("button",{className:"text-xs text-blue-500 hover:text-blue-700 underline",onClick:()=>Et(t._id),title:"Show this deleted message content",children:"Show"})]})}):e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(ve,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400",children:t.originalMessage?e.jsx("span",{className:"whitespace-pre-wrap",children:t.originalMessage}):t.message?e.jsx("span",{className:"whitespace-pre-wrap",children:t.message}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})}),!1,e.jsx("button",{className:"mt-2 text-xs text-red-500 hover:text-red-700 underline",onClick:()=>Dt(t._id),title:"Hide this deleted message from your admin view",children:"Hide from admin view"})]}):e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(ve,{className:"inline-block text-lg"})," This message has been deleted."]})})():e.jsx("div",{children:d?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"✏️ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap",children:(t.message||"").replace(/\n+$/,"")}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[e.jsx("span",{className:`${r?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),!t.deleted&&e.jsx("button",{className:`${t.senderEmail===u.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:T=>{T.stopPropagation(),q(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(Vt,{size:t.senderEmail===u.email?14:12})}),t.senderEmail===u.email&&!t.deleted&&e.jsx("span",{className:"ml-1 flex items-center gap-1",children:(mt=t.readBy)!=null&&mt.some(T=>T!==u._id)?e.jsx(ft,{className:"text-green-400 text-xs",title:"Read"}):t.status==="delivered"?e.jsx(ft,{className:"text-blue-200 text-xs",title:"Delivered"}):t.status==="sending"?e.jsx(bt,{className:"text-blue-200 text-xs animate-pulse",title:"Sending..."}):e.jsx(bt,{className:"text-blue-200 text-xs",title:"Sent"})})]})]})})]},t._id||o)}),e.jsx("div",{ref:s})]}),K&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(it=K.message)==null?void 0:it.substring(0,40),((ot=K.message)==null?void 0:ot.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>oe(null),title:"Cancel reply",children:e.jsx(le,{className:"w-3 h-3"})})]})}),j&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"✏️ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:E}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{J(null),U(""),B("")},title:"Cancel edit",children:e.jsx(le,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-200 bg-white resize-y whitespace-pre-wrap",placeholder:j?"Edit your message...":"Type a message...",value:O,onChange:t=>{B(t.target.value),j&&U(t.target.value)},onClick:()=>{Ie&&(q(null),h.info("You can hit reply icon in header to reply"))},onKeyDown:t=>{const o=window.innerWidth>=768&&!("ontouchstart"in window||navigator.maxTouchPoints>0);t.key==="Enter"&&(o&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),j?Ke(j):Je())},ref:i}),e.jsx("button",{onClick:j?()=>Ke(j):Je,disabled:(j?Se===j:ee)||!O.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:transform-none flex items-center gap-2 min-w-24",children:j?Se===j?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":ee?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(10px) scale(0.98); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                }
              `}),!n&&!j&&!K&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:Nt,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:g>0?`${g} new message${g>1?"s":""}`:"Scroll to bottom","aria-label":g>0?`${g} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),g>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:g>99?"99+":g})]})}),jt&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-sm relative shadow-2xl",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>{_e(!1),De("")},title:"Close","aria-label":"Close",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-red-600 flex items-center gap-2",children:[e.jsx(re,{})," Delete Entire Chat"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"This will permanently delete all messages for this appointment. Enter admin password to confirm."}),e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-red-200 mb-4",placeholder:"Admin password",value:Oe,onChange:t=>De(t.target.value),autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{_e(!1),De("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",disabled:We||!Oe,onClick:async()=>{try{Qe(!0);const t=await fetch(`${A}/api/bookings/${a._id}/comments`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:Oe})}),o=await t.json();t.ok?(v([]),h.success("Chat deleted successfully."),_e(!1),De("")):h.error(o.message||"Failed to delete chat")}catch{h.error("An error occurred. Please try again.")}finally{Qe(!1)}},className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-60",children:We?"Deleting...":e.jsxs(e.Fragment,{children:[e.jsx(re,{size:12})," Delete Chat"]})})]})]})})]})}),Ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(re,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Delete Message"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to delete this message for everyone?"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ce(!1),pe(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:It,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(re,{size:14}),"Delete"]})]})]})})}),Be&&ie===a._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ve,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Cancel Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:Pe,onChange:t=>z(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for cancelling this appointment..."})]})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{N(!1),L(null),z("")},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:ze,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(ve,{size:14}),"Cancel Appointment"]})]})]})})}),Fe&&ie===a._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(me,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Reinitiate Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Le(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:S,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(me,{size:14}),"Reinitiate"]})]})]})})}),ne&&ie===a._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Te,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Archive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{$e(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:R,className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(Te,{size:14}),"Archive"]})]})]})})}),Ce&&ie===a._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(me,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Unarchive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{V(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Z,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(me,{size:14}),"Unarchive"]})]})]})})})]})]})}export{Kt as default};
