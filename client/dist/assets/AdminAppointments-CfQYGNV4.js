import{g as xe,r as m,t as S,j as e,L as me,Z as be,_ as ue,$ as he,a0 as fe,y as i,X as w,a1 as re,a2 as ne,E as ge,B as ye,x as pe}from"./index-wlKvsxpT.js";const g="https://urbansetu.onrender.com";function je(){const{currentUser:t}=xe(s=>s.user),[p,N]=m.useState([]),[M,_]=m.useState([]),[ee,E]=m.useState(!0),[y,Y]=m.useState("all"),[b,O]=m.useState(""),[C,te]=m.useState(null),[G,z]=m.useState(!1),[H,T]=m.useState(!1),[v,j]=m.useState(!1),[A,se]=m.useState(""),[I,q]=m.useState("");m.useEffect(()=>{const s=async()=>{try{const c=await(await fetch(`${g}/api/bookings`,{credentials:"include"})).json();N(c),E(!1)}catch(r){console.error("Failed to fetch appointments",r),E(!1)}},a=async()=>{try{const c=await(await fetch(`${g}/api/bookings/archived`,{credentials:"include"})).json();_(c)}catch(r){console.error("Failed to fetch archived appointments",r)}};s(),a();const o=setInterval(()=>{s(),a()},5e3),h=r=>{N(c=>c.map(d=>{const x={...d};return d.buyerId&&(d.buyerId._id===r.userId||d.buyerId===r.userId)&&(x.buyerId={...x.buyerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),d.sellerId&&(d.sellerId._id===r.userId||d.sellerId===r.userId)&&(x.sellerId={...x.sellerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),x})),_(c=>c.map(d=>{const x={...d};return d.buyerId&&(d.buyerId._id===r.userId||d.buyerId===r.userId)&&(x.buyerId={...x.buyerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),d.sellerId&&(d.sellerId._id===r.userId||d.sellerId===r.userId)&&(x.sellerId={...x.sellerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),x}))};return S.on("profileUpdated",h),()=>{clearInterval(o),S.off("profileUpdated",h)}},[]),m.useEffect(()=>{t&&(N(s=>s.map(a=>{const o={...a};return a.buyerId&&(a.buyerId._id===t._id||a.buyerId===t._id)&&(o.buyerId={...o.buyerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),a.sellerId&&(a.sellerId._id===t._id||a.sellerId===t._id)&&(o.sellerId={...o.sellerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),o})),_(s=>s.map(a=>{const o={...a};return a.buyerId&&(a.buyerId._id===t._id||a.buyerId===t._id)&&(o.buyerId={...o.buyerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),a.sellerId&&(a.sellerId._id===t._id||a.sellerId===t._id)&&(o.sellerId={...o.sellerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),o})))},[t]);const J=async s=>{const a=prompt("Please provide a reason for cancelling this appointment:");if(a&&window.confirm("Are you sure you want to cancel this appointment?"))try{console.log("Attempting to cancel appointment:",s),console.log("Current user:",t),console.log("User role:",t.role),console.log("Admin approval status:",t.adminApprovalStatus);const o=p.find(c=>c._id===s);o&&(console.log("Current appointment status:",o.status),console.log("Appointment date:",o.date),console.log("Appointment time:",o.time));const h=await fetch(`${g}/api/bookings/${s}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:a})});console.log("Response status:",h.status);const r=await h.json();console.log("Response data:",r),h.ok?(N(c=>c.map(d=>d._id===s?{...d,status:"cancelledByAdmin",cancelReason:a}:d)),i.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):i.error(r.message||"Failed to cancel appointment.")}catch(o){console.error("Error in handleAdminCancel:",o),i.error("An error occurred. Please try again.")}},V=async s=>{if(window.confirm("Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."))try{console.log("Attempting to reinitiate appointment:",s);const a=await fetch(`${g}/api/bookings/${s}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",a.status);const o=await a.json();console.log("Response data:",o),a.ok?(N(h=>h.map(r=>r._id===s?{...r,status:"pending",cancelReason:""}:r)),i.success("Appointment reinitiated successfully. Both buyer and seller have been notified.")):i.error(o.message||"Failed to reinitiate appointment.")}catch(a){console.error("Error in handleReinitiateAppointment:",a),i.error("An error occurred. Please try again.")}},K=async s=>{if(window.confirm("Are you sure you want to archive this appointment? It will be moved to the archived section."))try{const a=await fetch(`${g}/api/bookings/${s}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),o=await a.json();if(a.ok){const h=p.find(r=>r._id===s);h&&(N(r=>r.filter(c=>c._id!==s)),_(r=>[{...h,archivedByAdmin:!0,archivedAt:new Date},...r])),i.success("Appointment archived successfully.")}else i.error(o.message||"Failed to archive appointment.")}catch(a){console.error("Error in handleArchiveAppointment:",a),i.error("An error occurred. Please try again.")}},L=async s=>{if(window.confirm("Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."))try{const a=await fetch(`${g}/api/bookings/${s}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),o=await a.json();if(a.ok){const h=M.find(r=>r._id===s);h&&(_(r=>r.filter(c=>c._id!==s)),N(r=>[{...h,archivedByAdmin:!1,archivedAt:void 0},...r])),i.success("Appointment unarchived successfully.")}else i.error(o.message||"Failed to unarchive appointment.")}catch(a){console.error("Error in handleUnarchiveAppointment:",a),i.error("An error occurred. Please try again.")}},D=async s=>{if(!s){i.error("User ID not available");return}T(!0),z(!0);try{const a=await fetch(`${g}/api/user/id/${s}`),o=await a.json();a.ok?te(o):(i.error("Failed to fetch user details."),z(!1))}catch{i.error("An error occurred while fetching user details."),z(!1)}T(!1)},X=p.filter(s=>{var c,d,x,P,U,$,R,F,B;const a=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=y==="all"?!0:y==="outdated"?a:s.status===y,h=((d=(c=s.buyerId)==null?void 0:c.email)==null?void 0:d.toLowerCase().includes(b.toLowerCase()))||((P=(x=s.sellerId)==null?void 0:x.email)==null?void 0:P.toLowerCase().includes(b.toLowerCase()))||((U=s.propertyName)==null?void 0:U.toLowerCase().includes(b.toLowerCase()))||((R=($=s.buyerId)==null?void 0:$.username)==null?void 0:R.toLowerCase().includes(b.toLowerCase()))||((B=(F=s.sellerId)==null?void 0:F.username)==null?void 0:B.toLowerCase().includes(b.toLowerCase()));let r=!0;return A&&(r=r&&new Date(s.date)>=new Date(A)),I&&(r=r&&new Date(s.date)<=new Date(I)),o&&h&&r}),Z=M.filter(s=>{var c,d,x,P,U,$,R,F,B;const a=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o=y==="all"?!0:y==="outdated"?a:s.status===y,h=((d=(c=s.buyerId)==null?void 0:c.email)==null?void 0:d.toLowerCase().includes(b.toLowerCase()))||((P=(x=s.sellerId)==null?void 0:x.email)==null?void 0:P.toLowerCase().includes(b.toLowerCase()))||((U=s.propertyName)==null?void 0:U.toLowerCase().includes(b.toLowerCase()))||((R=($=s.buyerId)==null?void 0:$.username)==null?void 0:R.toLowerCase().includes(b.toLowerCase()))||((B=(F=s.sellerId)==null?void 0:F.username)==null?void 0:B.toLowerCase().includes(b.toLowerCase()));let r=!0;return A&&(r=r&&new Date(s.date)>=new Date(A)),I&&(r=r&&new Date(s.date)<=new Date(I)),o&&h&&r}),Q=async()=>{E(!0);try{const s=await fetch(`${g}/api/bookings`,{credentials:"include"});if(s.ok){const o=await s.json();N(o)}const a=await fetch(`${g}/api/bookings/archived`,{credentials:"include"});if(a.ok){const o=await a.json();_(Array.isArray(o)?o:[])}}catch{}finally{E(!1)}};return ee?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(p)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(be,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:v?"Archived Appointments":"All Appointments (Admin View)"}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:Q,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>j(!v),className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${v?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:v?e.jsxs(e.Fragment,{children:[e.jsx(ue,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{})," ",e.jsxs("span",{children:["Archived Appointments (",M.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:v?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments. 💡 Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:y,onChange:s=>Y(s.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:A,onChange:s=>se(s.target.value),max:I||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:I,onChange:s=>q(s.target.value),min:A||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:b,onChange:s=>O(s.target.value)})]})]}),v?Z.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Z.map(s=>e.jsx(ce,{appt:s,currentUser:t,handleAdminCancel:J,handleReinitiateAppointment:V,handleArchiveAppointment:K,handleUnarchiveAppointment:L,onUserClick:D,isArchived:!0},s._id))})]})}):X.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:X.map(s=>e.jsx(ce,{appt:s,currentUser:t,handleAdminCancel:J,handleReinitiateAppointment:V,handleArchiveAppointment:K,handleUnarchiveAppointment:L,onUserClick:D,isArchived:!1},s._id))})]})})]}),G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"User Details"}),H?e.jsx("p",{children:"Loading..."}):C?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Username:"})," ",C.username]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",C.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",C.mobileNumber||"Not provided"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Role:"})," ",C.role]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Admin Status:"})," ",C.adminApprovalStatus]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Created:"})," ",new Date(C.createdAt).toLocaleDateString()]})]}):e.jsx("p",{children:"User not found"}),e.jsx("button",{onClick:()=>z(!1),className:"mt-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold",children:"Close"})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(me,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function ce({appt:t,currentUser:p,handleAdminCancel:N,handleReinitiateAppointment:M,handleArchiveAppointment:_,handleUnarchiveAppointment:ee,onUserClick:E,isArchived:y}){var B,ae,oe,le,ie,de;const[Y,b]=m.useState(t.comments||[]),[O,C]=m.useState(""),[te,G]=m.useState(!1),[z,H]=m.useState(null),[T,v]=m.useState(""),[j,A]=m.useState(!1),[se,I]=m.useState(!1),[q,J]=m.useState(""),[V,K]=m.useState(!1),L=w.useRef(null),D=w.useRef(null),[X,Z]=m.useState(!0),[Q,s]=m.useState(!1),a=w.useRef(null);w.useEffect(()=>{j&&L.current&&L.current.scrollIntoView({behavior:"smooth"})},[j,Y]);const o=w.useCallback(()=>{if(D.current){const{scrollTop:n,scrollHeight:l,clientHeight:u}=D.current,k=l-n-u<5;Z(k)}},[]);w.useEffect(()=>{const n=D.current;if(n&&j)return n.addEventListener("scroll",o),o(),()=>{n.removeEventListener("scroll",o)}},[j,o]);const h=w.useCallback(()=>{L.current&&L.current.scrollIntoView({behavior:"smooth"})},[]);w.useEffect(()=>(j?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[j]),w.useEffect(()=>{function n(l){l.appointmentId===t._id&&!j&&i.custom(u=>e.jsxs("div",{className:"bg-blue-600 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2 animate-bounce-in",children:[e.jsx(ne,{})," New message from ",l.comment.senderEmail||"User",e.jsx("button",{onClick:()=>{A(!0),i.dismiss(u.id)},className:"ml-4 bg-white text-blue-700 px-2 py-1 rounded",children:"Open Chat"})]}))}return S.on("commentUpdate",n),()=>{S.off("commentUpdate",n)}},[t._id,j]),w.useEffect(()=>{function n(l){l.appointmentId===t._id&&b(u=>{const k=u.findIndex(f=>f._id===l.comment._id);if(k!==-1){const f=[...u];return f[k]=l.comment,f}else return[...u,l.comment]})}return S.on("commentUpdate",n),()=>{S.off("commentUpdate",n)}},[t._id,b]),w.useEffect(()=>{function n(l){l.appointmentId===t._id&&l.fromUserId!==p._id&&(s(!0),a.current&&clearTimeout(a.current),a.current=setTimeout(()=>s(!1),2e3))}return S.on("typing",n),()=>{S.off("typing",n),a.current&&clearTimeout(a.current)}},[t._id,p._id]);const r=async()=>{if(O.trim()){G(!0);try{const n=await fetch(`${g}/api/bookings/${t._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:O})}),l=await n.json();n.ok?(b(l.comments),C(""),i.success("Comment sent successfully!")):i.error(l.message||"Failed to send comment.")}catch{i.error("An error occurred. Please try again.")}G(!1)}},c=async n=>{if(T.trim()){console.log("Admin editing comment:",n,"with text:",T);try{const l=await fetch(`${g}/api/bookings/${t._id}/comment/${n}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:T})}),u=await l.json();console.log("Edit response:",l.status,u),l.ok?(b(u.comments),H(null),v(""),i.success("Comment edited successfully!")):i.error(u.message||"Failed to edit comment.")}catch(l){console.error("Edit comment error:",l),i.error("An error occurred. Please try again.")}}},d=n=>{H(n._id),v(n.message)},x=new Date(t.date)>new Date||new Date(t.date).toDateString()===new Date().toDateString()&&(!t.time||t.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),P=n=>{switch(n){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},U=()=>{I(!0),J("")},$=async n=>{n.preventDefault(),K(!0);try{const l=await fetch(`${g}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:q})}),u=await l.json();l.ok&&u.success?(I(!1),A(!0)):i.error("Incorrect password. Please try again.")}catch{i.error("Failed to verify password. Please try again.")}K(!1)};function R(n){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${n}`))||[]}catch{return[]}}function F(n,l){const u=R(n);if(!u.includes(l)){const k=[...u,l];localStorage.setItem(`removedDeletedMsgs_${n}`,JSON.stringify(k))}}return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${y?"bg-gray-50":""} ${x?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(t.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:t.time}),!x&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),y&&t.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(t.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:t.listingId?e.jsx(me,{to:`/admin/listing/${t.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:t.propertyName}):e.jsx("div",{className:"font-semibold",children:t.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var n;return E((n=t.buyerId)==null?void 0:n._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((B=t.buyerId)==null?void 0:B.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((ae=t.buyerId)==null?void 0:ae.email)||t.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((oe=t.buyerId)==null?void 0:oe.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var n;return E((n=t.sellerId)==null?void 0:n._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((le=t.sellerId)==null?void 0:le.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(ie=t.sellerId)==null?void 0:ie.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((de=t.sellerId)==null?void 0:de.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:t.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:t.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${P(t.status)}`,children:t.status==="deletedByAdmin"?"Deleted by Admin":t.status==="cancelledByBuyer"?"Cancelled by Buyer":t.status==="cancelledBySeller"?"Cancelled by Seller":t.status==="cancelledByAdmin"?"Cancelled by Admin":t.status.charAt(0).toUpperCase()+t.status.slice(1)}),t.status==="deletedByAdmin"&&t.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',t.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:y?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>ee(t._id),title:"Unarchive Appointment",children:[e.jsx(ue,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[t.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>M(t._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(re,{})," Reinitiate"]}):t.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>N(t._id),title:"Cancel Appointment (Admin)",children:[e.jsx(re,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>_(t._id),title:"Archive Appointment",children:[e.jsx(he,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsxs("button",{className:"flex items-center justify-center bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full p-2 shadow-md mx-auto relative",title:"Open Chat",onClick:U,children:[e.jsx(ne,{size:20}),Q&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."})]}),se&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl",onClick:()=>I(!1),title:"Close",children:"×"}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(re,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:$,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:q,onChange:n=>J(n.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:V,children:V?"Verifying...":"Unlock Chat"})]})]})}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 rounded-2xl shadow-2xl max-w-md w-full p-0 relative animate-fadeIn flex flex-col",children:[e.jsxs("div",{className:"flex items-center gap-2 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-200 to-purple-200 rounded-t-2xl relative",children:[e.jsx(ne,{className:"text-blue-600 text-xl"}),e.jsx("h3",{className:"text-lg font-bold text-blue-800",children:"Chat"}),Q&&e.jsx("span",{className:"ml-3 text-blue-600 font-semibold text-sm",children:"Typing..."}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>{localStorage.setItem(clearTimeKey,Date.now()),b([])},title:"Clear chat locally",children:"Clear Chat"}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>A(!1),title:"Close","aria-label":"Close",children:"×"})]})]}),e.jsxs("div",{ref:D,className:"flex-1 max-h-60 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",children:[Y.map((n,l)=>{const u=n.senderEmail===p.email,k=z===n._id;return e.jsx("div",{className:`flex w-full ${u?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*l}s`},children:e.jsxs("div",{className:`rounded-2xl px-4 py-2 text-sm shadow-lg max-w-[80%] break-words relative ${u?"bg-gradient-to-r from-blue-400 to-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,children:[e.jsxs("div",{className:"font-semibold mb-1 flex items-center gap-2",children:[u?"You":n.senderEmail,e.jsx("span",{className:"text-gray-300 ml-2 text-[10px]",children:new Date(n.timestamp).toLocaleString()})]}),e.jsx("div",{className:"flex items-center gap-1",children:k?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",className:"border rounded px-2 py-1 text-xs w-40 text-gray-900 bg-white focus:bg-white",value:T,onChange:f=>v(f.target.value),onKeyDown:f=>{f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),c(n._id))},autoFocus:!0}),e.jsx("button",{onClick:()=>c(n._id),className:"text-green-600 hover:text-green-800 font-bold ml-1",children:"Save"}),e.jsx("button",{onClick:()=>{H(null),v("")},className:"text-gray-500 hover:text-gray-700 font-bold ml-1",children:"Cancel"})]}):n.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(ge,{className:"inline-block text-lg"})," This message has been deleted.",e.jsx("button",{className:"ml-2 text-xs text-red-400 hover:text-red-700 underline",onClick:()=>{b(f=>f.filter(W=>W._id!==n._id)),F(t._id,n._id)},title:"Remove this deleted message from your chat view",children:"Remove"})]}):e.jsxs("div",{children:[n.message,n.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})}),n.senderEmail===p.email&&!k&&!n.deleted&&e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("button",{onClick:()=>d(n),className:"text-blue-200 hover:text-white",title:"Edit comment",children:e.jsx(ye,{size:12})}),e.jsx("button",{className:"text-red-200 hover:text-white",onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{const f=await fetch(`${g}/api/bookings/${t._id}/comment/${n._id}`,{method:"DELETE",credentials:"include"}),W=await f.json();f.ok?(b(W.comments),i.success("Comment deleted successfully!")):i.error(W.message||"Failed to delete comment.")}catch{i.error("An error occurred. Please try again.")}},title:"Delete comment",children:e.jsx(pe,{size:12})})]})]})},n._id||l)}),e.jsx("div",{ref:L})]}),e.jsxs("div",{className:"flex gap-2 mt-2 px-4 pb-4",children:[e.jsx("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-full text-sm focus:ring-2 focus:ring-blue-200 shadow",placeholder:"Type a message...",value:O,onChange:n=>{var l,u;C(n.target.value),(l=t.buyerId)!=null&&l._id&&S.emit("typing",{toUserId:t.buyerId._id,fromUserId:p._id,appointmentId:t._id}),(u=t.sellerId)!=null&&u._id&&S.emit("typing",{toUserId:t.sellerId._id,fromUserId:p._id,appointmentId:t._id})},onKeyDown:n=>{n.key==="Enter"&&r()}}),e.jsx("button",{onClick:r,disabled:te||!O.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-full text-sm font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50",children:"Send"})]}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(10px) scale(0.98); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                }
              `}),!X&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsx("button",{onClick:h,className:"bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-all duration-200 hover:scale-110 animate-pulse",title:"Scroll to bottom","aria-label":"Scroll to bottom",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})})})})]})})]})]})}export{je as default};
