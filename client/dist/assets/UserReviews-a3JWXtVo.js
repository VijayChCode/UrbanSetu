import{g as K,r as l,t as x,j as s,an as O,y as c,x as Q,z as V,b as W,H as L,I as $}from"./index-CSJkwgkh.js";import{R as X}from"./ReviewForm-5VXBotb3.js";const j="https://urbansetu.onrender.com";function ee(){const{currentUser:i}=K(e=>e.user),[g,m]=l.useState([]),[p,f]=l.useState(!0),[v,w]=l.useState(""),[u,h]=l.useState(null),[N,P]=l.useState(""),[y,T]=l.useState("");l.useEffect(()=>{b()},[]),l.useEffect(()=>{const e=t=>{!i||t.userId!==i._id||m(n=>t.status==="removed"?n.map(a=>a._id===t._id?{...a,...t}:a):t._deleted?n.filter(a=>a._id!==t._id):n.map(a=>a._id===t._id?{...a,...t}:a))};x.on("reviewUpdated",e);const r=t=>{console.log("[UserReviews] Received profileUpdated socket event:",t),console.log("[UserReviews] Current reviews:",g.length),m(n=>{const a=n.map(d=>d.userId===t.userId?(console.log("[UserReviews] Updating review:",d._id,"for user:",t.userId),{...d,userName:t.username,userAvatar:t.avatar}):d);return console.log("[UserReviews] Updated reviews:",a.length),a})};return x.on("profileUpdated",r),console.log("[UserReviews] Socket listeners set up for profileUpdated"),()=>{x.off("reviewUpdated",e),x.off("profileUpdated",r),console.log("[UserReviews] Socket listeners cleaned up")}},[i]),l.useEffect(()=>{const e=setInterval(async()=>{if(i)try{const r=await fetch(`${j}/api/user/id/${i._id}`);if(r.ok){const t=await r.json();(t.username!==i.username||t.avatar!==i.avatar)&&(console.log("[UserReviews] Profile updated via polling:",t),m(n=>n.map(a=>a.userId===t._id?{...a,userName:t.username,userAvatar:t.avatar}:a)))}}catch(r){console.error("[UserReviews] Error polling for profile updates:",r)}},3e4);return()=>clearInterval(e)},[i]);const b=async()=>{try{f(!0),console.log("Fetching user reviews...");const e=await fetch(`${j}/api/review/user`,{credentials:"include"}),r=await e.json();console.log("Reviews data:",r),e.ok?m(r):w(r.message||"Failed to fetch reviews")}catch(e){console.error("Error fetching reviews:",e),w("Network error. Please try again.")}finally{f(!1)}},z=async e=>{if(window.confirm("Are you sure you want to delete this review?"))try{const r=await fetch(`${j}/api/review/delete/${e}`,{method:"DELETE",credentials:"include"}),t=await r.json();r.ok?(m(g.filter(n=>n._id!==e)),c.success("Review deleted successfully")):c.error(t.message||"Failed to delete review")}catch{c.error("Network error. Please try again.")}},B=e=>{h(e)},D=()=>{h(null),b(),c.success("Review updated successfully")},q=async()=>{try{f(!0),await b(),c.success("Reviews refreshed successfully")}catch{c.error("Failed to refresh reviews")}},H=e=>[...Array(5)].map((r,t)=>s.jsx(W,{className:`text-lg ${t<e?"text-yellow-400":"text-gray-300"}`},t)),R=e=>new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),M=e=>{if(!e)return s.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:"Unknown"});const t={pending:{color:"bg-yellow-100 text-yellow-800",icon:$},approved:{color:"bg-green-100 text-green-800",icon:$},rejected:{color:"bg-red-100 text-red-800",icon:L},removed:{color:"bg-gray-100 text-gray-800",icon:L}}[e];if(!t)return s.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:e.charAt(0).toUpperCase()+e.slice(1)});const n=t.icon;return s.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${t.color}`,children:[s.jsx(n,{className:"mr-1"}),e.charAt(0).toUpperCase()+e.slice(1)]})},U=g.filter(e=>{var S,I,C,_,k,E,F,A;if(y&&e.status!==y)return!1;const r=((I=(S=e.listingId)==null?void 0:S.name)==null?void 0:I.toLowerCase())||"",t=((_=(C=e.listingId)==null?void 0:C.city)==null?void 0:_.toLowerCase())||"",n=((E=(k=e.listingId)==null?void 0:k.state)==null?void 0:E.toLowerCase())||"",a=String(e.rating),d=((F=e.comment)==null?void 0:F.toLowerCase())||"",G=((A=e.adminNote)==null?void 0:A.toLowerCase())||"",J=R(e.createdAt).toLowerCase(),o=N.toLowerCase();return r.includes(o)||t.includes(o)||n.includes(o)||a===o||d.includes(o)||G.includes(o)||J.includes(o)||o===""});return p?s.jsx("div",{className:"min-h-screen flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),s.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your reviews..."})]})}):s.jsxs("div",{className:"max-w-full sm:max-w-2xl md:max-w-4xl mx-auto px-2 sm:px-4 py-4 sm:py-8",children:[s.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-3 sm:p-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4 sm:mb-6",children:[s.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800",children:"My Reviews"}),s.jsxs("button",{onClick:q,disabled:p,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Refresh reviews",children:[s.jsx(O,{className:`${p?"animate-spin":""}`}),"Refresh"]})]}),s.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-4 mb-6",children:[s.jsx("input",{type:"text",placeholder:"Search by property name, city, state, review comment, admin note, or review date...",className:"border border-gray-300 rounded-lg px-3 py-2 w-full sm:w-1/2",value:N,onChange:e=>{P(e.target.value)}}),s.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 w-full sm:w-1/4",value:y,onChange:e=>{T(e.target.value),e.target.value?c.info(`Filtered by status: ${e.target.value}`):c.info("Showing all reviews")},children:[s.jsx("option",{value:"",children:"All Statuses"}),s.jsx("option",{value:"pending",children:"Pending"}),s.jsx("option",{value:"approved",children:"Approved"}),s.jsx("option",{value:"rejected",children:"Rejected"}),s.jsx("option",{value:"removed",children:"Removed"})]})]}),v&&s.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:s.jsx("p",{className:"text-red-800",children:v})}),U.length===0?s.jsxs("div",{className:"text-center py-8",children:[s.jsx("div",{className:"text-6xl mb-4",children:"⭐"}),s.jsx("h3",{className:"text-xl font-semibold text-gray-800 mb-2",children:"No Reviews Found"}),s.jsx("p",{className:"text-gray-600",children:"Try adjusting your search or filters."})]}):s.jsx("div",{className:"space-y-4 sm:space-y-6",children:U.map(e=>s.jsx("div",{className:"border border-gray-200 rounded-lg p-3 sm:p-6 hover:shadow-md transition-shadow overflow-x-auto",children:s.jsxs("div",{className:"flex flex-col gap-2 sm:gap-4 lg:flex-row lg:items-start lg:justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[M(e.status),s.jsx("span",{className:"text-sm text-gray-500",children:R(e.createdAt)})]}),s.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[H(e.rating),s.jsxs("span",{className:"text-sm text-gray-600",children:[e.rating," star",e.rating>1?"s":""]})]}),s.jsx("p",{className:"text-gray-700 mb-3",children:e.comment}),e.listingId&&s.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[s.jsx("h4",{className:"font-semibold text-gray-800",children:s.jsx("a",{href:`/user/listing/${typeof e.listingId=="object"?e.listingId._id:e.listingId}`,className:"text-blue-600 hover:underline",target:"_blank",rel:"noopener noreferrer",children:e.listingId.name})}),s.jsxs("p",{className:"text-sm text-gray-600",children:[e.listingId.city,", ",e.listingId.state]})]}),e.adminNote&&s.jsx("div",{className:"mt-3 p-3 bg-blue-50 rounded-lg",children:s.jsxs("p",{className:"text-sm text-blue-800",children:[s.jsx("strong",{children:"Admin Note:"})," ",e.adminNote]})})]}),s.jsxs("div",{className:"flex flex-col gap-2 lg:flex-shrink-0 w-full sm:w-auto",children:[s.jsxs("button",{onClick:()=>B(e),className:"flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[s.jsx(Q,{}),"Edit"]}),s.jsxs("button",{onClick:()=>z(e._id),className:"flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors",children:[s.jsx(V,{}),"Delete"]})]})]})},e._id))})]}),u&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4",children:s.jsx("div",{className:"bg-white rounded-lg max-w-xs sm:max-w-md w-full",children:s.jsxs("div",{className:"p-4 sm:p-6",children:[s.jsx("h2",{className:"text-lg sm:text-xl font-semibold text-gray-800 mb-2 sm:mb-4",children:"Edit Review"}),s.jsx(X,{listingId:typeof u.listingId=="object"?u.listingId._id:u.listingId,existingReview:u,onReviewSubmitted:D}),s.jsx("button",{onClick:()=>h(null),className:"mt-4 w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600",children:"Cancel"})]})})})]})}export{ee as default};
