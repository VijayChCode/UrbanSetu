import{g as Mt,r as c,v as Q,j as e,L as yt,a3 as Rt,P as ue,a4 as Me,a5 as Ft,G as ne,U as Bt,a6 as Ce,a7 as Lt,f as $t,a8 as Pt,a9 as zt,y as h,a1 as y,aa as Ge,ab as Ot,C as Ut,z as le,ac as Ht,E as Ne,ad as Vt,ae as ft,H as bt}from"./index-T5xbu-4v.js";const A="https://urbansetu.onrender.com";function qt(){const{currentUser:r}=Mt(s=>s.user),[u,D]=c.useState([]),[he,V]=c.useState([]),[Re,X]=c.useState(!0),[M,Fe]=c.useState("all"),[I,Be]=c.useState(""),[C,Le]=c.useState(null),[$e,ie]=c.useState(!1),[Pe,Se]=c.useState(!1),[J,oe]=c.useState(!1),[L,ze]=c.useState(""),[O,Oe]=c.useState(""),[k,R]=c.useState(null),[Z,f]=c.useState(""),[j,U]=c.useState(!1),[F,ee]=c.useState(!1),[xe,v]=c.useState(!1),[q,E]=c.useState(!1),[H,ke]=c.useState({}),ge=(s,n)=>{ke(a=>({...a,[s]:n}))};c.useEffect(()=>{const s=async()=>{try{const _=await(await fetch(`${A}/api/bookings`,{credentials:"include"})).json();D(_),X(!1)}catch(i){console.error("Failed to fetch appointments",i),X(!1)}},n=async()=>{try{const _=await(await fetch(`${A}/api/bookings/archived`,{credentials:"include"})).json();V(_)}catch(i){console.error("Failed to fetch archived appointments",i)}};s(),n();const a=setInterval(()=>{s(),n()},5e3),x=i=>{D(_=>_.map(g=>{const p={...g};return g.buyerId&&(g.buyerId._id===i.userId||g.buyerId===i.userId)&&(p.buyerId={...p.buyerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),g.sellerId&&(g.sellerId._id===i.userId||g.sellerId===i.userId)&&(p.sellerId={...p.sellerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),p})),V(_=>_.map(g=>{const p={...g};return g.buyerId&&(g.buyerId._id===i.userId||g.buyerId===i.userId)&&(p.buyerId={...p.buyerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),g.sellerId&&(g.sellerId._id===i.userId||g.sellerId===i.userId)&&(p.sellerId={...p.sellerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),p}))};return Q.on("profileUpdated",x),()=>{clearInterval(a),Q.off("profileUpdated",x)}},[]),c.useEffect(()=>{r&&(D(s=>s.map(n=>{const a={...n};return n.buyerId&&(n.buyerId._id===r._id||n.buyerId===r._id)&&(a.buyerId={...a.buyerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),n.sellerId&&(n.sellerId._id===r._id||n.sellerId===r._id)&&(a.sellerId={...a.sellerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),a})),V(s=>s.map(n=>{const a={...n};return n.buyerId&&(n.buyerId._id===r._id||n.buyerId===r._id)&&(a.buyerId={...a.buyerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),n.sellerId&&(n.sellerId._id===r._id||n.sellerId===r._id)&&(a.sellerId={...a.sellerId,username:r.username,email:r.email,mobileNumber:r.mobileNumber,avatar:r.avatar}),a})))},[r]);const K=async s=>{R(s),f(""),U(!0)},de=async()=>{if(!Z.trim()){h.error("Please provide a reason for cancelling this appointment.");return}try{console.log("Attempting to cancel appointment:",k),console.log("Current user:",r),console.log("User role:",r.role),console.log("Admin approval status:",r.adminApprovalStatus);const s=u.find(x=>x._id===k);s&&(console.log("Current appointment status:",s.status),console.log("Appointment date:",s.date),console.log("Appointment time:",s.time));const n=await fetch(`${A}/api/bookings/${k}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:Z})});console.log("Response status:",n.status);const a=await n.json();console.log("Response data:",a),n.ok?(D(x=>x.map(i=>i._id===k?{...i,status:"cancelledByAdmin",cancelReason:Z}:i)),h.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):h.error(a.message||"Failed to cancel appointment."),U(!1),R(null),f("")}catch(s){console.error("Error in confirmAdminCancel:",s),h.error("An error occurred. Please try again.")}},S=async s=>{R(s),ee(!0)},fe=async()=>{try{console.log("Attempting to reinitiate appointment:",k);const s=await fetch(`${A}/api/bookings/${k}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",s.status);const n=await s.json();console.log("Response data:",n),s.ok?(D(a=>a.map(x=>x._id===k?{...x,status:"pending",cancelReason:""}:x)),h.success("Appointment reinitiated successfully. Both buyer and seller have been notified.")):h.error(n.message||"Failed to reinitiate appointment."),ee(!1),R(null)}catch(s){console.error("Error in confirmReinitiate:",s),h.error("An error occurred. Please try again.")}},Ae=async s=>{R(s),v(!0)},ce=async()=>{try{const s=await fetch(`${A}/api/bookings/${k}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),n=await s.json();if(s.ok){const a=u.find(x=>x._id===k);a&&(D(x=>x.filter(i=>i._id!==k)),V(x=>[{...a,archivedByAdmin:!0,archivedAt:new Date},...x])),h.success("Appointment archived successfully.")}else h.error(n.message||"Failed to archive appointment.");v(!1),R(null)}catch(s){console.error("Error in confirmArchive:",s),h.error("An error occurred. Please try again.")}},be=async s=>{R(s),E(!0)},pe=async()=>{try{const s=await fetch(`${A}/api/bookings/${k}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),n=await s.json();if(s.ok){const a=he.find(x=>x._id===k);a&&(V(x=>x.filter(i=>i._id!==k)),D(x=>[{...a,archivedByAdmin:!1,archivedAt:void 0},...x])),h.success("Appointment unarchived successfully.")}else h.error(n.message||"Failed to unarchive appointment.");E(!1),R(null)}catch(s){console.error("Error in confirmUnarchive:",s),h.error("An error occurred. Please try again.")}},Ie=async s=>{if(!s){h.error("User ID not available");return}Se(!0),ie(!0);try{const n=await fetch(`${A}/api/user/id/${s}`),a=await n.json();n.ok?Le(a):(h.error("Failed to fetch user details."),ie(!1))}catch{h.error("An error occurred while fetching user details."),ie(!1)}Se(!1)},me=u.filter(s=>{var _,g,p,P,se,re,G,z,Y;const n=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=M==="all"?!0:M==="outdated"?n:s.status===M,x=((g=(_=s.buyerId)==null?void 0:_.email)==null?void 0:g.toLowerCase().includes(I.toLowerCase()))||((P=(p=s.sellerId)==null?void 0:p.email)==null?void 0:P.toLowerCase().includes(I.toLowerCase()))||((se=s.propertyName)==null?void 0:se.toLowerCase().includes(I.toLowerCase()))||((G=(re=s.buyerId)==null?void 0:re.username)==null?void 0:G.toLowerCase().includes(I.toLowerCase()))||((Y=(z=s.sellerId)==null?void 0:z.username)==null?void 0:Y.toLowerCase().includes(I.toLowerCase()));let i=!0;return L&&(i=i&&new Date(s.date)>=new Date(L)),O&&(i=i&&new Date(s.date)<=new Date(O)),a&&x&&i}).map(s=>({...s,comments:H[s._id]||s.comments||[]})),te=he.filter(s=>{var _,g,p,P,se,re,G,z,Y;const n=new Date(s.date)<new Date||new Date(s.date).toDateString()===new Date().toDateString()&&s.time&&s.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=M==="all"?!0:M==="outdated"?n:s.status===M,x=((g=(_=s.buyerId)==null?void 0:_.email)==null?void 0:g.toLowerCase().includes(I.toLowerCase()))||((P=(p=s.sellerId)==null?void 0:p.email)==null?void 0:P.toLowerCase().includes(I.toLowerCase()))||((se=s.propertyName)==null?void 0:se.toLowerCase().includes(I.toLowerCase()))||((G=(re=s.buyerId)==null?void 0:re.username)==null?void 0:G.toLowerCase().includes(I.toLowerCase()))||((Y=(z=s.sellerId)==null?void 0:z.username)==null?void 0:Y.toLowerCase().includes(I.toLowerCase()));let i=!0;return L&&(i=i&&new Date(s.date)>=new Date(L)),O&&(i=i&&new Date(s.date)<=new Date(O)),a&&x&&i}).map(s=>({...s,comments:H[s._id]||s.comments||[]})),ye=async()=>{X(!0);try{const s=await fetch(`${A}/api/bookings`,{credentials:"include"});if(s.ok){const a=await s.json();D(a)}const n=await fetch(`${A}/api/bookings/archived`,{credentials:"include"});if(n.ok){const a=await n.json();V(Array.isArray(a)?a:[])}}catch{}finally{X(!1)}},we=s=>{if(console.log("Copy button clicked, message:",s),!s){h.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(s).then(()=>{h.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{ve(s)}):ve(s)},ve=s=>{try{const n=document.createElement("textarea");n.value=s,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();const a=document.execCommand("copy");document.body.removeChild(n),a?(console.log("Copy successful via fallback method"),h.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),h.error("Failed to copy message"))}catch(n){console.error("Fallback copy error:",n),h.error("Copy not supported")}};return Re?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(u)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(Rt,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:J?"Archived Appointments":"All Appointments (Admin View)"}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:ye,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>oe(!J),className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${J?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:J?e.jsxs(e.Fragment,{children:[e.jsx(ue,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{})," ",e.jsxs("span",{children:["Archived Appointments (",he.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:J?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments.ðŸ’¡ High data traffic may cause this page to slow down or stop working. Please refresh to continue using it normally."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:M,onChange:s=>Fe(s.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:L,onChange:s=>ze(s.target.value),max:O||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:O,onChange:s=>Oe(s.target.value),min:L||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ft,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:I,onChange:s=>Be(s.target.value)})]})]}),J?te.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:te.map(s=>e.jsx(pt,{appt:s,currentUser:r,handleAdminCancel:K,handleReinitiateAppointment:S,handleArchiveAppointment:Ae,handleUnarchiveAppointment:be,onUserClick:Ie,isArchived:!0,copyMessageToClipboard:we,updateAppointmentComments:ge,showCancelModal:j,setShowCancelModal:U,showReinitiateModal:F,setShowReinitiateModal:ee,showArchiveModal:xe,setShowArchiveModal:v,showUnarchiveModal:q,setShowUnarchiveModal:E,appointmentToHandle:k,setAppointmentToHandle:R,cancelReason:Z,setCancelReason:f,confirmAdminCancel:de,confirmReinitiate:fe,confirmArchive:ce,confirmUnarchive:pe},s._id))})]})}):me.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:me.map(s=>e.jsx(pt,{appt:s,currentUser:r,handleAdminCancel:K,handleReinitiateAppointment:S,handleArchiveAppointment:Ae,handleUnarchiveAppointment:be,onUserClick:Ie,isArchived:!1,copyMessageToClipboard:we,updateAppointmentComments:ge,showCancelModal:j,setShowCancelModal:U,showReinitiateModal:F,setShowReinitiateModal:ee,showArchiveModal:xe,setShowArchiveModal:v,showUnarchiveModal:q,setShowUnarchiveModal:E,appointmentToHandle:k,setAppointmentToHandle:R,cancelReason:Z,setCancelReason:f,confirmAdminCancel:de,confirmReinitiate:fe,confirmArchive:ce,confirmUnarchive:pe},s._id))})]})})]}),$e&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>ie(!1),title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),Pe?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-4 text-gray-600",children:"Loading user details..."})]}):C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Bt,{user:{username:C.username,avatar:C.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:C.role==="admin"||C.role==="rootadmin"?e.jsx(Ce,{className:"w-3 h-3 text-white"}):e.jsx(Lt,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[C.username,(C.role==="admin"||C.role==="rootadmin")&&e.jsx(Ce,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:C.role||"User"}),C.adminApprovalStatus&&e.jsx("p",{className:`text-xs font-medium px-2 py-1 rounded-full ${C.adminApprovalStatus==="approved"?"bg-green-100 text-green-700":C.adminApprovalStatus==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:C.adminApprovalStatus})]})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx($t,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:C.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Pt,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:C.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(zt,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:new Date(C.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-gray-600",children:"User not found"})})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(yt,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function Ye(r){const u=new Date,D=new Date;return D.setDate(u.getDate()-1),r.toDateString()===u.toDateString()?"Today":r.toDateString()===D.toDateString()?"Yesterday":r.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function pt({appt:r,currentUser:u,handleAdminCancel:D,handleReinitiateAppointment:he,handleArchiveAppointment:V,handleUnarchiveAppointment:Re,onUserClick:X,isArchived:M,copyMessageToClipboard:Fe,updateAppointmentComments:I,showCancelModal:Be,setShowCancelModal:C,showReinitiateModal:Le,setShowReinitiateModal:$e,showArchiveModal:ie,setShowArchiveModal:Pe,showUnarchiveModal:Se,setShowUnarchiveModal:J,appointmentToHandle:oe,setAppointmentToHandle:L,cancelReason:ze,setCancelReason:O,confirmAdminCancel:Oe,confirmReinitiate:k,confirmArchive:R,confirmUnarchive:Z}){var st,rt,at,lt,nt,it,ot,dt;const[f,j]=c.useState(r.comments||[]),[U,F]=c.useState(""),[ee,xe]=c.useState(!1),[v,q]=c.useState(null),[E,H]=c.useState(""),[ke,ge]=c.useState(null),[K,de]=c.useState(null),[S,fe]=c.useState(!1),[Ae,ce]=c.useState(!1),[be,pe]=c.useState(""),[Ie,me]=c.useState(!1),[te,ye]=c.useState(null),[we,ve]=c.useState(!1),s=y.useRef(null),n=y.useRef(null),a=y.useRef(null),x=y.useRef({}),[i,_]=c.useState(!0),[g,p]=c.useState(0),[P,se]=c.useState(""),[re,G]=c.useState(!1),[z,Y]=c.useState(!1),[wt,We]=c.useState(()=>_t(r._id)),[_e,W]=c.useState(null),je=y.useRef(null),[vt,De]=c.useState(!1),[Ue,Ee]=c.useState(""),[Qe,Xe]=c.useState(!1),B=_e?f.find(t=>t._id===_e):null;y.useEffect(()=>{if(z){const t=setTimeout(()=>{Y(!1)},1e4);return()=>clearTimeout(t)}},[z]),y.useEffect(()=>{S&&s.current&&s.current.scrollIntoView({behavior:"smooth"})},[S]),y.useEffect(()=>{I&&I(r._id,f)},[f,r._id,I]),y.useEffect(()=>{r.comments&&r.comments.length>f.length&&j(r.comments)},[r.comments]);const Ze=y.useRef(f.length),jt=y.useRef(f);y.useEffect(()=>{const t=f.slice(Ze.current),o=t.length;if(Ze.current=f.length,jt.current=f,o>0&&S){const l=t.some(m=>m.senderEmail===u.email),d=t.filter(m=>m.senderEmail!==u.email);l||i?setTimeout(()=>{s.current&&s.current.scrollIntoView({behavior:"smooth"})},100):d.length>0&&p(m=>m+d.length)}},[f.length,i,S,u.email]),y.useEffect(()=>{p(0)},[S]);const He=y.useCallback(()=>{if(!n.current||f.length===0)return;const o=n.current.getBoundingClientRect(),l=o.top+60;let d="";for(let m=0;m<f.length;m++){const b=x.current[f[m]._id];if(b){const w=b.getBoundingClientRect();if(w.top>=l&&w.bottom<=o.bottom){const N=new Date(f[m].timestamp);d=Ye(N);break}}}if(!d)for(let m=0;m<f.length;m++){const b=x.current[f[m]._id];if(b&&b.getBoundingClientRect().bottom>l){const N=new Date(f[m].timestamp);d=Ye(N);break}}d&&d!==P&&se(d)},[f,P]),Ve=y.useRef(!1),Te=y.useCallback(async()=>{if(Ve.current)return;const t=f.filter(o=>{var l;return!((l=o.readBy)!=null&&l.includes(u._id))&&o.senderEmail!==u.email});if(t.length>0){Ve.current=!0;try{(await fetch(`${A}/api/bookings/${r._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(j(l=>l.map(d=>t.some(m=>m._id===d._id)?{...d,readBy:[...d.readBy||[],u._id],status:"read"}:d)),t.forEach(l=>{Q.emit("messageRead",{appointmentId:r._id,messageId:l._id,userId:u._id})}))}catch(o){console.error("Error marking messages as read:",o)}finally{Ve.current=!1}}},[f,u._id,r._id,Q]),Je=y.useCallback(()=>{if(n.current){const{scrollTop:t,scrollHeight:o,clientHeight:l}=n.current,d=o-t-l<5;_(d),d&&g>0&&(p(0),Te())}},[g,Te]);y.useEffect(()=>{const t=n.current;if(t&&S){const o=()=>{Je(),He(),G(!0),je.current&&clearTimeout(je.current),je.current=setTimeout(()=>{G(!1)},1e3)};return t.addEventListener("scroll",o),Je(),setTimeout(He,100),()=>{t.removeEventListener("scroll",o),je.current&&clearTimeout(je.current)}}},[S,Je,He]);const Nt=y.useCallback(()=>{s.current&&(s.current.scrollIntoView({behavior:"smooth"}),p(0),setTimeout(()=>{Te()},500))},[Te]);y.useEffect(()=>(S?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[S]),y.useEffect(()=>{function t(l){l.appointmentId===r._id&&(j(d=>{const m=d.findIndex(b=>b._id===l.comment._id);if(m!==-1){const b=[...d],w=d[m],N=l.comment;let $=N.status;return w.status==="read"&&N.status!=="read"&&($="read"),b[m]={...N,status:$},b}else return!d.some(w=>w._id.toString().startsWith("temp-"))||l.comment.senderEmail!==u.email?[...d,l.comment]:d}),l.comment.deleted&&l.comment.senderEmail!==u.email&&g>0&&p(d=>Math.max(0,d-1)),S&&l.comment.senderEmail!==u.email&&(setTimeout(()=>{fetch(`${A}/api/bookings/${r._id}/comments/read`,{method:"PATCH",credentials:"include"})},100),setTimeout(()=>{s.current&&i&&s.current.scrollIntoView({behavior:"smooth"})},50)))}Q.on("commentUpdate",t);const o=l=>{l.appointmentId===r._id&&(j([]),h.success("Chat deleted by admin"))};return Q.on("chatCleared",o),()=>{Q.off("commentUpdate",t),Q.off("chatCleared",o)}},[r._id,j,S,u.email,i]),y.useEffect(()=>{if(!S)return;const t=o=>{var l;o.ctrlKey&&o.key==="f"&&(o.preventDefault(),(l=a.current)==null||l.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[S]);const qe=async()=>{if(!U.trim())return;const t=U.trim(),o=K,l=`temp-${Date.now()}`,d={_id:l,sender:u._id,senderEmail:u.email,senderName:u.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[u._id],...o?{replyTo:o._id}:{}};j(b=>[...b,d]),F(""),de(null),xe(!0);const m=()=>{a.current&&(a.current.focus(),a.current.setSelectionRange(0,0),document.activeElement!==a.current&&(a.current.click(),a.current.focus()))};m(),requestAnimationFrame(m),setTimeout(m,10),s.current&&s.current.scrollIntoView({behavior:"smooth"});try{const b=await fetch(`${A}/api/bookings/${r._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...o?{replyTo:o._id}:{}})}),w=await b.json();if(b.ok){const N=w.comments[w.comments.length-1];j($=>$.map(ae=>ae._id===l?{...N}:ae))}else{j($=>$.filter(ae=>ae._id!==l)),F(t),h.error(w.message||"Failed to send message.");const N=()=>{a.current&&(a.current.focus(),a.current.setSelectionRange(0,0),document.activeElement!==a.current&&(a.current.click(),a.current.focus()))};N(),requestAnimationFrame(N)}}catch{j(N=>N.filter($=>$._id!==l)),F(t),h.error("An error occurred. Please try again.");const w=()=>{a.current&&(a.current.focus(),a.current.setSelectionRange(0,0),document.activeElement!==a.current&&(a.current.click(),a.current.focus()))};w(),requestAnimationFrame(w)}finally{xe(!1)}},Ke=async t=>{if(!E.trim())return;ge(t),j(l=>l.map(d=>d._id===t?{...d,message:E,edited:!0,editedAt:new Date}:d));try{const l=await fetch(`${A}/api/bookings/${r._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:E})}),d=await l.json();l.ok?(j(m=>m.map(b=>{const w=d.comments.find(N=>N._id===b._id);return w?w._id===t?w:b.status==="read"&&w.status!=="read"?{...w,status:"read"}:w:b})),q(null),H(""),F(""),h.success("Message edited successfully!")):(j(m=>m.map(b=>b._id===t?{...b,message:b.originalMessage||b.message,edited:b.wasEdited||!1}:b)),q(t),H(E),F(E),h.error(d.message||"Failed to edit message."))}catch{j(d=>d.map(m=>m._id===t?{...m,message:m.originalMessage||m.message,edited:m.wasEdited||!1}:m)),q(t),H(E),F(E),h.error("An error occurred. Please try again.")}finally{ge(null)}},Ct=t=>{q(t._id),H(t.message),F(t.message),j(o=>o.map(l=>l._id===t._id?{...l,originalMessage:l.message,wasEdited:l.edited}:l)),setTimeout(()=>{a.current&&(a.current.focus(),a.current.select())},100)},et=new Date(r.date)>new Date||new Date(r.date).toDateString()===new Date().toDateString()&&(!r.time||r.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),St=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},kt=()=>{ce(!0),pe("")},At=async t=>{t.preventDefault(),ve(!0);try{const o=await fetch(`${A}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:be})}),l=await o.json();o.ok&&l.success?(ce(!1),fe(!0)):h.error("Incorrect password. Please try again.")}catch{h.error("Failed to verify password. Please try again.")}ve(!1)},tt=t=>{ye(t),me(!0)},It=async()=>{var t;if(te){try{const o=!((t=te.readBy)!=null&&t.includes(u._id))&&te.senderEmail!==u.email,l=await fetch(`${A}/api/bookings/${r._id}/comment/${te._id}`,{method:"DELETE",credentials:"include"}),d=await l.json();l.ok?(j(d.comments),o&&p(m=>Math.max(0,m-1)),h.success("Message deleted successfully!")):h.error(d.message||"Failed to delete message.")}catch{h.error("An error occurred. Please try again.")}me(!1),ye(null)}};function _t(t){try{return JSON.parse(localStorage.getItem(`hiddenDeletedMsgs_${t}`))||[]}catch{return[]}}const Dt=y.useCallback(t=>{We(o=>{if(!o.includes(t)){const l=[...o,t];return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${r._id}`,JSON.stringify(l))},0),l}return o})},[r._id]),Et=y.useCallback(t=>{We(o=>{const l=o.filter(d=>d!==t);return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${r._id}`,JSON.stringify(l))},0),l})},[r._id]);return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${M?"bg-gray-50":""} ${et?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(r.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:r.time}),!et&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),M&&r.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(r.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:r.listingId?e.jsx(yt,{to:`/admin/listing/${r.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:r.propertyName}):e.jsx("div",{className:"font-semibold",children:r.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return X((t=r.buyerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((st=r.buyerId)==null?void 0:st.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((rt=r.buyerId)==null?void 0:rt.email)||r.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((at=r.buyerId)==null?void 0:at.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return X((t=r.sellerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((lt=r.sellerId)==null?void 0:lt.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(nt=r.sellerId)==null?void 0:nt.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((it=r.sellerId)==null?void 0:it.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:r.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:r.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${St(r.status)}`,children:r.status==="deletedByAdmin"?"Deleted by Admin":r.status==="cancelledByBuyer"?"Cancelled by Buyer":r.status==="cancelledBySeller"?"Cancelled by Seller":r.status==="cancelledByAdmin"?"Cancelled by Admin":r.status.charAt(0).toUpperCase()+r.status.slice(1)}),r.status==="deletedByAdmin"&&r.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',r.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:M?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>Re(r._id),title:"Unarchive Appointment",children:[e.jsx(ue,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[r.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>he(r._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(Ce,{})," Reinitiate"]}):r.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>D(r._id),title:"Cancel Appointment (Admin)",children:[e.jsx(Ce,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>V(r._id),title:"Archive Appointment",children:[e.jsx(Me,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsxs("button",{className:"flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 mx-auto relative group",title:"Open Chat",onClick:kt,children:[e.jsx(Ge,{size:22,className:"group-hover:animate-pulse"}),e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"})]}),Ae&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>ce(!1),title:"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(Ce,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:At,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:be,onChange:t=>pe(t.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:we,children:we?"Verifying...":"Unlock Chat"})]})]})}),S&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200",children:[e.jsx("div",{className:"flex items-center gap-3 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-600 rounded-t-3xl relative",children:_e&&B?e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[!B.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{var t;de(B),(t=a.current)==null||t.focus(),W(null)},title:"Reply","aria-label":"Reply",children:e.jsx("svg",{width:"20",height:"20",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),!B.deleted&&e.jsx("button",{className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{Fe(B.message),W(null)},title:"Copy message","aria-label":"Copy message",children:e.jsx(Ot,{size:18})}),B.senderEmail===u.email&&!B.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{Ct(B),W(null)},className:"text-white hover:text-yellow-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",title:"Edit comment","aria-label":"Edit comment",disabled:v!==null,children:e.jsx(Ut,{size:18})}),e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{tt(B),W(null)},title:"Delete","aria-label":"Delete",children:e.jsx(le,{size:18})})]}),B.senderEmail!==u.email&&!B.deleted&&e.jsx("button",{className:"text-white hover:text-red-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors",onClick:()=>{tt(B),W(null)},title:"Delete","aria-label":"Delete",children:e.jsx(le,{size:18})})]}),e.jsx("button",{className:"text-white hover:text-gray-200 bg-white/10 hover:bg-white/20 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>W(null),title:"Close options","aria-label":"Close options",children:e.jsx(ne,{className:"w-4 h-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-full p-1.5 shadow-lg",children:e.jsx(Ge,{className:"text-blue-600 text-lg"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Live Chat"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[f.length>0&&e.jsx("button",{className:"text-red-100 hover:text-white bg-red-500/30 hover:bg-red-500/50 rounded-full p-2 transition-colors shadow flex items-center gap-2",onClick:()=>De(!0),title:"Delete entire chat","aria-label":"Delete chat",children:e.jsx(le,{className:"text-sm"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>Y(!z),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(Ht,{className:"text-sm"})}),z&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>fe(!1),title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{ref:n,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[P&&f.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${re?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:P})})}),f.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(Ge,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start a conversation to communicate with the parties"})]}):f.map((t,o)=>{var N,$,ae,ct,mt;const l=t.senderEmail===u.email,d=v===t._id,m=new Date(t.timestamp),b=o>0?new Date(f[o-1].timestamp):null,w=b?m.toDateString()!==b.toDateString():!0;return e.jsxs(y.Fragment,{children:[w&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Ye(m)})}),e.jsx("div",{className:`flex w-full ${l?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*o}s`},children:e.jsxs("div",{ref:T=>x.current[t._id]=T,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] break-all overflow-hidden relative transition-all duration-200 min-h-[60px] ${l?"bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-500 hover:to-purple-600 text-white shadow-blue-200 hover:shadow-blue-300":"bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-lg hover:border-gray-300"}`,children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 hover:from-purple-100 hover:to-blue-100 rounded-lg w-full max-w-full break-words cursor-pointer transition-all duration-200 hover:shadow-sm",onClick:()=>{x.current[t.replyTo]&&(x.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),x.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{x.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"â†©"}),(($=(N=f.find(T=>T._id===t.replyTo))==null?void 0:N.message)==null?void 0:$.substring(0,30))||"Original message",((ct=(ae=f.find(T=>T._id===t.replyTo))==null?void 0:ae.message)==null?void 0:ct.length)>30?"...":""]})}),e.jsx("div",{className:"font-semibold mb-2 flex items-center gap-2 justify-start text-left",children:e.jsx("span",{className:`truncate max-w-[120px] min-w-[60px] inline-block align-middle overflow-hidden text-ellipsis text-left ${l?"text-blue-100":"text-gray-700"}`,children:l?"You":(()=>{var ut,ht,xt,gt;const T=t.senderEmail===((ut=r.buyerId)==null?void 0:ut.email),Tt=t.senderEmail===((ht=r.sellerId)==null?void 0:ht.email);return T?((xt=r.buyerId)==null?void 0:xt.username)||t.senderName||t.senderEmail:Tt?((gt=r.sellerId)==null?void 0:gt.username)||t.senderName||t.senderEmail:t.senderName||t.senderEmail})()})}),e.jsx("div",{className:`text-left ${l?"text-base font-medium":"text-sm"}`,children:t.deleted?(()=>{const T=wt.includes(t._id);return u&&(u.role==="admin"||u.role==="rootadmin")?T?e.jsx("div",{className:"border border-gray-300 bg-gray-100 rounded p-2 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 text-xs",children:[e.jsx(Ne,{className:"inline-block"}),e.jsx("span",{children:"Deleted message hidden from view"})]}),e.jsx("button",{className:"text-xs text-blue-500 hover:text-blue-700 underline",onClick:()=>Et(t._id),title:"Show this deleted message content",children:"Show"})]})}):e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(Ne,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400",children:t.originalMessage?e.jsx("span",{className:"whitespace-pre-wrap",children:t.originalMessage}):t.message?e.jsx("span",{className:"whitespace-pre-wrap",children:t.message}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})}),!1,e.jsx("button",{className:"mt-2 text-xs text-red-500 hover:text-red-700 underline",onClick:()=>Dt(t._id),title:"Hide this deleted message from your admin view",children:"Hide from admin view"})]}):e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(Ne,{className:"inline-block text-lg"})," This message has been deleted."]})})():e.jsx("div",{children:d?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap",children:(t.message||"").replace(/\n+$/,"")}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300 whitespace-nowrap",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-1 justify-end mt-2","data-message-actions":!0,children:[e.jsx("span",{className:`${l?"text-blue-200":"text-gray-500"} text-[10px]`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})}),!t.deleted&&e.jsx("button",{className:`${t.senderEmail===u.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-1`,onClick:T=>{T.stopPropagation(),W(t._id)},title:"Message options","aria-label":"Message options",children:e.jsx(Vt,{size:t.senderEmail===u.email?14:12})}),t.senderEmail===u.email&&!t.deleted&&e.jsx("span",{className:"ml-1 flex items-center gap-1",children:(mt=t.readBy)!=null&&mt.some(T=>T!==u._id)?e.jsx(ft,{className:"text-green-400 text-xs",title:"Read"}):t.status==="delivered"?e.jsx(ft,{className:"text-blue-200 text-xs",title:"Delivered"}):t.status==="sending"?e.jsx(bt,{className:"text-blue-200 text-xs animate-pulse",title:"Sending..."}):e.jsx(bt,{className:"text-blue-200 text-xs",title:"Sent"})})]})]})})]},t._id||o)}),e.jsx("div",{ref:s})]}),K&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(ot=K.message)==null?void 0:ot.substring(0,40),((dt=K.message)==null?void 0:dt.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>de(null),title:"Cancel reply",children:e.jsx(ne,{className:"w-3 h-3"})})]})}),v&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:E}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{q(null),H(""),F("")},title:"Cancel edit",children:e.jsx(ne,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-200 bg-white resize-y whitespace-pre-wrap",placeholder:v?"Edit your message...":"Type a message...",value:U,onChange:t=>{F(t.target.value),v&&H(t.target.value)},onClick:()=>{_e&&(W(null),h.info("You can hit reply icon in header to reply"))},onKeyDown:t=>{const o=window.innerWidth>=768&&!("ontouchstart"in window||navigator.maxTouchPoints>0);t.key==="Enter"&&(o&&!t.shiftKey||t.ctrlKey||t.metaKey)&&(t.preventDefault(),v?Ke(v):qe())},ref:a}),e.jsx("button",{onClick:t=>{t.preventDefault(),v?Ke(v):qe()},disabled:(v?ke===v:ee)||!U.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:transform-none flex items-center gap-2 min-w-24",children:v?ke===v?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":ee?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(10px) scale(0.98); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                }
              `}),!i&&!v&&!K&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:Nt,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:g>0?`${g} new message${g>1?"s":""}`:"Scroll to bottom","aria-label":g>0?`${g} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),g>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:g>99?"99+":g})]})}),vt&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-sm relative shadow-2xl",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>{De(!1),Ee("")},title:"Close","aria-label":"Close",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-red-600 flex items-center gap-2",children:[e.jsx(le,{})," Delete Entire Chat"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"This will permanently delete all messages for this appointment. Enter admin password to confirm."}),e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-red-200 mb-4",placeholder:"Admin password",value:Ue,onChange:t=>Ee(t.target.value),autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{De(!1),Ee("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",disabled:Qe||!Ue,onClick:async()=>{try{Xe(!0);const t=await fetch(`${A}/api/bookings/${r._id}/comments`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:Ue})}),o=await t.json();t.ok?(j([]),h.success("Chat deleted successfully."),De(!1),Ee("")):h.error(o.message||"Failed to delete chat")}catch{h.error("An error occurred. Please try again.")}finally{Xe(!1)}},className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-60",children:Qe?"Deleting...":e.jsxs(e.Fragment,{children:[e.jsx(le,{size:12})," Delete Chat"]})})]})]})})]})}),Ie&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(le,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Delete Message"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to delete this message for everyone?"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{me(!1),ye(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:It,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(le,{size:14}),"Delete"]})]})]})})}),Be&&oe===r._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ne,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Cancel Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:ze,onChange:t=>O(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for cancelling this appointment..."})]})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{C(!1),L(null),O("")},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Oe,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(Ne,{size:14}),"Cancel Appointment"]})]})]})})}),Le&&oe===r._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ue,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Reinitiate Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{$e(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:k,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ue,{size:14}),"Reinitiate"]})]})]})})}),ie&&oe===r._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Me,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Archive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Pe(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:R,className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(Me,{size:14}),"Archive"]})]})]})})}),Se&&oe===r._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ue,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Unarchive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{J(!1),L(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Z,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ue,{size:14}),"Unarchive"]})]})]})})})]})]})}export{qt as default};
