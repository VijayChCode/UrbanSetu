import{g as Dt,r as o,a1 as p,v as J,j as e,L as ft,a3 as Et,P as ue,a4 as Ee,a5 as Tt,G as xe,U as Mt,a6 as je,a7 as Lt,f as Bt,a8 as Ft,a9 as Rt,y as x,aa as De,z as me,ab as $t,E as ye,ac as Pt,ad as zt,C as Ot,ae as ht,H as gt}from"./index-CGqS_iGw.js";const I="https://urbansetu.onrender.com";function Ht(){const{currentUser:s}=Dt(a=>a.user),[u,M]=o.useState([]),[he,W]=o.useState([]),[Te,te]=o.useState(!0),[B,Me]=o.useState("all"),[L,Le]=o.useState(""),[w,Be]=o.useState(null),[Fe,ie]=o.useState(!1),[Re,ve]=o.useState(!1),[R,oe]=o.useState(!1),[Q,we]=o.useState(""),[X,$e]=o.useState(""),[C,F]=o.useState(null),[b,v]=o.useState(""),[se,D]=o.useState(!1),[ge,ae]=o.useState(!1),[S,O]=o.useState(!1),[$,P]=o.useState(!1),[Pe,ze]=o.useState(!1),[de,Ne]=o.useState(()=>getLocallyHiddenIds(appt._id)),[N,Ce]=o.useState(null);p.useRef(null);const[Ge,Se]=o.useState(!1),[Oe,Ue]=o.useState(""),[Ke,ke]=o.useState(!1);o.useEffect(()=>{const a=async()=>{try{const k=await(await fetch(`${I}/api/bookings`,{credentials:"include"})).json();M(k),te(!1)}catch(i){console.error("Failed to fetch appointments",i),te(!1)}},n=async()=>{try{const k=await(await fetch(`${I}/api/bookings/archived`,{credentials:"include"})).json();W(k)}catch(i){console.error("Failed to fetch archived appointments",i)}};a(),n();const c=setInterval(()=>{a(),n()},5e3),h=i=>{M(k=>k.map(f=>{const y={...f};return f.buyerId&&(f.buyerId._id===i.userId||f.buyerId===i.userId)&&(y.buyerId={...y.buyerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),f.sellerId&&(f.sellerId._id===i.userId||f.sellerId===i.userId)&&(y.sellerId={...y.sellerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),y})),W(k=>k.map(f=>{const y={...f};return f.buyerId&&(f.buyerId._id===i.userId||f.buyerId===i.userId)&&(y.buyerId={...y.buyerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),f.sellerId&&(f.sellerId._id===i.userId||f.sellerId===i.userId)&&(y.sellerId={...y.sellerId,username:i.username,email:i.email,mobileNumber:i.mobileNumber,avatar:i.avatar}),y}))};return J.on("profileUpdated",h),()=>{clearInterval(c),J.off("profileUpdated",h)}},[]),o.useEffect(()=>{s&&(M(a=>a.map(n=>{const c={...n};return n.buyerId&&(n.buyerId._id===s._id||n.buyerId===s._id)&&(c.buyerId={...c.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),n.sellerId&&(n.sellerId._id===s._id||n.sellerId===s._id)&&(c.sellerId={...c.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),c})),W(a=>a.map(n=>{const c={...n};return n.buyerId&&(n.buyerId._id===s._id||n.buyerId===s._id)&&(c.buyerId={...c.buyerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),n.sellerId&&(n.sellerId._id===s._id||n.sellerId===s._id)&&(c.sellerId={...c.sellerId,username:s.username,email:s.email,mobileNumber:s.mobileNumber,avatar:s.avatar}),c})))},[s]);const re=async a=>{F(a),v(""),D(!0)},ce=async()=>{if(!b.trim()){x.error("Please provide a reason for cancelling this appointment.");return}try{console.log("Attempting to cancel appointment:",C),console.log("Current user:",s),console.log("User role:",s.role),console.log("Admin approval status:",s.adminApprovalStatus);const a=u.find(h=>h._id===C);a&&(console.log("Current appointment status:",a.status),console.log("Appointment date:",a.date),console.log("Appointment time:",a.time));const n=await fetch(`${I}/api/bookings/${C}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:b})});console.log("Response status:",n.status);const c=await n.json();console.log("Response data:",c),n.ok?(M(h=>h.map(i=>i._id===C?{...i,status:"cancelledByAdmin",cancelReason:b}:i)),x.success("Appointment cancelled successfully. Both buyer and seller have been notified of the cancellation.")):x.error(c.message||"Failed to cancel appointment."),D(!1),F(null),v("")}catch(a){console.error("Error in confirmAdminCancel:",a),x.error("An error occurred. Please try again.")}},be=async a=>{F(a),ae(!0)},fe=async()=>{try{console.log("Attempting to reinitiate appointment:",C);const a=await fetch(`${I}/api/bookings/${C}/reinitiate`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"});console.log("Response status:",a.status);const n=await a.json();console.log("Response data:",n),a.ok?(M(c=>c.map(h=>h._id===C?{...h,status:"pending",cancelReason:""}:h)),x.success("Appointment reinitiated successfully. Both buyer and seller have been notified.")):x.error(n.message||"Failed to reinitiate appointment."),ae(!1),F(null)}catch(a){console.error("Error in confirmReinitiate:",a),x.error("An error occurred. Please try again.")}},E=async a=>{F(a),O(!0)},G=async()=>{try{const a=await fetch(`${I}/api/bookings/${C}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),n=await a.json();if(a.ok){const c=u.find(h=>h._id===C);c&&(M(h=>h.filter(i=>i._id!==C)),W(h=>[{...c,archivedByAdmin:!0,archivedAt:new Date},...h])),x.success("Appointment archived successfully.")}else x.error(n.message||"Failed to archive appointment.");O(!1),F(null)}catch(a){console.error("Error in confirmArchive:",a),x.error("An error occurred. Please try again.")}},K=async a=>{F(a),P(!0)},U=async()=>{try{const a=await fetch(`${I}/api/bookings/${C}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),n=await a.json();if(a.ok){const c=he.find(h=>h._id===C);c&&(W(h=>h.filter(i=>i._id!==C)),M(h=>[{...c,archivedByAdmin:!1,archivedAt:void 0},...h])),x.success("Appointment unarchived successfully.")}else x.error(n.message||"Failed to unarchive appointment.");P(!1),F(null)}catch(a){console.error("Error in confirmUnarchive:",a),x.error("An error occurred. Please try again.")}},Z=async a=>{if(!a){x.error("User ID not available");return}ve(!0),ie(!0);try{const n=await fetch(`${I}/api/user/id/${a}`),c=await n.json();n.ok?Be(c):(x.error("Failed to fetch user details."),ie(!1))}catch{x.error("An error occurred while fetching user details."),ie(!1)}ve(!1)},Ae=u.filter(a=>{var k,f,y,z,ne,H,q,V,ee;const n=new Date(a.date)<new Date||new Date(a.date).toDateString()===new Date().toDateString()&&a.time&&a.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),c=B==="all"?!0:B==="outdated"?n:a.status===B,h=((f=(k=a.buyerId)==null?void 0:k.email)==null?void 0:f.toLowerCase().includes(L.toLowerCase()))||((z=(y=a.sellerId)==null?void 0:y.email)==null?void 0:z.toLowerCase().includes(L.toLowerCase()))||((ne=a.propertyName)==null?void 0:ne.toLowerCase().includes(L.toLowerCase()))||((q=(H=a.buyerId)==null?void 0:H.username)==null?void 0:q.toLowerCase().includes(L.toLowerCase()))||((ee=(V=a.sellerId)==null?void 0:V.username)==null?void 0:ee.toLowerCase().includes(L.toLowerCase()));let i=!0;return Q&&(i=i&&new Date(a.date)>=new Date(Q)),X&&(i=i&&new Date(a.date)<=new Date(X)),c&&h&&i}),T=he.filter(a=>{var k,f,y,z,ne,H,q,V,ee;const n=new Date(a.date)<new Date||new Date(a.date).toDateString()===new Date().toDateString()&&a.time&&a.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),c=B==="all"?!0:B==="outdated"?n:a.status===B,h=((f=(k=a.buyerId)==null?void 0:k.email)==null?void 0:f.toLowerCase().includes(L.toLowerCase()))||((z=(y=a.sellerId)==null?void 0:y.email)==null?void 0:z.toLowerCase().includes(L.toLowerCase()))||((ne=a.propertyName)==null?void 0:ne.toLowerCase().includes(L.toLowerCase()))||((q=(H=a.buyerId)==null?void 0:H.username)==null?void 0:q.toLowerCase().includes(L.toLowerCase()))||((ee=(V=a.sellerId)==null?void 0:V.username)==null?void 0:ee.toLowerCase().includes(L.toLowerCase()));let i=!0;return Q&&(i=i&&new Date(a.date)>=new Date(Q)),X&&(i=i&&new Date(a.date)<=new Date(X)),c&&h&&i}),Y=async()=>{te(!0);try{const a=await fetch(`${I}/api/bookings`,{credentials:"include"});if(a.ok){const c=await a.json();M(c)}const n=await fetch(`${I}/api/bookings/archived`,{credentials:"include"});if(n.ok){const c=await n.json();W(Array.isArray(c)?c:[])}}catch{}finally{te(!1)}},le=a=>{if(console.log("Copy button clicked, message:",a),!a){x.error("No message to copy");return}navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(a).then(()=>{x.success("Copied",{autoClose:2e3,position:"bottom-center"})}).catch(()=>{Ie(a)}):Ie(a)},Ie=a=>{try{const n=document.createElement("textarea");n.value=a,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();const c=document.execCommand("copy");document.body.removeChild(n),c?(console.log("Copy successful via fallback method"),x.success("Copied",{autoClose:2e3,position:"bottom-center"})):(console.error("Fallback copy failed"),x.error("Failed to copy message"))}catch(n){console.error("Fallback copy error:",n),x.error("Copy not supported")}};return Te?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading appointments..."})]})}):Array.isArray(u)?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(Et,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-6",children:[e.jsx("h3",{className:"text-2xl sm:text-3xl font-extrabold text-blue-700 drop-shadow",children:R?"Archived Appointments":"All Appointments (Admin View)"}),e.jsxs("div",{className:"flex flex-row w-full sm:w-auto gap-2 sm:gap-4 justify-center sm:justify-end mt-2 sm:mt-0",children:[e.jsx("button",{onClick:Y,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-2.5 py-1.5 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md text-xs sm:text-base sm:px-4 sm:py-2 sm:rounded-lg w-1/2 sm:w-auto",title:"Refresh appointments",children:"Refresh"}),e.jsx("button",{onClick:()=>oe(!R),className:`bg-gradient-to-r text-white px-2.5 py-1.5 rounded-md transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-1 sm:gap-2 text-xs sm:text-base w-1/2 sm:w-auto sm:px-6 sm:py-3 sm:rounded-lg justify-center ${R?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:R?e.jsxs(e.Fragment,{children:[e.jsx(ue,{})," ",e.jsx("span",{children:"Active Appointments"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{})," ",e.jsxs("span",{children:["Archived Appointments (",he.length,")"]})]})})]})]}),e.jsx("p",{className:"text-center text-gray-600 mb-6",children:R?"View and manage archived appointments. You can unarchive them to move them back to active appointments.":"Monitor all appointments across the platform. Use the status filter to view pending appointments. 💡 Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:B,onChange:a=>Me(a.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending Appointments"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:Q,onChange:a=>we(a.target.value),max:X||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:X,onChange:a=>$e(a.target.value),min:Q||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Tt,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by email, property, or username...",value:L,onChange:a=>Le(a.target.value)})]})]}),R?T.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:T.map(a=>e.jsx(bt,{appt:a,currentUser:s,handleAdminCancel:re,handleReinitiateAppointment:be,handleArchiveAppointment:E,handleUnarchiveAppointment:K,onUserClick:Z,isArchived:!0,copyMessageToClipboard:le,showCancelModal:se,setShowCancelModal:D,showReinitiateModal:ge,setShowReinitiateModal:ae,showArchiveModal:S,setShowArchiveModal:O,showUnarchiveModal:$,setShowUnarchiveModal:P,appointmentToHandle:C,setAppointmentToHandle:F,cancelReason:b,setCancelReason:v,confirmAdminCancel:ce,confirmReinitiate:fe,confirmArchive:G,confirmUnarchive:U},a._id))})]})}):Ae.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Buyer"}),e.jsx("th",{className:"border p-2",children:"Seller"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Ae.map(a=>e.jsx(bt,{appt:a,currentUser:s,handleAdminCancel:re,handleReinitiateAppointment:be,handleArchiveAppointment:E,handleUnarchiveAppointment:K,onUserClick:Z,isArchived:!1,copyMessageToClipboard:le,showCancelModal:se,setShowCancelModal:D,showReinitiateModal:ge,setShowReinitiateModal:ae,showArchiveModal:S,setShowArchiveModal:O,showUnarchiveModal:$,setShowUnarchiveModal:P,appointmentToHandle:C,setAppointmentToHandle:F,cancelReason:b,setCancelReason:v,confirmAdminCancel:ce,confirmReinitiate:fe,confirmArchive:G,confirmUnarchive:U},a._id))})]})})]}),Fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>ie(!1),title:"Close","aria-label":"Close",children:e.jsx(xe,{className:"w-4 h-4"})}),Re?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"}),e.jsx("p",{className:"ml-4 text-gray-600",children:"Loading user details..."})]}):w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Mt,{user:{username:w.username,avatar:w.avatar},size:"w-16 h-16",textSize:"text-lg",showBorder:!0,className:"border-4 border-white shadow-lg"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:w.role==="admin"||w.role==="rootadmin"?e.jsx(je,{className:"w-3 h-3 text-white"}):e.jsx(Lt,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[w.username,(w.role==="admin"||w.role==="rootadmin")&&e.jsx(je,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:w.role||"User"}),w.adminApprovalStatus&&e.jsx("p",{className:`text-xs font-medium px-2 py-1 rounded-full ${w.adminApprovalStatus==="approved"?"bg-green-100 text-green-700":w.adminApprovalStatus==="pending"?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:w.adminApprovalStatus})]})]})]})}),e.jsx("div",{className:"px-6 py-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(Bt,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:w.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(Ft,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:w.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(Rt,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:new Date(w.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})})]})]})]})})]}):e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("p",{className:"text-gray-600",children:"User not found"})})]})})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 to-blue-100",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Session expired or unauthorized"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Please sign in again to access admin appointments."}),e.jsx(ft,{to:"/sign-in",className:"bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors",children:"Go to Sign In"})]})})}function Je(s){const u=new Date,M=new Date;return M.setDate(u.getDate()-1),s.toDateString()===u.toDateString()?"Today":s.toDateString()===M.toDateString()?"Yesterday":s.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function bt({appt:s,currentUser:u,handleAdminCancel:M,handleReinitiateAppointment:he,handleArchiveAppointment:W,handleUnarchiveAppointment:Te,onUserClick:te,isArchived:B,copyMessageToClipboard:Me,showCancelModal:L,setShowCancelModal:Le,showReinitiateModal:w,setShowReinitiateModal:Be,showArchiveModal:Fe,setShowArchiveModal:ie,showUnarchiveModal:Re,setShowUnarchiveModal:ve,appointmentToHandle:R,setAppointmentToHandle:oe,cancelReason:Q,setCancelReason:we,confirmAdminCancel:X,confirmReinitiate:$e,confirmArchive:C,confirmUnarchive:F}){var Ze,et,tt,st,at,rt,lt,nt;const[b,v]=o.useState(s.comments||[]),[se,D]=o.useState(""),[ge,ae]=o.useState(!1),[S,O]=o.useState(null),[$,P]=o.useState(""),[Pe,ze]=o.useState(null),[de,Ne]=o.useState(null),[N,Ce]=o.useState(!1),[Ge,Se]=o.useState(!1),[Oe,Ue]=o.useState(""),[Ke,ke]=o.useState(!1),[re,ce]=o.useState(null),[be,fe]=o.useState(!1),E=p.useRef(null),G=p.useRef(null),K=p.useRef(null),U=p.useRef({}),[Z,Ae]=o.useState(!0),[T,Y]=o.useState(0),[le,Ie]=o.useState(""),[a,n]=o.useState(!1),[c,h]=o.useState(!1),[i,k]=o.useState(()=>kt(s._id)),[f,y]=o.useState(null),z=p.useRef(null),[ne,H]=o.useState(!1),[q,V]=o.useState(""),[ee,Ye]=o.useState(!1);p.useEffect(()=>{if(c){const t=setTimeout(()=>{h(!1)},1e4);return()=>clearTimeout(t)}},[c]),p.useEffect(()=>{N&&E.current&&E.current.scrollIntoView({behavior:"smooth"})},[N]);const qe=p.useRef(b.length),pt=p.useRef(b);p.useEffect(()=>{const t=b.slice(qe.current),l=t.length;if(qe.current=b.length,pt.current=b,l>0&&N){const r=t.some(d=>d.senderEmail===u.email),m=t.filter(d=>d.senderEmail!==u.email);r||Z?setTimeout(()=>{E.current&&E.current.scrollIntoView({behavior:"smooth"})},100):m.length>0&&Y(d=>d+m.length)}},[b.length,Z,N,u.email]),p.useEffect(()=>{Y(0)},[N]);const He=p.useCallback(()=>{if(!G.current||b.length===0)return;const l=G.current.getBoundingClientRect(),r=l.top+60;let m="";for(let d=0;d<b.length;d++){const g=U.current[b[d]._id];if(g){const j=g.getBoundingClientRect();if(j.top>=r&&j.bottom<=l.bottom){const _=new Date(b[d].timestamp);m=Je(_);break}}}if(!m)for(let d=0;d<b.length;d++){const g=U.current[b[d]._id];if(g&&g.getBoundingClientRect().bottom>r){const _=new Date(b[d].timestamp);m=Je(_);break}}m&&m!==le&&Ie(m)},[b,le]),_e=p.useCallback(async()=>{const t=b.filter(l=>{var r;return!((r=l.readBy)!=null&&r.includes(u._id))&&l.senderEmail!==u.email});if(t.length>0)try{(await fetch(`${I}/api/bookings/${s._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(v(r=>r.map(m=>t.some(d=>d._id===m._id)?{...m,readBy:[...m.readBy||[],u._id],status:"read"}:m)),t.forEach(r=>{J.emit("messageRead",{appointmentId:s._id,messageId:r._id,userId:u._id})}))}catch(l){console.error("Error marking messages as read:",l)}},[b,u._id,s._id,J]),Ve=p.useCallback(()=>{if(G.current){const{scrollTop:t,scrollHeight:l,clientHeight:r}=G.current,m=l-t-r<5;Ae(m),m&&T>0&&(Y(0),_e())}},[T,_e]);p.useEffect(()=>{const t=G.current;if(t&&N){const l=()=>{Ve(),He(),n(!0),z.current&&clearTimeout(z.current),z.current=setTimeout(()=>{n(!1)},1e3)};return t.addEventListener("scroll",l),Ve(),setTimeout(He,100),()=>{t.removeEventListener("scroll",l),z.current&&clearTimeout(z.current)}}},[N,Ve,He]);const yt=p.useCallback(()=>{E.current&&(E.current.scrollIntoView({behavior:"smooth"}),Y(0),setTimeout(()=>{_e()},500))},[_e]);p.useEffect(()=>(N?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[N]),p.useEffect(()=>{function t(r){if(r.appointmentId===s._id&&!N){if(r.comment.deleted)return;x.custom(m=>e.jsxs("div",{className:"bg-blue-600 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2 animate-bounce-in",children:[e.jsx(De,{})," New message from ",r.comment.senderEmail||"User",e.jsx("button",{onClick:()=>{Ce(!0),x.dismiss(m.id)},className:"ml-4 bg-white text-blue-700 px-2 py-1 rounded",children:"Open Chat"})]}))}}J.on("commentUpdate",t);const l=r=>{r.appointmentId===s._id&&(v([]),x.success("Chat deleted by admin"))};return J.on("chatCleared",l),()=>{J.off("commentUpdate",t),J.off("chatCleared",l)}},[s._id,N]),p.useEffect(()=>{function t(l){l.appointmentId===s._id&&(v(r=>{const m=r.findIndex(d=>d._id===l.comment._id);if(m!==-1){const d=[...r],g=r[m],j=l.comment;let _=j.status;return g.status==="read"&&j.status!=="read"&&(_="read"),d[m]={...j,status:_},d}else return!r.some(g=>g._id.toString().startsWith("temp-"))||l.comment.senderEmail!==u.email?[...r,l.comment]:r}),l.comment.deleted&&l.comment.senderEmail!==u.email&&T>0&&Y(r=>Math.max(0,r-1)),N&&l.comment.senderEmail!==u.email&&(setTimeout(()=>{fetch(`${I}/api/bookings/${s._id}/comments/read`,{method:"PATCH",credentials:"include"})},100),setTimeout(()=>{E.current&&Z&&E.current.scrollIntoView({behavior:"smooth"})},50)))}return J.on("commentUpdate",t),()=>{J.off("commentUpdate",t)}},[s._id,v,N,u.email,Z]),p.useEffect(()=>{if(!N)return;const t=l=>{var r;l.ctrlKey&&l.key==="f"&&(l.preventDefault(),(r=K.current)==null||r.focus())};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}},[N]);const We=async()=>{if(!se.trim())return;const t=se.trim(),l=de,r=`temp-${Date.now()}`,m={_id:r,sender:u._id,senderEmail:u.email,senderName:u.username,message:t,status:"sending",timestamp:new Date().toISOString(),readBy:[u._id],...l?{replyTo:l._id}:{}};v(d=>[...d,m]),D(""),Ne(null),ae(!0),E.current&&E.current.scrollIntoView({behavior:"smooth"});try{const d=await fetch(`${I}/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:t,...l?{replyTo:l._id}:{}})}),g=await d.json();if(d.ok){const j=g.comments[g.comments.length-1];v(_=>_.map(pe=>pe._id===r?{...j}:pe))}else v(j=>j.filter(_=>_._id!==r)),D(t),x.error(g.message||"Failed to send message.")}catch{v(g=>g.filter(j=>j._id!==r)),D(t),x.error("An error occurred. Please try again.")}finally{ae(!1)}},Qe=async t=>{if(!$.trim())return;ze(t),v(r=>r.map(m=>m._id===t?{...m,message:$,edited:!0,editedAt:new Date}:m)),O(null),P(""),D("");try{const r=await fetch(`${I}/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:$})}),m=await r.json();r.ok?(v(d=>d.map(g=>{const j=m.comments.find(_=>_._id===g._id);return j?j._id===t?j:g.status==="read"&&j.status!=="read"?{...j,status:"read"}:j:g})),x.success("Message edited successfully!")):(v(d=>d.map(g=>g._id===t?{...g,message:g.originalMessage||g.message,edited:g.wasEdited||!1}:g)),O(t),P($),D($),x.error(m.message||"Failed to edit message."))}catch{v(m=>m.map(d=>d._id===t?{...d,message:d.originalMessage||d.message,edited:d.wasEdited||!1}:d)),O(t),P($),D($),x.error("An error occurred. Please try again.")}finally{ze(null)}},jt=t=>{O(t._id),P(t.message),D(t.message),v(l=>l.map(r=>r._id===t._id?{...r,originalMessage:r.message,wasEdited:r.edited}:r)),setTimeout(()=>{K.current&&(K.current.focus(),K.current.select())},100)},Xe=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),vt=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-red-100 text-red-700";case"cancelledBySeller":return"bg-red-100 text-red-700";case"cancelledByAdmin":return"bg-red-100 text-red-700";case"deletedByAdmin":return"bg-gray-100 text-gray-700";default:return"bg-gray-100 text-gray-700"}},wt=()=>{Se(!0),Ue("")},Nt=async t=>{t.preventDefault(),fe(!0);try{const l=await fetch(`${I}/api/auth/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:Oe})}),r=await l.json();l.ok&&r.success?(Se(!1),Ce(!0)):x.error("Incorrect password. Please try again.")}catch{x.error("Failed to verify password. Please try again.")}fe(!1)},Ct=t=>{ce(t),ke(!0)},St=async()=>{var t;if(re){try{const l=!((t=re.readBy)!=null&&t.includes(u._id))&&re.senderEmail!==u.email,r=await fetch(`${I}/api/bookings/${s._id}/comment/${re._id}`,{method:"DELETE",credentials:"include"}),m=await r.json();r.ok?(v(m.comments),l&&Y(d=>Math.max(0,d-1)),x.success("Message deleted successfully!")):x.error(m.message||"Failed to delete message.")}catch{x.error("An error occurred. Please try again.")}ke(!1),ce(null)}};function kt(t){try{return JSON.parse(localStorage.getItem(`hiddenDeletedMsgs_${t}`))||[]}catch{return[]}}const At=p.useCallback(t=>{k(l=>{if(!l.includes(t)){const r=[...l,t];return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${s._id}`,JSON.stringify(r))},0),r}return l})},[s._id]),It=p.useCallback(t=>{k(l=>{const r=l.filter(m=>m!==t);return setTimeout(()=>{localStorage.setItem(`hiddenDeletedMsgs_${s._id}`,JSON.stringify(r))},0),r})},[s._id]);return e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${B?"bg-gray-50":""} ${Xe?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time}),!Xe&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"}),B&&s.archivedAt&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Archived: ",new Date(s.archivedAt).toLocaleDateString("en-GB")]})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(ft,{to:`/admin/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return te((t=s.buyerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view buyer details",children:[e.jsx("div",{className:"font-semibold",children:((Ze=s.buyerId)==null?void 0:Ze.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:((et=s.buyerId)==null?void 0:et.email)||s.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((tt=s.buyerId)==null?void 0:tt.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2",children:e.jsxs("button",{onClick:()=>{var t;return te((t=s.sellerId)==null?void 0:t._id)},className:"text-blue-600 hover:text-blue-800 hover:underline text-left",title:"Click to view seller details",children:[e.jsx("div",{className:"font-semibold",children:((st=s.sellerId)==null?void 0:st.username)||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-600",children:(at=s.sellerId)==null?void 0:at.email}),e.jsx("div",{className:"text-sm text-gray-600",children:((rt=s.sellerId)==null?void 0:rt.mobileNumber)||"No phone"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsxs("td",{className:"border p-2 text-center",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${vt(s.status)}`,children:s.status==="deletedByAdmin"?"Deleted by Admin":s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)}),s.status==="deletedByAdmin"&&s.adminComment&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:['"',s.adminComment,'"']})]}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:B?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>Te(s._id),title:"Unarchive Appointment",children:[e.jsx(ue,{})," Unarchive"]}):e.jsxs(e.Fragment,{children:[s.status==="cancelledByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>he(s._id),title:"Reinitiate Appointment (Admin)",children:[e.jsx(je,{})," Reinitiate"]}):s.status!=="deletedByAdmin"?e.jsxs("button",{className:"bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>M(s._id),title:"Cancel Appointment (Admin)",children:[e.jsx(je,{})," Cancel"]}):null,e.jsxs("button",{className:"bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2",onClick:()=>W(s._id),title:"Archive Appointment",children:[e.jsx(Ee,{})," Archive"]})]})})}),e.jsxs("td",{className:"border p-2 text-center relative",children:[e.jsxs("button",{className:"flex items-center justify-center bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 mx-auto relative group",title:"Open Chat",onClick:wt,children:[e.jsx(De,{size:22,className:"group-hover:animate-pulse"}),e.jsx("div",{className:"absolute inset-0 bg-white rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-200"})]}),Ge&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-xs relative flex flex-col items-center",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>Se(!1),title:"Close",children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-blue-700 flex items-center gap-2",children:[e.jsx(je,{})," Admin Password Required"]}),e.jsxs("form",{onSubmit:Nt,className:"w-full flex flex-col gap-3",children:[e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-blue-200",placeholder:"Enter your password",value:Oe,onChange:t=>Ue(t.target.value),required:!0,autoFocus:!0}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full font-semibold",disabled:be,children:be?"Verifying...":"Unlock Chat"})]})]})}),N&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-3xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-600 rounded-t-3xl relative",children:[e.jsx("div",{className:"bg-white rounded-full p-1.5 shadow-lg",children:e.jsx(De,{className:"text-blue-600 text-lg"})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:"Live Chat"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[e.jsx("button",{className:"text-red-100 hover:text-white bg-red-500/30 hover:bg-red-500/50 rounded-full p-2 transition-colors shadow flex items-center gap-2",onClick:()=>H(!0),title:"Delete entire chat","aria-label":"Delete chat",children:e.jsx(me,{className:"text-sm"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>h(!c),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx($t,{className:"text-sm"})}),c&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>Ce(!1),title:"Close","aria-label":"Close",children:e.jsx(xe,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{ref:G,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[le&&b.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${a?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:le})})}),b.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(De,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start a conversation to communicate with the parties"})]}):b.map((t,l)=>{var _,pe,it,ot,dt;const r=t.senderEmail===u.email,m=S===t._id,d=new Date(t.timestamp),g=l>0?new Date(b[l-1].timestamp):null,j=g?d.toDateString()!==g.toDateString():!0;return e.jsxs(p.Fragment,{children:[j&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Je(d)})}),e.jsx("div",{className:`flex w-full ${r?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*l}s`},children:e.jsxs("div",{ref:A=>U.current[t._id]=A,className:`rounded-2xl px-4 sm:px-5 py-3 text-sm shadow-xl max-w-[90%] sm:max-w-[80%] md:max-w-[70%] break-all overflow-hidden relative transform hover:scale-[1.02] transition-transform duration-200 min-h-[60px] ${r?"bg-gradient-to-r from-blue-600 to-purple-700 text-white shadow-blue-200":"bg-white text-gray-800 border border-gray-200 shadow-gray-200 hover:shadow-gray-300"}`,children:[t.replyTo&&e.jsx("div",{className:"border-l-4 border-purple-400 pl-3 mb-2 text-xs bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg w-full max-w-full break-words cursor-pointer transform hover:scale-[1.02] transition-transform duration-200",onClick:()=>{U.current[t.replyTo]&&(U.current[t.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),U.current[t.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{U.current[t.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsxs("span",{className:"text-xs text-gray-700 font-medium truncate max-w-[150px] flex items-center gap-1",children:[e.jsx("span",{className:"text-purple-500",children:"↩"}),((pe=(_=b.find(A=>A._id===t.replyTo))==null?void 0:_.message)==null?void 0:pe.substring(0,30))||"Original message",((ot=(it=b.find(A=>A._id===t.replyTo))==null?void 0:it.message)==null?void 0:ot.length)>30?"...":""]})}),e.jsxs("div",{className:"font-semibold mb-2 flex items-center gap-2 justify-start text-left",children:[e.jsx("span",{className:`truncate max-w-[120px] min-w-[60px] inline-block align-middle overflow-hidden text-ellipsis text-left ${r?"text-blue-100":"text-gray-700"}`,children:r?"You":(()=>{var ct,mt,ut,xt;const A=t.senderEmail===((ct=s.buyerId)==null?void 0:ct.email),_t=t.senderEmail===((mt=s.sellerId)==null?void 0:mt.email);return A?((ut=s.buyerId)==null?void 0:ut.username)||t.senderName||t.senderEmail:_t?((xt=s.sellerId)==null?void 0:xt.username)||t.senderName||t.senderEmail:t.senderName||t.senderEmail})()}),e.jsx("span",{className:`text-[10px] px-2 py-1 rounded-full flex-shrink-0 ${r?"text-blue-200 bg-blue-600 bg-opacity-30":"text-gray-500 bg-gray-100"}`,children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsx("div",{className:`text-left ${r?"text-base font-medium":"text-sm"}`,children:t.deleted?(()=>{const A=i.includes(t._id);return u&&(u.role==="admin"||u.role==="rootadmin")?A?e.jsx("div",{className:"border border-gray-300 bg-gray-100 rounded p-2 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 text-xs",children:[e.jsx(ye,{className:"inline-block"}),e.jsx("span",{children:"Deleted message hidden from view"})]}),e.jsx("button",{className:"text-xs text-blue-500 hover:text-blue-700 underline",onClick:()=>It(t._id),title:"Show this deleted message content",children:"Show"})]})}):e.jsxs("div",{className:"border border-red-300 bg-red-50 rounded p-2 mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-xs font-semibold mb-1",children:[e.jsx(ye,{className:"inline-block"}),"Message deleted by ",t.deletedBy||"user"," (Admin view - preserved for records)"]}),e.jsx("div",{className:"text-gray-800 bg-white p-2 rounded border-l-4 border-red-400",children:t.originalMessage?e.jsx("span",{className:"whitespace-pre-wrap",children:t.originalMessage}):t.message?e.jsx("span",{className:"whitespace-pre-wrap",children:t.message}):e.jsx("span",{className:"text-gray-500 italic",children:"[Message content not preserved - this message was deleted before content preservation was implemented]"})}),!1,e.jsx("button",{className:"mt-2 text-xs text-red-500 hover:text-red-700 underline",onClick:()=>At(t._id),title:"Hide this deleted message from your admin view",children:"Hide from admin view"})]}):e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(ye,{className:"inline-block text-lg"})," This message has been deleted."]})})():e.jsx("div",{children:m?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"✏️ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"whitespace-pre-wrap",children:t.message}),t.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-2 justify-end mt-2","data-message-actions":!0,children:[!t.deleted&&e.jsx("button",{className:`${t.senderEmail===u.email?"text-blue-200 hover:text-white":"text-gray-500 hover:text-gray-700"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20`,onClick:A=>{A.stopPropagation(),y(f===t._id?null:t._id)},title:"Message options",children:e.jsx(Pt,{size:t.senderEmail===u.email?16:14})}),f===t._id&&e.jsxs(e.Fragment,{children:[!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`${t.senderEmail===u.email?"text-yellow-300 hover:text-yellow-100":"text-blue-600 hover:text-blue-800"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20`,onClick:()=>{var A;Ne(t),(A=K.current)==null||A.focus(),y(null)},title:"Reply",children:e.jsx("svg",{width:t.senderEmail===u.email?"20":"18",height:t.senderEmail===u.email?"20":"18",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),e.jsx("button",{className:`${t.senderEmail===u.email?"text-blue-300 hover:text-blue-100":"text-gray-600 hover:text-gray-800"} transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20`,onClick:()=>{console.log("Button clicked! Message:",t.message),Me(t.message),y(null)},title:"Copy message",children:e.jsx(zt,{size:t.senderEmail===u.email?16:14})})]}),t.senderEmail===u.email&&!t.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>{jt(t),y(null)},className:"text-green-300 hover:text-green-100 transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20",title:"Edit comment",disabled:S!==null,children:e.jsx(Ot,{size:16})}),e.jsx("button",{className:"text-red-300 hover:text-red-100 transition-all duration-200 hover:scale-110 p-1 rounded-full hover:bg-white hover:bg-opacity-20",onClick:()=>{Ct(t),y(null)},title:"Delete comment",children:e.jsx(me,{size:16})})]})]}),t.senderEmail===u.email&&!t.deleted&&e.jsx("span",{className:"ml-2 flex items-center gap-1",children:(dt=t.readBy)!=null&&dt.some(A=>A!==u._id)?e.jsx(ht,{className:"text-green-600 text-sm",title:"Read"}):t.status==="delivered"?e.jsx(ht,{className:"text-blue-200 text-sm",title:"Delivered"}):t.status==="sending"?e.jsx(gt,{className:"text-blue-200 text-sm animate-pulse",title:"Sending..."}):e.jsx(gt,{className:"text-blue-200 text-sm",title:"Sent"})})]})]})})]},t._id||l)}),e.jsx("div",{ref:E})]}),de&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsxs("span",{className:"text-xs text-gray-600 truncate max-w-[200px]",children:[(lt=de.message)==null?void 0:lt.substring(0,40),((nt=de.message)==null?void 0:nt.length)>40?"...":""]}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors",onClick:()=>Ne(null),title:"Cancel reply",children:e.jsx(xe,{className:"w-3 h-3"})})]})}),S&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"✏️ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:$}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700 bg-yellow-100 hover:bg-yellow-200 rounded-full p-1 transition-colors",onClick:()=>{O(null),P(""),D("")},title:"Cancel edit",children:e.jsx(xe,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"flex gap-2 mt-1 px-3 pb-2",children:[e.jsx("textarea",{rows:1,className:"flex-1 px-4 py-3 border-2 border-gray-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-300 focus:border-blue-400 shadow-lg transition-all duration-200 bg-white resize-y whitespace-pre-wrap",placeholder:S?"Edit your message...":"Type a message...",value:se,onChange:t=>{D(t.target.value),S&&P(t.target.value)},onKeyDown:t=>{t.key==="Enter"&&(t.ctrlKey||t.metaKey)&&(t.preventDefault(),S?Qe(S):We())},ref:K}),e.jsx("button",{onClick:S?()=>Qe(S):We,disabled:(S?Pe===S:ge)||!se.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-full text-sm font-semibold shadow-lg hover:from-blue-600 hover:to-purple-700 hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:transform-none flex items-center gap-2 min-w-24",children:S?Pe===S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":ge?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                @keyframes fadeInChatBubble {
                  from { opacity: 0; transform: translateY(10px) scale(0.98); }
                  to { opacity: 1; transform: translateY(0) scale(1); }
                }
                .animate-fadeInChatBubble {
                  animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                }
                @keyframes fadeInChat {
                  from { opacity: 0; }
                  to { opacity: 1; }
                }
                .animate-fadeInChat {
                  animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                }
              `}),!Z&&!S&&!de&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:yt,className:"bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-full p-3 shadow-xl transition-all duration-200 hover:scale-110 relative transform hover:shadow-2xl",title:T>0?`${T} new message${T>1?"s":""}`:"Scroll to bottom","aria-label":T>0?`${T} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),T>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:T>99?"99+":T})]})}),ne&&e.jsx("div",{className:"absolute inset-0 bg-black/30 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl p-6 w-full max-w-sm relative shadow-2xl",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors",onClick:()=>{H(!1),V("")},title:"Close","aria-label":"Close",children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsxs("h3",{className:"text-lg font-bold mb-4 text-red-600 flex items-center gap-2",children:[e.jsx(me,{})," Delete Entire Chat"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"This will permanently delete all messages for this appointment. Enter admin password to confirm."}),e.jsx("input",{type:"password",className:"border rounded px-3 py-2 w-full focus:ring-2 focus:ring-red-200 mb-4",placeholder:"Admin password",value:q,onChange:t=>V(t.target.value),autoFocus:!0}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{H(!1),V("")},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsx("button",{type:"button",disabled:ee||!q,onClick:async()=>{try{Ye(!0);const t=await fetch(`${I}/api/bookings/${s._id}/comments`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:q})}),l=await t.json();t.ok?(v([]),x.success("Chat deleted successfully."),H(!1),V("")):x.error(l.message||"Failed to delete chat")}catch{x.error("An error occurred. Please try again.")}finally{Ye(!1)}},className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2 disabled:opacity-60",children:ee?"Deleting...":e.jsxs(e.Fragment,{children:[e.jsx(me,{size:12})," Delete Chat"]})})]})]})})]})}),Ke&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(me,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Delete Message"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to delete this message for everyone?"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ke(!1),ce(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:St,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(me,{size:14}),"Delete"]})]})]})})}),L&&R===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ye,{className:"text-red-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Cancel Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify mb-4",children:"Are you sure you want to cancel this appointment?"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Reason for cancellation (required):"}),e.jsx("textarea",{value:Q,onChange:t=>we(t.target.value),className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500",rows:"3",placeholder:"Please provide a reason for cancelling this appointment..."})]})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Le(!1),oe(null),we("")},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:X,className:"px-4 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(ye,{size:14}),"Cancel Appointment"]})]})]})})}),w&&R===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ue,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Reinitiate Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to reinitiate this appointment? This will notify both buyer and seller."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{Be(!1),oe(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:$e,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ue,{size:14}),"Reinitiate"]})]})]})})}),Fe&&R===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(Ee,{className:"text-blue-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Archive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to archive this appointment? It will be moved to the archived section."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ie(!1),oe(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:C,className:"px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors flex items-center gap-2",children:[e.jsx(Ee,{size:14}),"Archive"]})]})]})})}),Re&&R===s._id&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 animate-fadeIn",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(ue,{className:"text-green-600 text-xl"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Unarchive Appointment"}),e.jsx("p",{className:"text-sm text-gray-600 leading-relaxed text-justify",children:"Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{ve(!1),oe(null)},className:"px-4 py-2 rounded-lg border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:F,className:"px-4 py-2 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors flex items-center gap-2",children:[e.jsx(ue,{size:14}),"Unarchive"]})]})]})})})]})]})}export{Ht as default};
