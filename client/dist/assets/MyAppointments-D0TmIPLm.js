import{g as it,r as a,u as lt,t as y,j as e,_ as ot,$ as dt,a0 as ct,a1 as mt,H as Ke,v as ut,a2 as Ge,f as ht,a3 as xt,a4 as ft,y as h,h as gt,L as bt,z as q,I as qe,a5 as ke,a6 as yt,Y as pt,G as jt,D as vt,a9 as Ve}from"./index-Bz8Z3JxA.js";const k="https://urbansetu.onrender.com";function Nt(){const{currentUser:t}=it(n=>n.user),[b,A]=a.useState([]),[Re,Y]=a.useState(!0),[be,Z]=a.useState(null),[U,$e]=a.useState(""),[K,ye]=a.useState("all"),[L,ue]=a.useState("all"),[G,H]=a.useState(""),[N,v]=a.useState(!1),[C,he]=a.useState(null),[w,ee]=a.useState(""),[B,Q]=a.useState(""),[pe,ae]=a.useState(!1),[T,j]=a.useState(null),[te,E]=a.useState([]),[R,ie]=a.useState(!1),W=lt(),[M,xe]=a.useState(null);a.useEffect(()=>{const n=async()=>{if(!t){Z("Please sign in to view your appointments"),Y(!1);return}try{Y(!0),Z(null);const l=await fetch(`${k}/api/bookings/my`,{credentials:"include"});if(l.ok){const m=await l.json();A(m)}else throw new Error("Failed to fetch appointments")}catch{Z("Failed to load appointments. Please try again.")}finally{Y(!1)}},o=async()=>{try{const l=await fetch(`${k}/api/bookings/archived`,{credentials:"include"});if(!l.ok)throw new Error("Not allowed");const m=await l.json();E(Array.isArray(m)?m:[])}catch{E([]),t&&(t.role==="admin"||t.role==="rootadmin")&&h.error("Failed to fetch archived appointments")}};n(),o()},[t]),a.useEffect(()=>{const n=o=>{A(l=>l.filter(m=>m._id!==o.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[t]),a.useEffect(()=>{t&&A(n=>n.map(o=>{const l={...o};return o.buyerId&&(o.buyerId._id===t._id||o.buyerId===t._id)&&(l.buyerId={...l.buyerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),o.sellerId&&(o.sellerId._id===t._id||o.sellerId===t._id)&&(l.sellerId={...l.sellerId,username:t.username,email:t.email,mobileNumber:t.mobileNumber,avatar:t.avatar}),l}))},[t]),a.useEffect(()=>{function n(o){A(l=>l.map(m=>m._id===o.appointmentId?{...m,...o.updatedAppointment}:m))}return y.on("appointmentUpdate",n),()=>{y.off("appointmentUpdate",n)}},[]),a.useEffect(()=>{function n(l){const m=l.appointment;m.buyerId&&t&&(m.buyerId._id===t._id||m.buyerId===t._id)?m.role="buyer":m.sellerId&&t&&(m.sellerId._id===t._id||m.sellerId===t._id)&&(m.role="seller"),A(f=>[m,...f])}y.on("appointmentCreated",n);const o=l=>{A(m=>m.map(f=>{const g={...f};return f.buyerId&&(f.buyerId._id===l.userId||f.buyerId===l.userId)&&(g.buyerId={...g.buyerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),f.sellerId&&(f.sellerId._id===l.userId||f.sellerId===l.userId)&&(g.sellerId={...g.sellerId,username:l.username,email:l.email,mobileNumber:l.mobileNumber,avatar:l.avatar}),g}))};return y.on("profileUpdated",o),()=>{y.off("appointmentCreated",n),y.off("profileUpdated",o)}},[t]),a.useEffect(()=>{if(!t)return;const n=setInterval(()=>{y.emit("userAppointmentsActive",{userId:t._id})},5e3);return()=>clearInterval(n)},[t]);const se=async(n,o)=>{H(n+o);try{const l=await fetch(`${k}/api/bookings/${n}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:o})}),m=await l.json();if(l.status===401){h.error("Session expired or unauthorized. Please sign in again."),W("/sign-in");return}if(l.ok){A(g=>g.map(_=>_._id===n?{..._,status:o}:_));const f=o==="accepted"?"accepted":"rejected";h.success(`Appointment ${f} successfully! ${o==="accepted"?"Contact information is now visible to both parties.":""}`),W("/user/my-appointments")}else h.error(m.message||"Failed to update appointment status.")}catch{h.error("An error occurred. Please try again.")}H("")},je=async n=>{const o=prompt("Please provide a reason for deleting this appointment:");if(o&&window.confirm("Are you sure you want to delete this appointment?"))try{const l=await fetch(`${k}/api/bookings/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:o})}),m=await l.json();if(l.status===401){h.error("Session expired or unauthorized. Please sign in again."),W("/sign-in");return}l.ok?(A(f=>f.map(g=>g._id===n?{...g,status:"deletedByAdmin",adminComment:o}:g)),h.success("Appointment deleted successfully. Both buyer and seller have been notified."),W("/user/my-appointments")):h.error(m.message||"Failed to delete appointment.")}catch{h.error("An error occurred. Please try again.")}},ve=async n=>{if(window.confirm("Are you sure you want to archive this appointment? It will be moved to the archived section."))try{const o=await fetch(`${k}/api/bookings/${n}/archive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),l=await o.json();if(o.ok){const m=b.find(f=>f._id===n);m&&(A(f=>f.filter(g=>g._id!==n)),E(f=>[{...m,archivedAt:new Date},...f])),h.success("Appointment archived successfully.")}else h.error(l.message||"Failed to archive appointment.")}catch{h.error("An error occurred. Please try again.")}},fe=async n=>{if(window.confirm("Are you sure you want to unarchive this appointment? It will be moved back to the active appointments."))try{const o=await fetch(`${k}/api/bookings/${n}/unarchive`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"}),l=await o.json();if(o.ok){const m=te.find(f=>f._id===n);m&&(E(f=>f.filter(g=>g._id!==n)),A(f=>[{...m,archivedAt:void 0},...f])),h.success("Appointment unarchived successfully.")}else h.error(l.message||"Failed to unarchive appointment.")}catch{h.error("An error occurred. Please try again.")}},we=b.filter(n=>{var _,P,z,$,le,ne,re,J,oe,de;if(t._id===((P=(_=n.buyerId)==null?void 0:_._id)==null?void 0:P.toString())&&n.visibleToBuyer===!1||t._id===(($=(z=n.sellerId)==null?void 0:z._id)==null?void 0:$.toString())&&n.visibleToSeller===!1)return!1;const o=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(K==="outdated")return o;const l=K==="all"?!0:n.status===K,m=L==="all"?!0:n.role===L,f=((le=n.propertyName)==null?void 0:le.toLowerCase().includes(U.toLowerCase()))||((ne=n.message)==null?void 0:ne.toLowerCase().includes(U.toLowerCase()))||((J=(re=n.buyerId)==null?void 0:re.username)==null?void 0:J.toLowerCase().includes(U.toLowerCase()))||((de=(oe=n.sellerId)==null?void 0:oe.username)==null?void 0:de.toLowerCase().includes(U.toLowerCase()));let g=!0;return w&&(g=g&&new Date(n.date)>=new Date(w)),B&&(g=g&&new Date(n.date)<=new Date(B)),l&&m&&f&&g}),Ne=Array.isArray(te)?te.filter(n=>{var f,g,_,P,z,$;const o=new Date(n.date)<new Date||new Date(n.date).toDateString()===new Date().toDateString()&&n.time&&n.time<new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(K==="outdated")return o;K==="all"||n.status;const l=((f=n.propertyName)==null?void 0:f.toLowerCase().includes(U.toLowerCase()))||((g=n.message)==null?void 0:g.toLowerCase().includes(U.toLowerCase()))||((P=(_=n.buyerId)==null?void 0:_.username)==null?void 0:P.toLowerCase().includes(U.toLowerCase()))||(($=(z=n.sellerId)==null?void 0:z.username)==null?void 0:$.toLowerCase().includes(U.toLowerCase()));let m=!0;return w&&(m=m&&new Date(n.date)>=new Date(w)),B&&(m=m&&new Date(n.date)<=new Date(B)),l&&m}):[];function Ce(n){j({...n,date:n.date?new Date(n.date).toISOString().split("T")[0]:"",time:n.time||"",message:n.message||"",buyerReinitiationCount:n.buyerReinitiationCount||0,sellerReinitiationCount:n.sellerReinitiationCount||0}),ae(!0)}async function Ie(n){var f,g;if(n.preventDefault(),!T)return;const o=t&&(((f=T.buyerId)==null?void 0:f._id)===t._id||T.buyerId===t._id);if(t&&(((g=T.sellerId)==null?void 0:g._id)===t._id||(T.sellerId,t._id)),(o?T.buyerReinitiationCount||0:T.sellerReinitiationCount||0)>=2){h.error("You have reached the maximum number of reinitiations for your role.");return}if(!T.buyerId||!T.sellerId){h.error("Cannot reinitiate: one of the parties no longer exists.");return}const m={...T,status:"pending"};try{const _=await fetch(`${k}/api/bookings/reinitiate`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(m)}),P=await _.json();_.ok?(h.success("Appointment reinitiated successfully!"),ae(!1),j(null),W("/user/my-appointments"),A(z=>z.map($=>$._id===P.appointment._id?{...$,...P.appointment}:$))):h.error(P.message||"Failed to reinitiate appointment.")}catch{h.error("An error occurred. Please try again.")}}const X=(n,o)=>{A(l=>l.map(m=>m._id===n?{...m,status:o}:m))},Se=async()=>{Y(!0),Z(null);try{const n=await fetch(`${k}/api/bookings/my`,{credentials:"include"});if(n.ok){const l=await n.json();A(l)}else throw new Error("Failed to fetch appointments");const o=await fetch(`${k}/api/bookings/archived`,{credentials:"include"});if(o.ok){const l=await o.json();E(Array.isArray(l)?l:[])}}catch{Z("Failed to refresh appointments. Please try again.")}finally{Y(!1)}};return Re?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading your appointments..."})]})}):be?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:be})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsx(ot,{position:"top-center",autoClose:2e3,closeOnClick:!0,containerClassName:"!z-[100]",toastOptions:{style:{fontSize:"0.9rem",borderRadius:"8px",boxShadow:"0 2px 8px #0001"}}}),e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 drop-shadow",children:R?"Archived Appointments":"My Appointments"}),!R&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"ðŸ’¡ Outdated appointments (past their scheduled date) are automatically ignored when booking new appointments."})]}),e.jsx("button",{onClick:Se,className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all font-semibold shadow-md ml-4",title:"Refresh appointments",children:"Refresh"}),t&&(t.role==="admin"||t.role==="rootadmin")&&e.jsx("button",{onClick:()=>ie(!R),className:`bg-gradient-to-r text-white px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg font-semibold flex items-center gap-2 ${R?"from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600":"from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700"}`,children:R?e.jsxs(e.Fragment,{children:[e.jsx(dt,{})," Active Appointments"]}):e.jsxs(e.Fragment,{children:[e.jsx(ct,{})," Archived Appointments (",te.length,")"]})})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:K,onChange:n=>ye(n.target.value),children:[e.jsx("option",{value:"all",children:"All Appointments"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"noShow",children:"No Show"}),e.jsx("option",{value:"outdated",children:"Outdated"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:w,onChange:n=>ee(n.target.value),max:B||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:B,onChange:n=>Q(n.target.value),min:w||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:L,onChange:n=>ue(n.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mt,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:U,onChange:n=>$e(n.target.value)})]})]}),R&&t&&(t.role==="admin"||t.role==="rootadmin")?Ne.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No archived appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-100 to-gray-200",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:Ne.map(n=>e.jsx(Ye,{appt:n,currentUser:t,handleStatusUpdate:se,handleAdminDelete:je,actionLoading:G,onShowOtherParty:o=>{he(o),v(!0)},onOpenReinitiate:()=>Ce(n),handleArchiveAppointment:ve,handleUnarchiveAppointment:fe,isArchived:!0,onCancelRefresh:X},n._id))})]})}):we.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:"No appointments found."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Connect"})]})}),e.jsx("tbody",{children:we.map(n=>e.jsx(Ye,{appt:n,currentUser:t,handleStatusUpdate:se,handleAdminDelete:je,actionLoading:G,onShowOtherParty:o=>{he(o),v(!0)},onOpenReinitiate:()=>Ce(n),handleArchiveAppointment:ve,handleUnarchiveAppointment:fe,isArchived:!1,onCancelRefresh:X},n._id))})]})}),N&&C&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-2 sm:p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-2 sm:mx-4 max-h-[90vh] overflow-y-auto relative animate-fadeIn",children:[e.jsx("button",{className:"absolute top-3 right-3 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>v(!1),title:"Close","aria-label":"Close",children:e.jsx(Ke,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex flex-col items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100 rounded-t-2xl px-6 py-6 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[C.avatar&&C.avatar.trim()&&C.avatar!=="null"&&C.avatar!=="undefined"?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:C.avatar,alt:C.username,className:"w-16 h-16 rounded-full object-cover border-4 border-white shadow-lg",onError:n=>{n.target.style.display="none",n.target.nextElementSibling.style.display="flex"}}),e.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",style:{display:"none"},children:e.jsx("span",{className:"text-white font-bold text-lg",children:C.username?C.username.split(" ").map(n=>n.charAt(0).toUpperCase()).join("").slice(0,2):"U"})})]}):e.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-lg",children:C.username?C.username.split(" ").map(n=>n.charAt(0).toUpperCase()).join("").slice(0,2):"U"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center",children:e.jsx(ut,{className:"w-3 h-3 text-white"})})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-xl font-bold text-blue-800 flex items-center gap-2",children:[C.username||"User",C.role==="admin"&&e.jsx(Ge,{className:"text-purple-600 text-base",title:"Admin user"})]}),e.jsx("p",{className:"text-sm text-gray-600 capitalize font-medium bg-white px-3 py-1 rounded-full shadow-sm",children:C.role||"User"})]})]})}),e.jsxs("div",{className:"px-6 py-6 space-y-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx(ht,{className:"text-blue-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Email"}),e.jsx("p",{className:"text-gray-800 font-medium",children:C.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-green-500",children:[e.jsx(xt,{className:"text-green-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Phone"}),e.jsx("p",{className:"text-gray-800 font-medium",children:C.mobileNumber||"Not provided"})]})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border-l-4 border-purple-500",children:[e.jsx(ft,{className:"text-purple-500 w-5 h-5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:"Member Since"}),e.jsx("p",{className:"text-gray-800 font-medium",children:C.createdAt?new Date(C.createdAt).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"Not available"})]})]})]}),e.jsx("button",{onClick:()=>v(!1),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-3 rounded-lg hover:from-blue-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg font-semibold",children:"Close"})]})]})}),pe&&T&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:Ie,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:T.date,onChange:n=>j(o=>({...o,date:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:T.time,onChange:n=>j(o=>({...o,time:n.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:T.message,onChange:n=>j(o=>({...o,message:n.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>ae(!1),children:"Cancel"})]})]})})]})]})}function Ee(t){const b=new Date,A=new Date;return A.setDate(b.getDate()-1),t.toDateString()===b.toDateString()?"Today":t.toDateString()===A.toDateString()?"Yesterday":t.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}function Ye({appt:t,currentUser:b,handleStatusUpdate:A,handleAdminDelete:Re,actionLoading:Y,onShowOtherParty:be,onOpenReinitiate:Z,handleArchiveAppointment:U,handleUnarchiveAppointment:$e,isArchived:K,onCancelRefresh:ye}){const[L,ue]=a.useState(null),[G,H]=a.useState(""),[N,v]=a.useState(t.comments||[]),[C,he]=a.useState(!1),[w,ee]=a.useState(null),[B,Q]=a.useState(""),[pe,ae]=a.useState(null),T=gt(),[j,te]=a.useState(!1),E=a.useRef(null),R=a.useRef(null),[ie,W]=a.useState(!0),[M,xe]=a.useState(0),[se,je]=a.useState(""),[ve,fe]=a.useState(!1),[we,Ne]=a.useState(!1),[Ce,Ie]=a.useState(!1),[X,Se]=a.useState(!1),[n,o]=a.useState(!1),[l,m]=a.useState(!1),f=a.useRef(null),g=a.useRef(null),_=a.useRef(null),[P,z]=a.useState(!1),[$,le]=a.useState(null),[ne,re]=a.useState(!0),J=a.useRef({});a.useEffect(()=>{if(n){const s=setTimeout(()=>{o(!1)},1e4);return()=>clearTimeout(s)}},[n]);function oe(s){try{return JSON.parse(localStorage.getItem(`removedDeletedMsgs_${s}`))||[]}catch{return[]}}function de(s,r){const i=oe(s);if(!i.includes(r)){const c=[...i,r];localStorage.setItem(`removedDeletedMsgs_${s}`,JSON.stringify(c))}}const De=(b.role==="admin"||b.role==="rootadmin")&&b.adminApprovalStatus==="approved",Qe=T.pathname.includes("/admin"),F=t.role==="seller",ce=t.role==="buyer",O=new Date(t.date)>new Date||new Date(t.date).toDateString()===new Date().toDateString()&&(!t.time||t.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),Oe=(De||t.status==="accepted")&&O,u=F?t.buyerId:t.sellerId,We=s=>{le(s),re(!0),z(!0)},Xe=async()=>{if($){try{if(ne){const s=await fetch(`${k}/api/bookings/${t._id}/comment/${$._id}`,{method:"DELETE",credentials:"include"}),r=await s.json();s.ok?(v(i=>r.comments.map(c=>{const d=i.find(x=>x._id===c._id);return d&&d.status==="read"&&c.status!=="read"?{...c,status:"read"}:c})),h.success("Message deleted for both users!")):h.error(r.message||"Failed to delete comment.")}else v(s=>s.filter(r=>r._id!==$._id)),de(t._id,$._id),h.success("Message hidden from your view!")}catch{h.error("An error occurred. Please try again.")}z(!1),le(null),re(!0)}},Fe=async()=>{if(!G.trim())return;he(!0);const s=`temp-${Date.now()}`,r={_id:s,senderEmail:b.email,message:G,status:"sending",timestamp:new Date().toISOString(),readBy:[b._id],...L?{replyTo:L._id}:{}};v(i=>[...i,r]),H(""),ue(null);try{const i=await fetch(`${k}/api/bookings/${t._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:G,...L?{replyTo:L._id}:{}})}),c=await i.json();i.ok?(v(d=>[...d.filter(x=>x._id!==s),...c.comments.filter(x=>!d.some(p=>p._id===x._id))]),h.success("Message sent successfully!")):(v(d=>d.filter(x=>x._id!==s)),h.error(c.message||"Failed to send comment."))}catch{v(c=>c.filter(d=>d._id!==s)),h.error("An error occurred. Please try again.")}he(!1)},Le=async s=>{if(!B.trim())return;ae(s),v(i=>i.map(c=>c._id===s?{...c,message:B,edited:!0,editedAt:new Date}:c)),ee(null),Q(""),H("");try{const i=await fetch(`${k}/api/bookings/${t._id}/comment/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:B})}),c=await i.json();i.ok?(v(d=>d.map(x=>{const p=c.comments.find(S=>S._id===x._id);return p?p._id===s?p:x.status==="read"&&p.status!=="read"?{...p,status:"read"}:p:x})),h.success("Message edited successfully!")):(v(d=>d.map(x=>x._id===s?{...x,message:x.originalMessage||x.message,edited:x.wasEdited||!1}:x)),ee(s),Q(B),H(B),h.error(c.message||"Failed to edit comment."))}catch{v(c=>c.map(d=>d._id===s?{...d,message:d.originalMessage||d.message,edited:d.wasEdited||!1}:d)),ee(s),Q(B),H(B),h.error("An error occurred. Please try again.")}finally{ae(null)}},Ze=s=>{ee(s._id),Q(s.message),H(s.message),v(r=>r.map(i=>i._id===s._id?{...i,originalMessage:i.message,wasEdited:i.edited}:i)),setTimeout(()=>{_.current&&(_.current.focus(),_.current.select())},100)},et=s=>{switch(s){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},Me=async()=>{let s="";if(F){if(s=prompt("Please provide a reason for cancelling this appointment (required):"),!s)return h.error("Reason is required for seller cancellation.")}else s=prompt("Please provide a reason for cancelling this appointment (optional):")||"";if(window.confirm("Are you sure you want to cancel this appointment?"))try{const r=await fetch(`${k}/api/bookings/${t._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:s})}),i=await r.json();if(r.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}r.ok?(h.success("Appointment cancelled successfully."),typeof ye=="function"&&ye(t._id,F?"cancelledBySeller":"cancelledByBuyer")):h.error(i.message||"Failed to cancel appointment.")}catch{h.error("An error occurred. Please try again.")}},tt=async()=>{const s=prompt("Please provide a reason for admin cancellation (required):");if(!s)return h.error("Reason is required for admin cancellation.");if(window.confirm("Are you sure you want to cancel this appointment as admin?"))try{const r=await fetch(`${k}/api/bookings/${t._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:s})}),i=await r.json();if(r.status===401){h.error("Session expired or unauthorized. Please sign in again."),navigate("/sign-in");return}r.ok?(h.success("Appointment cancelled by admin."),navigate("/user/my-appointments")):h.error(i.message||"Failed to cancel appointment.")}catch{h.error("An error occurred. Please try again.")}},Te=async()=>{if(window.confirm("Are you sure you want to permanently remove this appointment from your table? This cannot be undone."))try{const s=ce?"buyer":F?"seller":null;if(!s)return;if((await fetch(`${k}/api/bookings/${t._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:s})})).ok){if(typeof window<"u"){const i=new CustomEvent("removeAppointmentRow",{detail:t._id});window.dispatchEvent(i),h.success("Appointment removed from your table sucessfully")}}else h.error("Failed to remove appointment from table.")}catch{h.error("An error occurred. Please try again.")}};a.useEffect(()=>{j&&E.current&&E.current.scrollIntoView({behavior:"smooth"})},[j]);const me=a.useCallback(async()=>{if(!R.current)return;const{scrollTop:s,scrollHeight:r,clientHeight:i}=R.current;if(!(r-s-i<10))return;const d=N.filter(x=>{var p;return!((p=x.readBy)!=null&&p.includes(b._id))&&x.senderEmail!==b.email});if(d.length>0)try{(await fetch(`${k}/api/bookings/${t._id}/comments/read`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include"})).ok&&(v(p=>p.map(S=>d.some(D=>D._id===S._id)?{...S,readBy:[...S.readBy||[],b._id],status:"read"}:S)),d.forEach(p=>{y.emit("messageRead",{appointmentId:t._id,messageId:p._id,userId:b._id,readBy:b._id})}),console.log(`Marked ${d.length} messages as read for user ${b._id}`))}catch(x){console.error("Error marking messages as read:",x)}},[N,b._id,t._id,y]),Pe=a.useRef(N.length),st=a.useRef(N);a.useEffect(()=>{const s=N.slice(Pe.current),r=s.length;if(Pe.current=N.length,st.current=N,r>0&&j){const i=s.some(d=>d.senderEmail===b.email),c=s.filter(d=>d.senderEmail!==b.email);i||ie?setTimeout(()=>{E.current&&(E.current.scrollIntoView({behavior:"smooth"}),ie&&c.length>0&&setTimeout(()=>{me()},300))},100):c.length>0&&xe(d=>d+c.length)}},[N.length,ie,j,b.email,me]);const ze=a.useCallback(()=>{if(R.current){const{scrollTop:s,scrollHeight:r,clientHeight:i}=R.current,c=r-s-i<10;if(W(c),c){const d=N.filter(x=>{var p;return!((p=x.readBy)!=null&&p.includes(b._id))&&x.senderEmail!==b.email}).length;d>0&&(console.log(`User manually scrolled to bottom, marking ${d} messages as read`),me()),M>0&&xe(0)}}},[M,me,N,b._id]),Be=a.useCallback(()=>{if(!R.current||N.length===0)return;const s=`chatClearTime_${t._id}`,r=Number(localStorage.getItem(s))||0,i=oe(t._id),c=N.filter(D=>new Date(D.timestamp).getTime()>r&&!i.includes(D._id));if(c.length===0)return;const x=R.current.getBoundingClientRect(),p=x.top+60;let S="";for(let D=0;D<c.length;D++){const I=J.current[c[D]._id];if(I){const V=I.getBoundingClientRect();if(V.top>=p&&V.bottom<=x.bottom){const Ae=new Date(c[D].timestamp);S=Ee(Ae);break}}}if(!S)for(let D=0;D<c.length;D++){const I=J.current[c[D]._id];if(I&&I.getBoundingClientRect().bottom>p){const Ae=new Date(c[D].timestamp);S=Ee(Ae);break}}S&&S!==se&&je(S)},[N,se,t._id]);a.useEffect(()=>{const s=R.current;if(s&&j){const r=()=>{ze(),Be(),fe(!0),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{fe(!1)},1e3)};if(s.addEventListener("scroll",r),s){const{scrollTop:i,scrollHeight:c,clientHeight:d}=s,x=c-i-d<10;W(x)}return setTimeout(Be,100),()=>{s.removeEventListener("scroll",r),g.current&&clearTimeout(g.current)}}},[j,ze,Be]),a.useEffect(()=>{j&&E.current&&E.current.scrollIntoView({behavior:"smooth"})},[j]);const nt=a.useCallback(()=>{E.current&&(E.current.scrollIntoView({behavior:"smooth"}),xe(0),setTimeout(()=>{me()},500))},[me]);a.useEffect(()=>{function s(r){var i,c;if(r.appointmentId===t._id&&!j){const d=r.comment.senderEmail===((i=t.buyerId)==null?void 0:i.email),x=r.comment.senderEmail===((c=t.sellerId)==null?void 0:c.email),S=!d&&!x?"Organization":r.comment.senderEmail||"User";h.info(`New message from ${S}`)}}return y.on("commentUpdate",s),()=>{y.off("commentUpdate",s)}},[t._id,j]),a.useEffect(()=>{function s(r){r.appointmentId===t._id&&(v(i=>{const c=i.findIndex(d=>d._id===r.comment._id);if(c!==-1){const d=[...i],x=i[c],p=r.comment;let S=p.status;return x.status==="read"&&p.status!=="read"&&(S="read"),d[c]={...p,status:S},d}else return[...i,r.comment]}),j&&r.comment.senderEmail!==b.email&&fetch(`${k}/api/bookings/${t._id}/comments/read`,{method:"PATCH",credentials:"include"}))}return y.on("commentUpdate",s),()=>{y.off("commentUpdate",s)}},[t._id,v,j,b.email]),a.useEffect(()=>{j&&(fetch(`${k}/api/bookings/${t._id}/comments/read`,{method:"PATCH",credentials:"include"}),N.length===0&&(m(!0),fetch(`${k}/api/bookings/${t._id}`).then(s=>s.json()).then(s=>{s&&Array.isArray(s.comments)&&v(s.comments)}).catch(s=>console.error("Failed to fetch comments:",s)).finally(()=>m(!1))))},[j,t._id,N.length]),a.useEffect(()=>{function s(i){i.appointmentId===t._id&&v(c=>c.map(d=>d._id===i.commentId?{...d,status:d.status==="read"?"read":"delivered"}:d))}function r(i){i.appointmentId===t._id&&v(c=>c.map(d=>{var x;return(x=d.readBy)!=null&&x.includes(i.userId)?d:{...d,status:"read",readBy:[...d.readBy||[],i.userId]}}))}return y.on("commentDelivered",s),y.on("commentRead",r),()=>{y.off("commentDelivered",s),y.off("commentRead",r)}},[t._id,v]);const ge=N.filter(s=>{var r;return!((r=s.readBy)!=null&&r.includes(b._id))&&s.senderEmail!==b.email}).length;a.useEffect(()=>(j?document.body.style.overflow="hidden":(document.body.style.overflow="",xe(0)),()=>{document.body.style.overflow=""}),[j]);const Ue=`chatClearTime_${t._id}`,rt=Number(localStorage.getItem(Ue))||0,at=oe(t._id),_e=N.filter(s=>new Date(s.timestamp).getTime()>rt&&!at.includes(s._id));return a.useEffect(()=>{if(!j||!(u!=null&&u._id))return;y.emit("checkUserOnline",{userId:u._id});function s(r){r.userId===u._id&&Ne(!!r.online)}return y.on("userOnlineStatus",s),y.on("userOnlineUpdate",s),()=>{y.off("userOnlineStatus",s),y.off("userOnlineUpdate",s)}},[j,u==null?void 0:u._id]),a.useEffect(()=>{if(!(u!=null&&u._id))return;y.emit("checkUserOnline",{userId:u._id});function s(r){r.userId===u._id&&Ie(!!r.online)}return y.on("userOnlineStatus",s),y.on("userOnlineUpdate",s),()=>{y.off("userOnlineStatus",s),y.off("userOnlineUpdate",s)}},[u==null?void 0:u._id]),a.useEffect(()=>{function s(r){r.fromUserId===(u==null?void 0:u._id)&&r.appointmentId===t._id&&(Se(!0),f.current&&clearTimeout(f.current),f.current=setTimeout(()=>Se(!1),2e3))}return y.on("typing",s),()=>{y.off("typing",s),f.current&&clearTimeout(f.current)}},[u==null?void 0:u._id,t._id]),a.useEffect(()=>{if(!j)return;const s=r=>{var i;r.ctrlKey&&r.key==="f"&&(r.preventDefault(),(i=_.current)==null||i.focus())};return document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}},[j]),e.jsxs(e.Fragment,{children:[e.jsxs("tr",{className:`hover:bg-blue-50 transition align-top ${O?"":"bg-gray-100"}`,children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(t.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:t.time}),!O&&e.jsx("div",{className:"text-xs text-red-600 font-medium mt-1",children:"Outdated"})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:t.listingId?e.jsx(bt,{to:Qe?`/admin/listing/${t.listingId._id}`:`/user/listing/${t.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:t.propertyName}):e.jsx("div",{className:"font-semibold",children:t.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${F?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:F?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[Oe?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>be(u),title:"Click to view details",children:(u==null?void 0:u.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(u==null?void 0:u.username)||"Unknown"}),Oe?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:u==null?void 0:u.email}),e.jsx("div",{className:"text-sm text-gray-600",children:u!=null&&u.mobileNumber&&(u==null?void 0:u.mobileNumber)!==""?u.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:De?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:t.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:t.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${et(t.status)}`,children:t.status==="cancelledByBuyer"?"Cancelled by Buyer":t.status==="cancelledBySeller"?"Cancelled by Seller":t.status==="cancelledByAdmin"?"Cancelled by Admin":t.status.charAt(0).toUpperCase()+t.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("div",{className:"flex flex-col gap-2",children:O?e.jsxs(e.Fragment,{children:[F&&t.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>A(t._id,"accepted"),disabled:Y===t._id+"accepted",title:"Accept Appointment",children:e.jsx(qe,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>A(t._id,"rejected"),disabled:Y===t._id+"rejected",title:"Reject Appointment",children:e.jsx(Ke,{})})]}),F&&t.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Me,title:"Cancel Appointment (Seller)",children:e.jsx(q,{})}),F&&(t.status==="cancelledBySeller"||t.status==="cancelledByBuyer"||t.status==="cancelledByAdmin"||t.status==="rejected"||t.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Te,title:"Remove from table",style:{opacity:.5},children:e.jsx(q,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),ce&&(t.status==="pending"||t.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:Me,title:"Cancel Appointment (Buyer)",children:e.jsx(q,{})}),ce&&(t.status==="cancelledByBuyer"||t.status==="cancelledBySeller"||t.status==="cancelledByAdmin"||t.status==="deletedByAdmin"||t.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Te,title:"Remove from table",style:{opacity:.5},children:e.jsx(q,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),De&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:tt,title:"Cancel Appointment (Admin)",children:e.jsx(Ge,{})}),(t.status==="cancelledByBuyer"&&ce||t.status==="cancelledBySeller"&&F)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>Z(t),disabled:t.status==="cancelledByBuyer"&&ce&&(t.buyerReinitiationCount||0)>=2||t.status==="cancelledBySeller"&&F&&(t.sellerReinitiationCount||0)>=2||!t.buyerId||!t.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:ce&&t.status==="cancelledByBuyer"?`${2-(t.buyerReinitiationCount||0)} left`:F&&t.status==="cancelledBySeller"?`${2-(t.sellerReinitiationCount||0)} left`:""})]})]}):e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:Te,title:"Delete outdated appointment from table",style:{opacity:.7},children:e.jsx(q,{size:18})})})}),e.jsx("td",{className:"border p-2 text-center relative",children:e.jsxs("button",{className:`flex items-center justify-center rounded-full p-2 shadow-md mx-auto relative ${O?"bg-blue-100 hover:bg-blue-200 text-blue-700":"bg-gray-100 text-gray-400 cursor-not-allowed opacity-50"}`,title:O?"Open Chat":"Chat not available for outdated appointments",onClick:O?()=>te(!0):void 0,disabled:!O,children:[e.jsx(ke,{size:20}),X&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white animate-pulse",children:"..."}),!X&&ge>0&&!O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-gray-400 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:ge}),!X&&ge>0&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] text-center font-bold border-2 border-white",children:ge}),!X&&ge===0&&Ce&&O&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-green-500 border-2 border-white rounded-full w-3 h-3"})]})})]}),j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-100 rounded-2xl shadow-2xl w-full h-full max-w-6xl max-h-full p-0 relative animate-fadeIn flex flex-col",children:[O?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2 px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-200 to-purple-200 rounded-t-2xl relative",children:[e.jsx(ke,{className:"text-blue-600 text-xl"}),e.jsx("h3",{className:"text-lg font-bold text-blue-800",children:"Chat"}),X?e.jsx("span",{className:"ml-3 text-blue-600 font-semibold text-sm",children:"Typing..."}):we?e.jsx("span",{className:"ml-3 text-green-600 font-semibold text-sm",children:"Online"}):e.jsx("span",{className:"ml-3 text-gray-600 font-semibold text-sm",children:"Offline"}),e.jsxs("div",{className:"flex items-center gap-3 ml-auto",children:[_e.length>0&&e.jsx("button",{className:"text-xs text-red-600 hover:underline",onClick:()=>{window.confirm("Are you sure you want to clear chat? This action cannot be undone.")&&(localStorage.setItem(Ue,Date.now()),v([]),h.success("Chat Cleared"))},title:"Clear chat locally",children:"Clear Chat"}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"text-yellow-500 hover:text-yellow-600 bg-yellow-50 hover:bg-yellow-100 rounded-full p-2 transition-colors shadow",onClick:()=>o(!n),title:"Keyboard shortcut tip","aria-label":"Show keyboard shortcut tip",children:e.jsx(yt,{className:"text-sm"})}),n&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-20 whitespace-nowrap",children:["Press Ctrl + F to quickly focus and type your message.",e.jsx("div",{className:"absolute -top-1 right-4 w-2 h-2 bg-gray-800 transform rotate-45"})]})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition-colors z-10 shadow",onClick:()=>te(!1),title:"Close","aria-label":"Close",children:"Ã—"})]})]}),e.jsxs("div",{ref:R,className:"flex-1 overflow-y-auto space-y-2 mb-4 px-4 pt-4 animate-fadeInChat relative",style:{minHeight:"400px",maxHeight:"calc(100vh - 200px)"},children:[se&&_e.length>0&&e.jsx("div",{className:`sticky top-0 left-0 right-0 z-30 pointer-events-none transition-all duration-300 ease-in-out ${ve?"opacity-100 scale-100":"opacity-0 scale-95"}`,children:e.jsx("div",{className:"w-full flex justify-center py-2",children:e.jsx("div",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:se})})}),l?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx("div",{className:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"Loading messages..."})]}):_e.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center py-8",children:[e.jsx(ke,{className:"text-gray-300 text-4xl mb-3"}),e.jsx("p",{className:"text-gray-500 font-medium text-sm",children:"No messages yet"}),e.jsx("p",{className:"text-gray-400 text-xs mt-1",children:"Start the conversation and connect with the other party"})]}):_e.map((s,r)=>{var S,D;const i=s.senderEmail===b.email,c=w===s._id,d=new Date(s.timestamp),x=r>0?new Date(N[r-1].timestamp):null,p=x?d.toDateString()!==x.toDateString():!0;return d.toLocaleDateString("en-US",{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"}),e.jsxs(pt.Fragment,{children:[p&&e.jsx("div",{className:"w-full flex justify-center my-2",children:e.jsx("span",{className:"bg-blue-600 text-white text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white",children:Ee(d)})}),e.jsx("div",{className:`flex w-full ${i?"justify-end":"justify-start"} animate-fadeInChatBubble`,style:{animationDelay:`${.03*r}s`},children:e.jsxs("div",{ref:I=>J.current[s._id]=I,"data-message-id":s._id,className:`rounded-2xl px-4 py-2 text-sm shadow-lg max-w-[60%] break-words relative ${i?"bg-gradient-to-r from-blue-400 to-blue-600 text-white":"bg-white text-gray-800 border border-gray-200"}`,style:{animationDelay:`${.03*r}s`},children:[s.replyTo&&e.jsx("div",{className:"border-l-4 border-blue-300 pl-2 mb-1 text-xs text-gray-500 bg-blue-50 rounded w-full max-w-full break-words cursor-pointer",onClick:()=>{J.current[s.replyTo]&&(J.current[s.replyTo].scrollIntoView({behavior:"smooth",block:"center"}),J.current[s.replyTo].classList.add("ring-2","ring-yellow-400"),setTimeout(()=>{J.current[s.replyTo].classList.remove("ring-2","ring-yellow-400")},1e3))},role:"button",tabIndex:0,"aria-label":"Go to replied message",children:e.jsx("span",{className:"text-xs text-gray-600 truncate",children:((S=N.find(I=>I._id===s.replyTo))==null?void 0:S.message)||"Original message"})}),e.jsxs("div",{className:"font-semibold mb-1 flex items-center gap-2 flex-wrap break-all",children:[e.jsx("span",{className:"truncate max-w-[60%] min-w-[80px] inline-block align-middle overflow-hidden text-ellipsis",children:i?"You":(()=>{var He,Je;const I=s.senderEmail===((He=t.buyerId)==null?void 0:He.email),V=s.senderEmail===((Je=t.sellerId)==null?void 0:Je.email);return!I&&!V?"Organization":(u==null?void 0:u.username)||s.senderName||s.senderEmail})()}),e.jsx("span",{className:"text-gray-300 ml-2 text-[10px]",children:new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsx("div",{className:"flex items-center gap-1",children:s.deleted?e.jsxs("span",{className:"flex items-center gap-1 text-gray-400 italic",children:[e.jsx(jt,{className:"inline-block text-lg"})," ",s.senderEmail===b.email?"You deleted this message":"This message was deleted.",e.jsx("button",{className:"ml-2 text-red-700 hover:text-red-900",onClick:()=>{v(I=>I.filter(V=>V._id!==s._id)),de(t._id,s._id)},title:"Remove this deleted message from your chat view",children:e.jsx(q,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})})]}):e.jsx("div",{children:c?e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-400 px-2 py-1 rounded",children:e.jsx("span",{className:"text-yellow-800 text-xs font-medium",children:"âœï¸ Editing this message below..."})}):e.jsxs(e.Fragment,{children:[s.message,s.edited&&e.jsx("span",{className:"ml-2 text-[10px] italic text-gray-300",children:"(Edited)"})]})})}),e.jsxs("div",{className:"flex items-center gap-2 justify-end mt-1",children:[!s.deleted&&e.jsx("button",{className:`${i?"text-yellow-500 hover:text-yellow-700":"text-blue-600 hover:text-blue-800"}`,onClick:()=>{var I;ue(s),(I=_.current)==null||I.focus()},title:"Reply",children:e.jsx("svg",{width:"18",height:"18",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c4.28 0 6.92 1.45 8.84 4.55.23.36.76.09.65-.32C18.31 13.13 15.36 10.36 10 9z"})})}),s.senderEmail===b.email&&!s.deleted&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Ze(s),className:"text-green-800 hover:text-green-950",title:"Edit comment",disabled:w!==null,children:e.jsx(vt,{size:12})}),e.jsx("button",{className:"text-red-700 hover:text-red-900",onClick:()=>We(s),children:e.jsx(q,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),e.jsx("span",{className:"ml-1",children:(D=s.readBy)!=null&&D.includes(u==null?void 0:u._id)?e.jsx(Ve,{className:"text-white inline"}):s.status==="delivered"?e.jsx(Ve,{className:"text-white/70 inline"}):e.jsx(qe,{className:"text-white/70 inline"})})]}),!i&&!c&&!s.deleted&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xs",onClick:()=>{v(I=>I.filter(V=>V._id!==s._id)),de(t._id,s._id)},title:"Delete message locally",children:e.jsx(q,{size:14})})]})]})})]},s._id||r)}),e.jsx("div",{ref:E})]}),L&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-blue-50 border-l-4 border-blue-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-gray-700 font-semibold mr-2",children:"Replying to:"}),e.jsx("span",{className:"text-xs text-gray-600 truncate",children:L.message}),e.jsx("button",{className:"ml-auto text-gray-400 hover:text-gray-700",onClick:()=>ue(null),title:"Cancel reply",children:"Ã—"})]})}),w&&e.jsx("div",{className:"px-4 mb-2",children:e.jsxs("div",{className:"flex items-center bg-yellow-50 border-l-4 border-yellow-400 px-2 py-1 rounded",children:[e.jsx("span",{className:"text-xs text-yellow-700 font-semibold mr-2",children:"âœï¸ Editing message:"}),e.jsx("span",{className:"text-xs text-yellow-600 truncate",children:B}),e.jsx("button",{className:"ml-auto text-yellow-400 hover:text-yellow-700",onClick:()=>{ee(null),Q(""),H("")},title:"Cancel edit",children:"Ã—"})]})}),e.jsxs("div",{className:"flex gap-2 mt-2 px-4 pb-4",children:[e.jsx("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-full text-sm focus:ring-2 focus:ring-blue-200 shadow",placeholder:w?"Edit your message...":"Type a message...",value:G,onChange:s=>{H(s.target.value),w&&Q(s.target.value),w||y.emit("typing",{toUserId:u._id,fromUserId:b._id,appointmentId:t._id})},onKeyDown:s=>{s.key==="Enter"&&(w?Le(w):Fe())},ref:_}),e.jsx("button",{onClick:w?()=>Le(w):Fe,disabled:(w?pe===w:C)||!G.trim(),className:"bg-gradient-to-r from-blue-500 to-purple-500 text-white px-5 py-2 rounded-full text-sm font-semibold shadow hover:from-blue-600 hover:to-purple-600 transition disabled:opacity-50 flex items-center gap-2 min-w-20",children:w?pe===w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Saving..."]}):"Save":C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border border-white border-t-transparent rounded-full animate-spin"}),"Sending..."]}):"Send"})]}),e.jsx("style",{jsx:!0,children:`
                  @keyframes fadeInChatBubble {
                    from { opacity: 0; transform: translateY(10px) scale(0.98); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                  }
                  .animate-fadeInChatBubble {
                    animation: fadeInChatBubble 0.4s cubic-bezier(0.4,0,0.2,1) both;
                  }
                  @keyframes fadeInChat {
                    from { opacity: 0; }
                    to { opacity: 1; }
                  }
                  .animate-fadeInChat {
                    animation: fadeInChat 0.3s cubic-bezier(0.4,0,0.2,1) both;
                  }
                `})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center flex-1 p-8 min-h-96",children:[e.jsx(ke,{className:"text-6xl text-gray-400 mb-6"}),e.jsx("div",{className:"text-xl font-semibold text-gray-500 text-center",children:"Chat not available for outdated appointments"}),e.jsx("div",{className:"text-gray-400 text-center mt-2",children:"This appointment has already passed"})]}),!ie&&O&&!w&&!L&&e.jsx("div",{className:"absolute bottom-20 right-6 z-20",children:e.jsxs("button",{onClick:nt,className:"bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition-all duration-200 hover:scale-110 relative",title:M>0?`${M} new message${M>1?"s":""}`:"Scroll to bottom","aria-label":M>0?`${M} new messages, scroll to bottom`:"Scroll to bottom",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",className:"transform",children:e.jsx("path",{d:"M12 16l-6-6h12l-6 6z"})}),M>0&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1 border-2 border-white shadow-lg",children:M>99?"99+":M})]})})]})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx(q,{className:"text-red-500"}),"Delete Message"]}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Are you sure you want to delete this message?"}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:ne,onChange:s=>re(s.target.checked),className:"form-checkbox h-4 w-4 text-red-600 rounded border-gray-300 focus:ring-red-500"}),e.jsxs("span",{className:"text-sm text-gray-700",children:["Also delete for"," ",e.jsx("span",{className:"font-medium text-gray-900",children:(u==null?void 0:u.username)||"other user"})]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1 ml-7",children:ne?"The message will be permanently deleted for both users":"The message will only be hidden from your view"})]}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{type:"button",onClick:()=>{z(!1),le(null),re(!0)},className:"px-4 py-2 rounded bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"button",onClick:Xe,className:"px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors flex items-center gap-2",children:[e.jsx(q,{size:12}),ne?"Delete for Both":"Hide from Me"]})]})]})})]})}export{Nt as default};
