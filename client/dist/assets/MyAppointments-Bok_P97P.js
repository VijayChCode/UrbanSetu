import{b as V,r,j as e,y as W,D as X,E as Z,G as ee,u as te,L as se,H as ne,I as ae,l as R,z as le,A as re}from"./index-crh2KQ3K.js";function ce(){const{currentUser:s}=V(t=>t.user),[b,g]=r.useState([]),[J,j]=r.useState(!0),[_,S]=r.useState(null),[u,F]=r.useState(""),[A,k]=r.useState("all"),[B,E]=r.useState("all"),[O,v]=r.useState(""),[D,y]=r.useState(!1),[x,p]=r.useState(null),[N,o]=r.useState(""),[h,P]=r.useState(""),[l,w]=r.useState(!1),[c,f]=r.useState(null);r.useEffect(()=>{(async()=>{if(!s){S("Please sign in to view your appointments"),j(!1);return}try{j(!0),S(null);const a=await fetch("/api/bookings/my",{credentials:"include"});if(a.ok){const i=await a.json();g(i)}else throw new Error("Failed to fetch appointments")}catch{S("Failed to load appointments. Please try again.")}finally{j(!1)}})();const n=a=>{g(i=>i.filter(d=>d._id!==a.detail))};return window.addEventListener("removeAppointmentRow",n),()=>{window.removeEventListener("removeAppointmentRow",n)}},[s]);const I=async(t,n)=>{v(t+n);try{const a=await fetch(`/api/bookings/${t}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({status:n})}),i=await a.json();a.ok?(g(m=>m.map(C=>C._id===t?{...C,status:n}:C)),alert(`Appointment ${n==="accepted"?"accepted":"rejected"} successfully! ${n==="accepted"?"Contact information is now visible to both parties.":""}`)):alert(i.message||"Failed to update appointment status.")}catch{alert("An error occurred. Please try again.")}v("")},$=async t=>{const n=prompt("Please provide a reason for deleting this appointment:");if(n&&window.confirm("Are you sure you want to delete this appointment?"))try{const a=await fetch(`/api/bookings/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:n})}),i=await a.json();a.ok?(g(d=>d.map(m=>m._id===t?{...m,status:"deletedByAdmin",adminComment:n}:m)),alert("Appointment deleted successfully. Both buyer and seller have been notified.")):alert(i.message||"Failed to delete appointment.")}catch{alert("An error occurred. Please try again.")}},T=b.filter(t=>{var m,C,q,H,U,z,G,Y,K,Q;if(s._id===((C=(m=t.buyerId)==null?void 0:m._id)==null?void 0:C.toString())&&t.visibleToBuyer===!1||s._id===((H=(q=t.sellerId)==null?void 0:q._id)==null?void 0:H.toString())&&t.visibleToSeller===!1)return!1;const n=A==="all"?!0:t.status===A,a=B==="all"?!0:t.role===B,i=((U=t.propertyName)==null?void 0:U.toLowerCase().includes(u.toLowerCase()))||((z=t.message)==null?void 0:z.toLowerCase().includes(u.toLowerCase()))||((Y=(G=t.buyerId)==null?void 0:G.username)==null?void 0:Y.toLowerCase().includes(u.toLowerCase()))||((Q=(K=t.sellerId)==null?void 0:K.username)==null?void 0:Q.toLowerCase().includes(u.toLowerCase()));let d=!0;return N&&(d=d&&new Date(t.date)>=new Date(N)),h&&(d=d&&new Date(t.date)<=new Date(h)),n&&a&&i&&d});function M(t){f({...t,date:t.date?new Date(t.date).toISOString().split("T")[0]:"",time:t.time||"",message:t.message||"",reinitiationCount:t.reinitiationCount||0}),w(!0)}async function L(t){if(t.preventDefault(),!c)return;if(c.reinitiationCount>=2){alert("You have reached the maximum number of reinitiations for this appointment.");return}if(!c.buyerId||!c.sellerId){alert("Cannot reinitiate: one of the parties no longer exists.");return}const n={...c,status:"pending",reinitiationCount:(c.reinitiationCount||0)+1};try{const a=await fetch("/api/bookings/reinitiate",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)}),i=await a.json();a.ok?(alert("Appointment reinitiated successfully!"),w(!1),f(null),g(d=>d.map(m=>m._id===i.appointment._id?{...m,...i.appointment}:m))):alert(i.message||"Failed to reinitiate appointment.")}catch{alert("An error occurred. Please try again.")}}return J?e.jsx("p",{className:"text-center mt-8 text-lg font-semibold text-blue-600 animate-pulse",children:"Loading appointments..."}):_?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"text-center text-red-600 text-lg",children:_})})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 to-blue-100 py-10 px-2 md:px-8",children:[e.jsxs("div",{className:"max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6",children:[e.jsx("h3",{className:"text-3xl font-extrabold text-blue-700 mb-6 text-center drop-shadow",children:"My Appointments"}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Status:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:A,onChange:t=>k(t.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"accepted",children:"Accepted"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelledByBuyer",children:"Cancelled by Buyer"}),e.jsx("option",{value:"cancelledBySeller",children:"Cancelled by Seller"}),e.jsx("option",{value:"cancelledByAdmin",children:"Cancelled by Admin"}),e.jsx("option",{value:"deletedByAdmin",children:"Deleted by Admin"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"From:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:N,onChange:t=>o(t.target.value),max:h||void 0}),e.jsx("label",{className:"font-semibold",children:"To:"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:h,onChange:t=>P(t.target.value),min:N||void 0})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"font-semibold",children:"Role:"}),e.jsxs("select",{className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",value:B,onChange:t=>E(t.target.value),children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"buyer",children:"As Buyer"}),e.jsx("option",{value:"seller",children:"As Seller"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"text-gray-500"}),e.jsx("input",{type:"text",className:"border rounded px-2 py-1 focus:outline-none focus:ring focus:ring-blue-200",placeholder:"Search by property, message, or user...",value:u,onChange:t=>F(t.target.value)})]})]}),T.length===0?e.jsx("div",{className:"text-center text-gray-500 text-lg",children:b.length===0?"No appointments found.":"No appointments match your filters."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-blue-100 to-purple-100",children:[e.jsx("th",{className:"border p-2",children:"Date & Time"}),e.jsx("th",{className:"border p-2",children:"Property"}),e.jsx("th",{className:"border p-2",children:"Role"}),e.jsx("th",{className:"border p-2",children:"Other Party"}),e.jsx("th",{className:"border p-2",children:"Purpose"}),e.jsx("th",{className:"border p-2",children:"Message"}),e.jsx("th",{className:"border p-2",children:"Status"}),e.jsx("th",{className:"border p-2",children:"Actions"}),e.jsx("th",{className:"border p-2",children:"Comments"})]})}),e.jsx("tbody",{children:T.map(t=>e.jsx(ie,{appt:t,currentUser:s,handleStatusUpdate:I,handleAdminDelete:$,actionLoading:O,onShowOtherParty:n=>{p(n),y(!0)},onOpenReinitiate:()=>M(t)},t._id))})]})})]}),D&&x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4 relative",children:[e.jsx("button",{className:"absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-2xl",onClick:()=>y(!1),title:"Close",children:"Ã—"}),e.jsxs("h3",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(X,{className:"text-blue-500"}),x.username||"User Details"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"text-gray-500"})," ",e.jsx("span",{children:x.email})]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"text-gray-500"})," ",e.jsx("span",{children:x.mobileNumber||"Not provided"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Role:"})," ",x.role]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Member Since:"})," ",x.createdAt?new Date(x.createdAt).toLocaleDateString():""]})]}),e.jsx("button",{onClick:()=>y(!1),className:"mt-6 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Close"})]})}),l&&c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-blue-700",children:"Reinitiate Appointment"}),e.jsxs("form",{onSubmit:L,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Date"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:c.date,onChange:t=>f(n=>({...n,date:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Time"}),e.jsx("input",{type:"time",className:"border rounded px-2 py-1 w-full",value:c.time,onChange:t=>f(n=>({...n,time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block font-semibold mb-1",children:"Message"}),e.jsx("textarea",{className:"border rounded px-2 py-1 w-full",value:c.message,onChange:t=>f(n=>({...n,message:t.target.value})),required:!0})]}),e.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full",children:"Submit"}),e.jsx("button",{type:"button",className:"mt-2 w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400",onClick:()=>w(!1),children:"Cancel"})]})]})})]})}function ie({appt:s,currentUser:b,handleStatusUpdate:g,handleAdminDelete:J,actionLoading:j,onShowOtherParty:_,onOpenReinitiate:S}){const[u,F]=r.useState(""),[A,k]=r.useState(s.comments||[]),[B,E]=r.useState(!1),[O,v]=r.useState(null),[D,y]=r.useState(""),x=te();console.log("Appointment data:",s),console.log("listingId:",s.listingId);const p=(b.role==="admin"||b.role==="rootadmin")&&b.adminApprovalStatus==="approved",N=x.pathname.includes("/admin"),o=s.role==="seller",h=s.role==="buyer",P=p||s.status==="accepted",l=o?s.buyerId:s.sellerId,w=new Date(s.date)>new Date||new Date(s.date).toDateString()===new Date().toDateString()&&(!s.time||s.time>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),c=async()=>{if(u.trim()){E(!0);try{const t=await fetch(`/api/bookings/${s._id}/comment`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:u})}),n=await t.json();t.ok?(k(n.comments),F("")):alert(n.message||"Failed to send comment.")}catch{alert("An error occurred. Please try again.")}E(!1)}},f=async t=>{if(D.trim())try{const n=await fetch(`/api/bookings/${s._id}/comment/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message:D})}),a=await n.json();n.ok?(k(a.comments),v(null),y("")):alert(a.message||"Failed to edit comment.")}catch{alert("An error occurred. Please try again.")}},I=t=>{v(t._id),y(t.message)},$=t=>{switch(t){case"pending":return"bg-yellow-100 text-yellow-700";case"accepted":return"bg-green-100 text-green-700";case"rejected":return"bg-red-100 text-red-700";case"cancelledByBuyer":return"bg-orange-100 text-orange-700";case"cancelledBySeller":return"bg-pink-100 text-pink-700";case"cancelledByAdmin":return"bg-purple-100 text-purple-700";default:return"bg-gray-100 text-gray-700"}},T=async()=>{let t="";if(o){if(t=prompt("Please provide a reason for cancelling this appointment (required):"),!t)return alert("Reason is required for seller cancellation.")}else t=prompt("Please provide a reason for cancelling this appointment (optional):")||"";if(window.confirm("Are you sure you want to cancel this appointment?"))try{const n=await fetch(`/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:t})}),a=await n.json();n.ok?(alert("Appointment cancelled successfully."),window.location.href="/user/my-appointments"):alert(a.message||"Failed to cancel appointment.")}catch{alert("An error occurred. Please try again.")}},M=async()=>{const t=prompt("Please provide a reason for admin cancellation (required):");if(!t)return alert("Reason is required for admin cancellation.");if(window.confirm("Are you sure you want to cancel this appointment as admin?"))try{const n=await fetch(`/api/bookings/${s._id}/cancel`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({reason:t})}),a=await n.json();n.ok?(alert("Appointment cancelled by admin."),window.location.href="/user/my-appointments"):alert(a.message||"Failed to cancel appointment.")}catch{alert("An error occurred. Please try again.")}},L=async()=>{if(window.confirm("Are you sure you want to permanently remove this appointment from your table? This cannot be undone."))try{const t=h?"buyer":o?"seller":null;if(!t)return;if((await fetch(`/api/bookings/${s._id}/soft-delete`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({who:t})})).ok){if(typeof window<"u"){const a=new CustomEvent("removeAppointmentRow",{detail:s._id});window.dispatchEvent(a)}}else alert("Failed to remove appointment from table.")}catch{alert("An error occurred. Please try again.")}};return e.jsxs("tr",{className:"hover:bg-blue-50 transition align-top",children:[e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[e.jsx("div",{children:new Date(s.date).toLocaleDateString("en-GB")}),e.jsx("div",{className:"text-sm text-gray-600",children:s.time})]})}),e.jsx("td",{className:"border p-2",children:e.jsx("div",{children:s.listingId?e.jsx(se,{to:N?`/admin/listing/${s.listingId._id}`:`/user/listing/${s.listingId._id}`,className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",children:s.propertyName}):e.jsx("div",{className:"font-semibold",children:s.propertyName})})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${o?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:o?"Seller":"Buyer"})}),e.jsx("td",{className:"border p-2",children:e.jsxs("div",{children:[P?e.jsx("button",{className:"font-semibold text-blue-700 hover:underline text-left",style:{cursor:"pointer"},onClick:()=>_(l),title:"Click to view details",children:(l==null?void 0:l.username)||"Unknown"}):e.jsx("span",{className:"font-semibold",children:(l==null?void 0:l.username)||"Unknown"}),P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600",children:l==null?void 0:l.email}),e.jsx("div",{className:"text-sm text-gray-600",children:l!=null&&l.mobileNumber&&(l==null?void 0:l.mobileNumber)!==""?l.mobileNumber:"No phone"})]}):e.jsx("div",{className:"text-sm text-gray-500 italic",children:p?"Contact info available":"Contact info hidden until accepted"})]})}),e.jsx("td",{className:"border p-2 capitalize",children:s.purpose}),e.jsx("td",{className:"border p-2 max-w-xs truncate",children:s.message}),e.jsx("td",{className:"border p-2 text-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold ${$(s.status)}`,children:s.status==="cancelledByBuyer"?"Cancelled by Buyer":s.status==="cancelledBySeller"?"Cancelled by Seller":s.status==="cancelledByAdmin"?"Cancelled by Admin":s.status.charAt(0).toUpperCase()+s.status.slice(1)})}),e.jsx("td",{className:"border p-2 text-center",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[o&&w&&s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"text-green-500 hover:text-green-700 text-xl disabled:opacity-50",onClick:()=>g(s._id,"accepted"),disabled:j===s._id+"accepted",title:"Accept Appointment",children:e.jsx(ne,{})}),e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl disabled:opacity-50",onClick:()=>g(s._id,"rejected"),disabled:j===s._id+"rejected",title:"Reject Appointment",children:e.jsx(ae,{})})]}),o&&s.status==="accepted"&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:T,title:"Cancel Appointment (Seller)",children:e.jsx(R,{})}),o&&(s.status==="cancelledBySeller"||s.status==="cancelledByBuyer"||s.status==="cancelledByAdmin"||s.status==="rejected"||s.status==="deletedByAdmin")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:L,title:"Remove from table",style:{opacity:.5},children:e.jsx(R,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),h&&w&&(s.status==="pending"||s.status==="accepted")&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:T,title:"Cancel Appointment (Buyer)",children:e.jsx(R,{})}),h&&(s.status==="cancelledByBuyer"||s.status==="cancelledBySeller"||s.status==="cancelledByAdmin"||s.status==="deletedByAdmin"||s.status==="rejected")&&e.jsx("button",{className:"text-gray-400 hover:text-red-700 text-xl",onClick:L,title:"Remove from table",style:{opacity:.5},children:e.jsx(R,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})}),p&&e.jsx("button",{className:"text-red-500 hover:text-red-700 text-xl",onClick:M,title:"Cancel Appointment (Admin)",children:e.jsx(le,{})}),(s.status==="cancelledByBuyer"&&h||s.status==="cancelledBySeller"&&o)&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("button",{className:"text-blue-500 hover:text-blue-700 text-xs border border-blue-500 rounded px-2 py-1 mt-1",onClick:()=>S(s),disabled:s.reinitiationCount>=2||!s.buyerId||!s.sellerId,title:"Reinitiate or Reschedule Appointment",children:"Reinitiate"}),e.jsxs("span",{className:"text-xs text-gray-500 mt-1",children:[2-(s.reinitiationCount||0)," left"]})]})]})}),e.jsxs("td",{className:"border p-2",children:[s.status==="cancelledByAdmin"?e.jsxs("div",{className:"text-center text-red-500 text-sm",children:[e.jsx("div",{className:"mb-2",children:"This appointment has been cancelled by admin."}),s.cancelReason&&e.jsxs("div",{className:"text-xs bg-red-100 p-2 rounded border border-red-200",children:[e.jsx("strong",{children:"Cancellation Reason:"}),' "',s.cancelReason,'"']})]}):e.jsx("div",{className:"max-h-32 overflow-y-auto space-y-2",children:A.map((t,n)=>e.jsx("div",{className:"text-xs border-b pb-1",children:O===t._id?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",className:"flex-1 px-1 py-1 border rounded text-xs",value:D,onChange:a=>y(a.target.value)}),e.jsx("button",{onClick:()=>f(t._id),className:"bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600",children:"Save"}),e.jsx("button",{onClick:()=>v(null),className:"bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600",children:"Cancel"})]}):e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold text-blue-700",children:[t.senderEmail===b.email?"You":p?"Admin":t.senderEmail===(l==null?void 0:l.email)?o?"Buyer":"Seller":"Unknown",":"]})," ",t.message,e.jsx("span",{className:"text-gray-400 ml-2",children:new Date(t.timestamp).toLocaleString()})]}),(t.senderEmail===b.email||p)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>I(t),className:"text-blue-600 hover:text-blue-800",title:"Edit comment",children:e.jsx(re,{size:12})}),e.jsx("button",{className:"text-red-500 hover:text-red-700",onClick:async()=>{if(window.confirm("Are you sure you want to delete this comment?"))try{const a=await fetch(`/api/bookings/${s._id}/comment/${t._id}`,{method:"DELETE",credentials:"include"}),i=await a.json();a.ok?k(i.comments):alert(i.message||"Failed to delete comment.")}catch{alert("An error occurred. Please try again.")}},children:e.jsx(R,{className:"group-hover:text-red-900 group-hover:scale-125 group-hover:animate-shake transition-all duration-200"})})]})]})},t._id||n))}),s.status!=="cancelledByAdmin"&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("input",{type:"text",className:"flex-1 px-2 py-1 border rounded text-xs",placeholder:"Add a comment...",value:u,onChange:t=>F(t.target.value)}),e.jsx("button",{onClick:c,disabled:B||!u.trim(),className:"bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition disabled:opacity-50",children:"Send"})]})]})]})}export{ce as default};
